name: lettalite安卓APK编译（含Rust核心.so）
on: 
  workflow_dispatch:  # 明确指定触发方式，确保按钮显示
    description: "手动触发安卓APK编译"  # 可选，增加按钮描述

jobs:
  build-android:
    runs-on: ubuntu-latest
    env:
      ANDROID_NDK_VERSION: 27.3.13750724
      ANDROID_API_LEVEL: 24
      TARGET_ARCH: aarch64-linux-android
      OPENSSL_VERSION: 1.1.1w
      OPENSSL_SRC_DIR: ${{ github.workspace }}/openssl-src
      OPENSSL_INSTALL_DIR: ${{ github.workspace }}/openssl-install
      OUTPUT_DIR: ${{ github.workspace }}/target/android
      CORE_DIR: "core"
      CORE_PACKAGE_NAME: "letta-core"
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      BUILD_TOOLS_VERSION: 28.0.3

    steps:
      - name: 拉取letta-lite源码
        uses: actions/checkout@v4

      - name: 安装基础依赖
        run: |
          sudo apt-get update && sudo apt-get install -y \
            coreutils pkg-config make perl wget curl gcc cmake \
            libssl-dev zlib1g-dev zip unzip openjdk-17-jdk

      - name: 安装Android SDK和构建工具
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          packages: |
            ndk;${{ env.ANDROID_NDK_VERSION }}
            platforms;android-${{ env.ANDROID_API_LEVEL }}
            build-tools;${{ env.BUILD_TOOLS_VERSION }}

      - name: 查看SDK安装目录
        run: |
          echo "=== SDK根目录 ==="
          ls -l ${{ env.ANDROID_SDK_ROOT }}
          echo "=== build-tools目录 ==="
          ls -l ${{ env.ANDROID_SDK_ROOT }}/build-tools/
          echo "=== platforms目录 ==="
          ls -l ${{ env.ANDROID_SDK_ROOT }}/platforms/

      - name: 验证NDK和SDK工具（动态查找路径）
        run: |
          NDK_PATH=$(find ${{ env.ANDROID_SDK_ROOT }}/ndk -maxdepth 1 -type d | grep ${{ env.ANDROID_NDK_VERSION }})
          if [ -z "$NDK_PATH" ]; then echo "❌ 未找到NDK"; exit 1; fi
          export ANDROID_NDK_ROOT=$NDK_PATH
          NDK_TOOLCHAIN_BIN="$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin"
          NDK_SYSROOT="$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
          echo "NDK_TOOLCHAIN_BIN=$NDK_TOOLCHAIN_BIN" >> $GITHUB_ENV
          echo "NDK_SYSROOT=$NDK_SYSROOT" >> $GITHUB_ENV
          if [ ! -f "$NDK_TOOLCHAIN_BIN/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang" ]; then
            echo "❌ 编译器缺失"; exit 1
          fi

          AAPT_PATH=$(find ${{ env.ANDROID_SDK_ROOT }}/build-tools -name aapt -type f | head -1)
          DX_PATH=$(find ${{ env.ANDROID_SDK_ROOT }}/build-tools -name dx -type f | head -1)
          APKSIGNER_PATH=$(find ${{ env.ANDROID_SDK_ROOT }}/build-tools -name apksigner -type f | head -1)
          if [ -z "$AAPT_PATH" ] || [ -z "$DX_PATH" ] || [ -z "$APKSIGNER_PATH" ]; then
            echo "❌ 缺少Android构建工具"; exit 1
          fi
          BUILD_TOOLS_BIN=$(dirname "$AAPT_PATH")
          echo "BUILD_TOOLS_BIN=$BUILD_TOOLS_BIN" >> $GITHUB_ENV
          echo "✅ NDK和SDK工具验证通过"

      - name: 下载并编译OpenSSL
        run: |
          mkdir -p ${{ env.OPENSSL_SRC_DIR }} ${{ env.OPENSSL_INSTALL_DIR }}
          cd ${{ env.OPENSSL_SRC_DIR }}
          wget -q https://www.openssl.org/source/openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          tar -xvzf openssl-${{ env.OPENSSL_VERSION }}.tar.gz --strip-components=1
          export CC="${{ env.NDK_TOOLCHAIN_BIN }}/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang"
          export CXX="${{ env.NDK_TOOLCHAIN_BIN }}/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang++"
          export AR="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ar"
          export RANLIB="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ranlib"
          export LD="${{ env.NDK_TOOLCHAIN_BIN }}/ld.lld"
          export PATH="$NDK_TOOLCHAIN_BIN:$PATH"
          ./Configure linux-aarch64 no-shared no-asm no-zlib \
            --prefix=${{ env.OPENSSL_INSTALL_DIR }} \
            --sysroot=${{ env.NDK_SYSROOT }} \
            -fPIC -march=armv8-a \
            CC=$CC CXX=$CXX AR=$AR RANLIB=$RANLIB LD=$LD
          make -j$(nproc) V=1
          make install_sw && echo "✅ OpenSSL编译完成"

      - name: 配置Rust环境
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.85.0
          target: ${{ env.TARGET_ARCH }}

      - name: 安装cargo-ndk
        run: cargo install cargo-ndk --version=3.5.4 --locked

      - name: 修复工作区配置
        run: |
          sed -i '/^\[lib\]$/,/^$/d' Cargo.toml
          echo "✅ 已清理根目录Cargo.toml"
          CORE_CARGO="${{ env.CORE_DIR }}/Cargo.toml"
          if [ ! -f "$CORE_CARGO" ]; then echo "❌ 子包目录不存在"; ls -l */Cargo.toml; exit 1; fi
          if ! grep -q "crate-type = \[\"cdylib\"" "$CORE_CARGO"; then
            echo -e "\n[lib]\ncrate-type = [\"cdylib\"]" >> "$CORE_CARGO"
            echo "✅ 已添加cdylib配置"
          fi

      - name: 编译核心子包（改用 --profile mobile）
        run: |
          cargo clean
          export OPENSSL_INCLUDE_DIR=${{ env.OPENSSL_INSTALL_DIR }}/include
          export OPENSSL_LIB_DIR=${{ env.OPENSSL_INSTALL_DIR }}/lib
          export OPENSSL_DIR=${{ env.OPENSSL_INSTALL_DIR }}
          export PKG_CONFIG_ALLOW_CROSS=1
          cargo ndk -t aarch64-linux-android -o ${{ env.OUTPUT_DIR }} build \
            --package ${{ env.CORE_PACKAGE_NAME }} \
            --profile mobile
          echo "✅ 编译完成，产物目录："
          ls -l ${{ env.OUTPUT_DIR }}
          find target -name "lib*.so" -exec cp {} ${{ env.OUTPUT_DIR }}/ \;
          echo "✅ 最终产物列表："
          ls -l ${{ env.OUTPUT_DIR }}

      - name: 上传.so产物
        uses: actions/upload-artifact@v4
        with:
          name: lettalite-android-so-mobile
          path: ${{ env.OUTPUT_DIR }}/*.so
          retention-days: 14

      - name: 创建极简Android项目结构（含正确Manifest）
        run: |
          set -e
          mkdir -p android-app/src/main/{java/com/letta/app,res/layout,jniLibs/arm64-v8a}

          # 1. 布局文件
          cat > android-app/src/main/res/layout/activity_main.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:padding="16dp">
    <TextView
        android:id="@+id/resultView"
        android:layout_width="match_parent"
        android:layout_height="0dp"
        android:layout_weight="1"
        android:hint="等待Lettalite回复..."
        android:textSize="16sp" />
    <EditText
        android:id="@+id/inputEdit"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:hint="输入指令..."
        android:layout_marginBottom="8dp" />
    <Button
        android:id="@+id/sendBtn"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="发送"
        android:background="#2196F3"
        android:textColor="@android:color/white" />
    <LinearLayout
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:orientation="horizontal"
        android:layout_marginTop="8dp">
        <Button
            android:id="@+id/allowBtn"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="允许工具调用"
            android:background="#4CAF50"
            android:textColor="@android:color/white"
            android:layout_marginRight="8dp"
            android:visibility="gone" />
        <Button
            android:id="@+id/denyBtn"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="拒绝工具调用"
            android:background="#F44336"
            android:textColor="@android:color/white"
            android:visibility="gone" />
    </LinearLayout>
</LinearLayout>
EOF

          # 2. MainActivity.java
          cat > android-app/src/main/java/com/letta/app/MainActivity.java << 'EOF'
package com.letta.app;
import android.os.Bundle;
import android.view.View;
import android.widget.Button;
import android.widget.EditText;
import android.widget.TextView;
import android.app.Activity;

public class MainActivity extends Activity {
    static {
        System.loadLibrary("letta-core");
    }

    private EditText inputEdit;
    private TextView resultView;
    private Button sendBtn, allowBtn, denyBtn;
    private long ctx;

    public native long letta_init();
    public native String letta_send_input(long ctx, String input);
    public native String letta_confirm_tool(long ctx, boolean confirm);

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        inputEdit = findViewById(R.id.inputEdit);
        resultView = findViewById(R.id.resultView);
        sendBtn = findViewById(R.id.sendBtn);
        allowBtn = findViewById(R.id.allowBtn);
        denyBtn = findViewById(R.id.denyBtn);

        ctx = letta_init();

        sendBtn.setOnClickListener(v -> {
            String input = inputEdit.getText().toString().trim();
            if (!input.isEmpty()) {
                inputEdit.setText("");
                String result = letta_send_input(ctx, input);
                resultView.setText(result);
                if (result.contains("是否允许") || result.contains("需要调用")) {
                    allowBtn.setVisibility(View.VISIBLE);
                    denyBtn.setVisibility(View.VISIBLE);
                } else {
                    allowBtn.setVisibility(View.GONE);
                    denyBtn.setVisibility(View.GONE);
                }
            }
        });

        allowBtn.setOnClickListener(v -> {
            resultView.setText(letta_confirm_tool(ctx, true));
            allowBtn.setVisibility(View.GONE);
            denyBtn.setVisibility(View.GONE);
        });

        denyBtn.setOnClickListener(v -> {
            resultView.setText(letta_confirm_tool(ctx, false));
            allowBtn.setVisibility(View.GONE);
            denyBtn.setVisibility(View.GONE);
        });
    }
}
EOF

          # 3. AndroidManifest.xml（已修复图标和标签）
          cat > android-app/src/main/AndroidManifest.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.letta.app"
    android:versionCode="1"
    android:versionName="1.0">
    <uses-sdk
        android:minSdkVersion="24"
        android:targetSdkVersion="33" />
    <application
        android:allowBackup="true"
        android:icon="@android:mipmap/sym_def_app_icon"
        android:label="Lettalite"
        android:theme="@android:style/Theme.Light">
        <activity
            android:name=".MainActivity"
            android:exported="true">
            <<intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </</intent-filter>
        </activity>
    </application>
</manifest>
EOF

          # 验证XML格式
          if [ ! -s android-app/src/main/AndroidManifest.xml ]; then
            echo "❌ Manifest写入失败"; exit 1
          fi
          xmllint --noout android-app/src/main/AndroidManifest.xml || (echo "❌ XML格式错误"; exit 1)
          echo "✅ Android项目结构创建完成"

      - name: 整合.so文件到APK目录
        run: |
          cp ${{ env.OUTPUT_DIR }}/lib*.so android-app/src/main/jniLibs/arm64-v8a/
          echo "✅ .so核心整合完成"

      - name: 手动编译打包APK
        working-directory: ./android-app
        run: |
          set -e
          BUILD_TOOLS_BIN="${{ env.BUILD_TOOLS_BIN }}"
          ANDROID_SDK_ROOT="${{ env.ANDROID_SDK_ROOT }}"
          OUTPUT_APK="app-debug.apk"
          TEMP_DIR="temp_build"
          mkdir -p $TEMP_DIR/{classes,resources,dex,jniLibs,gen}

          # 1. 打包资源
          $BUILD_TOOLS_BIN/aapt package -f -m -J $TEMP_DIR/gen -M src/main/AndroidManifest.xml \
            -S src/main/res -I "$ANDROID_SDK_ROOT/platforms/android-${{ env.ANDROID_API_LEVEL }}/android.jar" \
            -F $TEMP_DIR/resources.ap_
          echo "✅ 资源打包完成"

          # 2. 复制R.java
          mkdir -p src/main/java/com/letta/app
          cp $TEMP_DIR/gen/com/letta/app/R.java src/main/java/com/letta/app/
          echo "✅ R.java已复制"

          # 3. 编译Java
          javac -source 1.8 -target 1.8 \
            -bootclasspath "$ANDROID_SDK_ROOT/platforms/android-${{ env.ANDROID_API_LEVEL }}/android.jar" \
            -d $TEMP_DIR/classes \
            src/main/java/com/letta/app/*.java
          echo "✅ Java编译完成"

          # 4. 生成dex
          $BUILD_TOOLS_BIN/dx --dex --output=$TEMP_DIR/dex/classes.dex $TEMP_DIR/classes
          echo "✅ Dex生成完成"

          # 5. 复制so
          cp -r src/main/jniLibs/arm64-v8a $TEMP_DIR/jniLibs/
          echo "✅ so复制完成"

          # 6. 打包未签名APK
          cd $TEMP_DIR && zip -r ../unsigned.apk dex resources.ap_ jniLibs && cd ..
          echo "✅ 未签名APK生成"

          # 7. 生成调试密钥
          keytool -genkeypair -validity 10000 -dname "CN=Android Debug,O=Android,C=US" \
            -keystore debug.keystore -storepass android -keypass android -keyalg RSA -keysize 2048
          echo "✅ 调试密钥生成"

          # 8. 签名
          $BUILD_TOOLS_BIN/apksigner sign --ks debug.keystore --ks-pass pass:android --key-pass pass:android \
            --out $OUTPUT_APK unsigned.apk
          echo "✅ APK签名完成"

          # 9. 对齐
          $BUILD_TOOLS_BIN/zipalign -f 4 $OUTPUT_APK $OUTPUT_APK.aligned
          mv $OUTPUT_APK.aligned $OUTPUT_APK
          echo "✅ APK对齐完成"
          ls -l $OUTPUT_APK

      - name: 上传最终APK
        uses: actions/upload-artifact@v4
        with:
          name: lettalite-安卓APK（直接安装）
          path: android-app/app-debug.apk
          retention-days: 14

name: Letta Lite Android 自动构建（标准路径版）
on:
  push:
    branches: [ main ]
    paths:
      - 'app/src/main/AndroidManifest.xml'  # 监听标准路径的 Manifest
      - 'anzhuoshifangyingwenjian/**'       # 保留其他文件的监听
      - 'settings.gradle'
      - 'gradle.properties'
      - 'app/build.gradle'
      - '.github/workflows/android-build.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取项目代码
        uses: actions/checkout@v4

      - name: 配置 Gradle 模块（仅确认 app 模块）
        run: |
          SETTINGS_FILE="settings.gradle"
          if ! grep -q "include ':app'" "$SETTINGS_FILE"; then
              echo "include ':app'" >> "$SETTINGS_FILE"
              echo "rootProject.name = 'letta-lite'" >> "$SETTINGS_FILE"
          fi
          echo "✅ Gradle 模块配置完成"

      - name: 检查核心文件（仅验证标准路径 Manifest）
        run: |
          [ ! -f "./settings.gradle" ] && { echo "❌ 缺少 settings.gradle"; exit 1; }
          [ ! -f "./gradle.properties" ] && { echo "❌ 缺少 gradle.properties"; exit 1; }
          [ ! -f "./app/build.gradle" ] && { echo "❌ 缺少 app/build.gradle"; exit 1; }
          [ ! -f "./app/src/main/AndroidManifest.xml" ] && { echo "❌ 标准路径缺少 AndroidManifest.xml"; exit 1; }
          # 保留其他文件的检查（如果需要）
          [ -f "./anzhuoshifangyingwenjian/letta_lite_main.xml" ] && echo "✅ 自定义目录其他文件存在" || echo "⚠️ 自定义目录布局文件缺失（非必需）"
          echo "✅ 核心构建文件齐全"

      - name: 设置 JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: 同步自定义目录的其他文件（仅保留非 Manifest 文件）
        run: |
          # 仅同步布局、资源等其他文件（排除 AndroidManifest.xml）
          CUSTOM_DIR="anzhuoshifangyingwenjian"
          DEST_LAYOUT="app/src/main/res/layout"
          mkdir -p "$DEST_LAYOUT"
          # 复制除 Manifest 外的所有文件（可根据需要调整通配符）
          cp -f "$CUSTOM_DIR"/*.xml "$DEST_LAYOUT/" 2>/dev/null || echo "⚠️ 自定义目录无额外 XML 文件可同步"
          echo "✅ 自定义目录其他文件同步完成"

      - name: 编译 Release 版本 APK（标准 app 模块）
        run: |
          if [ -f "./gradlew" ]; then
              chmod +x ./gradlew
              ./gradlew clean :app:assembleRelease --no-daemon --info --stacktrace
          else
              echo "⚠️ 使用云端全局 Gradle"
              gradle clean :app:assembleRelease --no-daemon --info --stacktrace
          fi

      - name: 上传 APK 产物
        uses: actions/upload-artifact@v4
        with:
          name: letta-lite-android-apk
          path: app/build/outputs/apk/release/*.apk
          retention-days: 30
          if-no-files-found: error

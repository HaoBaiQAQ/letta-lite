name: Letta Lite Android 自动构建（无 .sh 版本）

# 触发条件：提交代码到 main 分支 或 手动触发
on:
  push:
    branches: [ main ]
    paths: # 只在这些路径文件变更时触发，减少不必要构建
      - 'app/**'
      - 'anzhuoshifangyingwenjian/**'
      - '.github/workflows/android-build.yml'
  workflow_dispatch: # 允许在 GitHub 手动触发

jobs:
  build:
    runs-on: ubuntu-latest # 云端服务器环境（Ubuntu 最新版）

    steps:
      # 步骤1：拉取项目代码到云端服务器
      - name: 拉取项目代码
        uses: actions/checkout@v4

      # 步骤2：配置 Java 环境（Android 构建必需）
      - name: 设置 JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle # 缓存 Gradle 依赖，加速后续构建

      # 步骤3：同步自定义布局文件到 Android 标准路径（核心步骤）
      - name: 同步布局文件（自定义目录 → 标准目录）
        run: |
          # 配置路径（可根据实际需求调整）
          CUSTOM_LAYOUT_PATH="anzhuoshifangyingwenjian/letta_lite_main.xml"
          STANDARD_LAYOUT_PATH="app/src/main/res/layout"
          
          # 检查自定义布局文件是否存在
          if [ ! -f "$CUSTOM_LAYOUT_PATH" ]; then
              echo "❌ 错误：自定义布局文件 $CUSTOM_LAYOUT_PATH 不存在"
              exit 1
          fi
          
          # 创建标准布局目录（若不存在）
          mkdir -p "$STANDARD_LAYOUT_PATH"
          
          # 复制布局文件到标准路径（覆盖旧文件，确保同步最新版本）
          cp -f "$CUSTOM_LAYOUT_PATH" "$STANDARD_LAYOUT_PATH/"
          echo "✅ 布局文件同步成功：$CUSTOM_LAYOUT_PATH → $STANDARD_LAYOUT_PATH/letta_lite_main.xml"

      # 步骤4：检查并修复 AndroidManifest.xml（避免格式错误导致编译失败）
      - name: 检查并修复清单文件
        run: |
          MANIFEST_FILE="app/src/main/AndroidManifest.xml"
          PACKAGE_NAME="com.letta.lite.mobile" # 请根据你的项目实际包名修改
          
          # 检查清单文件是否存在，不存在则创建
          if [ ! -f "$MANIFEST_FILE" ]; then
              echo "❌ 清单文件不存在，正在创建标准版本..."
              mkdir -p $(dirname "$MANIFEST_FILE")
              cat > "$MANIFEST_FILE" << EOF
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android"
              package="$PACKAGE_NAME">
              <uses-permission android:name="android.permission.INTERNET" />
              <application
                  android:allowBackup="true"
                  android:label="Letta Lite"
                  android:theme="@android:style/Theme.Material.Light">
                  <activity
                      android:name=".MainActivity"
                      android:exported="true">
                      <<intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </</intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF
              echo "✅ 清单文件创建成功"
              exit 0
          fi
          
          # 检查清单文件根标签是否为 <manifest>（修复原错误）
          if ! grep -q "<manifest" "$MANIFEST_FILE"; then
              echo "❌ 清单文件格式错误，正在修复..."
              cat > "$MANIFEST_FILE" << EOF
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android"
              package="$PACKAGE_NAME">
              <uses-permission android:name="android.permission.INTERNET" />
              <application
                  android:allowBackup="true"
                  android:label="Letta Lite"
                  android:theme="@android:style/Theme.Material.Light">
                  <activity
                      android:name=".MainActivity"
                      android:exported="true">
                      <<intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </</intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF
              echo "✅ 清单文件修复成功"
          else
              echo "✅ 清单文件格式正常"
          fi

      # 步骤5：执行 Gradle 编译（生成 Release 版 APK）
      - name: 编译 Release 版本 APK
        run: |
          # 赋予 gradlew 执行权限（云端默认可能无权限）
          chmod +x ./gradlew
          # 执行清理+编译，--no-daemon 避免后台进程占用资源
          ./gradlew clean assembleRelease --no-daemon

      # 步骤6：上传编译好的 APK 作为构建产物（方便下载）
      - name: 上传 APK 产物
        uses: actions/upload-artifact@v4
        with:
          name: letta-lite-android-apk # 产物名称（下载时显示）
          path: app/build/outputs/apk/release/*.apk # APK 输出路径（匹配所有 Release 版 APK）
          retention-days: 30 # 产物保留 30 天（可按需调整，如 7/90 天）
          if-no-files-found: error # 若未找到 APK，标记构建失败

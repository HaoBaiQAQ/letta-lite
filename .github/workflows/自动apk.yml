name: ä¸æ”¹åŠ¨é¡¹ç›®ï¼Œè‡ªåŠ¨ç”ŸæˆAPK
on: [push]  # æ¨ä»£ç å°±è§¦å‘ï¼Œå’Œä½ ç°æœ‰ç¼–è¯‘é€»è¾‘å¹¶è¡Œ

jobs:
  build-apk:
    runs-on: ubuntu-latest
    steps:
      # 1. æ‹‰å–ä½ çš„ç°æœ‰é¡¹ç›®ï¼ˆåŒ…æ‹¬ä½ ä¿®çš„ä¸¤ä¸ªè„šæœ¬ï¼Œä¸€åŠ¨ä¸æ”¹ï¼‰
      - name: æ‹‰å–ç°æœ‰Lettaliteé¡¹ç›®
        uses: actions/checkout@v4

      # 2. å®‰è£…ç¼–è¯‘ä¾èµ–ï¼ˆRustã€å®‰å“NDKï¼Œäº‘ä¾§ä¸´æ—¶è£…ï¼Œä¸å½±å“ä½ é¡¹ç›®ï¼‰
      - name: å®‰è£…Rustå’Œå®‰å“äº¤å‰ç¼–è¯‘å·¥å…·
        uses: dtolnay/rust-toolchain@stable
        with:
          target: aarch64-linux-android

      - name: å®‰è£…å®‰å“NDKï¼ˆç”¨äºç”Ÿæˆå¯¹æ¥ä»£ç å’Œæ‰“åŒ…APKï¼‰
        uses: android-actions/setup-android@v3
        with:
          ndk-version: "25.2.9519653"

      # 3. ç”¨ä½ ç°æœ‰çš„è„šæœ¬ç¼–è¯‘.soï¼ˆå®Œå…¨å¤ç”¨ä½ çš„é€»è¾‘ï¼Œä¸æ”¹åŠ¨ï¼‰
      - name: æ‰§è¡Œä½ ä¿®è¿‡çš„è„šæœ¬ï¼Œç¼–è¯‘.so
        run: |
          # ğŸ‘‡ ã€æ”¹1ï¼šæ›¿æ¢æˆä½ ç°æœ‰ç¼–è¯‘.soçš„è„šæœ¬è·¯å¾„ã€‘æ¯”å¦‚ä½ ä¿®çš„è„šæœ¬åœ¨scripts/build-android.sh
          bash scripts/build-android.sh  # ä½ çš„è„šæœ¬ä¼šç”Ÿæˆ.soï¼Œè®°ä½å®ƒçš„è¾“å‡ºè·¯å¾„ï¼

      # 4. è‡ªåŠ¨ç”ŸæˆJavaå¯¹æ¥ä»£ç ï¼ˆæ ¹æ®.soå¯¼å‡ºçš„APIï¼Œä¸ç”¨ä½ å†™ï¼‰
      - name: ç”Ÿæˆå¯¹æ¥ä»£ç 
        run: |
          # å®‰è£…ç”Ÿæˆå·¥å…·
          cargo install cbindgen
          # ğŸ‘‡ ã€æ”¹2ï¼šæ›¿æ¢æˆä½ Rustæ ¸å¿ƒæºç çš„ç›®å½•ã€‘æ¯”å¦‚ä½ çš„Rustä»£ç åœ¨core/ç›®å½•
          cbindgen --lang c --output letta_api.h --source core/
          # ç”¨NDKè‡ªåŠ¨ç”ŸæˆJavaç±»
          $ANDROID_HOME/ndk/25.2.9519653/build/tools/ndk-build.sh \
          -C . \
          APP_BUILD_SCRIPT=Android.mk \
          APP_PLATFORM=android-24

      # 5. è‡ªåŠ¨æ‹‰å–æç®€å®‰å“UIæ¨¡æ¿ï¼ˆè¾“å…¥æ¡†+æŒ‰é’®ï¼Œå…¨åŠŸèƒ½ï¼Œä¸ç”¨ä½ å†™UIï¼‰
      - name: æ‹‰å–UIæ¨¡æ¿
        run: |
          # æ‹‰å–æˆ‘æå‰å‡†å¤‡å¥½çš„æç®€UIæ¨¡æ¿ï¼ˆå«è¾“å…¥æ¡†ã€å‘é€æŒ‰é’®ã€ç»“æœå±•ç¤ºï¼‰
          git clone https://gitee.com/xxx/letta-android-ui-template.git ui-template
          # æŠŠUIæ¨¡æ¿å¤åˆ¶åˆ°ä¸´æ—¶ç›®å½•ï¼Œå’Œ.soã€å¯¹æ¥ä»£ç æ•´åˆ
          mkdir -p android-app/src/main
          cp -r ui-template/* android-app/src/main/

      # 6. æ•´åˆ.soå’Œå¯¹æ¥ä»£ç åˆ°UIé¡¹ç›®
      - name: æ•´åˆæ–‡ä»¶
        run: |
          # ğŸ‘‡ ã€æ”¹3ï¼šæ›¿æ¢æˆä½ ç¼–è¯‘å¥½çš„.soè·¯å¾„ã€‘æ¯”å¦‚ä½ çš„.soåœ¨target/aarch64-linux-android/release/
          cp target/aarch64-linux-android/release/libletta.so android-app/src/main/jniLibs/arm64-v8a/
          cp letta_api.h android-app/src/main/jniLibs/arm64-v8a/

      # 7. è‡ªåŠ¨æ‰“åŒ…APKï¼ˆä¸ç”¨ä½ æ‡‚å®‰å“ç¼–è¯‘ï¼‰
      - name: æ‰“åŒ…APK
        working-directory: ./android-app
        run: |
          # è‡ªåŠ¨ä¸‹è½½å®‰å“ç¼–è¯‘ä¾èµ–
          ./gradlew assembleDebug

      # 8. ä¸Šä¼ APKï¼Œä½ ç›´æ¥ä¸‹è½½å®‰è£…
      - name: ä¸Šä¼ APK
        uses: actions/upload-artifact@v4
        with:
          name: å…¨åŠŸèƒ½Lettalite-APK
          path: android-app/build/outputs/apk/debug/app-debug.apk

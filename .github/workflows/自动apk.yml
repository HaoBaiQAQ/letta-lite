name: lettaliteå®‰å“APKç¼–è¯‘ï¼ˆå«Rustæ ¸å¿ƒ.soï¼‰
on:
  workflow_dispatch:
    description: "æ‰‹åŠ¨è§¦å‘å®‰å“APKç¼–è¯‘ï¼ˆæ”¯æŒAndroid 7.0+ï¼‰"

jobs:
  build-android:
    runs-on: ubuntu-latest
    env:
      ANDROID_NDK_VERSION: 27.3.13750724
      ANDROID_API_LEVEL: 24
      TARGET_ARCH: aarch64-linux-android
      OPENSSL_VERSION: 1.1.1w
      OPENSSL_SRC_DIR: ${{ github.workspace }}/openssl-src
      OPENSSL_INSTALL_DIR: ${{ github.workspace }}/openssl-install
      OUTPUT_DIR: ${{ github.workspace }}/target/android
      CORE_DIR: "core"
      CORE_PACKAGE_NAME: "letta-core"
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      BUILD_TOOLS_VERSION: 28.0.3

    steps:
      - name: æ‹‰å–letta-liteæºç 
        uses: actions/checkout@v4

      - name: å®‰è£…åŸºç¡€ä¾èµ–ï¼ˆå«XMLéªŒè¯å·¥å…·ï¼‰
        run: |
          sudo apt-get update && sudo apt-get install -y \
            coreutils pkg-config make perl wget curl gcc cmake \
            libssl-dev zlib1g-dev zip unzip openjdk-17-jdk \
            libxml2-utils  # ä¿®å¤xmllintç¼ºå¤±é—®é¢˜

      - name: å®‰è£…Android SDKå’Œæ„å»ºå·¥å…·
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          packages: |
            ndk;${{ env.ANDROID_NDK_VERSION }}
            platforms;android-${{ env.ANDROID_API_LEVEL }}
            build-tools;${{ env.BUILD_TOOLS_VERSION }}

      - name: æŸ¥çœ‹SDKå®‰è£…ç›®å½•ï¼ˆè°ƒè¯•ç”¨ï¼‰
        run: |
          echo "=== SDKæ ¹ç›®å½• ==="
          ls -l ${{ env.ANDROID_SDK_ROOT }}
          echo "=== build-toolsç›®å½• ==="
          ls -l ${{ env.ANDROID_SDK_ROOT }}/build-tools/
          echo "=== platformsç›®å½• ==="
          ls -l ${{ env.ANDROID_SDK_ROOT }}/platforms/

      - name: éªŒè¯NDKå’ŒSDKå·¥å…·ï¼ˆåŠ¨æ€æŸ¥æ‰¾è·¯å¾„ï¼‰
        run: |
          NDK_PATH=$(find ${{ env.ANDROID_SDK_ROOT }}/ndk -maxdepth 1 -type d | grep ${{ env.ANDROID_NDK_VERSION }})
          if [ -z "$NDK_PATH" ]; then echo "âŒ æœªæ‰¾åˆ°NDK"; exit 1; fi
          export ANDROID_NDK_ROOT=$NDK_PATH
          NDK_TOOLCHAIN_BIN="$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin"
          NDK_SYSROOT="$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
          echo "NDK_TOOLCHAIN_BIN=$NDK_TOOLCHAIN_BIN" >> $GITHUB_ENV
          echo "NDK_SYSROOT=$NDK_SYSROOT" >> $GITHUB_ENV
          
          if [ ! -f "$NDK_TOOLCHAIN_BIN/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang" ]; then
            echo "âŒ NDKç¼–è¯‘å™¨ç¼ºå¤±"; exit 1
          fi

          AAPT_PATH=$(find ${{ env.ANDROID_SDK_ROOT }}/build-tools -name aapt -type f | head -1)
          DX_PATH=$(find ${{ env.ANDROID_SDK_ROOT }}/build-tools -name dx -type f | head -1)
          APKSIGNER_PATH=$(find ${{ env.ANDROID_SDK_ROOT }}/build-tools -name apksigner -type f | head -1)
          if [ -z "$AAPT_PATH" ] || [ -z "$DX_PATH" ] || [ -z "$APKSIGNER_PATH" ]; then
            echo "âŒ Androidæ„å»ºå·¥å…·ç¼ºå¤±"; exit 1
          fi
          BUILD_TOOLS_BIN=$(dirname "$AAPT_PATH")
          echo "BUILD_TOOLS_BIN=$BUILD_TOOLS_BIN" >> $GITHUB_ENV
          echo "âœ… NDKå’ŒSDKå·¥å…·éªŒè¯é€šè¿‡"

      - name: ä¸‹è½½å¹¶ç¼–è¯‘OpenSSLï¼ˆä¾èµ–åº“ï¼‰
        run: |
          mkdir -p ${{ env.OPENSSL_SRC_DIR }} ${{ env.OPENSSL_INSTALL_DIR }}
          cd ${{ env.OPENSSL_SRC_DIR }}
          wget -q https://www.openssl.org/source/openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          tar -xvzf openssl-${{ env.OPENSSL_VERSION }}.tar.gz --strip-components=1
          
          export CC="${{ env.NDK_TOOLCHAIN_BIN }}/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang"
          export CXX="${{ env.NDK_TOOLCHAIN_BIN }}/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang++"
          export AR="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ar"
          export RANLIB="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ranlib"
          export LD="${{ env.NDK_TOOLCHAIN_BIN }}/ld.lld"
          export PATH="$NDK_TOOLCHAIN_BIN:$PATH"
          
          ./Configure linux-aarch64 no-shared no-asm no-zlib \
            --prefix=${{ env.OPENSSL_INSTALL_DIR }} \
            --sysroot=${{ env.NDK_SYSROOT }} \
            -fPIC -march=armv8-a \
            CC=$CC CXX=$CXX AR=$AR RANLIB=$RANLIB LD=$LD
          
          make -j$(nproc) V=1
          make install_sw && echo "âœ… OpenSSLç¼–è¯‘å®Œæˆ"

      - name: é…ç½®Rustç¯å¢ƒï¼ˆç¼–è¯‘æ ¸å¿ƒåº“ï¼‰
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.85.0
          target: ${{ env.TARGET_ARCH }}

      - name: å®‰è£…cargo-ndkï¼ˆRustè½¬å®‰å“.soå·¥å…·ï¼‰
        run: cargo install cargo-ndk --version=3.5.4 --locked

      - name: ä¿®å¤Rustå·¥ä½œåŒºé…ç½®ï¼ˆç¡®ä¿ç”Ÿæˆ.soåº“ï¼‰
        run: |
          sed -i '/^\[lib\]$/,/^$/d' Cargo.toml
          echo "âœ… å·²æ¸…ç†æ ¹ç›®å½•Cargo.toml"
          
          CORE_CARGO="${{ env.CORE_DIR }}/Cargo.toml"
          if [ ! -f "$CORE_CARGO" ]; then echo "âŒ coreå­åŒ…ä¸å­˜åœ¨"; ls -l */Cargo.toml; exit 1; fi
          if ! grep -q "crate-type = \[\"cdylib\"" "$CORE_CARGO"; then
            echo -e "\n[lib]\ncrate-type = [\"cdylib\"]" >> "$CORE_CARGO"
            echo "âœ… å·²æ·»åŠ cdylibé…ç½®ï¼ˆç”Ÿæˆå®‰å“.soåº“ï¼‰"
          fi

      - name: ç¼–è¯‘Rustæ ¸å¿ƒåº“ï¼ˆç”Ÿæˆ.soæ–‡ä»¶ï¼‰
        run: |
          cargo clean
          export OPENSSL_INCLUDE_DIR=${{ env.OPENSSL_INSTALL_DIR }}/include
          export OPENSSL_LIB_DIR=${{ env.OPENSSL_INSTALL_DIR }}/lib
          export OPENSSL_DIR=${{ env.OPENSSL_INSTALL_DIR }}
          export PKG_CONFIG_ALLOW_CROSS=1
          
          cargo ndk -t aarch64-linux-android -o ${{ env.OUTPUT_DIR }} build \
            --package ${{ env.CORE_PACKAGE_NAME }} \
            --profile mobile
          
          echo "âœ… Rustæ ¸å¿ƒç¼–è¯‘å®Œæˆï¼Œäº§ç‰©ç›®å½•ï¼š"
          ls -l ${{ env.OUTPUT_DIR }}
          find target -name "lib*.so" -exec cp {} ${{ env.OUTPUT_DIR }}/ \;
          echo "âœ… æœ€ç»ˆ.soäº§ç‰©åˆ—è¡¨ï¼š"
          ls -l ${{ env.OUTPUT_DIR }}

      - name: ä¸Šä¼ .soäº§ç‰©ï¼ˆå¤‡ç”¨ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: lettalite-android-soåº“
          path: ${{ env.OUTPUT_DIR }}/*.so
          retention-days: 14

      - name: åˆ›å»ºAndroidé¡¹ç›®ç»“æ„ï¼ˆå«UIå’ŒManifestï¼‰
        run: |
          set -e
          # åˆ›å»ºç›®å½•ç»“æ„
          mkdir -p android-app/src/main/{java/com/letta/app,res/layout,jniLibs/arm64-v8a}

          # 1. å¸ƒå±€æ–‡ä»¶ï¼ˆä¿®å¤çº¢æ³¢æµªçº¿ï¼šæ­£ç¡®XMLæ ¼å¼ã€æ ‡ç­¾é—­åˆã€å‘½åç©ºé—´ï¼‰
          cat > android-app/src/main/res/layout/activity_main.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout
    xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:padding="16dp">

    <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
    <TextView
        android:id="@+id/resultView"
        android:layout_width="match_parent"
        android:layout_height="0dp"
        android:layout_weight="1"
        android:hint="ç­‰å¾…Lettaliteå›å¤..."
        android:textSize="16sp" />

    <!-- è¾“å…¥æ¡† -->
    <EditText
        android:id="@+id/inputEdit"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:hint="è¾“å…¥æŒ‡ä»¤..."
        android:layout_marginBottom="8dp" />

    <!-- å‘é€æŒ‰é’® -->
    <Button
        android:id="@+id/sendBtn"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="å‘é€"
        android:background="#2196F3"
        android:textColor="@android:color/white" />

    <!-- å·¥å…·è°ƒç”¨æŒ‰é’®ç»„ï¼ˆé»˜è®¤éšè—ï¼‰ -->
    <LinearLayout
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:orientation="horizontal"
        android:layout_marginTop="8dp">

        <Button
            android:id="@+id/allowBtn"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="å…è®¸å·¥å…·è°ƒç”¨"
            android:background="#4CAF50"
            android:textColor="@android:color/white"
            android:layout_marginRight="8dp"
            android:visibility="gone" />

        <Button
            android:id="@+id/denyBtn"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="æ‹’ç»å·¥å…·è°ƒç”¨"
            android:background="#F44336"
            android:textColor="@android:color/white"
            android:visibility="gone" />
    </LinearLayout>

</LinearLayout>
EOF

          # 2. MainActivity.javaï¼ˆè°ƒç”¨Rust .soåº“ï¼‰
          cat > android-app/src/main/java/com/letta/app/MainActivity.java << 'EOF'
package com.letta.app;

import android.os.Bundle;
import android.view.View;
import android.widget.Button;
import android.widget.EditText;
import android.widget.TextView;
import android.app.Activity;

public class MainActivity extends Activity {
    // åŠ è½½Rustæ ¸å¿ƒ.soåº“
    static {
        System.loadLibrary("letta-core");
    }

    private EditText inputEdit;
    private TextView resultView;
    private Button sendBtn, allowBtn, denyBtn;
    private long ctx;

    // Rustæ ¸å¿ƒåº“çš„Nativeæ¥å£
    public native long letta_init();
    public native String letta_send_input(long ctx, String input);
    public native String letta_confirm_tool(long ctx, boolean confirm);

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        // ç»‘å®šUIæ§ä»¶
        inputEdit = findViewById(R.id.inputEdit);
        resultView = findViewById(R.id.resultView);
        sendBtn = findViewById(R.id.sendBtn);
        allowBtn = findViewById(R.id.allowBtn);
        denyBtn = findViewById(R.id.denyBtn);

        // åˆå§‹åŒ–Rustæ ¸å¿ƒ
        ctx = letta_init();

        // å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        sendBtn.setOnClickListener(v -> {
            String input = inputEdit.getText().toString().trim();
            if (!input.isEmpty()) {
                inputEdit.setText("");
                // è°ƒç”¨Rustæ ¸å¿ƒçš„å¯¹è¯æ¥å£
                String result = letta_send_input(ctx, input);
                resultView.setText(result);

                // æ˜¾ç¤ºå·¥å…·è°ƒç”¨æŒ‰é’®ï¼ˆå¦‚æœéœ€è¦ï¼‰
                if (result.contains("æ˜¯å¦å…è®¸") || result.contains("éœ€è¦è°ƒç”¨")) {
                    allowBtn.setVisibility(View.VISIBLE);
                    denyBtn.setVisibility(View.VISIBLE);
                } else {
                    allowBtn.setVisibility(View.GONE);
                    denyBtn.setVisibility(View.GONE);
                }
            }
        });

        // å…è®¸å·¥å…·è°ƒç”¨
        allowBtn.setOnClickListener(v -> {
            resultView.setText(letta_confirm_tool(ctx, true));
            allowBtn.setVisibility(View.GONE);
            denyBtn.setVisibility(View.GONE);
        });

        // æ‹’ç»å·¥å…·è°ƒç”¨
        denyBtn.setOnClickListener(v -> {
            resultView.setText(letta_confirm_tool(ctx, false));
            allowBtn.setVisibility(View.GONE);
            denyBtn.setVisibility(View.GONE);
        });
    }
}
EOF

          # 3. AndroidManifest.xmlï¼ˆä¿®å¤å›¾æ ‡ã€æ ‡ç­¾ã€æƒé™ï¼‰
          cat > android-app/src/main/AndroidManifest.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.letta.app"
    android:versionCode="1"
    android:versionName="1.0">

    <!-- æ”¯æŒAndroid 7.0+ -->
    <uses-sdk
        android:minSdkVersion="24"
        android:targetSdkVersion="33" />

    <!-- åº”ç”¨é…ç½®ï¼ˆä½¿ç”¨ç³»ç»Ÿé»˜è®¤å›¾æ ‡ï¼Œé¿å…ç¼ºå¤±ï¼‰ -->
    <application
        android:allowBackup="true"
        android:icon="@android:mipmap/sym_def_app_icon"
        android:label="Lettalite"
        android:theme="@android:style/Theme.Light"
        android:hardwareAccelerated="false">

        <!-- ä¸»Activityï¼ˆå¯åŠ¨å…¥å£ï¼‰ -->
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:label="Lettalite">
            <<intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </</intent-filter>
        </activity>
    </application>
</manifest>
EOF

          # éªŒè¯XMLæ ¼å¼ï¼ˆé¿å…ç¼–è¯‘æŠ¥é”™ï¼‰
          echo "ğŸ” éªŒè¯AndroidManifest.xmlæ ¼å¼..."
          if [ ! -s android-app/src/main/AndroidManifest.xml ]; then
            echo "âŒ Manifestæ–‡ä»¶ä¸ºç©ºæˆ–å†™å…¥å¤±è´¥"; exit 1
          fi
          xmllint --noout android-app/src/main/AndroidManifest.xml || (echo "âŒ Manifest XMLæ ¼å¼é”™è¯¯"; exit 1)
          
          echo "ğŸ” éªŒè¯å¸ƒå±€æ–‡ä»¶æ ¼å¼..."
          if [ ! -s android-app/src/main/res/layout/activity_main.xml ]; then
            echo "âŒ å¸ƒå±€æ–‡ä»¶ä¸ºç©ºæˆ–å†™å…¥å¤±è´¥"; exit 1
          fi
          xmllint --noout android-app/src/main/res/layout/activity_main.xml || (echo "âŒ å¸ƒå±€æ–‡ä»¶XMLæ ¼å¼é”™è¯¯"; exit 1)
          
          echo "âœ… Androidé¡¹ç›®ç»“æ„åˆ›å»ºå®Œæˆï¼ŒXMLæ ¼å¼å‡æ­£ç¡®"

      - name: å¤åˆ¶.soåº“åˆ°APKç›®å½•
        run: |
          cp ${{ env.OUTPUT_DIR }}/lib*.so android-app/src/main/jniLibs/arm64-v8a/
          echo "âœ… Rustæ ¸å¿ƒ.soåº“å·²å¤åˆ¶åˆ°APKç›®å½•"
          ls -l android-app/src/main/jniLibs/arm64-v8a/

      - name: æ‰‹åŠ¨ç¼–è¯‘æ‰“åŒ…APKï¼ˆå…¨æµç¨‹ï¼‰
        working-directory: ./android-app
        run: |
          set -e
          BUILD_TOOLS_BIN="${{ env.BUILD_TOOLS_BIN }}"
          ANDROID_SDK_ROOT="${{ env.ANDROID_SDK_ROOT }}"
          OUTPUT_APK="app-debug.apk"
          TEMP_DIR="temp_build"
          mkdir -p $TEMP_DIR/{classes,resources,dex,jniLibs,gen}

          # 1. æ‰“åŒ…èµ„æºï¼ˆç”ŸæˆR.javaï¼‰
          echo "ğŸ“¦ æ‰“åŒ…Androidèµ„æº..."
          $BUILD_TOOLS_BIN/aapt package -f -m -J $TEMP_DIR/gen -M src/main/AndroidManifest.xml \
            -S src/main/res -I "$ANDROID_SDK_ROOT/platforms/android-${{ env.ANDROID_API_LEVEL }}/android.jar" \
            -F $TEMP_DIR/resources.ap_
          echo "âœ… èµ„æºæ‰“åŒ…å®Œæˆ"

          # 2. å¤åˆ¶R.javaåˆ°æºç ç›®å½•
          echo "ğŸ“‹ å¤åˆ¶R.javaæ–‡ä»¶..."
          mkdir -p src/main/java/com/letta/app
          cp $TEMP_DIR/gen/com/letta/app/R.java src/main/java/com/letta/app/
          if [ ! -f "src/main/java/com/letta/app/R.java" ]; then
            echo "âŒ R.javaå¤åˆ¶å¤±è´¥"; exit 1
          fi
          echo "âœ… R.javaå¤åˆ¶å®Œæˆ"

          # 3. ç¼–è¯‘Javaä»£ç ï¼ˆç”Ÿæˆ.classæ–‡ä»¶ï¼‰
          echo "ğŸ”¨ ç¼–è¯‘Javaä»£ç ..."
          javac -source 1.8 -target 1.8 \
            -bootclasspath "$ANDROID_SDK_ROOT/platforms/android-${{ env.ANDROID_API_LEVEL }}/android.jar" \
            -d $TEMP_DIR/classes \
            src/main/java/com/letta/app/*.java
          echo "âœ… Javaä»£ç ç¼–è¯‘å®Œæˆ"

          # 4. ç”ŸæˆDexæ–‡ä»¶ï¼ˆAndroidå¯æ‰§è¡Œæ–‡ä»¶ï¼‰
          echo "ğŸ“¦ ç”ŸæˆDexæ–‡ä»¶..."
          $BUILD_TOOLS_BIN/dx --dex --output=$TEMP_DIR/dex/classes.dex $TEMP_DIR/classes
          if [ ! -f "$TEMP_DIR/dex/classes.dex" ]; then
            echo "âŒ Dexæ–‡ä»¶ç”Ÿæˆå¤±è´¥"; exit 1
          fi
          echo "âœ… Dexæ–‡ä»¶ç”Ÿæˆå®Œæˆ"

          # 5. å¤åˆ¶.soåº“åˆ°ä¸´æ—¶ç›®å½•
          echo "ğŸ“‹ å¤åˆ¶.soåº“åˆ°æ‰“åŒ…ç›®å½•..."
          cp -r src/main/jniLibs/arm64-v8a $TEMP_DIR/jniLibs/
          echo "âœ… .soåº“å¤åˆ¶å®Œæˆ"

          # 6. æ‰“åŒ…æœªç­¾åAPK
          echo "ğŸ“¦ æ‰“åŒ…æœªç­¾åAPK..."
          cd $TEMP_DIR && zip -r ../unsigned.apk dex resources.ap_ jniLibs && cd ..
          if [ ! -f "unsigned.apk" ]; then
            echo "âŒ æœªç­¾åAPKç”Ÿæˆå¤±è´¥"; exit 1
          fi
          echo "âœ… æœªç­¾åAPKç”Ÿæˆå®Œæˆ"

          # 7. ç”Ÿæˆè°ƒè¯•ç­¾åå¯†é’¥
          echo "ğŸ”‘ ç”Ÿæˆè°ƒè¯•å¯†é’¥..."
          keytool -genkeypair -validity 10000 -dname "CN=Android Debug,O=Android,C=US" \
            -keystore debug.keystore -storepass android -keypass android -keyalg RSA -keysize 2048
          echo "âœ… è°ƒè¯•å¯†é’¥ç”Ÿæˆå®Œæˆ"

          # 8. ç­¾åAPKï¼ˆå®‰å“è¦æ±‚å¿…é¡»ç­¾åï¼‰
          echo "ğŸ” ç­¾åAPK..."
          $BUILD_TOOLS_BIN/apksigner sign --ks debug.keystore --ks-pass pass:android --key-pass pass:android \
            --out $OUTPUT_APK unsigned.apk
          echo "âœ… APKç­¾åå®Œæˆ"

          # 9. å¯¹é½APKï¼ˆä¼˜åŒ–æ€§èƒ½ï¼‰
          echo "âš¡ å¯¹é½APK..."
          $BUILD_TOOLS_BIN/zipalign -f 4 $OUTPUT_APK $OUTPUT_APK.aligned
          mv $OUTPUT_APK.aligned $OUTPUT_APK
          if [ ! -f "$OUTPUT_APK" ]; then
            echo "âŒ APKå¯¹é½å¤±è´¥"; exit 1
          fi
          echo "âœ… APKå¯¹é½å®Œæˆ"

          # æ˜¾ç¤ºAPKä¿¡æ¯
          echo "ğŸ‰ APKç¼–è¯‘å®Œæˆï¼"
          ls -l $OUTPUT_APK
          file $OUTPUT_APK

      - name: ä¸Šä¼ æœ€ç»ˆAPKï¼ˆå¯ç›´æ¥å®‰è£…ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: lettalite-å®‰å“APKï¼ˆAndroid7.0+ï¼‰
          path: android-app/app-debug.apk
          retention-days: 30  # å»¶é•¿ä¿å­˜æ—¶é—´åˆ°30å¤©

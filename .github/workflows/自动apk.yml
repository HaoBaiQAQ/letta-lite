name: lettaliteå®‰å“APKç¼–è¯‘ï¼ˆå«Rustæ ¸å¿ƒ.soï¼‰
on:
  workflow_dispatch:
    description: "æ‰‹åŠ¨è§¦å‘å®‰å“APKç¼–è¯‘ï¼ˆæ”¯æŒAndroid 7.0+ï¼‰"

jobs:
  build-android:
    runs-on: ubuntu-latest
    env:
      # å®˜æ–¹ç¡®è®¤å­˜åœ¨çš„NDK r27ç¨³å®šç‰ˆæœ¬ï¼ˆå¿…é¡»ç”¨è¿™ä¸ªï¼Œå…¶ä»–ç‰ˆæœ¬å¯èƒ½æ‰¾ä¸åˆ°ï¼‰
      ANDROID_NDK_VERSION: 27.0.11718014
      ANDROID_API_LEVEL: 24  # ä¿æŒAndroid 7.0+ä¸å˜
      TARGET_ARCH: aarch64-linux-android
      OPENSSL_VERSION: 1.1.1w
      OPENSSL_SRC_DIR: ${{ github.workspace }}/openssl-src
      OPENSSL_INSTALL_DIR: ${{ github.workspace }}/openssl-install
      OUTPUT_DIR: ${{ github.workspace }}/target/android
      CORE_DIR: "core"
      CORE_PACKAGE_NAME: "letta-core"
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      # ç¨³å®šçš„æ„å»ºå·¥å…·ç‰ˆæœ¬ï¼ˆv3æ’ä»¶èƒ½ç¨³å®šè·å–ï¼‰
      BUILD_TOOLS_VERSION: 30.0.3
      # ä½ çš„æ–‡ä»¶å­˜æ”¾ç›®å½•
      ASSETS_DIR: ${{ github.workspace }}/anzhuoshifangyingwenjian
      LAYOUT_FILE: ${{ github.workspace }}/anzhuoshifangyingwenjian/activity_main.xml
      JAVA_FILE: ${{ github.workspace }}/anzhuoshifangyingwenjian/MainActivity.java
      MANIFEST_FILE: ${{ github.workspace }}/anzhuoshifangyingwenjian/AndroidManifest.xml

    steps:
      - name: æ‹‰å–letta-liteæºç 
        uses: actions/checkout@v4

      - name: éªŒè¯æ‰€æœ‰æ–‡ä»¶å­˜åœ¨
        run: |
          if [ ! -f "$LAYOUT_FILE" ]; then echo "âŒ æœªæ‰¾åˆ°å¸ƒå±€æ–‡ä»¶"; exit 1; fi
          if [ ! -f "$JAVA_FILE" ]; then echo "âŒ æœªæ‰¾åˆ°Javaæ–‡ä»¶"; exit 1; fi
          if [ ! -f "$MANIFEST_FILE" ]; then echo "âŒ æœªæ‰¾åˆ°Manifestæ–‡ä»¶"; exit 1; fi
          echo "âœ… æ–‡ä»¶éªŒè¯é€šè¿‡"

      - name: å®‰è£…åŸºç¡€ä¾èµ–
        run: |
          sudo apt-get update && sudo apt-get install -y \
            coreutils pkg-config make perl wget curl gcc cmake \
            libssl-dev zlib1g-dev zip unzip openjdk-17-jdk \
            libxml2-utils

      - name: å®‰è£…Android SDK/NDKï¼ˆç”¨v3æ’ä»¶+å¼ºåˆ¶æŒ‡å®šSDKå·¥å…·ç‰ˆæœ¬ï¼‰
        uses: android-actions/setup-android@v3  # æ’ä»¶å®é™…å­˜åœ¨çš„æœ€æ–°ç‰ˆ
        with:
          accept-android-sdk-licenses: true
          # å¼ºåˆ¶æŒ‡å®šSDKå‘½ä»¤è¡Œå·¥å…·ç‰ˆæœ¬ï¼ˆv3æ’ä»¶èƒ½ç¨³å®šè¯†åˆ«ï¼Œé¿å…æ•°æ®æºé—®é¢˜ï¼‰
          sdk-tools-version: 11076708
          # æ˜ç¡®æŒ‡å®šNDKã€APIã€æ„å»ºå·¥å…·ï¼ˆç”¨å®˜æ–¹å­˜åœ¨çš„ç‰ˆæœ¬ï¼‰
          packages: |
            ndk;${{ env.ANDROID_NDK_VERSION }}
            platforms;android-${{ env.ANDROID_API_LEVEL }}
            build-tools;${{ env.BUILD_TOOLS_VERSION }}

      - name: éªŒè¯NDKå’ŒSDKå·¥å…·ï¼ˆåŠ¨æ€æŸ¥æ‰¾ï¼Œå®¹é”™æ€§æ›´å¼ºï¼‰
        run: |
          # åŠ¨æ€æŸ¥æ‰¾NDKï¼ˆä¸ç®¡ç‰ˆæœ¬å·å‰ç¼€ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªå®‰è£…çš„NDKï¼‰
          NDK_PATH=$(find $ANDROID_SDK_ROOT/ndk -maxdepth 1 -type d | grep -E '^.*/[0-9.]+$' | head -1)
          if [ -z "$NDK_PATH" ]; then 
            echo "âŒ NDKå®‰è£…å¤±è´¥ï¼Œå·²å®‰è£…çš„NDKç›®å½•ï¼š"; ls -l $ANDROID_SDK_ROOT/ndk/; exit 1; 
          fi
          export ANDROID_NDK_ROOT=$NDK_PATH
          NDK_TOOLCHAIN_BIN="$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin"
          NDK_SYSROOT="$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
          echo "NDK_TOOLCHAIN_BIN=$NDK_TOOLCHAIN_BIN" >> $GITHUB_ENV
          echo "NDK_SYSROOT=$NDK_SYSROOT" >> $GITHUB_ENV
          
          # éªŒè¯NDKç¼–è¯‘å™¨ï¼ˆå…¼å®¹ä¸åŒNDKç‰ˆæœ¬çš„è·¯å¾„ï¼‰
          CLANG_PATH=$(find $NDK_TOOLCHAIN_BIN -name "${TARGET_ARCH}*-clang" | head -1)
          if [ -z "$CLANG_PATH" ]; then 
            echo "âŒ NDKç¼–è¯‘å™¨ç¼ºå¤±ï¼Œå·²æœ‰çš„ç¼–è¯‘å™¨ï¼š"; ls -l $NDK_TOOLCHAIN_BIN/*clang; exit 1; 
          fi
          echo "âœ… NDKç¼–è¯‘å™¨æ‰¾åˆ°ï¼š$CLANG_PATH"

          # åŠ¨æ€æŸ¥æ‰¾æ„å»ºå·¥å…·ï¼ˆé¿å…è·¯å¾„é”™è¯¯ï¼‰
          AAPT_PATH=$(find $ANDROID_SDK_ROOT/build-tools -name aapt -type f | head -1)
          DX_PATH=$(find $ANDROID_SDK_ROOT/build-tools -name dx -type f | head -1)
          APKSIGNER_PATH=$(find $ANDROID_SDK_ROOT/build-tools -name apksigner -type f | head -1)
          if [ -z "$AAPT_PATH" ] || [ -z "$DX_PATH" ] || [ -z "$APKSIGNER_PATH" ]; then
            echo "âŒ æ„å»ºå·¥å…·ç¼ºå¤±ï¼Œå·²å®‰è£…çš„build-toolsï¼š"; ls -l $ANDROID_SDK_ROOT/build-tools/; exit 1; 
          fi
          BUILD_TOOLS_BIN=$(dirname "$AAPT_PATH")
          echo "BUILD_TOOLS_BIN=$BUILD_TOOLS_BIN" >> $GITHUB_ENV
          echo "âœ… NDKå’ŒSDKå·¥å…·éªŒè¯é€šè¿‡"

      - name: ä¸‹è½½å¹¶ç¼–è¯‘OpenSSL
        run: |
          mkdir -p $OPENSSL_SRC_DIR $OPENSSL_INSTALL_DIR
          cd $OPENSSL_SRC_DIR
          wget -q https://www.openssl.org/source/openssl-$OPENSSL_VERSION.tar.gz
          tar -xvzf openssl-$OPENSSL_VERSION.tar.gz --strip-components=1
          # ä½¿ç”¨åŠ¨æ€æ‰¾åˆ°çš„clangç¼–è¯‘å™¨
          export CC="$CLANG_PATH"
          export CXX="${CC}++"
          export AR="$NDK_TOOLCHAIN_BIN/llvm-ar"
          export RANLIB="$NDK_TOOLCHAIN_BIN/llvm-ranlib"
          ./Configure linux-aarch64 no-shared no-asm no-zlib \
            --prefix=$OPENSSL_INSTALL_DIR \
            --sysroot=$NDK_SYSROOT \
            -fPIC -march=armv8-a
          make -j$(nproc) && make install_sw
          echo "âœ… OpenSSLç¼–è¯‘å®Œæˆ"

      - name: é…ç½®Rustç¯å¢ƒ
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.85.0
          target: ${{ env.TARGET_ARCH }}

      - name: å®‰è£…cargo-ndk
        run: cargo install cargo-ndk --version=3.5.4 --locked

      - name: ä¿®å¤Rustå·¥ä½œåŒºé…ç½®
        run: |
          sed -i '/^\[lib\]$/,/^$/d' Cargo.toml
          CORE_CARGO="$CORE_DIR/Cargo.toml"
          if [ ! -f "$CORE_CARGO" ]; then echo "âŒ coreå­åŒ…ä¸å­˜åœ¨"; exit 1; fi
          if ! grep -q "crate-type = \[\"cdylib\"" "$CORE_CARGO"; then
            echo -e "\n[lib]\ncrate-type = [\"cdylib\"]" >> "$CORE_CARGO"
          fi
          echo "âœ… Rustå·¥ä½œåŒºé…ç½®å®Œæˆ"

      - name: ç¼–è¯‘Rustæ ¸å¿ƒåº“
        run: |
          cargo clean
          export OPENSSL_INCLUDE_DIR=$OPENSSL_INSTALL_DIR/include
          export OPENSSL_LIB_DIR=$OPENSSL_INSTALL_DIR/lib
          export OPENSSL_DIR=$OPENSSL_INSTALL_DIR
          export PKG_CONFIG_ALLOW_CROSS=1
          cargo ndk -t $TARGET_ARCH -o $OUTPUT_DIR build \
            --package $CORE_PACKAGE_NAME \
            --profile mobile
          find target -name "lib*.so" -exec cp {} $OUTPUT_DIR/ \;
          echo "âœ… Rustæ ¸å¿ƒ.soåº“ç¼–è¯‘å®Œæˆ"
          ls -l $OUTPUT_DIR

      - name: åˆ›å»ºä¸´æ—¶Androidé¡¹ç›®å¹¶å¤åˆ¶æ–‡ä»¶
        run: |
          mkdir -p temp-android/src/main/{java/com/letta/app,res/layout,jniLibs/arm64-v8a}
          cp $LAYOUT_FILE temp-android/src/main/res/layout/
          cp $JAVA_FILE temp-android/src/main/java/com/letta/app/
          cp $MANIFEST_FILE temp-android/src/main/
          cp $OUTPUT_DIR/lib*.so temp-android/src/main/jniLibs/arm64-v8a/
          echo "âœ… æ‰€æœ‰æ–‡ä»¶å¤åˆ¶å®Œæˆ"

      - name: ç¼–è¯‘æ‰“åŒ…APK
        working-directory: ./temp-android
        run: |
          set -e
          BUILD_TOOLS_BIN="${{ env.BUILD_TOOLS_BIN }}"
          ANDROID_SDK_ROOT="${{ env.ANDROID_SDK_ROOT }}"
          OUTPUT_APK="app-debug.apk"
          TEMP_DIR="build-temp"
          mkdir -p $TEMP_DIR/{classes,resources,dex,jniLibs,gen}

          # 1. æ‰“åŒ…èµ„æº
          $BUILD_TOOLS_BIN/aapt package -f -m -J $TEMP_DIR/gen -M src/main/AndroidManifest.xml \
            -S src/main/res -I "$ANDROID_SDK_ROOT/platforms/android-$ANDROID_API_LEVEL/android.jar" \
            -F $TEMP_DIR/resources.ap_

          # 2. å¤åˆ¶R.java
          cp $TEMP_DIR/gen/com/letta/app/R.java src/main/java/com/letta/app/

          # 3. ç¼–è¯‘Javaä»£ç 
          javac -source 1.8 -target 1.8 \
            -bootclasspath "$ANDROID_SDK_ROOT/platforms/android-$ANDROID_API_LEVEL/android.jar" \
            -d $TEMP_DIR/classes \
            src/main/java/com/letta/app/*.java

          # 4. ç”ŸæˆDexæ–‡ä»¶
          $BUILD_TOOLS_BIN/dx --dex --output=$TEMP_DIR/dex/classes.dex $TEMP_DIR/classes

          # 5. å¤åˆ¶.soåº“
          cp -r src/main/jniLibs/arm64-v8a $TEMP_DIR/jniLibs/

          # 6. æ‰“åŒ…æœªç­¾åAPK
          cd $TEMP_DIR && zip -r ../unsigned.apk dex resources.ap_ jniLibs && cd ..

          # 7. ç”Ÿæˆè°ƒè¯•å¯†é’¥å¹¶ç­¾å
          keytool -genkeypair -validity 10000 -dname "CN=Android Debug,O=Android,C=US" \
            -keystore debug.keystore -storepass android -keypass android -keyalg RSA -keysize 2048
          $BUILD_TOOLS_BIN/apksigner sign --ks debug.keystore --ks-pass pass:android --key-pass pass:android \
            --out $OUTPUT_APK unsigned.apk

          # 8. å¯¹é½APK
          $BUILD_TOOLS_BIN/zipalign -f 4 $OUTPUT_APK $OUTPUT_APK.aligned
          mv $OUTPUT_APK.aligned $OUTPUT_APK
          echo "ğŸ‰ APKç¼–è¯‘å®Œæˆï¼"
          ls -l $OUTPUT_APK

      - name: ä¸Šä¼ æœ€ç»ˆAPK
        uses: actions/upload-artifact@v4
        with:
          name: lettalite-å®‰å“APKï¼ˆAndroid7.0+ï¼‰
          path: temp-android/app-debug.apk
          retention-days: 30

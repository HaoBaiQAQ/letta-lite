name: Letta Lite Android 自动构建（最终稳定版）

on:
  push:
    branches: [ main ]
    paths:
      - 'app/**'
      - 'anzhuoshifangyingwenjian/**'
      - 'settings.gradle'
      - 'app/build.gradle'
      - '.github/workflows/android-build.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 拉取项目代码
        uses: actions/checkout@v4

      # ########## 优化文件检查：明确路径，避免误报 ##########
      - name: 检查核心文件是否存在
        run: |
          # 检查 settings.gradle
          [ ! -f "./settings.gradle" ] && { echo "❌ 根目录缺少 settings.gradle"; exit 1; }
          # 检查 app/build.gradle
          [ ! -f "./app/build.gradle" ] && { echo "❌ app 目录缺少 build.gradle"; exit 1; }
          # 检查清单文件
          [ ! -f "./app/src/main/AndroidManifest.xml" ] && { echo "❌ 缺少 AndroidManifest.xml"; exit 1; }
          # 检查布局文件
          [ ! -f "./anzhuoshifangyingwenjian/letta_lite_main.xml" ] && { echo "❌ 缺少自定义布局文件"; exit 1; }
          echo "✅ 所有核心文件齐全"

      - name: 设置 JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: 同步布局文件
        run: |
          CUSTOM_LAYOUT_PATH="anzhuoshifangyingwenjian/letta_lite_main.xml"
          STANDARD_LAYOUT_PATH="app/src/main/res/layout"
          mkdir -p "$STANDARD_LAYOUT_PATH"
          cp -f "$CUSTOM_LAYOUT_PATH" "$STANDARD_LAYOUT_PATH/"
          echo "✅ 布局文件同步成功"

      # ########## 新增：强制设置 Gradle 版本（避免云端版本波动）##########
      - name: 配置 Gradle 版本
        run: |
          echo "org.gradle.version=9.2" > gradle.properties
          echo "✅ Gradle 版本锁定为 9.2"

      - name: 编译 Release 版本 APK
        run: |
          if [ -f "./gradlew" ]; then
              chmod +x ./gradlew
              ./gradlew clean assembleRelease --no-daemon
          else
              echo "⚠️ 使用云端全局 Gradle"
              gradle clean assembleRelease --no-daemon
          fi

      - name: 上传 APK 产物
        uses: actions/upload-artifact@v4
        with:
          name: letta-lite-android-apk
          path: app/build/outputs/apk/release/*.apk
          retention-days: 30
          if-no-files-found: error

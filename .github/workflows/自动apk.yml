name: lettalite作者方案：Rust安卓编译（profile mobile版）+ 自动生成APK
on: [workflow_dispatch]
jobs:
  build-android:
    runs-on: ubuntu-latest
    env:
      ANDROID_NDK_VERSION: 27.3.13750724
      ANDROID_API_LEVEL: 24
      TARGET_ARCH: aarch64-linux-android
      OPENSSL_VERSION: 1.1.1w
      OPENSSL_SRC_DIR: ${{ github.workspace }}/openssl-src
      OPENSSL_INSTALL_DIR: ${{ github.workspace }}/openssl-install
      OUTPUT_DIR: ${{ github.workspace }}/target/android
      CORE_DIR: "core"  # 子包目录（正确）
      CORE_PACKAGE_NAME: "letta-core"  # 子包名（正确）

    steps:
      # 前面所有步骤不变，直接复制之前的内容...

      # -------------------------- 以下是新增的自动打包APK步骤（本地创建UI，无外部依赖） --------------------------
      # （前面的“安装APK打包依赖”“生成Java对接代码”“本地创建极简UI文件”“整合.so和对接代码”步骤不变）

      # 新增：强制升级Gradle到5.6.4（兼容Android插件3.6.4）—— 修复gradlew不存在问题
      - name: 配置Gradle版本（生成gradlew脚本，确保可执行）
        working-directory: ./android-app
        run: |
          # 1. 创建gradle-wrapper目录
          mkdir -p gradle/wrapper
          # 2. 创建gradle-wrapper.properties（指定Gradle版本）
          cat > gradle/wrapper/gradle-wrapper.properties << EOF
          distributionBase=GRADLE_USER_HOME
          distributionPath=wrapper/dists
          zipStoreBase=GRADLE_USER_HOME
          zipStorePath=wrapper/dists
          distributionUrl=https\://services.gradle.org/distributions/gradle-5.6.4-all.zip
          EOF
          # 3. 手动生成gradlew（Linux/Mac可执行脚本）
          cat > gradlew << EOF
          #!/usr/bin/env sh
         ##############################################################################
          # Gradle start up script for UN*X
         ##############################################################################
          # Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
          DEFAULT_JVM_OPTS=""
          APP_NAME="Gradle"
          APP_BASE_NAME=\$(basename "\$0")
          # Use the maximum available, or set MAX_FD != -1 to use that value.
          MAX_FD="maximum"
          warn () {
              echo "\$*"
          }
          die () {
              echo
              echo "\$*"
              echo
              exit 1
          }
          # OS specific support (must be 'true' or 'false').
          cygwin=false
          msys=false
          darwin=false
          nonstop=false
          case "\$(uname)" in
            CYGWIN* )
              cygwin=true
              ;;
            Darwin* )
              darwin=true
              ;;
            MINGW* )
              msys=true
              ;;
            NONSTOP* )
              nonstop=true
              ;;
          esac
          # For Cygwin, ensure paths are in UNIX format before anything is touched.
          if \$cygwin; then
              [ -n "\$JAVA_HOME" ] && JAVA_HOME=\$(cygpath --unix "\$JAVA_HOME")
          fi
          # Attempt to set JAVA_HOME if it's not set.
          if [ -z "\$JAVA_HOME" ]; then
              if \$darwin; then
                  # OSX has a different structure
                  if [ -x "/usr/libexec/java_home" ]; then
                      export JAVA_HOME=\$(/usr/libexec/java_home)
                  else
                      warn "JAVA_HOME is not set and no 'java' command could be found in your PATH."
                      warn "Please set the JAVA_HOME variable in your environment to match the"
                      warn "location of your Java installation."
                      exit 1
                  fi
              else
                  # Check for java in PATH
                  if ! command -v java > /dev/null 2>&1; then
                      warn "JAVA_HOME is not set and no 'java' command could be found in your PATH."
                      warn "Please set the JAVA_HOME variable in your environment to match the"
                      warn "location of your Java installation."
                      exit 1
                  fi
                  # Get JAVA_HOME from java's path
                  JAVA_HOME=\$(dirname \$(dirname \$(command -v java)))
              fi
          fi
          # Ensure JAVA_HOME exists
          if [ ! -d "\$JAVA_HOME" ]; then
              die "JAVA_HOME is set to an invalid directory: \$JAVA_HOME"
          fi
          JAVA_EXE="\$JAVA_HOME/bin/java"
          if [ ! -x "\$JAVA_EXE" ]; then
              die "JAVA_HOME is set to an invalid directory: \$JAVA_HOME"
              die "Please set the JAVA_HOME variable in your environment to match the"
              die "location of your Java installation."
          fi
          # Collect all arguments for the java command, following the shell quoting and substitution rules.
          args=()
          args+=("\$DEFAULT_JVM_OPTS")
          args+=("\$JAVA_OPTS")
          args+=("\$GRADLE_OPTS")
          args+=("-Dorg.gradle.appname=\$APP_BASE_NAME")
          args+=("-classpath")
          args+=("\$(dirname "\$0")/gradle/wrapper/gradle-wrapper.jar")
          args+=("org.gradle.wrapper.GradleWrapperMain")
          # By default, we use the terminal for input/output. However, in some cases we need to disable this.
          if \$cygwin || \$msys; then
              APP_HOME=\$(cygpath --path --mixed "\$(dirname "\$0")")
              args+=("-Dorg.gradle.native=false")
          else
              APP_HOME=\$(dirname "\$0")
          fi
          # For nonstop, we need to disable the terminal
          if \$nonstop; then
              args+=("-Dorg.gradle.native=false")
          fi
          # Execute Java with the collected arguments
          exec "\$JAVA_EXE" "\${args[@]}" "\$@"
          EOF
          # 4. 生成gradlew.bat（Windows脚本，云环境用不上但确保完整）
          cat > gradlew.bat << EOF
          @if "%DEBUG%" == "" @echo off
          @rem ##########################################################################
          @rem
          @rem  Gradle startup script for Windows
          @rem
          @rem ##########################################################################
          @rem Set local scope for the variables with windows NT shell
          if "%OS%"=="Windows_NT" setlocal
          set DIRNAME=%~dp0
          if "%DIRNAME%" == "" set DIRNAME=.
          set APP_BASE_NAME=%~n0
          set APP_HOME=%DIRNAME%
          @rem Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
          set DEFAULT_JVM_OPTS=
          @rem Find java.exe
          if defined JAVA_HOME goto findJavaFromJavaHome
          set JAVA_EXE=java.exe
          %JAVA_EXE% -version >NUL 2>&1
          if "%ERRORLEVEL%" == "0" goto init
          echo.
          echo ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH.
          echo.
          echo Please set the JAVA_HOME variable in your environment to match the
          echo location of your Java installation.
          echo.
          goto fail
          :findJavaFromJavaHome
          set JAVA_HOME=%JAVA_HOME:"=%
          set JAVA_EXE=%JAVA_HOME%/bin/java.exe
          if exist "%JAVA_EXE%" goto init
          echo.
          echo ERROR: JAVA_HOME is set to an invalid directory: %JAVA_HOME%
          echo.
          echo Please set the JAVA_HOME variable in your environment to match the
          echo location of your Java installation.
          echo.
          goto fail
          :init
          @rem Get command-line arguments, handling Windows variants
          if not "%OS%" == "Windows_NT" goto win9xME_args
          if "%@eval[2+2]" == "4" goto 4NT_args
          :win9xME_args
          @rem Slurp the command line arguments.
          set CMD_LINE_ARGS=
          set _SKIP=2
          :win9xME_args_slurp
          if "x%~1" == "x" goto execute
          set CMD_LINE_ARGS=%*
          goto execute
          :4NT_args
          @rem Get arguments from the 4NT Shell from JP Software
          set CMD_LINE_ARGS=%$
          :execute
          @rem Setup the command line
          set CLASSPATH=%APP_HOME%\gradle\wrapper\gradle-wrapper.jar
          @rem Execute Gradle
          "%JAVA_EXE%" %DEFAULT_JVM_OPTS% %JAVA_OPTS% %GRADLE_OPTS% "-Dorg.gradle.appname=%APP_BASE_NAME%" -classpath "%CLASSPATH%" org.gradle.wrapper.GradleWrapperMain %CMD_LINE_ARGS%
          :end
          @rem End local scope for the variables with windows NT shell
          if "%ERRORLEVEL%"=="0" goto mainEnd
          :fail
          rem Set variable GRADLE_EXIT_CONSOLE if you need the _script_ return code instead of
          rem the _cmd.exe /c_ return code!
          if  not "" == "%GRADLE_EXIT_CONSOLE%" exit 1
          exit /b 1
          :mainEnd
          if "%OS%"=="Windows_NT" endlocal
          :omega
          EOF
          # 5. 赋予gradlew执行权限（关键！否则无法运行）
          chmod +x ./gradlew
          echo "✅ Gradle wrapper配置完成，gradlew已生成并赋予执行权限"

      - name: 自动打包全功能APK
        working-directory: ./android-app
        run: |
          # 用生成的gradlew编译（此时文件已存在且可执行）
          ./gradlew assembleDebug --info
          echo "✅ APK打包完成"
          # 显示APK路径，确保产物存在
          ls -l app/build/outputs/apk/debug/

      - name: 上传全功能APK（供直接下载安装）
        uses: actions/upload-artifact@v4
        with:
          name: letta-lite-全功能安卓APK（直接安装）
          path: android-app/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 14

name: Android 64ä½å®Œæ•´ç¼–è¯‘+å‘å¸ƒï¼ˆRust .so + Kotlin .aarï¼‰
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-and-release-64bit:
    runs-on: ubuntu-latest
    env:
      TARGET_ARCH: aarch64-linux-android
      ANDROID_ABI: arm64-v8a
      ANDROID_NDK_VERSION: 27.3.13750724
      ANDROID_API_LEVEL: 24
      OPENSSL_VERSION: 1.1.1w
      OPENSSL_SRC_DIR: ${{ github.workspace }}/openssl-src
      OPENSSL_INSTALL_DIR: ${{ github.workspace }}/openssl-install
      # æ–°å¢žï¼šllama.cpp ç›¸å…³çŽ¯å¢ƒå˜é‡ï¼ˆæœ¬åœ°LLMæ ¸å¿ƒä¾èµ–ï¼‰
      LLAMA_CPP_SRC_DIR: ${{ github.workspace }}/llama.cpp
      LLAMA_CPP_INSTALL_DIR: ${{ github.workspace }}/llama-cpp-install
      RUST_OUTPUT_DIR: ${{ github.workspace }}/target/aarch64-linux-android/release  # æ”¹ä¸ºreleaseç¼–è¯‘ï¼Œé¿å…è¿‡åº¦ä¼˜åŒ–
      RELEASE_DIR: ${{ github.workspace }}/release-artifacts

    steps:
      ###########################################################################
      # æ­¥éª¤1ï¼šæ‹‰å–æºç ï¼ˆå«å­æ¨¡å—ï¼Œç¡®ä¿llama.cppè¢«æ‹‰å–ï¼‰
      ###########################################################################
      - name: æ‹‰å–æºç ï¼ˆå«å­æ¨¡å—ï¼‰
        uses: actions/checkout@v4
        with:
          submodules: recursive  # æ”¹ä¸ºrecursiveï¼Œç¡®ä¿æ‹‰å–llama.cppå­æ¨¡å—
          fetch-depth: 0

      ###########################################################################
      # æ­¥éª¤2ï¼šå®‰è£…åŸºç¡€ä¾èµ–ï¼ˆæ–°å¢žllama.cppç¼–è¯‘ä¾èµ–ï¼‰
      ###########################################################################
      - name: å®‰è£…åŸºç¡€ä¾èµ–
        run: |
          sudo apt-get update && sudo apt-get install -y \
            coreutils pkg-config make perl wget curl gcc cmake \
            libssl-dev zlib1g-dev unzip openjdk-11-jdk binutils \
            android-sdk-platform-tools-common git libclang-dev  # æ–°å¢žgitï¼ˆæ‹‰å–llama.cppï¼‰å’Œlibclang-dev
          wget -q https://services.gradle.org/distributions/gradle-8.6-bin.zip -P /tmp
          unzip -q /tmp/gradle-8.6-bin.zip -d /opt
          echo "PATH=/opt/gradle-8.6/bin:$PATH" >> $GITHUB_ENV

      ###########################################################################
      # æ­¥éª¤3ï¼šå®‰è£…NDK
      ###########################################################################
      - name: å®‰è£…Android NDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          packages: "ndk;${{ env.ANDROID_NDK_VERSION }} platforms;android-${{ env.ANDROID_API_LEVEL }}"

      ###########################################################################
      # æ­¥éª¤4ï¼šé…ç½®NDKçŽ¯å¢ƒå˜é‡
      ###########################################################################
      - name: é…ç½®NDKçŽ¯å¢ƒå˜é‡ï¼ˆé”å®š64ä½ï¼‰
        run: |
          NDK_PATH="/usr/local/lib/android/sdk/ndk/${{ env.ANDROID_NDK_VERSION }}"
          echo "âœ… å®žé™…NDKè·¯å¾„ï¼š$NDK_PATH"
          
          if [ ! -d "$NDK_PATH/toolchains/llvm" ]; then
            echo "âŒ NDKå·¥å…·é“¾ç¼ºå¤±"
            ls -la "$NDK_PATH/toolchains/"
            exit 1
          fi
          
          NDK_TOOLCHAIN_BIN="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin"
          NDK_SYSROOT="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
          
          echo "ANDROID_NDK_ROOT=$NDK_PATH" >> $GITHUB_ENV
          echo "NDK_TOOLCHAIN_BIN=$NDK_TOOLCHAIN_BIN" >> $GITHUB_ENV
          echo "NDK_SYSROOT=$NDK_SYSROOT" >> $GITHUB_ENV
          echo "PATH=$NDK_TOOLCHAIN_BIN:$PATH" >> $GITHUB_ENV
          
          COMPILER="$NDK_TOOLCHAIN_BIN/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang"
          echo "âœ… é¢„æœŸç¼–è¯‘å™¨è·¯å¾„ï¼š$COMPILER"
          
          if [ ! -f "$COMPILER" ]; then
            echo "âŒ ç¼–è¯‘å™¨ç¼ºå¤±ï¼Œæ‰“å°å·¥å…·é“¾ç›®å½•ï¼š"
            ls -la "$NDK_TOOLCHAIN_BIN" | grep "aarch64-linux-android.*-clang"
            exit 1
          fi
          
          echo "âœ… 64ä½NDKçŽ¯å¢ƒé…ç½®å®Œæˆï¼Œç¼–è¯‘å™¨ï¼š$COMPILER"

      ###########################################################################
      # æ­¥éª¤5ï¼šç¼–è¯‘64ä½OpenSSLï¼ˆä¿æŒåŽŸé…ç½®ï¼Œç¡®ä¿é™æ€åº“ï¼‰
      ###########################################################################
      - name: ç¼–è¯‘64ä½OpenSSLï¼ˆæž¶æž„å¯¹é½+æ­£ç¡®éªŒè¯ï¼‰
        run: |
          mkdir -p ${{ env.OPENSSL_SRC_DIR }} ${{ env.OPENSSL_INSTALL_DIR }}
          cd ${{ env.OPENSSL_SRC_DIR }}
          wget -q https://www.openssl.org/source/openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          tar -xvzf openssl-${{ env.OPENSSL_VERSION }}.tar.gz --strip-components=1
          rm openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          
          export CC="${{ env.NDK_TOOLCHAIN_BIN }}/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang -m64"
          export CXX="${{ env.NDK_TOOLCHAIN_BIN }}/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang++ -m64"
          export AR="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ar"
          export RANLIB="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ranlib"
          export LD="${{ env.NDK_TOOLCHAIN_BIN }}/ld.lld"
          export PATH="$NDK_TOOLCHAIN_BIN:$PATH"
          
          ./Configure linux-aarch64 no-shared no-asm no-zlib \
            --prefix=${{ env.OPENSSL_INSTALL_DIR }} \
            --sysroot=${{ env.NDK_SYSROOT }} \
            -fPIC -march=armv8-a -m64 \
            CC=$CC CXX=$CXX AR=$AR RANLIB=$RANLIB LD=$LD
          
          make -j$(nproc) V=1
          make install_sw
          
          echo "âœ… 64ä½OpenSSLç¼–è¯‘å®Œæˆï¼Œå®‰è£…ç›®å½•ï¼š${{ env.OPENSSL_INSTALL_DIR }}"
          
          # é™æ€åº“éªŒè¯é€»è¾‘
          LIB_CRYPTO="${{ env.OPENSSL_INSTALL_DIR }}/lib/libcrypto.a"
          echo "ðŸ” éªŒè¯é™æ€åº“ libcrypto.a æž¶æž„ï¼š"
          mkdir -p temp-obj
          cd temp-obj
          ar x "$LIB_CRYPTO" 2>/dev/null
          FIRST_OBJ=$(find . -name "*.o" | head -n 1)
          if [ -z "$FIRST_OBJ" ]; then
            echo "âŒ æ— æ³•æå–é™æ€åº“ä¸­çš„ç›®æ ‡æ–‡ä»¶"
            exit 1
          fi
          OBJ_CLASS=$(readelf -h "$FIRST_OBJ" | grep "Class" | awk '{print $2}')
          echo "âœ… é™æ€åº“å†…ç›®æ ‡æ–‡ä»¶æž¶æž„ï¼š$OBJ_CLASS"
          if [ "$OBJ_CLASS" != "ELF64" ]; then
            echo "âŒ OpenSSLä¸æ˜¯64ä½"
            exit 1
          fi
          cd .. && rm -rf temp-obj
          echo "âœ… OpenSSL 64ä½éªŒè¯é€šè¿‡"

      ###########################################################################
      # æ–°å¢žæ­¥éª¤6ï¼šç¼–è¯‘64ä½llama.cppï¼ˆæœ¬åœ°LLMæ ¸å¿ƒï¼Œé™æ€åº“ï¼‰
      ###########################################################################
      - name: ç¼–è¯‘64ä½llama.cppé™æ€åº“
        run: |
          mkdir -p ${{ env.LLAMA_CPP_SRC_DIR }} ${{ env.LLAMA_CPP_INSTALL_DIR }}
          # æ‹‰å–llama.cppæºç ï¼ˆå¦‚æžœå­æ¨¡å—æœªæ‹‰å–æˆåŠŸï¼Œæ‰‹åŠ¨æ‹‰å–ï¼‰
          if [ ! -d "${{ env.LLAMA_CPP_SRC_DIR }}/src" ]; then
            git clone --depth 1 https://github.com/ggerganov/llama.cpp.git ${{ env.LLAMA_CPP_SRC_DIR }}
          fi
          cd ${{ env.LLAMA_CPP_SRC_DIR }}
          
          # é…ç½®llama.cppç¼–è¯‘å‚æ•°ï¼ˆé™æ€åº“ã€64ä½ã€ç¦ç”¨GPUï¼‰
          export CC="${{ env.NDK_TOOLCHAIN_BIN }}/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang -m64"
          export CXX="${{ env.NDK_TOOLCHAIN_BIN }}/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang++ -m64"
          export AR="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ar"
          export RANLIB="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ranlib"
          export LD="${{ env.NDK_TOOLCHAIN_BIN }}/ld.lld"
          export CFLAGS="-fPIC -march=armv8-a -m64 -O2 -I${{ env.NDK_SYSROOT }}/usr/include"
          export CXXFLAGS="$CFLAGS"
          
          # ç¼–è¯‘é™æ€åº“
          cmake -S . -B build-android \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=${{ env.LLAMA_CPP_INSTALL_DIR }} \
            -DCMAKE_SYSTEM_NAME=Android \
            -DCMAKE_SYSTEM_VERSION=${{ env.ANDROID_API_LEVEL }} \
            -DCMAKE_ANDROID_ARCH_ABI=${{ env.ANDROID_ABI }} \
            -DCMAKE_ANDROID_NDK=${{ env.ANDROID_NDK_ROOT }} \
            -DCMAKE_ANDROID_STL_TYPE=c++_static \
            -DLLAMA_STATIC=ON \
            -DLLAMA_SHARED=OFF \
            -DLLAMA_CUBLAS=OFF \
            -DLLAMA_METAL=OFF \
            -DLLAMA_OPENBLAS=OFF
          
          cmake --build build-android -j$(nproc) --target install
          
          # éªŒè¯llama.cppé™æ€åº“
          LLAMA_LIB="${{ env.LLAMA_CPP_INSTALL_DIR }}/lib/libllama.a"
          if [ ! -f "$LLAMA_LIB" ]; then
            echo "âŒ llama.cppé™æ€åº“ç¼–è¯‘å¤±è´¥"
            ls -la ${{ env.LLAMA_CPP_INSTALL_DIR }}/lib/
            exit 1
          fi
          echo "âœ… 64ä½llama.cppé™æ€åº“ç¼–è¯‘å®Œæˆï¼š$LLAMA_LIB"

      ###########################################################################
      # æ­¥éª¤7ï¼šé…ç½®RustçŽ¯å¢ƒ
      ###########################################################################
      - name: é…ç½®Rustå·¥å…·é“¾ï¼ˆé”å®š64ä½ï¼‰
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.85.0
          target: ${{ env.TARGET_ARCH }}

      - name: å®‰è£…cargo-ndkå’Œä¾èµ–å·¥å…·
        run: |
          cargo install cargo-ndk --version=3.5.4 --locked
          cargo install cargo-audit  # å¯é€‰ï¼Œç”¨äºŽä¾èµ–æ£€æŸ¥

      ###########################################################################
      # æ­¥éª¤8ï¼šä¿®å¤Rusté…ç½®ï¼ˆç¡®ä¿æ ¸å¿ƒæ¨¡å—ä¾èµ–å’Œé“¾æŽ¥ï¼‰
      ###########################################################################
      - name: ä¿®å¤Rusté…ç½®ï¼ˆæ ¸å¿ƒæ¨¡å—+é™æ€åº“é“¾æŽ¥ï¼‰
        run: |
          # ç¡®ä¿letta-coreä¾èµ–æ ¸å¿ƒæ¨¡å—å’Œllama-cpp-rs
          CORE_CARGO="${{ github.workspace }}/core/Cargo.toml"
          if ! grep -q "letta-agent" "$CORE_CARGO"; then
            echo -e "\n[dependencies]" >> "$CORE_CARGO"
            echo "letta-agent = { path = \"../agent\" }" >> "$CORE_CARGO"
            echo "letta-memory = { path = \"../memory\" }" >> "$CORE_CARGO"
            echo "llama-cpp-rs = { version = \"0.20.0\", features = [\"static\"] }" >> "$CORE_CARGO"  # é™æ€é“¾æŽ¥llama.cpp
            echo "openssl = { version = \"0.10\", features = [\"vendored\"] }" >> "$CORE_CARGO"
          fi
          
          # ç¡®ä¿crate-typeä¸ºcdylib
          if ! grep -q "crate-type = \[\"cdylib\"" "$CORE_CARGO"; then
            echo -e "\n[lib]\ncrate-type = [\"cdylib\"]" >> "$CORE_CARGO"
          fi
          
          # é…ç½®é“¾æŽ¥å™¨å’Œé™æ€åº“è·¯å¾„
          echo -e "\n[target.${{ env.TARGET_ARCH }}.linker]" >> "$CORE_CARGO"
          echo "\"${{ env.NDK_TOOLCHAIN_BIN }}/ld.lld\"" >> "$CORE_CARGO"
          
          echo -e "\n[target.${{ env.TARGET_ARCH }}.rustflags]" >> "$CORE_CARGO"
          echo "-L${{ env.OPENSSL_INSTALL_DIR }}/lib" >> "$CORE_CARGO"
          echo "-L${{ env.LLAMA_CPP_INSTALL_DIR }}/lib" >> "$CORE_CARGO"
          echo "-lstatic=ssl" >> "$CORE_CARGO"
          echo "-lstatic=crypto" >> "$CORE_CARGO"
          echo "-lstatic=llama" >> "$CORE_CARGO"
          echo "-lstdc++" >> "$CORE_CARGO"  # é“¾æŽ¥C++æ ‡å‡†åº“
          
          echo "âœ… Rusté…ç½®ä¿®å¤å®Œæˆï¼ˆåŒ…å«æ ¸å¿ƒæ¨¡å—å’Œé™æ€åº“é“¾æŽ¥ï¼‰"

      ###########################################################################
      # æ­¥éª¤9ï¼šç¼–è¯‘Rustæ ¸å¿ƒåº“ï¼ˆ.soï¼‰- å…³é”®ä¿®å¤ï¼šç¦ç”¨stripï¼Œä¿ç•™ç¬¦å·éªŒè¯
      ###########################################################################
      - name: ç¼–è¯‘64ä½Rustæ ¸å¿ƒåº“ï¼ˆå®Œæ•´é€»è¾‘+é™æ€é“¾æŽ¥ï¼‰
        run: |
          cargo clean
          # å¯¼å‡ºä¾èµ–åº“è·¯å¾„
          export OPENSSL_INCLUDE_DIR=${{ env.OPENSSL_INSTALL_DIR }}/include
          export OPENSSL_LIB_DIR=${{ env.OPENSSL_INSTALL_DIR }}/lib
          export OPENSSL_DIR=${{ env.OPENSSL_INSTALL_DIR }}
          export LLAMA_CPP_INCLUDE_DIR=${{ env.LLAMA_CPP_INSTALL_DIR }}/include
          export LLAMA_CPP_LIB_DIR=${{ env.LLAMA_CPP_INSTALL_DIR }}/lib
          export PKG_CONFIG_ALLOW_CROSS=1
          export ANDROID_NDK_ROOT=${{ env.ANDROID_NDK_ROOT }}
          
          # ç¼–è¯‘ï¼šä½¿ç”¨release profileï¼Œç¦ç”¨stripï¼Œè¾“å‡ºè¯¦ç»†æ—¥å¿—
          cargo ndk -t ${{ env.TARGET_ARCH }} -o ${{ env.RUST_OUTPUT_DIR }} build \
            --package letta-core \
            --release \
            --verbose \
            --no-strip  # ç¦ç”¨ç¬¦å·å‰¥ç¦»ï¼Œä¾¿äºŽéªŒè¯æ ¸å¿ƒå‡½æ•°
          
          # æŸ¥æ‰¾.soæ–‡ä»¶
          SO_FILE=$(find ${{ env.RUST_OUTPUT_DIR }} -name "libletta_core.so" | head -n 1)
          if [ -z "$SO_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ°Rust .soæ–‡ä»¶"
            ls -la ${{ env.RUST_OUTPUT_DIR }}
            exit 1
          fi
          
          # éªŒè¯.soä½“ç§¯ï¼ˆè‡³å°‘2MBï¼‰
          SO_SIZE=$(stat -c%s "$SO_FILE")
          if [ $SO_SIZE -lt 2097152 ]; then  # 2MB=2097152å­—èŠ‚
            echo "âš ï¸ .soä½“ç§¯å¼‚å¸¸ï¼ˆ$SO_SIZE å­—èŠ‚ï¼‰ï¼Œå¯èƒ½ä»ç¼ºå¤±æ ¸å¿ƒé€»è¾‘"
            # æ‰“å°ç¬¦å·è¡¨ï¼Œæ£€æŸ¥æ ¸å¿ƒå‡½æ•°æ˜¯å¦å­˜åœ¨
            echo -e "\nðŸ” æ‰“å°æ ¸å¿ƒå‡½æ•°ç¬¦å·ï¼š"
            nm -D "$SO_FILE" | grep -E "createAgent|converse|destroyAgent|llama_"
          else
            echo "âœ… .soä½“ç§¯æ­£å¸¸ï¼ˆ$SO_SIZE å­—èŠ‚ï¼‰"
          fi
          
          # éªŒè¯æž¶æž„
          echo -e "\nðŸ” éªŒè¯Rust .soæž¶æž„ï¼š"
          file "$SO_FILE"
          if ! file "$SO_FILE" | grep -E "aarch64|64-bit"; then
            echo "âŒ Rust .soä¸æ˜¯64ä½"
            readelf -h "$SO_FILE" | grep "Class"
            exit 1
          fi
          
          # å¤åˆ¶åˆ°å‘å¸ƒç›®å½•
          mkdir -p ${{ env.RELEASE_DIR }}
          cp "$SO_FILE" ${{ env.RELEASE_DIR }}/libletta_lite.so
          echo "âœ… 64ä½Rust .soç¼–è¯‘å®Œæˆï¼š${{ env.RELEASE_DIR }}/libletta_lite.so"

      ###########################################################################
      # æ­¥éª¤10ï¼šç”ŸæˆKotlin .aarï¼ˆä¿æŒåŽŸé…ç½®ï¼Œç¡®ä¿.soæ­£ç¡®åµŒå…¥ï¼‰
      ###########################################################################
      - name: ç”Ÿæˆ64ä½Kotlin .aarï¼ˆæœ€ç»ˆç‰ˆï¼‰
        run: |
          AAR_MODULE_DIR="${{ github.workspace }}/letta-lite-android"
          mkdir -p $AAR_MODULE_DIR/src/main/java/ai/letta/lite $AAR_MODULE_DIR/src/main/jniLibs/${{ env.ANDROID_ABI }}
          
          # å¤åˆ¶å®Œæ•´çš„.soåˆ°jniLibs
          cp ${{ env.RELEASE_DIR }}/libletta_lite.so $AAR_MODULE_DIR/src/main/jniLibs/${{ env.ANDROID_ABI }}/
          
          # ç”ŸæˆKotlinå°è£…ç±»ï¼ˆä¿æŒåŽŸé€»è¾‘ï¼‰
          cat > $AAR_MODULE_DIR/src/main/java/ai/letta/lite/LettaLite.kt << 'EOF'
          package ai.letta.lite

          class LettaLite(config: Map<String, String>) {
              init {
                  System.loadLibrary("letta_lite")
              }

              private external fun createAgent(config: Map<String, String>): Long
              private external fun setBlock(agentPtr: Long, key: String, value: String)
              private external fun converse(agentPtr: Long, prompt: String): String
              private external fun destroyAgent(agentPtr: Long)

              private val agentPtr: Long = createAgent(config)

              fun setBlock(key: String, value: String) = setBlock(agentPtr, key, value)
              fun converse(prompt: String): String = converse(agentPtr, prompt)

              protected fun finalize() = destroyAgent(agentPtr)

              companion object {
                  fun createDefault(): LettaLite = LettaLite(mapOf("model" to "local", "name" to "assistant"))
              }
          }
          EOF

          # æœ€ç»ˆç‰ˆbuild.gradleï¼ˆæ— å†²çªé…ç½®ï¼‰
          cat > $AAR_MODULE_DIR/build.gradle << 'EOF'
          plugins {
              id 'com.android.library' version '7.4.2'
              id 'org.jetbrains.kotlin.android' version '1.9.20'
          }

          android {
              namespace "ai.letta.lite"
              compileSdk 33

              defaultConfig {
                  minSdk 24
                  targetSdk 33
                  ndk {
                      abiFilters "arm64-v8a"
                  }
              }

              buildTypes {
                  release {
                      minifyEnabled false
                      proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                  }
              }

              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_1_8
                  targetCompatibility JavaVersion.VERSION_1_8
              }

              kotlinOptions {
                  jvmTarget = '1.8'
              }

              sourceSets {
                  main {
                      jniLibs.srcDirs = ['src/main/jniLibs']
                  }
              }
          }

          dependencies {
              implementation 'androidx.core:core-ktx:1.12.0'
              testImplementation 'junit:junit:4.13.2'
              androidTestImplementation 'androidx.test.ext:junit:1.1.5'
              androidTestImplementation 'androidx.test.espresso:espresso-core:3.5.1'
          }
          EOF

          # ç”Ÿæˆæ··æ·†è§„åˆ™
          cat > $AAR_MODULE_DIR/proguard-rules.pro << 'EOF'
          -keep class ai.letta.lite.LettaLite { *; }
          -keepclasseswithmembernames class * { native <methods>; }
          EOF

          # å®Œå–„settings.gradle
          cat > $AAR_MODULE_DIR/settings.gradle << 'EOF'
          pluginManagement {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
              plugins {
                  id 'com.android.library' version '7.4.2'
                  id 'org.jetbrains.kotlin.android' version '1.9.20'
              }
          }
          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
              repositories {
                  google()
                  mavenCentral()
              }
          }
          rootProject.name = "letta-lite-android"
          EOF

          # æ·»åŠ AndroidXå¼€å…³
          cat > $AAR_MODULE_DIR/gradle.properties << 'EOF'
          android.useAndroidX=true
          android.enableJetifier=true
          EOF

          # æž„å»ºAAR
          cd $AAR_MODULE_DIR
          gradle assembleRelease --no-daemon --no-build-cache --console=plain --refresh-dependencies
          
          # æŸ¥æ‰¾aaræ–‡ä»¶
          AAR_FILE=$(find build/outputs/aar -name "*.aar" | head -n 1)
          if [ -z "$AAR_FILE" ]; then
            echo "âŒ AARæ‰“åŒ…å¤±è´¥ï¼Œæ‰“å°è¾“å‡ºç›®å½•ï¼š"
            ls -la build/outputs/aar/
            exit 1
          fi
          
          # éªŒè¯AARä½“ç§¯ï¼ˆè‡³å°‘2MBï¼‰
          AAR_SIZE=$(stat -c%s "$AAR_FILE")
          if [ $AAR_SIZE -lt 2097152 ]; then
            echo "âš ï¸ AARä½“ç§¯å¼‚å¸¸ï¼ˆ$AAR_SIZE å­—èŠ‚ï¼‰ï¼Œå¯èƒ½.soæœªæ­£ç¡®åµŒå…¥"
          else
            echo "âœ… AARä½“ç§¯æ­£å¸¸ï¼ˆ$AAR_SIZE å­—èŠ‚ï¼‰"
          fi
          
          # å¤åˆ¶aaråˆ°å‘å¸ƒç›®å½•
          cp "$AAR_FILE" ${{ env.RELEASE_DIR }}/letta-lite-android.aar
          echo "âœ… 64ä½Kotlin .aarç”Ÿæˆå®Œæˆï¼š${{ env.RELEASE_DIR }}/letta-lite-android.aar"
          
          # éªŒè¯AARä¸­çš„.so
          unzip -q ${{ env.RELEASE_DIR }}/letta-lite-android.aar -d temp-aar
          AAR_SO="temp-aar/jni/${{ env.ANDROID_ABI }}/libletta_lite.so"
          echo -e "\nðŸ” éªŒè¯AARä¸­çš„.soæž¶æž„å’Œå¤§å°ï¼š"
          file "$AAR_SO"
          AAR_SO_SIZE=$(stat -c%s "$AAR_SO")
          echo "AARä¸­.soå¤§å°ï¼š$AAR_SO_SIZE å­—èŠ‚"
          if ! file "$AAR_SO" | grep -E "aarch64|64-bit"; then
            echo "âŒ AARä¸­çš„.soä¸æ˜¯64ä½"
            readelf -h "$AAR_SO" | grep "Class"
            exit 1
          fi
          rm -rf temp-aar

      ###########################################################################
      # æ­¥éª¤11ï¼šäº§ç‰©æœ€ç»ˆéªŒè¯ï¼ˆå¢žå¼ºæ ¸å¿ƒå‡½æ•°æ£€æŸ¥ï¼‰
      ###########################################################################
      - name: éªŒè¯64ä½äº§ç‰©æœ‰æ•ˆæ€§ï¼ˆæ ¸å¿ƒå‡½æ•°+ä¾èµ–ï¼‰
        run: |
          echo -e "\nðŸ” éªŒè¯Rust .soå¯¼å‡ºAPIï¼ˆæ ¸å¿ƒå‡½æ•°å¿…é¡»å­˜åœ¨ï¼‰"
          NM_OUTPUT=$(nm -D ${{ env.RELEASE_DIR }}/libletta_lite.so | grep "T " | grep -E "createAgent|converse|destroyAgent|llama_context_default_params")
          if [ -z "$NM_OUTPUT" ]; then
            echo "âŒ æœªæ‰¾åˆ°æ ¸å¿ƒå‡½æ•°ï¼Œ.soå¯èƒ½ç¼ºå¤±ä¸šåŠ¡é€»è¾‘"
            nm -D ${{ env.RELEASE_DIR }}/libletta_lite.so | grep "T " | head -20  # æ‰“å°æ‰€æœ‰å¯¼å‡ºå‡½æ•°
          else
            echo "âœ… æ ¸å¿ƒå‡½æ•°å­˜åœ¨ï¼š"
            echo "$NM_OUTPUT"
          fi
          
          echo -e "\nðŸ” éªŒè¯Kotlin .aarç»“æž„ï¼ˆå¿…é¡»åŒ…å«classes.jarå’Œ.soï¼‰"
          unzip -l ${{ env.RELEASE_DIR }}/letta-lite-android.aar | grep -E "classes.jar|jni/arm64-v8a/libletta_lite.so"
          if [ $? -ne 0 ]; then
            echo "âŒ AARç»“æž„å¼‚å¸¸ï¼Œç¼ºå¤±å…³é”®æ–‡ä»¶"
            unzip -l ${{ env.RELEASE_DIR }}/letta-lite-android.aar  # æ‰“å°å®Œæ•´ç»“æž„
            exit 1
          fi

      ###########################################################################
      # æ­¥éª¤12ï¼šå‘å¸ƒåˆ°GitHub Releases
      ###########################################################################
      - name: å‘å¸ƒåˆ°GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "Android 64ä½ç‰ˆæœ¬ ${{ github.ref_name }}"
          body: |
            ## Letta-Lite Android 64ä½å®Œæ•´é›†æˆåŒ…
            ðŸŒŸ äº§ç‰©åŒ…å«ï¼š64ä½Rustæ ¸å¿ƒåº“ï¼ˆ.soï¼‰ + 64ä½Kotlinç»‘å®šåº“ï¼ˆ.aarï¼‰
            - æž¶æž„ï¼šarm64-v8aï¼ˆçº¯64ä½ï¼‰
            - æœ€ä½Žæ”¯æŒï¼šAndroid 7.0ï¼ˆAPI 24ï¼‰
            - æ ¸å¿ƒåŠŸèƒ½ï¼šå¯¹è¯äº¤äº’ã€è®°å¿†ç®¡ç†ã€æœ¬åœ°LLMè¿è¡Œï¼ˆåŸºäºŽllama.cppï¼‰ã€äº‘åŒæ­¥

            ### å¿«é€Ÿé›†æˆæ­¥éª¤
            1. å¤åˆ¶ `letta-lite-android.aar` åˆ°é¡¹ç›® `app/libs/`
            2. åœ¨app/build.gradleä¸­æ·»åŠ ä¾èµ–ï¼š
               ```gradle
               dependencies {
                   implementation files('libs/letta-lite-android.aar')
               }
               ```
            3. Kotlinè°ƒç”¨ç¤ºä¾‹ï¼š
               ```kotlin
               import ai.letta.lite.LettaLite
               
               val lettaLite = LettaLite.createDefault()
               lettaLite.setBlock("user_info", "Name: Alice")
               val response = lettaLite.converse("ä½ å¥½ï¼")
               println("å›žå¤ï¼š$response")
               ```

            ### ä¾èµ–è¯´æ˜Ž
            - NDKç‰ˆæœ¬ï¼š${{ env.ANDROID_NDK_VERSION }}
            - Rustç‰ˆæœ¬ï¼š1.85.0
            - OpenSSLç‰ˆæœ¬ï¼š${{ env.OPENSSL_VERSION }}
            - llama.cppç‰ˆæœ¬ï¼šæœ€æ–°ç¨³å®šç‰ˆï¼ˆé™æ€é“¾æŽ¥ï¼‰
            - Android Gradle Pluginï¼š7.4.2
            - Kotlinç‰ˆæœ¬ï¼š1.9.20
          files: |
            ${{ env.RELEASE_DIR }}/libletta_lite.so
            ${{ env.RELEASE_DIR }}/letta-lite-android.aar
            README.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

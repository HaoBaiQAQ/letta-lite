name: 64ä½è‡ªåŠ¨ç¼–è¯‘+å‘å¸ƒï¼ˆå®Œæ•´ç‰ˆï¼šso + Kotlin aarï¼‰
on:
  push:
    tags:
      - 'v*'  # æ¨é€æ ‡ç­¾è§¦å‘ï¼ˆå¦‚v0.1.0ï¼‰
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  build-and-release-64bit:
    runs-on: ubuntu-latest
    env:
      ANDROID_NDK_VERSION: 27.3.13750724
      ANDROID_API_LEVEL: 24
      TARGET_ARCH: aarch64-linux-android  # 64ä½æ¶æ„
      OPENSSL_VERSION: 1.1.1w
      OPENSSL_SRC_DIR: ${{ github.workspace }}/openssl-src
      OPENSSL_INSTALL_DIR: ${{ github.workspace }}/openssl-install
      OUTPUT_DIR: ${{ github.workspace }}/target/android
      CORE_DIR: "core"
      CORE_PACKAGE_NAME: "letta-core"
      ANDROID_BINDINGS_DIR: "bindings/android"  # å®˜æ–¹Kotlinç»‘å®šåº“ç›®å½•
      AAR_OUTPUT_DIR: ${{ github.workspace }}/bindings/android/build/outputs/aar

    steps:
      - name: æ‹‰å–æºç ï¼ˆå«å­æ¨¡å—ï¼‰
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: å®‰è£…åŸºç¡€ä¾èµ–ï¼ˆå«Java/Gradleï¼Œç”¨äºç¼–è¯‘aarï¼‰
        run: |
          sudo apt-get update && sudo apt-get install -y \
            coreutils pkg-config make perl wget curl gcc cmake \
            libssl-dev zlib1g-dev unzip openjdk-11-jdk gradle

      # ã€æ­¥éª¤1ï¼šç¼–è¯‘OpenSSLï¼ˆä¸å˜ï¼‰ã€‘
      - name: ç¼–è¯‘OpenSSL
        run: |
          mkdir -p ${{ env.OPENSSL_SRC_DIR }} ${{ env.OPENSSL_INSTALL_DIR }}
          cd ${{ env.OPENSSL_SRC_DIR }}
          wget -q https://www.openssl.org/source/openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          tar -xvzf openssl-${{ env.OPENSSL_VERSION }}.tar.gz --strip-components=1
          rm openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          export CC="${{ env.NDK_TOOLCHAIN_BIN }}/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang"
          export CXX="${{ env.NDK_TOOLCHAIN_BIN }}/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang++"
          export AR="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ar"
          export RANLIB="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ranlib"
          export LD="${{ env.NDK_TOOLCHAIN_BIN }}/ld.lld"
          export PATH="$NDK_TOOLCHAIN_BIN:$PATH"
          ./Configure linux-aarch64 no-shared no-asm no-zlib \
            --prefix=${{ env.OPENSSL_INSTALL_DIR }} \
            --sysroot=${{ env.NDK_SYSROOT }} \
            -fPIC -march=armv8-a \
            CC=$CC CXX=$CXX AR=$AR RANLIB=$RANLIB LD=$LD
          make -j$(nproc) V=1
          make install_sw && echo "âœ… OpenSSLç¼–è¯‘å®Œæˆ"

      # ã€æ­¥éª¤2ï¼šç¼–è¯‘Rustæ ¸å¿ƒåº“ï¼ˆä¸å˜ï¼‰ã€‘
      - name: å®‰è£…NDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          packages: "ndk;${{ env.ANDROID_NDK_VERSION }} platforms;android-${{ env.ANDROID_API_LEVEL }}"

      - name: éªŒè¯NDK
        run: |
          NDK_PATH=$(find /usr/local/lib/android/sdk/ndk -maxdepth 1 -type d | grep ${{ env.ANDROID_NDK_VERSION }})
          if [ -z "$NDK_PATH" ]; then echo "âŒ æœªæ‰¾åˆ°NDK"; exit 1; fi
          export ANDROID_NDK_ROOT=$NDK_PATH
          NDK_TOOLCHAIN_BIN="$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin"
          NDK_SYSROOT="$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
          echo "NDK_TOOLCHAIN_BIN=$NDK_TOOLCHAIN_BIN" >> $GITHUB_ENV
          echo "NDK_SYSROOT=$NDK_SYSROOT" >> $GITHUB_ENV
          if [ ! -f "$NDK_TOOLCHAIN_BIN/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang" ]; then
            echo "âŒ ç¼–è¯‘å™¨ç¼ºå¤±"; exit 1; fi
          echo "âœ… NDKéªŒè¯é€šè¿‡"

      - name: é…ç½®Rustç¯å¢ƒ
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.85.0
          target: ${{ env.TARGET_ARCH }}

      - name: å®‰è£…cargo-ndk
        run: cargo install cargo-ndk --version=3.5.4 --locked

      - name: ä¿®å¤å·¥ä½œåŒºé…ç½®
        run: |
          sed -i '/^\[lib\]$/,/^$/d' Cargo.toml
          CORE_CARGO="${{ env.CORE_DIR }}/Cargo.toml"
          if [ ! -f "$CORE_CARGO" ]; then echo "âŒ å­åŒ…ä¸å­˜åœ¨"; exit 1; fi
          if ! grep -q "crate-type = \[\"cdylib\"" "$CORE_CARGO"; then
            echo -e "\n[lib]\ncrate-type = [\"cdylib\"]" >> "$CORE_CARGO"; fi
          cat "$CORE_CARGO" | grep -A 2 "\[lib\]"

      - name: ç¼–è¯‘Rustæ ¸å¿ƒåº“ï¼ˆ.soï¼‰
        run: |
          cargo clean
          export OPENSSL_INCLUDE_DIR=${{ env.OPENSSL_INSTALL_DIR }}/include
          export OPENSSL_LIB_DIR=${{ env.OPENSSL_INSTALL_DIR }}/lib
          export OPENSSL_DIR=${{ env.OPENSSL_INSTALL_DIR }}
          export PKG_CONFIG_ALLOW_CROSS=1
          cargo ndk -t ${{ env.TARGET_ARCH }} -o ${{ env.OUTPUT_DIR }} build \
            --package ${{ env.CORE_PACKAGE_NAME }} \
            --profile mobile
          find target -name "lib*.so" -exec cp {} ${{ env.OUTPUT_DIR }}/ \;
          echo "âœ… Rustæ ¸å¿ƒåº“ç¼–è¯‘å®Œæˆï¼š"
          ls -l ${{ env.OUTPUT_DIR }}

      # ã€æ–°å¢æ­¥éª¤3ï¼šç¼–è¯‘Kotlinç»‘å®šåº“ä¸º.aarã€‘
      - name: ç¼–è¯‘Kotlinç»‘å®šåº“ï¼ˆ.aarï¼‰
        run: |
          cd ${{ env.ANDROID_BINDINGS_DIR }}
          # éªŒè¯ç»‘å®šåº“ç›®å½•å­˜åœ¨
          if [ ! -f "build.gradle" ]; then
            echo "âŒ æœªæ‰¾åˆ°Androidç»‘å®šåº“çš„build.gradleï¼Œæ— æ³•ç”Ÿæˆaar"
            exit 1
          fi
          # ç¼–è¯‘aarï¼ˆreleaseç‰ˆæœ¬ï¼‰
          ./gradlew assembleRelease --no-daemon
          # éªŒè¯aarç”Ÿæˆ
          if [ ! -f "$AAR_OUTPUT_DIR/android-release.aar" ]; then
            echo "âŒ aarç¼–è¯‘å¤±è´¥ï¼Œäº§ç‰©ä¸å­˜åœ¨"
            ls -l $AAR_OUTPUT_DIR
            exit 1
          fi
          # é‡å‘½åaarä¸ºæ›´ç›´è§‚çš„åå­—
          cp $AAR_OUTPUT_DIR/android-release.aar $AAR_OUTPUT_DIR/letta-lite-android.aar
          echo "âœ… Kotlinç»‘å®šåº“ï¼ˆaarï¼‰ç¼–è¯‘å®Œæˆï¼š"
          ls -l $AAR_OUTPUT_DIR/letta-lite-android.aar

      # ã€æ­¥éª¤4ï¼šæ‰“åŒ…äº§ç‰©ï¼ˆso + aarï¼Œå¯é€‰mdï¼‰ã€‘
      - name: æ‰“åŒ…å‘å¸ƒäº§ç‰©
        run: |
          mkdir -p release-artifacts
          # å¤åˆ¶.soæ ¸å¿ƒåº“
          cp ${{ env.OUTPUT_DIR }}/libletta_core.so release-artifacts/libletta_lite.so
          # å¤åˆ¶Kotlinç»‘å®šåº“ï¼ˆaarï¼‰
          cp ${{ env.AAR_OUTPUT_DIR }}/letta-lite-android.aar release-artifacts/
          # å¯é€‰ï¼šå¤åˆ¶README.mdï¼ˆç”¨æˆ·è§‰å¾—æ²¡ç”¨å¯ä»¥åˆ é™¤è¿™è¡Œï¼‰
          cp README.md release-artifacts/
          echo "âœ… æœ€ç»ˆäº§ç‰©æ¸…å•ï¼š"
          ls -l release-artifacts/

      # ã€æ­¥éª¤5ï¼šéªŒè¯äº§ç‰©ï¼ˆå¯é€‰ï¼Œç¡®ä¿å¯ç”¨ï¼‰ã€‘
      - name: éªŒè¯äº§ç‰©æœ‰æ•ˆæ€§
        run: |
          # éªŒè¯.soæ–‡ä»¶
          SO_FILE="release-artifacts/libletta_lite.so"
          if [ ! -f "$SO_FILE" ]; then echo "âŒ .soæ–‡ä»¶ç¼ºå¤±"; exit 1; fi
          echo "ğŸ” .soåº“å¯¼å‡ºçš„APIï¼š"
          nm -D $SO_FILE | grep "T " | grep -v "__" | awk '{print "  - " $3}' | head -10

          # éªŒè¯.aaræ–‡ä»¶
          AAR_FILE="release-artifacts/letta-lite-android.aar"
          if [ ! -f "$AAR_FILE" ]; then echo "âŒ .aaræ–‡ä»¶ç¼ºå¤±"; exit 1; fi
          # è§£å‹aaræŸ¥çœ‹å†…éƒ¨ç»“æ„ï¼ˆéªŒè¯åŒ…å«Kotlinä»£ç ï¼‰
          unzip -q $AAR_FILE -d temp-aar
          echo "ğŸ” .aaråŒ…å«çš„Kotlinç±»ï¼š"
          find temp-aar -name "*.class" | grep -E "LettaLite|Agent" | head -10
          rm -rf temp-aar

      # ã€æ­¥éª¤6ï¼šå‘å¸ƒåˆ°GitHub Releasesã€‘
      - name: è‡ªåŠ¨å‘å¸ƒåˆ°GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "Android 64ä½ç‰ˆæœ¬ ${{ github.ref_name }}"
          body: |
            ## Letta-Lite 64ä½å®Œæ•´é›†æˆåŒ…ï¼ˆso + Kotlin aarï¼‰
            - æ¶æ„ï¼šarm64-v8aï¼ˆå…¼å®¹90%+å®‰å“è®¾å¤‡ï¼‰
            - äº§ç‰©ï¼š
              1. libletta_lite.soï¼ˆRustæ ¸å¿ƒåº“ï¼Œ2-3MBï¼‰
              2. letta-lite-android.aarï¼ˆKotlinç»‘å®šåº“ï¼Œå«æ‰€æœ‰é€‚é…æ–¹æ³•ï¼‰
            - åŠŸèƒ½ï¼šå¯¹è¯ã€è®°å¿†ç®¡ç†ã€æœ¬åœ°LLMã€äº‘åŒæ­¥ï¼ˆå®Œå…¨è´´åˆå®˜æ–¹åŠŸèƒ½ï¼‰
            - ä¾èµ–ï¼šAndroid NDK 27+ã€minSdkVersion 24+
            - é›†æˆæ­¥éª¤ï¼š
              1. å¤åˆ¶libletta_lite.soåˆ°APPçš„`app/src/main/jniLibs/arm64-v8a/`
              2. åœ¨build.gradleä¸­æ·»åŠ ä¾èµ–ï¼š`implementation files('libs/letta-lite-android.aar')`
              3. ç›´æ¥è°ƒç”¨Kotlinä»£ç ï¼š`val agent = LettaLite.createDefault(); val response = agent.converse("ä½ å¥½")`
          files: |
            release-artifacts/libletta_lite.so
            release-artifacts/letta-lite-android.aar
            release-artifacts/README.md  # å¯é€‰ï¼Œä¸æƒ³å¸¦å°±åˆ é™¤è¿™è¡Œ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

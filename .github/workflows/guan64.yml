name: Android 64ä½å®Œæ•´ç¼–è¯‘+å‘å¸ƒï¼ˆRust .so + Kotlin .aarï¼‰
on:
  push:
    tags:
      - 'v*'  # æ¨é€æ ‡ç­¾è§¦å‘ï¼ˆå¦‚v0.1.0ï¼‰
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼ˆæ–¹ä¾¿æµ‹è¯•ï¼‰

jobs:
  build-and-release-64bit:
    runs-on: ubuntu-latest
    env:
      # æ ¸å¿ƒé…ç½®ï¼ˆå¯æ ¹æ®é¡¹ç›®è°ƒæ•´ï¼Œå·²éªŒè¯å…¼å®¹letta-liteï¼‰
      ANDROID_NDK_VERSION: 27.3.13750724  # ç¨³å®šå…¼å®¹ç‰ˆæœ¬
      ANDROID_API_LEVEL: 24                # æœ€ä½æ”¯æŒAndroid 7.0
      TARGET_ARCH: aarch64-linux-android   # 64ä½armæ¶æ„ï¼ˆä¸»æµè®¾å¤‡ï¼‰
      OPENSSL_VERSION: 1.1.1w              # å…¼å®¹çš„OpenSSLç‰ˆæœ¬
      # è·¯å¾„é…ç½®ï¼ˆæ— éœ€ä¿®æ”¹ï¼Œè´´åˆletta-liteé¡¹ç›®ç»“æ„ï¼‰
      OPENSSL_SRC_DIR: ${{ github.workspace }}/openssl-src
      OPENSSL_INSTALL_DIR: ${{ github.workspace }}/openssl-install
      RUST_OUTPUT_DIR: ${{ github.workspace }}/target/android
      CORE_DIR: "core"                     # Rustæ ¸å¿ƒåº“ç›®å½•
      CORE_PACKAGE_NAME: "letta-core"      # Rustæ ¸å¿ƒåº“åŒ…å
      ANDROID_BINDINGS_DIR: "bindings/android"  # Kotlinç»‘å®šåº“ç›®å½•
      AAR_OUTPUT_DIR: ${{ github.workspace }}/bindings/android/build/outputs/aar
      RELEASE_DIR: ${{ github.workspace }}/release-artifacts

    steps:
      ###########################################################################
      # æ­¥éª¤1ï¼šæ‹‰å–æºç ï¼ˆå«å­æ¨¡å—ï¼Œç¡®ä¿letta-liteæ ¸å¿ƒä»£ç å’Œç»‘å®šåº“å®Œæ•´ï¼‰
      ###########################################################################
      - name: æ‹‰å–æºç ï¼ˆå«å­æ¨¡å—ï¼‰
        uses: actions/checkout@v4
        with:
          submodules: true  # å…³é”®ï¼šæ‹‰å–bindings/androidç­‰å­æ¨¡å—

      ###########################################################################
      # æ­¥éª¤2ï¼šå®‰è£…åŸºç¡€ä¾èµ–ï¼ˆJava/Gradleç”¨äºç¼–è¯‘Kotlinï¼Œå…¶ä»–ä¾èµ–ç”¨äºRust/OpenSSLï¼‰
      ###########################################################################
      - name: å®‰è£…åŸºç¡€ä¾èµ–
        run: |
          sudo apt-get update && sudo apt-get install -y \
            coreutils pkg-config make perl wget curl gcc cmake \
            libssl-dev zlib1g-dev unzip openjdk-11-jdk gradle \
            binutils  # ç”¨äºnmå‘½ä»¤éªŒè¯.so API

      ###########################################################################
      # æ­¥éª¤3ï¼šå®‰è£…NDKï¼ˆå…ˆè£…NDKå†ç¼–è¯‘OpenSSLï¼Œè§£å†³ç¼–è¯‘å™¨è·¯å¾„é—®é¢˜ï¼‰
      ###########################################################################
      - name: å®‰è£…Android NDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          packages: |
            ndk;${{ env.ANDROID_NDK_VERSION }}
            platforms;android-${{ env.ANDROID_API_LEVEL }}

      ###########################################################################
      # æ­¥éª¤4ï¼šéªŒè¯NDKå¹¶è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆå…³é”®ï¼šä¼ é€’ç¼–è¯‘å™¨è·¯å¾„ç»™OpenSSL/Rustï¼‰
      ###########################################################################
      - name: éªŒè¯NDKå¹¶é…ç½®ç¯å¢ƒå˜é‡
        run: |
          # æŸ¥æ‰¾NDKå®é™…è·¯å¾„
          NDK_PATH=$(find /usr/local/lib/android/sdk/ndk -maxdepth 1 -type d | grep ${{ env.ANDROID_NDK_VERSION }})
          if [ -z "$NDK_PATH" ]; then
            echo "âŒ æœªæ‰¾åˆ°NDK ${{ env.ANDROID_NDK_VERSION }}"
            exit 1
          fi
          # è®¾ç½®NDKå·¥å…·é“¾è·¯å¾„ï¼ˆclangç¼–è¯‘å™¨ã€arã€ranlibç­‰ï¼‰
          NDK_TOOLCHAIN_BIN="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin"
          NDK_SYSROOT="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
          # å†™å…¥ç¯å¢ƒå˜é‡ï¼ˆåç»­æ­¥éª¤å¯ç›´æ¥ä½¿ç”¨ï¼‰
          echo "NDK_TOOLCHAIN_BIN=$NDK_TOOLCHAIN_BIN" >> $GITHUB_ENV
          echo "NDK_SYSROOT=$NDK_SYSROOT" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=$NDK_PATH" >> $GITHUB_ENV
          # éªŒè¯ç¼–è¯‘å™¨æ˜¯å¦å­˜åœ¨
          COMPILER="$NDK_TOOLCHAIN_BIN/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang"
          if [ ! -f "$COMPILER" ]; then
            echo "âŒ ç¼–è¯‘å™¨ç¼ºå¤±ï¼š$COMPILER"
            ls -l $NDK_TOOLCHAIN_BIN | grep clang
            exit 1
          fi
          echo "âœ… NDKéªŒè¯é€šè¿‡ï¼Œç¼–è¯‘å™¨è·¯å¾„ï¼š$COMPILER"

      ###########################################################################
      # æ­¥éª¤5ï¼šç¼–è¯‘OpenSSLï¼ˆä¾èµ–NDKç¯å¢ƒå˜é‡ï¼Œé¡ºåºä¸èƒ½ä¹±ï¼‰
      ###########################################################################
      - name: ç¼–è¯‘OpenSSLï¼ˆAndroid 64ä½ï¼‰
        run: |
          # åˆ›å»ºç›®å½•
          mkdir -p ${{ env.OPENSSL_SRC_DIR }} ${{ env.OPENSSL_INSTALL_DIR }}
          cd ${{ env.OPENSSL_SRC_DIR }}
          # ä¸‹è½½å¹¶è§£å‹OpenSSL
          wget -q https://www.openssl.org/source/openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          tar -xvzf openssl-${{ env.OPENSSL_VERSION }}.tar.gz --strip-components=1
          rm openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          # é…ç½®äº¤å‰ç¼–è¯‘å‚æ•°ï¼ˆä½¿ç”¨NDKå·¥å…·é“¾ï¼‰
          export CC="${{ env.NDK_TOOLCHAIN_BIN }}/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang"
          export CXX="${{ env.NDK_TOOLCHAIN_BIN }}/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang++"
          export AR="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ar"
          export RANLIB="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ranlib"
          export LD="${{ env.NDK_TOOLCHAIN_BIN }}/ld.lld"
          export PATH="$NDK_TOOLCHAIN_BIN:$PATH"
          # æ‰§è¡ŒOpenSSLé…ç½®ï¼ˆç¦ç”¨ä¸å¿…è¦åŠŸèƒ½ï¼Œå‡å°ä½“ç§¯ï¼‰
          ./Configure linux-aarch64 no-shared no-asm no-zlib no-ssl2 no-ssl3 \
            --prefix=${{ env.OPENSSL_INSTALL_DIR }} \
            --sysroot=${{ env.NDK_SYSROOT }} \
            -fPIC -march=armv8-a \
            CC=$CC CXX=$CXX AR=$AR RANLIB=$RANLIB LD=$LD
          # ç¼–è¯‘å¹¶å®‰è£…ï¼ˆ-j$(nproc) å¹¶è¡Œç¼–è¯‘åŠ é€Ÿï¼‰
          make -j$(nproc) V=1
          make install_sw  # ä»…å®‰è£…åº“æ–‡ä»¶ï¼ˆä¸å«æ–‡æ¡£ï¼‰
          echo "âœ… OpenSSLç¼–è¯‘å®Œæˆï¼Œå®‰è£…ç›®å½•ï¼š${{ env.OPENSSL_INSTALL_DIR }}"
          ls -l ${{ env.OPENSSL_INSTALL_DIR }}/lib  # éªŒè¯ç”Ÿæˆçš„åº“

      ###########################################################################
      # æ­¥éª¤6ï¼šé…ç½®Rustç¯å¢ƒï¼ˆç¼–è¯‘æ ¸å¿ƒ.soåº“ï¼‰
      ###########################################################################
      - name: é…ç½®Rustå·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.85.0  # éªŒè¯å…¼å®¹çš„Rustç‰ˆæœ¬
          target: ${{ env.TARGET_ARCH }}  # ç›®æ ‡æ¶æ„ï¼šAndroid 64ä½

      - name: å®‰è£…cargo-ndkï¼ˆRustç¼–è¯‘Androidå·¥å…·ï¼‰
        run: cargo install cargo-ndk --version=3.5.4 --locked  # ç¨³å®šç‰ˆæœ¬

      ###########################################################################
      # æ­¥éª¤7ï¼šä¿®å¤Rustå·¥ä½œåŒºé…ç½®ï¼ˆç¡®ä¿ç”Ÿæˆcdylibç±»å‹çš„.soåº“ï¼‰
      ###########################################################################
      - name: ä¿®å¤Rustç¼–è¯‘é…ç½®
        run: |
          # æ¸…ç†æ ¹ç›®å½•Cargo.tomlä¸­çš„[lib]é…ç½®ï¼ˆé¿å…å†²çªï¼‰
          sed -i '/^\[lib\]$/,/^$/d' Cargo.toml
          # ç¡®ä¿coreæ¨¡å—çš„Cargo.tomlé…ç½®ä¸ºcdylibï¼ˆç”Ÿæˆ.soï¼‰
          CORE_CARGO="${{ env.CORE_DIR }}/Cargo.toml"
          if [ ! -f "$CORE_CARGO" ]; then
            echo "âŒ æœªæ‰¾åˆ°Rustæ ¸å¿ƒåº“é…ç½®ï¼š$CORE_CARGO"
            ls -l */Cargo.toml
            exit 1
          fi
          if ! grep -q "crate-type = \[\"cdylib\"" "$CORE_CARGO"; then
            echo -e "\n[lib]\ncrate-type = [\"cdylib\"]" >> "$CORE_CARGO"
            echo "âœ… å·²æ·»åŠ cdylibé…ç½®åˆ° $CORE_CARGO"
          fi
          # éªŒè¯é…ç½®
          cat "$CORE_CARGO" | grep -A 2 "\[lib\]"

      ###########################################################################
      # æ­¥éª¤8ï¼šç¼–è¯‘Rustæ ¸å¿ƒåº“ï¼ˆç”Ÿæˆ.soæ–‡ä»¶ï¼‰
      ###########################################################################
      - name: ç¼–è¯‘Rustæ ¸å¿ƒåº“ï¼ˆ.soï¼‰
        run: |
          cargo clean  # æ¸…ç†ä¹‹å‰çš„ç¼–è¯‘äº§ç‰©
          # é…ç½®OpenSSLä¾èµ–è·¯å¾„ï¼ˆä¼ é€’ç»™Rustï¼‰
          export OPENSSL_INCLUDE_DIR=${{ env.OPENSSL_INSTALL_DIR }}/include
          export OPENSSL_LIB_DIR=${{ env.OPENSSL_INSTALL_DIR }}/lib
          export OPENSSL_DIR=${{ env.OPENSSL_INSTALL_DIR }}
          export PKG_CONFIG_ALLOW_CROSS=1  # å…è®¸äº¤å‰ç¼–è¯‘æ—¶ä½¿ç”¨pkg-config
          # ç¼–è¯‘å¹¶è¾“å‡ºåˆ°æŒ‡å®šç›®å½•
          cargo ndk -t ${{ env.TARGET_ARCH }} -o ${{ env.RUST_OUTPUT_DIR }} build \
            --package ${{ env.CORE_PACKAGE_NAME }} \
            --profile mobile  # ä½¿ç”¨mobileé…ç½®ï¼ˆä¼˜åŒ–ä½“ç§¯å’Œæ€§èƒ½ï¼‰
          # å¤åˆ¶.soæ–‡ä»¶åˆ°å‘å¸ƒç›®å½•ï¼ˆé‡å‘½åä¸ºæ›´ç›´è§‚çš„åç§°ï¼‰
          mkdir -p ${{ env.RELEASE_DIR }}
          SO_FILE=$(find ${{ env.RUST_OUTPUT_DIR }} -name "lib*.so" | head -n 1)
          if [ -z "$SO_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ°ç¼–è¯‘ç”Ÿæˆçš„.soæ–‡ä»¶"
            ls -l ${{ env.RUST_OUTPUT_DIR }}
            exit 1
          fi
          cp "$SO_FILE" ${{ env.RELEASE_DIR }}/libletta_lite.so
          echo "âœ… Rustæ ¸å¿ƒåº“ç¼–è¯‘å®Œæˆï¼š${{ env.RELEASE_DIR }}/libletta_lite.so"
          ls -l ${{ env.RELEASE_DIR }}/libletta_lite.so

      ###########################################################################
      # æ­¥éª¤9ï¼šç¼–è¯‘Kotlinç»‘å®šåº“ï¼ˆç”Ÿæˆ.aaræ–‡ä»¶ï¼‰
      ###########################################################################
      - name: ç¼–è¯‘Kotlinç»‘å®šåº“ï¼ˆ.aarï¼‰
        run: |
          # è¿›å…¥Kotlinç»‘å®šåº“ç›®å½•
          cd ${{ env.ANDROID_BINDINGS_DIR }}
          # éªŒè¯Androidé¡¹ç›®é…ç½®
          if [ ! -f "build.gradle" ] && [ ! -f "build.gradle.kts" ]; then
            echo "âŒ æœªæ‰¾åˆ°Kotlinç»‘å®šåº“çš„æ„å»ºæ–‡ä»¶"
            ls -l
            exit 1
          fi
          # ç¼–è¯‘releaseç‰ˆæœ¬çš„aarï¼ˆ--no-daemon é¿å…åå°è¿›ç¨‹å ç”¨ï¼‰
          ./gradlew assembleRelease --no-daemon
          # éªŒè¯aaräº§ç‰©
          if [ ! -f "$AAR_OUTPUT_DIR/android-release.aar" ]; then
            echo "âŒ Kotlin aarç¼–è¯‘å¤±è´¥ï¼Œäº§ç‰©ä¸å­˜åœ¨"
            ls -l $AAR_OUTPUT_DIR
            exit 1
          fi
          # é‡å‘½åaarï¼ˆæ›´ç›´è§‚ï¼Œä¾¿äºé›†æˆï¼‰
          cp "$AAR_OUTPUT_DIR/android-release.aar" ${{ env.RELEASE_DIR }}/letta-lite-android.aar
          echo "âœ… Kotlinç»‘å®šåº“ç¼–è¯‘å®Œæˆï¼š${{ env.RELEASE_DIR }}/letta-lite-android.aar"
          ls -l ${{ env.RELEASE_DIR }}/letta-lite-android.aar

      ###########################################################################
      # æ­¥éª¤10ï¼šéªŒè¯äº§ç‰©æœ‰æ•ˆæ€§ï¼ˆç¡®ä¿.soå’Œ.aarå¯ç”¨ï¼‰
      ###########################################################################
      - name: éªŒè¯äº§ç‰©æœ‰æ•ˆæ€§
        run: |
          echo -e "\n========================================"
          echo "ğŸ” éªŒè¯Rust .soåº“ï¼ˆå¯¼å‡ºAPIï¼‰"
          echo "========================================"
          SO_FILE="${{ env.RELEASE_DIR }}/libletta_lite.so"
          # æŸ¥çœ‹å¯¼å‡ºçš„Cæ¥å£ï¼ˆç¡®ä¿æ ¸å¿ƒåŠŸèƒ½APIå­˜åœ¨ï¼‰
          EXPORTED_APIS=$(nm -D $SO_FILE | grep "T " | grep -v "__" | awk '{print $3}')
          if [ -z "$EXPORTED_APIS" ]; then
            echo "âš ï¸  æœªæ‰¾åˆ°å¯¼å‡ºçš„APIï¼Œä½†ä¸å½±å“é›†æˆï¼ˆå¯èƒ½é€šè¿‡FFIå°è£…ï¼‰"
          else
            echo "å·²å¯¼å‡ºAPIåˆ—è¡¨ï¼ˆå‰10ä¸ªï¼‰ï¼š"
            echo "$EXPORTED_APIS" | head -10 | while read -r api; do echo "  - $api"; done
          fi

          echo -e "\n========================================"
          echo "ğŸ” éªŒè¯Kotlin .aaråº“ï¼ˆå†…éƒ¨ç»“æ„ï¼‰"
          echo "========================================"
          AAR_FILE="${{ env.RELEASE_DIR }}/letta-lite-android.aar"
          # è§£å‹aaræŸ¥çœ‹å†…éƒ¨ç»“æ„ï¼ˆéªŒè¯åŒ…å«Kotlinç±»å’Œèµ„æºï¼‰
          unzip -q $AAR_FILE -d temp-aar
          echo "AARåŒ…å«çš„æ ¸å¿ƒæ–‡ä»¶ï¼š"
          find temp-aar -name "*.class" | grep -E "LettaLite|Agent|Conversation" | head -5 | while read -r cls; do echo "  - $cls"; done
          rm -rf temp-aar  # æ¸…ç†ä¸´æ—¶æ–‡ä»¶

      ###########################################################################
      # æ­¥éª¤11ï¼šè‡ªåŠ¨å‘å¸ƒåˆ°GitHub Releasesï¼ˆäº§ç‰©æ‰“åŒ…å®Œæˆåå‘å¸ƒï¼‰
      ###########################################################################
      - name: å‘å¸ƒåˆ°GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}  # æ ‡ç­¾ä½œä¸ºç‰ˆæœ¬å·
          name: "Android 64ä½ç‰ˆæœ¬ ${{ github.ref_name }}"  # å‘å¸ƒåç§°
          body: |
            ## Letta-Lite Android 64ä½å®Œæ•´é›†æˆåŒ…
            ğŸŒŸ äº§ç‰©åŒ…å«ï¼šRustæ ¸å¿ƒåº“ï¼ˆ.soï¼‰ + Kotlinç»‘å®šåº“ï¼ˆ.aarï¼‰
            - æ¶æ„ï¼šarm64-v8aï¼ˆå…¼å®¹90%+å®‰å“è®¾å¤‡ï¼‰
            - æœ€ä½æ”¯æŒï¼šAndroid 7.0ï¼ˆAPI 24ï¼‰
            - ä¾èµ–ï¼šAndroid NDK 27+ã€Rust 1.85.0+
            - æ ¸å¿ƒåŠŸèƒ½ï¼šå¯¹è¯äº¤äº’ã€è®°å¿†ç®¡ç†ã€æœ¬åœ°LLMè¿è¡Œã€äº‘åŒæ­¥

            ### å¿«é€Ÿé›†æˆæ­¥éª¤
            1. å¤åˆ¶ `libletta_lite.so` åˆ°é¡¹ç›® `app/src/main/jniLibs/arm64-v8a/`
            2. å¤åˆ¶ `letta-lite-android.aar` åˆ°é¡¹ç›® `app/libs/`
            3. åœ¨app/build.gradleä¸­æ·»åŠ ä¾èµ–ï¼š
               ```gradle
               dependencies {
                   implementation files('libs/letta-lite-android.aar')
               }
               ```
            4. è°ƒç”¨ç¤ºä¾‹ï¼ˆKotlinï¼‰ï¼š
               ```kotlin
               val lettaLite = LettaLite.createDefault()
               val response = lettaLite.converse("ä½ å¥½ï¼ŒLetta-Liteï¼")
               println("Lettaå›å¤ï¼š$response")
               ```

            ### éªŒè¯ä¿¡æ¯
            - OpenSSLç‰ˆæœ¬ï¼š${{ env.OPENSSL_VERSION }}
            - NDKç‰ˆæœ¬ï¼š${{ env.ANDROID_NDK_VERSION }}
            - Rustç‰ˆæœ¬ï¼š1.85.0
          # å‘å¸ƒçš„äº§ç‰©æ–‡ä»¶ï¼ˆåŒ…å«.soã€.aarã€READMEï¼‰
          files: |
            ${{ env.RELEASE_DIR }}/libletta_lite.so
            ${{ env.RELEASE_DIR }}/letta-lite-android.aar
            README.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHubè‡ªåŠ¨æä¾›çš„ä»¤ç‰Œï¼ˆæ— éœ€æ‰‹åŠ¨é…ç½®ï¼‰

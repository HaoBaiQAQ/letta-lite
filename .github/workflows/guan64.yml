name: Android 64ä½å®Œæ•´ç¼–è¯‘+å‘å¸ƒï¼ˆRust .so + Kotlin .aarï¼‰
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-and-release-64bit:
    runs-on: ubuntu-latest
    env:
      # å¼ºåˆ¶é”å®š64ä½æ¶æ„ï¼Œå…¨æµç¨‹ç»Ÿä¸€
      TARGET_ARCH: aarch64-linux-android
      ANDROID_ABI: arm64-v8a
      ANDROID_NDK_VERSION: 27.3.13750724
      ANDROID_API_LEVEL: 24
      OPENSSL_VERSION: 1.1.1w
      # è·¯å¾„é…ç½®ï¼ˆé¿å…å†²çªï¼‰
      OPENSSL_SRC_DIR: ${{ github.workspace }}/openssl-src
      OPENSSL_INSTALL_DIR: ${{ github.workspace }}/openssl-install
      RUST_OUTPUT_DIR: ${{ github.workspace }}/target/${{ env.TARGET_ARCH }}/mobile
      RELEASE_DIR: ${{ github.workspace }}/release-artifacts

    steps:
      ###########################################################################
      # æ­¥éª¤1ï¼šæ‹‰å–æºç ï¼ˆå«å­æ¨¡å—ï¼‰
      ###########################################################################
      - name: æ‹‰å–æºç ï¼ˆå«å­æ¨¡å—ï¼‰
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      ###########################################################################
      # æ­¥éª¤2ï¼šå®‰è£…åŸºç¡€ä¾èµ–
      ###########################################################################
      - name: å®‰è£…åŸºç¡€ä¾èµ–
        run: |
          sudo apt-get update && sudo apt-get install -y \
            coreutils pkg-config make perl wget curl gcc cmake \
            libssl-dev zlib1g-dev unzip openjdk-11-jdk binutils \
            gradle android-sdk-platform-tools-common

      ###########################################################################
      # æ­¥éª¤3ï¼šå®‰è£…NDKï¼ˆ64ä½ç¼–è¯‘å¿…éœ€ï¼‰
      ###########################################################################
      - name: å®‰è£…Android NDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          packages: "ndk;${{ env.ANDROID_NDK_VERSION }} platforms;android-${{ env.ANDROID_API_LEVEL }}"

      ###########################################################################
      # æ­¥éª¤4ï¼šé…ç½®NDKç¯å¢ƒå˜é‡ï¼ˆå¼ºåˆ¶64ä½å·¥å…·é“¾ï¼‰
      ###########################################################################
      - name: é…ç½®NDKç¯å¢ƒå˜é‡ï¼ˆé”å®š64ä½ï¼‰
        run: |
          NDK_PATH=$(find /usr/local/lib/android/sdk/ndk -maxdepth 1 -type d | grep ${{ env.ANDROID_NDK_VERSION }})
          if [ -z "$NDK_PATH" ]; then
            echo "âŒ æœªæ‰¾åˆ°NDK ${{ env.ANDROID_NDK_VERSION }}"
            exit 1
          fi
          # å¼ºåˆ¶ä½¿ç”¨64ä½å·¥å…·é“¾è·¯å¾„
          NDK_TOOLCHAIN_BIN="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin"
          NDK_SYSROOT="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
          echo "ANDROID_NDK_ROOT=$NDK_PATH" >> $GITHUB_ENV
          echo "NDK_TOOLCHAIN_BIN=$NDK_TOOLCHAIN_BIN" >> $GITHUB_ENV
          echo "NDK_SYSROOT=$NDK_SYSROOT" >> $GITHUB_ENV
          echo "PATH=$NDK_TOOLCHAIN_BIN:$PATH" >> $GITHUB_ENV
          # éªŒè¯64ä½ç¼–è¯‘å™¨
          COMPILER="$NDK_TOOLCHAIN_BIN/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang"
          if [ ! -f "$COMPILER" ]; then
            echo "âŒ 64ä½ç¼–è¯‘å™¨ç¼ºå¤±ï¼š$COMPILER"
            exit 1
          fi
          echo "âœ… 64ä½NDKç¯å¢ƒé…ç½®å®Œæˆï¼Œç¼–è¯‘å™¨ï¼š$COMPILER"

      ###########################################################################
      # æ­¥éª¤5ï¼šç¼–è¯‘OpenSSLï¼ˆå¼ºåˆ¶64ä½ï¼Œä¸Rustç›®æ ‡ä¸€è‡´ï¼‰
      ###########################################################################
      - name: ç¼–è¯‘64ä½OpenSSLï¼ˆæ¶æ„å¯¹é½ï¼‰
        run: |
          mkdir -p ${{ env.OPENSSL_SRC_DIR }} ${{ env.OPENSSL_INSTALL_DIR }}
          cd ${{ env.OPENSSL_SRC_DIR }}
          wget -q https://www.openssl.org/source/openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          tar -xvzf openssl-${{ env.OPENSSL_VERSION }}.tar.gz --strip-components=1
          rm openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          # å¼ºåˆ¶64ä½é…ç½®ï¼ˆlinux-aarch64å¯¹åº”arm64-v8aï¼‰
          export CC="${{ env.NDK_TOOLCHAIN_BIN }}/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang"
          export CXX="${{ env.NDK_TOOLCHAIN_BIN }}/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang++"
          export AR="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ar"
          export RANLIB="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ranlib"
          export LD="${{ env.NDK_TOOLCHAIN_BIN }}/ld.lld"
          export PATH="$NDK_TOOLCHAIN_BIN:$PATH"
          # å…³é”®ï¼šæŒ‡å®š64ä½æ¶æ„é…ç½®ï¼ˆlinux-aarch64ï¼‰
          ./Configure linux-aarch64 no-shared no-asm no-zlib \
            --prefix=${{ env.OPENSSL_INSTALL_DIR }} \
            --sysroot=${{ env.NDK_SYSROOT }} \
            -fPIC -march=armv8-a \
            CC=$CC CXX=$CXX AR=$AR RANLIB=$RANLIB LD=$LD
          make -j$(nproc) V=1
          make install_sw
          echo "âœ… 64ä½OpenSSLç¼–è¯‘å®Œæˆï¼Œå®‰è£…ç›®å½•ï¼š${{ env.OPENSSL_INSTALL_DIR }}"
          # éªŒè¯OpenSSLæ¶æ„ï¼ˆç¡®ä¿æ˜¯64ä½ï¼‰
          file ${{ env.OPENSSL_INSTALL_DIR }}/lib/libcrypto.a | grep "64-bit" || { echo "âŒ OpenSSLä¸æ˜¯64ä½"; exit 1; }

      ###########################################################################
      # æ­¥éª¤6ï¼šé…ç½®Rustç¯å¢ƒï¼ˆå¼ºåˆ¶64ä½ç›®æ ‡ï¼‰
      ###########################################################################
      - name: é…ç½®Rustå·¥å…·é“¾ï¼ˆé”å®š64ä½ï¼‰
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.85.0
          target: ${{ env.TARGET_ARCH }}  # ä»…å®‰è£…64ä½ç›®æ ‡

      - name: å®‰è£…cargo-ndkï¼ˆ64ä½ç¼–è¯‘å·¥å…·ï¼‰
        run: cargo install cargo-ndk --version=3.5.4 --locked

      ###########################################################################
      # æ­¥éª¤7ï¼šä¿®å¤Rustç¼–è¯‘é…ç½®ï¼ˆç¦ç”¨å¤šæ¶æ„ï¼Œå¼ºåˆ¶64ä½ï¼‰
      ###########################################################################
      - name: ä¿®å¤Rusté…ç½®ï¼ˆç¡®ä¿64ä½è¾“å‡ºï¼‰
        run: |
          # æ¸…ç†æ ¹ç›®å½•Cargo.tomlä¸­çš„å†²çªé…ç½®
          sed -i '/^\[lib\]$/,/^$/d' Cargo.toml
          # ç¡®ä¿coreæ¨¡å—ç¼–è¯‘ä¸ºcdylibï¼ˆ.soï¼‰
          CORE_CARGO="${{ github.workspace }}/core/Cargo.toml"
          if ! grep -q "crate-type = \[\"cdylib\"" "$CORE_CARGO"; then
            echo -e "\n[lib]\ncrate-type = [\"cdylib\"]" >> "$CORE_CARGO"
          fi
          # ç¦ç”¨ffiæ¨¡å—çš„å¤šæ¶æ„ç¼–è¯‘ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          FFI_CARGO="${{ github.workspace }}/ffi/Cargo.toml"
          if [ -f "$FFI_CARGO" ]; then
            sed -i '/target\./d' "$FFI_CARGO"  # ç§»é™¤ç›®æ ‡æ¶æ„ç›¸å…³é…ç½®
          fi
          echo "âœ… Rusté…ç½®ä¿®å¤å®Œæˆï¼ˆå¼ºåˆ¶64ä½ï¼‰"

      ###########################################################################
      # æ­¥éª¤8ï¼šç¼–è¯‘Rustæ ¸å¿ƒåº“ï¼ˆç›´æ¥è°ƒç”¨cargo-ndkï¼Œé¿å…å®˜æ–¹è„šæœ¬å¹²æ‰°ï¼‰
      ###########################################################################
      - name: ç¼–è¯‘64ä½Rustæ ¸å¿ƒåº“ï¼ˆ.soï¼‰
        run: |
          cargo clean
          # ä¼ é€’OpenSSLè·¯å¾„å’Œ64ä½ç¯å¢ƒå˜é‡
          export OPENSSL_INCLUDE_DIR=${{ env.OPENSSL_INSTALL_DIR }}/include
          export OPENSSL_LIB_DIR=${{ env.OPENSSL_INSTALL_DIR }}/lib
          export OPENSSL_DIR=${{ env.OPENSSL_INSTALL_DIR }}
          export PKG_CONFIG_ALLOW_CROSS=1
          export ANDROID_NDK_ROOT=${{ env.ANDROID_NDK_ROOT }}
          # å¼ºåˆ¶64ä½ç¼–è¯‘ï¼Œè¾“å‡ºåˆ°æŒ‡å®šç›®å½•
          cargo ndk -t ${{ env.TARGET_ARCH }} -o ${{ env.RUST_OUTPUT_DIR }} build \
            --package letta-core \
            --profile mobile
          # éªŒè¯.soæ¶æ„ï¼ˆç¡®ä¿æ˜¯64ä½ï¼‰
          SO_FILE=$(find ${{ env.RUST_OUTPUT_DIR }} -name "libletta_core.so" | head -n 1)
          if [ -z "$SO_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ°64ä½Rust .soæ–‡ä»¶"
            exit 1
          fi
          file "$SO_FILE" | grep "64-bit" || { echo "âŒ Rust .soä¸æ˜¯64ä½"; exit 1; }
          # å¤åˆ¶åˆ°å‘å¸ƒç›®å½•
          mkdir -p ${{ env.RELEASE_DIR }}
          cp "$SO_FILE" ${{ env.RELEASE_DIR }}/libletta_lite.so
          echo "âœ… 64ä½Rust .soç¼–è¯‘å®Œæˆï¼š${{ env.RELEASE_DIR }}/libletta_lite.so"

      ###########################################################################
      # æ­¥éª¤9ï¼šç”ŸæˆKotlin .aarï¼ˆ64ä½ä¸“ç”¨ï¼‰
      ###########################################################################
      - name: ç”Ÿæˆ64ä½Kotlin .aar
        run: |
          # åˆ›å»ºAndroidåº“æ¨¡å—ï¼ˆä»…æ”¯æŒarm64-v8aï¼‰
          AAR_MODULE_DIR="${{ github.workspace }}/letta-lite-android"
          mkdir -p $AAR_MODULE_DIR/src/main/java/ai/letta/lite $AAR_MODULE_DIR/src/main/jniLibs/${{ env.ANDROID_ABI }}
          
          # å¤åˆ¶64ä½.soåˆ°jniLibs
          cp ${{ env.RELEASE_DIR }}/libletta_lite.so $AAR_MODULE_DIR/src/main/jniLibs/${{ env.ANDROID_ABI }}/
          
          # Kotlinå°è£…ç±»ï¼ˆåŸºäºå®˜æ–¹ç¤ºä¾‹ï¼Œé€‚é…64ä½ï¼‰
          cat > $AAR_MODULE_DIR/src/main/java/ai/letta/lite/LettaLite.kt << 'EOF'
          package ai.letta.lite

          class LettaLite(config: Map<String, String>) {
              init {
                  System.loadLibrary("letta_lite") // åŠ è½½64ä½.so
              }

              // JNIè°ƒç”¨Rust FFIæ ¸å¿ƒæ¥å£ï¼ˆå¯¹åº”å®˜æ–¹æš´éœ²APIï¼‰
              private external fun createAgent(config: Map<String, String>): Long
              private external fun setBlock(agentPtr: Long, key: String, value: String)
              private external fun converse(agentPtr: Long, prompt: String): String
              private external fun destroyAgent(agentPtr: Long)

              private val agentPtr: Long = createAgent(config)

              fun setBlock(key: String, value: String) = setBlock(agentPtr, key, value)
              fun converse(prompt: String): String = converse(agentPtr, prompt)

              protected fun finalize() = destroyAgent(agentPtr)

              companion object {
                  fun createDefault(): LettaLite = LettaLite(mapOf("model" to "local", "name" to "assistant"))
              }
          }
          EOF

          # build.gradleï¼ˆé”å®š64ä½æ¶æ„ï¼Œç¦ç”¨32ä½ï¼‰
          cat > $AAR_MODULE_DIR/build.gradle << 'EOF'
          plugins {
              id 'com.android.library'
              id 'org.jetbrains.kotlin.android'
          }

          android {
              namespace "ai.letta.lite"
              compileSdk 33

              defaultConfig {
                  minSdk 24
                  targetSdk 33
                  ndk {
                      abiFilters "arm64-v8a" // ä»…æ”¯æŒ64ä½æ¶æ„
                  }
              }

              buildTypes {
                  release {
                      minifyEnabled false
                      proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                  }
              }

              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_1_8
                  targetCompatibility JavaVersion.VERSION_1_8
              }

              kotlinOptions {
                  jvmTarget = '1.8'
              }

              sourceSets {
                  main {
                      jniLibs.srcDirs = ['src/main/jniLibs']
                  }
              }
          }

          dependencies {
              implementation 'androidx.core:core-ktx:1.12.0'
              testImplementation 'junit:junit:4.13.2'
              androidTestImplementation 'androidx.test.ext:junit:1.1.5'
              androidTestImplementation 'androidx.test.espresso:espresso-core:3.5.1'
          }
          EOF

          # æ··æ·†è§„åˆ™ï¼ˆä¿æŠ¤JNIæ–¹æ³•ï¼‰
          cat > $AAR_MODULE_DIR/proguard-rules.pro << 'EOF'
          -keep class ai.letta.lite.LettaLite { *; }
          -keepclasseswithmembernames class * { native <methods>; }
          EOF

          # æ‰“åŒ…aar
          cd $AAR_MODULE_DIR
          gradle assembleRelease --no-daemon
          # æå–aarå¹¶éªŒè¯
          AAR_FILE=$(find build/outputs/aar -name "*.aar" | head -n 1)
          if [ -z "$AAR_FILE" ]; then
            echo "âŒ Kotlin .aaræ‰“åŒ…å¤±è´¥"
            exit 1
          fi
          cp "$AAR_FILE" ${{ env.RELEASE_DIR }}/letta-lite-android.aar
          echo "âœ… 64ä½Kotlin .aarç”Ÿæˆå®Œæˆï¼š${{ env.RELEASE_DIR }}/letta-lite-android.aar"
          # éªŒè¯aarä¸­çš„.soæ˜¯64ä½
          unzip -q ${{ env.RELEASE_DIR }}/letta-lite-android.aar -d temp-aar
          file temp-aar/jni/${{ env.ANDROID_ABI }}/libletta_lite.so | grep "64-bit" || { echo "âŒ aarä¸­çš„.soä¸æ˜¯64ä½"; exit 1; }
          rm -rf temp-aar

      ###########################################################################
      # æ­¥éª¤10ï¼šäº§ç‰©æœ€ç»ˆéªŒè¯
      ###########################################################################
      - name: éªŒè¯64ä½äº§ç‰©æœ‰æ•ˆæ€§
        run: |
          echo -e "\nğŸ” éªŒè¯Rust .soï¼ˆ64ä½+å¯¼å‡ºAPIï¼‰"
          nm -D ${{ env.RELEASE_DIR }}/libletta_lite.so | grep "T " | grep -v "__" | head -10
          
          echo -e "\nğŸ” éªŒè¯Kotlin .aarï¼ˆç»“æ„+64ä½.soï¼‰"
          unzip -l ${{ env.RELEASE_DIR }}/letta-lite-android.aar | grep -E "classes.jar|jni/arm64-v8a/libletta_lite.so"

      ###########################################################################
      # æ­¥éª¤11ï¼šå‘å¸ƒåˆ°GitHub Releases
      ###########################################################################
      - name: å‘å¸ƒåˆ°GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "Android 64ä½ç‰ˆæœ¬ ${{ github.ref_name }}"
          body: |
            ## Letta-Lite Android 64ä½å®Œæ•´é›†æˆåŒ…ï¼ˆæ¶æ„å¯¹é½ç‰ˆï¼‰
            ğŸŒŸ äº§ç‰©åŒ…å«ï¼š64ä½Rustæ ¸å¿ƒåº“ï¼ˆ.soï¼‰ + 64ä½Kotlinç»‘å®šåº“ï¼ˆ.aarï¼‰
            - æ¶æ„ï¼šarm64-v8aï¼ˆçº¯64ä½ï¼Œå…¼å®¹90%+ç°ä»£å®‰å“è®¾å¤‡ï¼‰
            - æœ€ä½æ”¯æŒï¼šAndroid 7.0ï¼ˆAPI 24ï¼‰
            - æ ¸å¿ƒä¼˜åŒ–ï¼šå…¨æµç¨‹é”å®š64ä½æ¶æ„ï¼Œè§£å†³OpenSSLä¸Rusté“¾æ¥å†²çª
            - æ ¸å¿ƒåŠŸèƒ½ï¼šå¯¹è¯äº¤äº’ã€è®°å¿†ç®¡ç†ã€æœ¬åœ°LLMè¿è¡Œã€äº‘åŒæ­¥

            ### å¿«é€Ÿé›†æˆæ­¥éª¤
            1. å¤åˆ¶ `letta-lite-android.aar` åˆ°é¡¹ç›® `app/libs/`ï¼ˆå«64ä½.soï¼Œæ— éœ€é¢å¤–å¤åˆ¶ï¼‰
            2. åœ¨app/build.gradleä¸­æ·»åŠ ä¾èµ–ï¼š
               ```gradle
               dependencies {
                   implementation files('libs/letta-lite-android.aar')
               }
               ```
            3. Kotlinè°ƒç”¨ç¤ºä¾‹ï¼š
               ```kotlin
               import ai.letta.lite.LettaLite
               
               val lettaLite = LettaLite.createDefault()
               lettaLite.setBlock("user_info", "Name: Alice, prefers concise answers")
               val response = lettaLite.converse("ä½ å¥½ï¼ŒLetta-Liteï¼")
               println("Lettaå›å¤ï¼š$response")
               ```

            ### ä¾èµ–è¯´æ˜
            - NDKç‰ˆæœ¬ï¼š${{ env.ANDROID_NDK_VERSION }}
            - Rustç‰ˆæœ¬ï¼š1.85.0
            - OpenSSLç‰ˆæœ¬ï¼š${{ env.OPENSSL_VERSION }}
            - æ¶æ„ï¼šçº¯64ä½ï¼ˆarm64-v8aï¼‰ï¼Œæ— 32ä½å…¼å®¹
          files: |
            ${{ env.RELEASE_DIR }}/libletta_lite.so
            ${{ env.RELEASE_DIR }}/letta-lite-android.aar
            README.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

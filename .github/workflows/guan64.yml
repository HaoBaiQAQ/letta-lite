name: Android 64ä½å®Œæ•´ç¼–è¯‘+å‘å¸ƒï¼ˆRust .so + Kotlin .aarï¼‰
on:
  push:
    tags:
      - 'v*'  # æ¨é€æ ‡ç­¾è§¦å‘ï¼ˆå¦‚v0.1.0ï¼‰
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼ˆæ–¹ä¾¿æµ‹è¯•ï¼‰

jobs:
  build-and-release-64bit:
    runs-on: ubuntu-latest
    env:
      # æ ¸å¿ƒé…ç½®ï¼ˆè´´åˆletta-liteé¡¹ç›®ç»“æ„ï¼Œä¿æŒä¸å‚è€ƒè„šæœ¬ä¸€è‡´ï¼‰
      ANDROID_NDK_VERSION: 27.3.13750724
      ANDROID_API_LEVEL: 24
      TARGET_ARCH: aarch64-linux-android
      OPENSSL_VERSION: 1.1.1w
      # è·¯å¾„é…ç½®ï¼ˆç®€åŒ–å˜é‡åï¼Œé¿å…å†—ä½™ï¼‰
      OPENSSL_SRC_DIR: ${{ github.workspace }}/openssl-src
      OPENSSL_INSTALL_DIR: ${{ github.workspace }}/openssl-install
      RUST_OUTPUT_DIR: ${{ github.workspace }}/target/android
      CORE_DIR: "core"
      CORE_PACKAGE_NAME: "letta-core"
      ANDROID_BINDINGS_DIR: "bindings/android"
      RELEASE_DIR: ${{ github.workspace }}/release-artifacts

    steps:
      ###########################################################################
      # æ­¥éª¤1ï¼šæ‹‰å–æºç ï¼ˆå«å­æ¨¡å—ï¼Œç¡®ä¿ç»‘å®šåº“å®Œæ•´ï¼‰
      ###########################################################################
      - name: æ‹‰å–æºç ï¼ˆå«å­æ¨¡å—ï¼‰
        uses: actions/checkout@v4
        with:
          submodules: true

      ###########################################################################
      # æ­¥éª¤2ï¼šå®‰è£…åŸºç¡€ä¾èµ–ï¼ˆç²¾ç®€å†—ä½™ä¾èµ–ï¼Œä¿ç•™æ ¸å¿ƒç»„ä»¶ï¼‰
      ###########################################################################
      - name: å®‰è£…åŸºç¡€ä¾èµ–
        run: |
          sudo apt-get update && sudo apt-get install -y \
            coreutils pkg-config make perl wget curl gcc cmake \
            libssl-dev zlib1g-dev unzip openjdk-11-jdk binutils \
            gradle  # ä»…ä¿ç•™ç¼–è¯‘å¿…éœ€ä¾èµ–ï¼Œç§»é™¤æ— ç”¨ç»„ä»¶

      ###########################################################################
      # æ­¥éª¤3ï¼šå®‰è£…NDKï¼ˆå…³é”®ä¿®å¤ï¼špackagesæ”¹ä¸ºå•è¡Œç©ºæ ¼åˆ†éš”ï¼‰
      ###########################################################################
      - name: å®‰è£…Android NDKï¼ˆä¿®å¤åŒ…åè§£æï¼‰
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          # æ ¸å¿ƒä¿®å¤ï¼šå¤šè¡Œåˆ†éš”æ”¹ä¸ºå•è¡Œç©ºæ ¼åˆ†éš”ï¼Œsdkmanagerå¯æ­£ç¡®è¯†åˆ«ä¸¤ä¸ªåŒ…
          packages: "ndk;${{ env.ANDROID_NDK_VERSION }} platforms;android-${{ env.ANDROID_API_LEVEL }}"

      ###########################################################################
      # æ­¥éª¤4ï¼šéªŒè¯NDKï¼ˆæ²¿ç”¨å‚è€ƒè„šæœ¬çš„ç®€æ´é€»è¾‘ï¼Œé¿å…å†—ä½™åˆ¤æ–­ï¼‰
      ###########################################################################
      - name: éªŒè¯NDKå¹¶é…ç½®ç¯å¢ƒå˜é‡
        run: |
          NDK_PATH=$(find /usr/local/lib/android/sdk/ndk -maxdepth 1 -type d | grep ${{ env.ANDROID_NDK_VERSION }})
          if [ -z "$NDK_PATH" ]; then
            echo "âŒ æœªæ‰¾åˆ°NDK ${{ env.ANDROID_NDK_VERSION }}"
            exit 1
          fi
          NDK_TOOLCHAIN_BIN="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin"
          NDK_SYSROOT="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
          # å†™å…¥ç¯å¢ƒå˜é‡
          echo "NDK_TOOLCHAIN_BIN=$NDK_TOOLCHAIN_BIN" >> $GITHUB_ENV
          echo "NDK_SYSROOT=$NDK_SYSROOT" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=$NDK_PATH" >> $GITHUB_ENV
          # éªŒè¯ç¼–è¯‘å™¨
          COMPILER="$NDK_TOOLCHAIN_BIN/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang"
          if [ ! -f "$COMPILER" ]; then
            echo "âŒ ç¼–è¯‘å™¨ç¼ºå¤±ï¼š$COMPILER"
            exit 1
          fi
          echo "âœ… NDKéªŒè¯é€šè¿‡ï¼Œç¼–è¯‘å™¨è·¯å¾„ï¼š$COMPILER"

      ###########################################################################
      # æ­¥éª¤5ï¼šç¼–è¯‘OpenSSLï¼ˆå®Œå…¨æ²¿ç”¨å‚è€ƒè„šæœ¬çš„ç¨³å®šé€»è¾‘ï¼‰
      ###########################################################################
      - name: ç¼–è¯‘OpenSSLï¼ˆAndroid 64ä½ï¼‰
        run: |
          mkdir -p ${{ env.OPENSSL_SRC_DIR }} ${{ env.OPENSSL_INSTALL_DIR }}
          cd ${{ env.OPENSSL_SRC_DIR }}
          wget -q https://www.openssl.org/source/openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          tar -xvzf openssl-${{ env.OPENSSL_VERSION }}.tar.gz --strip-components=1
          rm openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          # é…ç½®äº¤å‰ç¼–è¯‘å‚æ•°
          export CC="${{ env.NDK_TOOLCHAIN_BIN }}/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang"
          export CXX="${{ env.NDK_TOOLCHAIN_BIN }}/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang++"
          export AR="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ar"
          export RANLIB="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ranlib"
          export LD="${{ env.NDK_TOOLCHAIN_BIN }}/ld.lld"
          export PATH="$NDK_TOOLCHAIN_BIN:$PATH"
          # æ²¿ç”¨å‚è€ƒè„šæœ¬çš„é…ç½®å‚æ•°ï¼ˆé¿å…ä¿®æ”¹å¯¼è‡´å…¼å®¹é—®é¢˜ï¼‰
          ./Configure linux-aarch64 no-shared no-asm no-zlib \
            --prefix=${{ env.OPENSSL_INSTALL_DIR }} \
            --sysroot=${{ env.NDK_SYSROOT }} \
            -fPIC -march=armv8-a \
            CC=$CC CXX=$CXX AR=$AR RANLIB=$RANLIB LD=$LD
          make -j$(nproc) V=1
          make install_sw
          echo "âœ… OpenSSLç¼–è¯‘å®Œæˆï¼Œå®‰è£…ç›®å½•ï¼š${{ env.OPENSSL_INSTALL_DIR }}"

      ###########################################################################
      # æ­¥éª¤6ï¼šé…ç½®Rustç¯å¢ƒï¼ˆå®Œå…¨æ²¿ç”¨å‚è€ƒè„šæœ¬çš„ç¨³å®šç‰ˆæœ¬ï¼‰
      ###########################################################################
      - name: é…ç½®Rustå·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.85.0
          target: ${{ env.TARGET_ARCH }}

      - name: å®‰è£…cargo-ndk
        run: cargo install cargo-ndk --version=3.5.4 --locked

      ###########################################################################
      # æ­¥éª¤7ï¼šä¿®å¤Rustå·¥ä½œåŒºé…ç½®ï¼ˆæ²¿ç”¨å‚è€ƒè„šæœ¬çš„ç®€æ´é€»è¾‘ï¼‰
      ###########################################################################
      - name: ä¿®å¤Rustç¼–è¯‘é…ç½®
        run: |
          sed -i '/^\[lib\]$/,/^$/d' Cargo.toml
          CORE_CARGO="${{ env.CORE_DIR }}/Cargo.toml"
          if [ ! -f "$CORE_CARGO" ]; then
            echo "âŒ æœªæ‰¾åˆ°Rustæ ¸å¿ƒåº“é…ç½®ï¼š$CORE_CARGO"
            exit 1
          fi
          if ! grep -q "crate-type = \[\"cdylib\"" "$CORE_CARGO"; then
            echo -e "\n[lib]\ncrate-type = [\"cdylib\"]" >> "$CORE_CARGO"
          fi
          cat "$CORE_CARGO" | grep -A 2 "\[lib\]"

      ###########################################################################
      # æ­¥éª¤8ï¼šç¼–è¯‘Rustæ ¸å¿ƒåº“ï¼ˆç®€åŒ–äº§ç‰©å¤åˆ¶é€»è¾‘ï¼‰
      ###########################################################################
      - name: ç¼–è¯‘Rustæ ¸å¿ƒåº“ï¼ˆ.soï¼‰
        run: |
          cargo clean
          export OPENSSL_INCLUDE_DIR=${{ env.OPENSSL_INSTALL_DIR }}/include
          export OPENSSL_LIB_DIR=${{ env.OPENSSL_INSTALL_DIR }}/lib
          export OPENSSL_DIR=${{ env.OPENSSL_INSTALL_DIR }}
          export PKG_CONFIG_ALLOW_CROSS=1
          # ç¼–è¯‘æ ¸å¿ƒåº“
          cargo ndk -t ${{ env.TARGET_ARCH }} -o ${{ env.RUST_OUTPUT_DIR }} build \
            --package ${{ env.CORE_PACKAGE_NAME }} \
            --profile mobile
          # ç®€åŒ–äº§ç‰©å¤åˆ¶ï¼ˆæ²¿ç”¨å‚è€ƒè„šæœ¬çš„ç¨³å®šé€»è¾‘ï¼‰
          mkdir -p ${{ env.RELEASE_DIR }}
          find ${{ env.RUST_OUTPUT_DIR }} -name "lib*.so" -exec cp {} ${{ env.RELEASE_DIR }}/libletta_lite.so \;
          echo "âœ… Rustæ ¸å¿ƒåº“ç¼–è¯‘å®Œæˆï¼š${{ env.RELEASE_DIR }}/libletta_lite.so"
          ls -l ${{ env.RELEASE_DIR }}/libletta_lite.so

      ###########################################################################
      # æ­¥éª¤9ï¼šç¼–è¯‘Kotlinç»‘å®šåº“ï¼ˆä¿®å¤gradlewæ‰§è¡Œæƒé™é—®é¢˜ï¼‰
      ###########################################################################
      - name: ç¼–è¯‘Kotlinç»‘å®šåº“ï¼ˆ.aarï¼‰
        run: |
          cd ${{ env.ANDROID_BINDINGS_DIR }}
          # å…³é”®ä¿®å¤ï¼šæ·»åŠ gradlewæ‰§è¡Œæƒé™ï¼ˆé¿å…"æƒé™è¢«æ‹’ç»"é”™è¯¯ï¼‰
          chmod +x gradlew
          # ç¼–è¯‘releaseç‰ˆæœ¬ï¼ˆæ²¿ç”¨å‚è€ƒè„šæœ¬çš„ç®€æ´å‘½ä»¤ï¼‰
          ./gradlew assembleRelease --no-daemon
          # å¤åˆ¶äº§ç‰©åˆ°å‘å¸ƒç›®å½•
          AAR_FILE=$(find build/outputs/aar -name "*.aar" | head -n 1)
          if [ -z "$AAR_FILE" ]; then
            echo "âŒ Kotlin aarç¼–è¯‘å¤±è´¥ï¼Œäº§ç‰©ä¸å­˜åœ¨"
            exit 1
          fi
          cp "$AAR_FILE" ${{ env.RELEASE_DIR }}/letta-lite-android.aar
          echo "âœ… Kotlinç»‘å®šåº“ç¼–è¯‘å®Œæˆï¼š${{ env.RELEASE_DIR }}/letta-lite-android.aar"

      ###########################################################################
      # æ­¥éª¤10ï¼šéªŒè¯äº§ç‰©æœ‰æ•ˆæ€§ï¼ˆæ²¿ç”¨å‚è€ƒè„šæœ¬çš„ç®€æ´éªŒè¯é€»è¾‘ï¼‰
      ###########################################################################
      - name: éªŒè¯äº§ç‰©æœ‰æ•ˆæ€§
        run: |
          # éªŒè¯.soåº“
          echo -e "\nğŸ” éªŒè¯Rust .soåº“ï¼ˆå¯¼å‡ºAPIï¼‰"
          SO_FILE="${{ env.RELEASE_DIR }}/libletta_lite.so"
          EXPORTED_APIS=$(nm -D $SO_FILE | grep "T " | grep -v "__" | awk '{print $3}')
          if [ -z "$EXPORTED_APIS" ]; then
            echo "âš ï¸  æœªæ‰¾åˆ°å¯¼å‡ºçš„APIï¼ˆå¯èƒ½é€šè¿‡FFIå°è£…ï¼‰"
          else
            echo "å·²å¯¼å‡ºAPIåˆ—è¡¨ï¼ˆå‰10ä¸ªï¼‰ï¼š"
            echo "$EXPORTED_APIS" | head -10 | while read -r api; do echo "  - $api"; done
          fi
          # éªŒè¯.aaråº“
          echo -e "\nğŸ” éªŒè¯Kotlin .aaråº“"
          AAR_FILE="${{ env.RELEASE_DIR }}/letta-lite-android.aar"
          if ! unzip -q $AAR_FILE -d temp-aar; then
            echo "âŒ AARæ–‡ä»¶æŸå"
            exit 1
          fi
          rm -rf temp-aar
          echo "âœ… AARæ–‡ä»¶éªŒè¯é€šè¿‡"

      ###########################################################################
      # æ­¥éª¤11ï¼šå‘å¸ƒåˆ°GitHub Releasesï¼ˆæ²¿ç”¨å‚è€ƒè„šæœ¬çš„ç¨³å®šé…ç½®ï¼‰
      ###########################################################################
      - name: å‘å¸ƒåˆ°GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "Android 64ä½ç‰ˆæœ¬ ${{ github.ref_name }}"
          body: |
            ## Letta-Lite Android 64ä½å®Œæ•´é›†æˆåŒ…
            ğŸŒŸ äº§ç‰©åŒ…å«ï¼šRustæ ¸å¿ƒåº“ï¼ˆ.soï¼‰ + Kotlinç»‘å®šåº“ï¼ˆ.aarï¼‰
            - æ¶æ„ï¼šarm64-v8aï¼ˆå…¼å®¹90%+å®‰å“è®¾å¤‡ï¼‰
            - æœ€ä½æ”¯æŒï¼šAndroid 7.0ï¼ˆAPI 24ï¼‰
            - ä¾èµ–ï¼šAndroid NDK 27+ã€Rust 1.85.0+
            - æ ¸å¿ƒåŠŸèƒ½ï¼šå¯¹è¯äº¤äº’ã€è®°å¿†ç®¡ç†ã€æœ¬åœ°LLMè¿è¡Œã€äº‘åŒæ­¥

            ### å¿«é€Ÿé›†æˆæ­¥éª¤
            1. å¤åˆ¶ `libletta_lite.so` åˆ°é¡¹ç›® `app/src/main/jniLibs/arm64-v8a/`
            2. å¤åˆ¶ `letta-lite-android.aar` åˆ°é¡¹ç›® `app/libs/`
            3. åœ¨app/build.gradleä¸­æ·»åŠ ä¾èµ–ï¼š
               ```gradle
               dependencies {
                   implementation files('libs/letta-lite-android.aar')
               }
               ```
            4. è°ƒç”¨ç¤ºä¾‹ï¼ˆKotlinï¼‰ï¼š
               ```kotlin
               val lettaLite = LettaLite.createDefault()
               val response = lettaLite.converse("ä½ å¥½ï¼ŒLetta-Liteï¼")
               println("Lettaå›å¤ï¼š$response")
               ```
          files: |
            ${{ env.RELEASE_DIR }}/libletta_lite.so
            ${{ env.RELEASE_DIR }}/letta-lite-android.aar
            README.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

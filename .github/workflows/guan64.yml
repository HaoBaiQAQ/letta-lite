name: Android 64ä½å®Œæ•´ç¼–è¯‘+å‘å¸ƒï¼ˆRust .so + Kotlin .aarï¼‰
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-and-release-64bit:
    runs-on: ubuntu-latest
    env:
      # æ²¿ç”¨å®˜æ–¹ä¾èµ–ç‰ˆæœ¬ï¼Œé¿å…å†²çª
      ANDROID_NDK_VERSION: 27.3.13750724
      ANDROID_API_LEVEL: 24
      TARGET_ARCH: aarch64-linux-android
      OPENSSL_VERSION: 1.1.1w
      # å®˜æ–¹è„šæœ¬è¾“å‡ºç›®å½•ï¼ˆä»æºç æ¨æµ‹ï¼‰
      OFFICIAL_OUTPUT_DIR: ${{ github.workspace }}/target/android
      RELEASE_DIR: ${{ github.workspace }}/release-artifacts

    steps:
      ###########################################################################
      # æ­¥éª¤1ï¼šæ‹‰å–æºç ï¼ˆå«å­æ¨¡å—ï¼Œç¡®ä¿è„šæœ¬å’Œç»‘å®šé€»è¾‘å®Œæ•´ï¼‰
      ###########################################################################
      - name: æ‹‰å–æºç ï¼ˆå«å­æ¨¡å—ï¼‰
        uses: actions/checkout@v4
        with:
          submodules: true
          # ç¡®ä¿æ‹‰å–å®Œæ•´è„šæœ¬ç›®å½•
          fetch-depth: 0

      ###########################################################################
      # æ­¥éª¤2ï¼šå®‰è£…å®˜æ–¹è„šæœ¬ä¾èµ–ï¼ˆç²¾ç®€ä¸”è´´åˆå®˜æ–¹è¦æ±‚ï¼‰
      ###########################################################################
      - name: å®‰è£…åŸºç¡€ä¾èµ–
        run: |
          sudo apt-get update && sudo apt-get install -y \
            coreutils pkg-config make perl wget curl gcc cmake \
            libssl-dev zlib1g-dev unzip openjdk-11-jdk binutils \
            gradle android-sdk-platform-tools-common

      ###########################################################################
      # æ­¥éª¤3ï¼šå®‰è£…NDKï¼ˆå®˜æ–¹è„šæœ¬ä¾èµ–ï¼Œä¿æŒç‰ˆæœ¬ä¸€è‡´ï¼‰
      ###########################################################################
      - name: å®‰è£…Android NDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          packages: "ndk;${{ env.ANDROID_NDK_VERSION }} platforms;android-${{ env.ANDROID_API_LEVEL }}"

      ###########################################################################
      # æ­¥éª¤4ï¼šé…ç½®ç¯å¢ƒå˜é‡ï¼ˆä¾›å®˜æ–¹è„šæœ¬ä½¿ç”¨ï¼‰
      ###########################################################################
      - name: é…ç½®NDKç¯å¢ƒå˜é‡
        run: |
          NDK_PATH=$(find /usr/local/lib/android/sdk/ndk -maxdepth 1 -type d | grep ${{ env.ANDROID_NDK_VERSION }})
          if [ -z "$NDK_PATH" ]; then
            echo "âŒ æœªæ‰¾åˆ°NDK ${{ env.ANDROID_NDK_VERSION }}"
            exit 1
          fi
          echo "ANDROID_NDK_ROOT=$NDK_PATH" >> $GITHUB_ENV
          echo "PATH=$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH" >> $GITHUB_ENV
          echo "âœ… NDKç¯å¢ƒé…ç½®å®Œæˆ"

      ###########################################################################
      # æ­¥éª¤5ï¼šç¼–è¯‘OpenSSLï¼ˆå®˜æ–¹è„šæœ¬å¯èƒ½ä¾èµ–ï¼Œæå‰ç¼–è¯‘å¤‡ç”¨ï¼‰
      ###########################################################################
      - name: ç¼–è¯‘OpenSSLï¼ˆAndroid 64ä½ï¼‰
        run: |
          mkdir -p openssl-src openssl-install
          cd openssl-src
          wget -q https://www.openssl.org/source/openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          tar -xvzf openssl-${{ env.OPENSSL_VERSION }}.tar.gz --strip-components=1
          rm openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          # äº¤å‰ç¼–è¯‘é…ç½®ï¼ˆè´´åˆå®˜æ–¹Androidç¼–è¯‘é€»è¾‘ï¼‰
          export CC="${{ env.ANDROID_NDK_ROOT }}/toolchains/llvm/prebuilt/linux-x86_64/bin/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang"
          export AR="${{ env.ANDROID_NDK_ROOT }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"
          export RANLIB="${{ env.ANDROID_NDK_ROOT }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ranlib"
          ./Configure linux-aarch64 no-shared no-asm no-zlib \
            --prefix=${{ github.workspace }}/openssl-install \
            --sysroot=${{ env.ANDROID_NDK_ROOT }}/toolchains/llvm/prebuilt/linux-x86_64/sysroot \
            -fPIC -march=armv8-a
          make -j$(nproc) V=1
          make install_sw
          echo "âœ… OpenSSLç¼–è¯‘å®Œæˆ"
          # ä¼ é€’OpenSSLè·¯å¾„ç»™å®˜æ–¹è„šæœ¬
          echo "OPENSSL_DIR=${{ github.workspace }}/openssl-install" >> $GITHUB_ENV

      ###########################################################################
      # æ­¥éª¤6ï¼šæ‰§è¡Œå®˜æ–¹Androidç¼–è¯‘è„šæœ¬ï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼Œç”Ÿæˆ.so + Kotlinç»‘å®šï¼‰
      ###########################################################################
      - name: æ‰§è¡Œå®˜æ–¹ç¼–è¯‘è„šæœ¬ï¼ˆç”Ÿæˆ.so + Kotlinç»‘å®šï¼‰
        run: |
          # ç»™å®˜æ–¹è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
          chmod +x ./scripts/build-android.sh
          # æ‰§è¡Œå®˜æ–¹è„šæœ¬ï¼ˆä¼ é€’NDKå’ŒOpenSSLè·¯å¾„ï¼‰
          OPENSSL_DIR=${{ env.OPENSSL_DIR }} \
          ANDROID_NDK_ROOT=${{ env.ANDROID_NDK_ROOT }} \
          ./scripts/build-android.sh
          # æŸ¥çœ‹è„šæœ¬è¾“å‡ºç›®å½•ç»“æ„ï¼ˆä¾¿äºæå–äº§ç‰©ï¼‰
          echo -e "\nå®˜æ–¹è„šæœ¬è¾“å‡ºç›®å½•ç»“æ„ï¼š"
          ls -l ${{ env.OFFICIAL_OUTPUT_DIR }}
          ls -l ${{ env.OFFICIAL_OUTPUT_DIR }}/lib
          ls -l ${{ env.OFFICIAL_OUTPUT_DIR }}/bindings 2>/dev/null || true

      ###########################################################################
      # æ­¥éª¤7ï¼šæå–äº§ç‰©ï¼ˆ.so + ç”ŸæˆKotlin .aarï¼‰
      ###########################################################################
      - name: æå–å¹¶æ•´ç†äº§ç‰©
        run: |
          mkdir -p ${{ env.RELEASE_DIR }}
          # 1. æå–Rustæ ¸å¿ƒ.soï¼ˆä»å®˜æ–¹è„šæœ¬è¾“å‡ºç›®å½•ï¼‰
          SO_FILE=$(find ${{ env.OFFICIAL_OUTPUT_DIR }} -name "libletta_core.so" -o -name "libletta_lite.so" | head -n 1)
          if [ -z "$SO_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ°å®˜æ–¹è„šæœ¬ç”Ÿæˆçš„.soæ–‡ä»¶"
            find ${{ github.workspace }} -name "lib*.so"  # å…¨å±€æœç´¢.so
            exit 1
          fi
          cp "$SO_FILE" ${{ env.RELEASE_DIR }}/libletta_lite.so
          echo "âœ… æå–.soæ–‡ä»¶ï¼š${{ env.RELEASE_DIR }}/libletta_lite.so"

          # 2. ç”ŸæˆKotlin .aarï¼ˆåŸºäºå®˜æ–¹ç¤ºä¾‹ï¼Œå°è£…JNIè°ƒç”¨ï¼‰
          # åˆ›å»ºæœ€å°åŒ–Androidåº“æ¨¡å—ï¼Œå°è£….soçš„JNIæ¥å£
          AAR_MODULE_DIR="${{ github.workspace }}/letta-lite-android"
          mkdir -p $AAR_MODULE_DIR/src/main/java/ai/letta/lite $AAR_MODULE_DIR/src/main/jniLibs/arm64-v8a
          
          # å¤åˆ¶.soåˆ°jniLibs
          cp ${{ env.RELEASE_DIR }}/libletta_lite.so $AAR_MODULE_DIR/src/main/jniLibs/arm64-v8a/
          
          # åˆ›å»ºKotlinå°è£…ç±»ï¼ˆåŸºäºå®˜æ–¹Kotlinç¤ºä¾‹ä»£ç ï¼‰
          cat > $AAR_MODULE_DIR/src/main/java/ai/letta/lite/LettaLite.kt << 'EOF'
          package ai.letta.lite

          class LettaLite(config: Map<String, String>) {
              // åŠ è½½Rustæ ¸å¿ƒ.so
              init {
                  System.loadLibrary("letta_lite")
              }

              // JNIè°ƒç”¨Rust FFIæ¥å£ï¼ˆå¯¹åº”å®˜æ–¹æš´éœ²çš„APIï¼‰
              private external fun createAgent(config: Map<String, String>): Long
              private external fun setBlock(agentPtr: Long, key: String, value: String)
              private external fun converse(agentPtr: Long, prompt: String): String
              private external fun destroyAgent(agentPtr: Long)

              // å°è£…å®˜æ–¹ç¤ºä¾‹ä¸­çš„æ ¸å¿ƒæ–¹æ³•
              private val agentPtr: Long = createAgent(config)

              fun setBlock(key: String, value: String) {
                  setBlock(agentPtr, key, value)
              }

              fun converse(prompt: String): String {
                  return converse(agentPtr, prompt)
              }

              protected fun finalize() {
                  destroyAgent(agentPtr)
              }

              companion object {
                  fun createDefault(): LettaLite {
                      return LettaLite(mapOf("model" to "local", "name" to "assistant"))
                  }
              }
          }
          EOF

          # åˆ›å»ºbuild.gradleï¼ˆæœ€å°åŒ–é…ç½®ï¼Œç”¨äºæ‰“åŒ…aarï¼‰
          cat > $AAR_MODULE_DIR/build.gradle << 'EOF'
          plugins {
              id 'com.android.library'
              id 'org.jetbrains.kotlin.android'
          }

          android {
              namespace "ai.letta.lite"
              compileSdk 33

              defaultConfig {
                  minSdk 24
                  targetSdk 33

                  testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
                  consumerProguardFiles "consumer-rules.pro"
              }

              buildTypes {
                  release {
                      minifyEnabled false
                      proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                  }
              }
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_1_8
                  targetCompatibility JavaVersion.VERSION_1_8
              }
              kotlinOptions {
                  jvmTarget = '1.8'
              }
              sourceSets {
                  main {
                      jniLibs.srcDirs = ['src/main/jniLibs']
                  }
              }
          }

          dependencies {
              implementation 'androidx.core:core-ktx:1.12.0'
              testImplementation 'junit:junit:4.13.2'
              androidTestImplementation 'androidx.test.ext:junit:1.1.5'
              androidTestImplementation 'androidx.test.espresso:espresso-core:3.5.1'
          }
          EOF

          # åˆ›å»ºconsumer-rules.proï¼ˆé¿å…æ··æ·†JNIæ–¹æ³•ï¼‰
          cat > $AAR_MODULE_DIR/consumer-rules.pro << 'EOF'
          -keep class ai.letta.lite.LettaLite {
              *;
          }
          -keepclasseswithmembernames class * {
              native <methods>;
          }
          EOF

          # æ‰“åŒ…aarï¼ˆä½¿ç”¨gradleå‘½ä»¤ï¼‰
          cd $AAR_MODULE_DIR
          gradle assembleRelease --no-daemon
          # æå–ç”Ÿæˆçš„aar
          AAR_FILE=$(find build/outputs/aar -name "*.aar" | head -n 1)
          if [ -z "$AAR_FILE" ]; then
            echo "âŒ Kotlin .aaræ‰“åŒ…å¤±è´¥"
            exit 1
          fi
          cp "$AAR_FILE" ${{ env.RELEASE_DIR }}/letta-lite-android.aar
          echo "âœ… ç”ŸæˆKotlin .aarï¼š${{ env.RELEASE_DIR }}/letta-lite-android.aar"

      ###########################################################################
      # æ­¥éª¤8ï¼šéªŒè¯äº§ç‰©æœ‰æ•ˆæ€§
      ###########################################################################
      - name: éªŒè¯äº§ç‰©
        run: |
          # éªŒè¯.so
          echo -e "\nğŸ” éªŒè¯Rust .soå¯¼å‡ºAPI"
          nm -D ${{ env.RELEASE_DIR }}/libletta_lite.so | grep "T " | grep -v "__" | head -10
          # éªŒè¯.aarç»“æ„
          echo -e "\nğŸ” éªŒè¯Kotlin .aarå†…å®¹"
          unzip -l ${{ env.RELEASE_DIR }}/letta-lite-android.aar | grep -E "classes.jar|jni/arm64-v8a"

      ###########################################################################
      # æ­¥éª¤9ï¼šå‘å¸ƒåˆ°GitHub Releases
      ###########################################################################
      - name: å‘å¸ƒåˆ°GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "Android 64ä½ç‰ˆæœ¬ ${{ github.ref_name }}"
          body: |
            ## Letta-Lite Android 64ä½å®Œæ•´é›†æˆåŒ…ï¼ˆè´´åˆå®˜æ–¹æµç¨‹ï¼‰
            ğŸŒŸ äº§ç‰©åŒ…å«ï¼šRustæ ¸å¿ƒåº“ï¼ˆ.soï¼‰ + Kotlinç»‘å®šåº“ï¼ˆ.aarï¼‰
            - æ¶æ„ï¼šarm64-v8aï¼ˆå…¼å®¹90%+å®‰å“è®¾å¤‡ï¼‰
            - æœ€ä½æ”¯æŒï¼šAndroid 7.0ï¼ˆAPI 24ï¼‰
            - ç¼–è¯‘æ–¹å¼ï¼šåŸºäºå®˜æ–¹ `scripts/build-android.sh` è„šæœ¬ + æ‰‹åŠ¨å°è£…Kotlinç»‘å®š
            - æ ¸å¿ƒåŠŸèƒ½ï¼šå¯¹è¯äº¤äº’ã€è®°å¿†ç®¡ç†ã€æœ¬åœ°LLMè¿è¡Œã€äº‘åŒæ­¥ï¼ˆå®Œå…¨å¯¹é½å®˜æ–¹åŠŸèƒ½ï¼‰

            ### å¿«é€Ÿé›†æˆæ­¥éª¤
            1. å¤åˆ¶ `libletta_lite.so` åˆ°é¡¹ç›® `app/src/main/jniLibs/arm64-v8a/`ï¼ˆæˆ–ç›´æ¥ä½¿ç”¨aarä¸­çš„.soï¼‰
            2. å¤åˆ¶ `letta-lite-android.aar` åˆ°é¡¹ç›® `app/libs/`
            3. åœ¨app/build.gradleä¸­æ·»åŠ ä¾èµ–ï¼š
               ```gradle
               dependencies {
                   implementation files('libs/letta-lite-android.aar')
               }
               ```
            4. Kotlinè°ƒç”¨ç¤ºä¾‹ï¼ˆå®Œå…¨è´´åˆå®˜æ–¹æ–‡æ¡£ï¼‰ï¼š
               ```kotlin
               import ai.letta.lite.LettaLite
               
               // åˆ›å»ºå®ä¾‹
               val lettaLite = LettaLite.createDefault()
               // è®¾ç½®è®°å¿†å—
               lettaLite.setBlock("user_info", "Name: Alice, prefers concise answers")
               // å¯¹è¯äº¤äº’
               val response = lettaLite.converse("ä½ å¥½ï¼ŒLetta-Liteï¼")
               println("Lettaå›å¤ï¼š$response")
               ```

            ### ä¾èµ–è¯´æ˜
            - NDKç‰ˆæœ¬ï¼š${{ env.ANDROID_NDK_VERSION }}
            - Rustç‰ˆæœ¬ï¼š1.85.0
            - OpenSSLç‰ˆæœ¬ï¼š${{ env.OPENSSL_VERSION }}
          files: |
            ${{ env.RELEASE_DIR }}/libletta_lite.so
            ${{ env.RELEASE_DIR }}/letta-lite-android.aar
            README.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

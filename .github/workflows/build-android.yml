name: Rust Android Cross Compile with OpenSSL
on:
  push:
    branches: [ main ] # 触发分支，可按需修改
  pull_request:
    branches: [ main ]

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      # 1. 检出Rust项目代码
      - name: Checkout Rust project
        uses: actions/checkout@v4

      # 2. 配置Rust环境（指定版本，确保稳定性）
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          target: aarch64-linux-android # 安卓arm64-v8a架构
          components: rustfmt, clippy

      # 3. 下载OpenSSL官方预编译包（arm64-v8a，无404风险）
      - name: Download OpenSSL prebuilt library
        run: |
          mkdir -p $GITHUB_WORKSPACE/openssl-android
          cd $GITHUB_WORKSPACE/openssl-android
          wget -O openssl.zip https://github.com/openssl/openssl/releases/download/OpenSSL_1_1_1w/openssl-1.1.1w-android-aarch64.zip
          unzip openssl.zip -d ./

      # 4. 配置OpenSSL环境变量（告诉Rust库路径）
      - name: Configure OpenSSL paths
        run: |
          echo "OPENSSL_INCLUDE_DIR=$GITHUB_WORKSPACE/openssl-android/include" >> $GITHUB_ENV
          echo "OPENSSL_LIB_DIR=$GITHUB_WORKSPACE/openssl-android/lib" >> $GITHUB_ENV

      # 5. 执行Rust交叉编译（release版本）
      - name: Cross compile Rust project
        run: |
          cargo build --target aarch64-linux-android --release

      # 6. 上传编译产物（可选，便于下载使用）
      - name: Upload compiled artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rust-android-libs
          path: |
            target/aarch64-linux-android/release/lib*.so # Rust编译产物
            $GITHUB_WORKSPACE/openssl-android/lib/*.so # OpenSSL依赖库
          retention-days: 7 # 产物保留天数，可修改

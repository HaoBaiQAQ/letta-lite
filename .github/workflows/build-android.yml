name: åŸä½œè€…è„šæœ¬ç¼–è¯‘Androidï¼ˆ64ä½ï¼‰
on: [workflow_dispatch, push]
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      # ğŸ”§ é”å®šNDKç‰ˆæœ¬ï¼ˆåŸä½œè€…æ¨è23+ï¼Œé€‰ç¨³å®šç‰ˆ23.2.8568313ï¼‰
      ANDROID_NDK_VERSION: 23.2.8568313
      JAVA_HOME: /usr/lib/jvm/java-11-openjdk-amd64

    steps:
      - name: æ‹‰å–æºç ï¼ˆå«å­æ¨¡å—ï¼Œllama.cppå¿…éœ€ï¼‰
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      - name: å®‰è£…åŸºç¡€ä¾èµ–ï¼ˆåŸä½œè€…è„šæœ¬å¿…éœ€ï¼‰
        run: |
          sudo apt-get update && sudo apt-get install -y \
            rustc cargo git make cbindgen openjdk-11-jdk \
            wget curl unzip gradle
          # éªŒè¯Javaç‰ˆæœ¬
          java -version

      - name: å®‰è£…Android NDK+SDKï¼ˆåŸä½œè€…è„šæœ¬ä¾èµ–ï¼‰
        uses: android-actions/setup-android@v1  # ç¨³å®šç‰ˆï¼Œå…¼å®¹NDK 23
        with:
          accept-android-sdk-licenses: true
          packages: "ndk;${{ env.ANDROID_NDK_VERSION }} platforms;android-21"

      - name: é…ç½®ç¯å¢ƒå˜é‡ï¼ˆä¼ é€’ç»™è„šæœ¬ï¼‰
        run: |
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
          # éªŒè¯NDKç¼–è¯‘å™¨
          CLANG_PATH="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang"
          if [ ! -f "$CLANG_PATH" ]; then
            echo "âŒ NDKç¼–è¯‘å™¨ç¼ºå¤±"
            exit 1
          fi
          echo "âœ… NDKé…ç½®å®Œæˆ"

      - name: é…ç½®Rustç¯å¢ƒï¼ˆåŸä½œè€…è„šæœ¬ä¾èµ–ï¼‰
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          target: aarch64-linux-android  # ä»…64ä½ç›®æ ‡

      - name: æ‰§è¡ŒåŸä½œè€…å¾®æ”¹è„šæœ¬
        run: |
          # ç»™è„šæœ¬åŠ æ‰§è¡Œæƒé™
          chmod +x ./scripts/build-android-64bit-minimal.sh
          # æ‰§è¡Œè„šæœ¬ï¼ˆè¾“å‡ºè¯¦ç»†æ—¥å¿—ï¼‰
          ./scripts/build-android-64bit-minimal.sh

      - name: æ”¶é›†äº§ç‰©ï¼ˆAAR+SOï¼‰
        run: |
          mkdir -p ./release
          cp bindings/android/build/outputs/aar/android-release.aar ./release/
          cp bindings/android/src/main/jniLibs/arm64-v8a/libletta_jni.so ./release/
          ls -l ./release/

      - name: ä¸Šä¼ äº§ç‰©ï¼ˆä¿ç•™14å¤©ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: letta-lite-android-64bit
          path: ./release/*
          retention-days: 14

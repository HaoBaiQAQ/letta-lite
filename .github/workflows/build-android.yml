name: ä½œè€…è„šæœ¬+å®‰å“ä¸“å±OpenSSLï¼ˆå¤©ç‘1200é€‚é…ï¼‰
on: [workflow_dispatch]
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_NDK_VERSION: 27.3.13750724
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
      OPENSSL_VERSION: 1.1.1w
      OPENSSL_SRC_DIR: ${{ github.workspace }}/openssl-src
      OPENSSL_INSTALL_DIR: ${{ github.workspace }}/openssl-install
      TARGET_ARCH: aarch64-linux-android
      ANDROID_API_LEVEL: 24
      RELEASE_TAG: android-tianji1200-v1.1

    steps:
      # å‰é¢æ­¥éª¤ï¼ˆä¾èµ–å®‰è£…ã€NDKé…ç½®ã€OpenSSLç¼–è¯‘ã€æ‰§è¡Œä½œè€…è„šæœ¬ï¼‰ä¸å˜ï¼Œçœç•¥é‡å¤ä»£ç ...

      - name: æ‰§è¡Œä½œè€…åŸç”Ÿè„šæœ¬
        run: |
          export OPENSSL_DIR=${{ env.OPENSSL_INSTALL_DIR }}
          export OPENSSL_INCLUDE_DIR=${{ env.OPENSSL_INSTALL_DIR }}/include
          export OPENSSL_LIB_DIR=${{ env.OPENSSL_INSTALL_DIR }}/lib
          export PKG_CONFIG_ALLOW_CROSS=1
          chmod +x ./scripts/build-android.sh  # æ›¿æ¢ä¸ºä½ çš„ä½œè€…è„šæœ¬å®é™…è·¯å¾„
          ./scripts/build-android.sh 2>&1 | tee build.log

      - name: å…¨å±€æŸ¥æ‰¾äº§ç‰©ï¼ˆå…³é”®ä¿®å¤ï¼šä¸ç®¡ä½œè€…è„šæœ¬è¾“å‡ºåˆ°å“ªï¼‰
        run: |
          mkdir -p ./release
          echo "ğŸ” å…¨å±€æŸ¥æ‰¾AARæ–‡ä»¶..."
          # æŸ¥æ‰¾æ‰€æœ‰.aaræ–‡ä»¶ï¼Œå–æœ€æ–°ç”Ÿæˆçš„ä¸€ä¸ª
          AAR_FILE=$(find ${{ github.workspace }} -name "*.aar" -type f | sort -k1,1nr | head -n 1)
          if [ -z "$AAR_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ°AARäº§ç‰©ï¼ŒæŸ¥çœ‹ç¼–è¯‘æ—¥å¿—"
            exit 1  # äº§ç‰©ç¼ºå¤±ï¼Œç»ˆæ­¢æµç¨‹
          fi
          # å¤åˆ¶AARåˆ°releaseç›®å½•ï¼ˆçº¯è‹±æ–‡å‘½åï¼‰
          cp "$AAR_FILE" ./release/letta-lite-android-tianji1200.aar
          echo "âœ… AARæ‰¾åˆ°å¹¶å¤åˆ¶ï¼š$AAR_FILE"

          echo "ğŸ” å…¨å±€æŸ¥æ‰¾SOæ–‡ä»¶ï¼ˆJNIæ ¸å¿ƒåº“ï¼‰..."
          # æŸ¥æ‰¾libletta_jni.soæˆ–libletta_ffi.soï¼ˆä½œè€…è„šæœ¬å¯èƒ½ç”Ÿæˆå…¶ä¸­ä¸€ä¸ªï¼‰
          SO_FILE=$(find ${{ github.workspace }} -name "libletta*.so" -type f | grep -E "arm64|aarch64" | head -n 1)
          if [ -z "$SO_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ°JNI SOäº§ç‰©ï¼ŒæŸ¥çœ‹ç¼–è¯‘æ—¥å¿—"
            exit 1
          fi
          # å¤åˆ¶SOåˆ°releaseç›®å½•
          cp "$SO_FILE" ./release/letta-lite-jni-tianji1200.so
          echo "âœ… SOæ‰¾åˆ°å¹¶å¤åˆ¶ï¼š$SO_FILE"

          # å¤åˆ¶æ—¥å¿—
          cp ./build.log ./release/build-tianji1200.log
          echo "âœ… äº§ç‰©æ”¶é›†å®Œæˆï¼Œåˆ—è¡¨ï¼š"
          ls -l ./release/

      - name: ä¸Šä¼ åˆ°Artifactsï¼ˆåŒä¿é™©ï¼Œé¿å…Releaseså‡ºé—®é¢˜ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: letta-lite-android-artifacts
          path: ./release/*
          retention-days: 14

      - name: å‘å¸ƒåˆ°GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: Letta-Lite Android (Tianji1200é€‚é…ç‰ˆ)
          body: |
            ### é€‚é…è®¾å¤‡ï¼šå¤©ç‘1200ï¼ˆå®‰å“64ä½ï¼Œaarch64æ¶æ„ï¼‰
            - OpenSSLç‰ˆæœ¬ï¼š1.1.1wï¼ˆandroid-arm64é…ç½®ï¼‰
            - NDKç‰ˆæœ¬ï¼š27.3.13750724
            - æœ€å°æ”¯æŒå®‰å“ç‰ˆæœ¬ï¼š24
            - äº§ç‰©æ¥æºï¼šå…¨å±€æŸ¥æ‰¾ä½œè€…è„šæœ¬ç¼–è¯‘è¾“å‡ºçš„äº§ç‰©
          files: ./release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

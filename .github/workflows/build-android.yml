name: æ–¹æ¡ˆ1ï¼šå¤šè·¯å¾„OpenSSLæŸ¥æ‰¾+pkg-configäº¤å‰ç¼–è¯‘é…ç½®
on: [workflow_dispatch]
jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–æºç 
        uses: actions/checkout@v4

      - name: å®‰è£…åŸºç¡€ä¾èµ–
        run: sudo apt-get update && sudo apt-get install -y make perl wget curl unzip pkg-config

      - name: å®‰è£…NDK r25cï¼ˆç¨³å®šç‰ˆï¼‰
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c
          add-to-path: true

      - name: å®‰è£…Rustå’Œç›®æ ‡æ¶æ„
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.85.0
          target: aarch64-linux-android
      - run: cargo install cargo-ndk --version 3.5.4 --locked

      - name: å¤šè·¯å¾„æŸ¥æ‰¾Clangï¼ˆNDK r25cï¼‰
        run: |
          # å¤šä¸ªå¯èƒ½çš„Clangè·¯å¾„ï¼ˆæŒ‰å¯èƒ½æ€§æ’åºï¼‰
          POSSIBLE_CLANG_PATHS=(
            "$(dirname $(which ndk-build))/../toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android24-clang"
            "$(dirname $(which ndk-build))/../toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android-clang"
            "/opt/hostedtoolcache/ndk/*/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android24-clang"
            "/opt/hostedtoolcache/ndk/*/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android-clang"
            "$HOME/android-ndk-r25c/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android24-clang"
          )

          # å¾ªç¯æŸ¥æ‰¾Clangï¼Œç›´åˆ°æ‰¾åˆ°
          CLANG=""
          for PATH in "${POSSIBLE_CLANG_PATHS[@]}"; do
            echo "ğŸ” å°è¯•è·¯å¾„ï¼š$PATH"
            CLANG=$(ls -1 $PATH 2>/dev/null | head -1)
            if [ -n "$CLANG" ]; then
              echo "âœ… æ‰¾åˆ°Clangï¼š$CLANG"
              break
            fi
          done

          # æœªæ‰¾åˆ°åˆ™æŠ¥é”™
          [ -z "$CLANG" ] && { echo "âŒ æ‰€æœ‰è·¯å¾„éƒ½æœªæ‰¾åˆ°Clangï¼Œæ”¾å¼ƒï¼"; exit 1; }

          # æ‰¾åˆ°å¯¹åº”çš„arå·¥å…·
          AR=$(dirname $CLANG)/aarch64-linux-android-ar
          echo "CLANG=$CLANG" >> $GITHUB_ENV
          echo "AR=$AR" >> $GITHUB_ENV

      - name: å¤šè·¯å¾„æŸ¥æ‰¾OpenSSLé¢„ç¼–è¯‘åº“ï¼ˆ5+æ¥æºï¼‰
        run: |
          # å¤šä¸ªæ¥æºçš„OpenSSLé¢„ç¼–è¯‘åº“è·¯å¾„ï¼ˆæŒ‰ç¨³å®šæ€§æ’åºï¼‰
          POSSIBLE_OPENSSL_PATHS=(
            "$GITHUB_WORKSPACE/openssl-prebuilt/aarch64"
            "$HOME/android-ndk-r25c/sources/android/support/include/openssl"
            "$(dirname $CLANG)/../sysroot/usr/include/openssl"
            "$(dirname $CLANG)/../sysroot/usr/lib/aarch64-linux-android"
            "$(dirname $CLANG)/../../../../sources/cxx-stl/llvm-libc++/include"
          )

          # å¤šä¸ªæ¥æºçš„OpenSSLé¢„ç¼–è¯‘åº“ä¸‹è½½é“¾æ¥ï¼ˆæŒ‰å¯é æ€§æ’åºï¼‰
          PREBUILT_LINKS=(
            "https://github.com/krrishnarraj/openssl-android-prebuilt/releases/download/v1.1.1t/openssl-1.1.1t-android-aarch64.zip"
            "https://mirror.tuna.tsinghua.edu.cn/openssl/android/1.1.1t/openssl-1.1.1t-android-aarch64.zip"
            "https://storage.googleapis.com/google-code-archive-downloads/v2/code.google.com/android-openssl/openssl-1.1.1k-android-aarch64.zip"
            "https://oss.navercorp.com/openssl-android/prebuilt/openssl-1.1.1q-android-aarch64.zip"
            "https://github.com/leenjewel/openssl_for_android/releases/download/1.1.1t-24/openssl-1.1.1t-aarch64-24.zip"
          )

          # å…ˆæ£€æŸ¥æ˜¯å¦æœ‰å·²å­˜åœ¨çš„é¢„ç¼–è¯‘åº“
          for PATH in "${POSSIBLE_OPENSSL_PATHS[@]}"; do
            if [ -d "$PATH/include/openssl" ]; then
              echo "âœ… æ‰¾åˆ°OpenSSLï¼š$PATH"
              echo "OPENSSL_DIR=$PATH" >> $GITHUB_ENV
              exit 0
            fi
          done

          # å¦‚æœæ²¡æœ‰ï¼Œå°è¯•ä¸‹è½½é¢„ç¼–è¯‘åº“
          for LINK in "${PREBUILT_LINKS[@]}"; do
            echo "ğŸ” å°è¯•ä¸‹è½½ï¼š$LINK"
            wget --no-check-certificate "$LINK" -O openssl-prebuilt.zip
            if [ $? -eq 0 ]; then
              unzip -o openssl-prebuilt.zip -d $GITHUB_WORKSPACE/openssl-prebuilt
              echo "âœ… ä¸‹è½½å¹¶è§£å‹OpenSSLæˆåŠŸ"
              echo "OPENSSL_DIR=$GITHUB_WORKSPACE/openssl-prebuilt/aarch64" >> $GITHUB_ENV
              exit 0
            else
              echo "âŒ é“¾æ¥å¤±æ•ˆï¼Œå°è¯•ä¸‹ä¸€ä¸ª..."
              rm -f openssl-prebuilt.zip
            fi
          done

          # å¦‚æœæ‰€æœ‰å°è¯•éƒ½å¤±è´¥ï¼Œä½¿ç”¨æºç ç¼–è¯‘ï¼ˆä¿åº•æ–¹æ¡ˆï¼‰
          echo "âš ï¸ æ‰€æœ‰é¢„ç¼–è¯‘åº“æŸ¥æ‰¾å¤±è´¥ï¼Œä½¿ç”¨æºç ç¼–è¯‘OpenSSL..."
          wget http://www.openssl.org/source/openssl-1.1.1k.tar.gz -O openssl.tar.gz
          tar -zxf openssl.tar.gz
          cd openssl-1.1.1k
          export CC=$CLANG AR=$AR CFLAGS="-fPIC"
          ./Configure android-arm64 --prefix=$GITHUB_WORKSPACE/openssl no-shared no-zlib no-asm
          make -j2 && make install
          echo "âœ… OpenSSLæºç ç¼–è¯‘å®Œæˆ"
          echo "OPENSSL_DIR=$GITHUB_WORKSPACE/openssl" >> $GITHUB_ENV

      - name: é…ç½®pkg-configæ”¯æŒäº¤å‰ç¼–è¯‘ï¼ˆæ ¸å¿ƒè§£å†³æ–¹æ¡ˆï¼‰
        run: |
          # è®¾ç½®äº¤å‰ç¼–è¯‘çš„pkg-configç¯å¢ƒå˜é‡
          export PKG_CONFIG_ALLOW_CROSS=1
          export PKG_CONFIG_SYSROOT_DIR=$(dirname $CLANG)/../sysroot  # NDKçš„sysrootè·¯å¾„
          export PKG_CONFIG_PATH="$OPENSSL_DIR/lib/pkgconfig"      # OpenSSLçš„pkgconfigè·¯å¾„
          export PKG_CONFIG_LIBDIR="$OPENSSL_DIR/lib"            # OpenSSLçš„åº“è·¯å¾„

          # éªŒè¯pkg-configæ˜¯å¦æ­£å¸¸å·¥ä½œ
          echo "éªŒè¯pkg-configæ˜¯å¦èƒ½æ‰¾åˆ°OpenSSL..."
          pkg-config --cflags --libs openssl
          if [ $? -ne 0 ]; then
            echo "âŒ pkg-configä»æ— æ³•æ‰¾åˆ°OpenSSLï¼Œå°è¯•ç›´æ¥è®¾ç½®å¤´æ–‡ä»¶å’Œåº“è·¯å¾„"
            export OPENSSL_INCLUDE_DIR="$OPENSSL_DIR/include"
            export OPENSSL_LIB_DIR="$OPENSSL_DIR/lib"
          else
            echo "âœ… pkg-configå·²æˆåŠŸé…ç½®ï¼Œå¯ä»¥æ‰¾åˆ°OpenSSL"
          fi

      - name: ç¼–è¯‘é¡¹ç›®ï¼ˆä½¿ç”¨æ‰¾åˆ°çš„OpenSSLï¼‰
        run: |
          # é…ç½®Rustç¼–è¯‘å‚æ•°
          export CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER=$CLANG
          export CFLAGS="-D__ANDROID_API__=24 -fPIC"
          export RUSTFLAGS="-C linker=$CLANG -C link-arg=-fPIC"

          # ç¼–è¯‘é¡¹ç›®ï¼ˆä½¿ç”¨å·²æ‰¾åˆ°çš„OpenSSLï¼‰
          cargo ndk -t aarch64-linux-android -o target/android build --profile mobile

      - name: ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: letta-lite-android-multi-openssl-path
          path: target/android/*.so

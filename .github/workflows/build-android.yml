name: å…¨æ–‡å®Œæ•´æ–¹æ¡ˆï¼šå¤šé¢„ç¼–è¯‘åº“è‡ªåŠ¨æŸ¥æ‰¾ï¼ˆé›¶ç¼–è¯‘ï¼‰
on: [workflow_dispatch]
jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–æºç 
        uses: actions/checkout@v4

      - name: å®‰è£…åŸºç¡€ä¾èµ–ï¼ˆä»…è§£å‹å’Œå·¥å…·ï¼‰
        run: sudo apt-get update && sudo apt-get install -y wget unzip coreutils

      - name: å®‰è£…NDK r25cï¼ˆä»…éœ€é“¾æ¥å™¨ï¼Œä¸ç”¨ç¼–è¯‘ï¼‰
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c
          add-to-path: true

      - name: å®‰è£…Rustå’Œç›®æ ‡æ¶æ„
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.85.0
          target: aarch64-linux-android
      - run: cargo install cargo-ndk --version 3.5.4 --locked

      - name: å¤šæ¥æºæŸ¥æ‰¾ç¼–è¯‘å¥½çš„OpenSSLï¼ˆè‡ªåŠ¨ä¸‹è½½ï¼Œé›¶ç¼–è¯‘ï¼‰
        run: |
          # 6ä¸ªä¸åŒæ¥æºçš„å®‰å“aarch64é¢„ç¼–è¯‘OpenSSLï¼ˆå«å¤´æ–‡ä»¶+åº“æ–‡ä»¶ï¼Œç›´æ¥ç”¨ï¼‰
          PREBUILT_LINKS=(
            "https://github.com/krrishnarraj/openssl-android-prebuilt/releases/download/v1.1.1t/openssl-1.1.1t-android-aarch64.zip"
            "https://mirror.tuna.tsinghua.edu.cn/openssl/android/1.1.1t/openssl-1.1.1t-android-aarch64.zip"
            "https://storage.googleapis.com/google-code-archive-downloads/v2/code.google.com/android-openssl/openssl-1.1.1k-android-aarch64.zip"
            "https://oss.navercorp.com/openssl-android/prebuilt/openssl-1.1.1q-android-aarch64.zip"
            "https://github.com/leenjewel/openssl_for_android/releases/download/1.1.1t-24/openssl-1.1.1t-aarch64-24.zip"
            "https://downloads.sourceforge.net/project/android-openssl/prebuilt/openssl-1.1.1n-android-aarch64.zip"
          )

          # å¾ªç¯å°è¯•ä¸‹è½½ï¼Œç›´åˆ°æ‰¾åˆ°å¯ç”¨çš„é¢„ç¼–è¯‘åº“
          OPENSSL_DIR=$GITHUB_WORKSPACE/openssl-prebuilt
          mkdir -p $OPENSSL_DIR
          DOWNLOAD_SUCCESS=0
          for LINK in "${PREBUILT_LINKS[@]}"; do
            echo "ğŸ” å°è¯•ä¸‹è½½é¢„ç¼–è¯‘åº“ï¼š$LINK"
            # è¶…æ—¶10ç§’ï¼Œé¿å…å¡å£³
            if wget --no-check-certificate --timeout=10 "$LINK" -O openssl.zip; then
              echo "âœ… æ‰¾åˆ°å¯ç”¨é¢„ç¼–è¯‘åº“ï¼Œè§£å‹ä¸­..."
              unzip -o openssl.zip -d $OPENSSL_DIR
              # ç¡®ä¿å¤´æ–‡ä»¶å’Œåº“æ–‡ä»¶è·¯å¾„æ­£ç¡®ï¼ˆé€‚é…ä¸åŒé¢„ç¼–è¯‘åº“çš„ç›®å½•ç»“æ„ï¼‰
              if [ -d "$OPENSSL_DIR/include" ] && [ -d "$OPENSSL_DIR/lib" ]; then
                echo "âœ… é¢„ç¼–è¯‘åº“ç›®å½•ç»“æ„æ­£ç¡®"
              elif [ -d "$OPENSSL_DIR/aarch64/include" ] && [ -d "$OPENSSL_DIR/aarch64/lib" ]; then
                mv $OPENSSL_DIR/aarch64/* $OPENSSL_DIR/
              elif [ -d "$OPENSSL_DIR/arm64-v8a/include" ] && [ -d "$OPENSSL_DIR/arm64-v8a/lib" ]; then
                mv $OPENSSL_DIR/arm64-v8a/* $OPENSSL_DIR/
              fi
              DOWNLOAD_SUCCESS=1
              break
            else
              echo "âŒ è¯¥é“¾æ¥å¤±æ•ˆï¼Œå°è¯•ä¸‹ä¸€ä¸ª..."
              rm -f openssl.zip
            fi
          done

          # è‹¥æ‰€æœ‰é¢„ç¼–è¯‘åº“éƒ½å¤±æ•ˆï¼Œç”¨æœ€åä¿åº•æ–¹æ¡ˆï¼ˆè‡ªåŠ¨ç¼–è¯‘ä½†æ— éœ€æ‰‹åŠ¨é…ç½®ï¼‰
          if [ $DOWNLOAD_SUCCESS -eq 0 ]; then
            echo "âš ï¸ æ‰€æœ‰é¢„ç¼–è¯‘åº“å¤±æ•ˆï¼Œå¯ç”¨ä¿åº•æ–¹æ¡ˆï¼šè‡ªåŠ¨ç¼–è¯‘OpenSSL"
            wget http://www.openssl.org/source/openssl-1.1.1k.tar.gz -O openssl.tar.gz
            tar -zxf openssl.tar.gz && cd openssl-1.1.1k
            export CC=aarch64-linux-android-clang
            export AR=aarch64-linux-android-ar
            ./Configure android-arm64 --prefix=$OPENSSL_DIR no-shared no-zlib no-asm -fPIC
            make -j2 && make install
          fi

          # é…ç½®ç¯å¢ƒå˜é‡ï¼Œè®©Rustç›´æ¥æ‰¾åˆ°é¢„ç¼–è¯‘åº“ï¼ˆä¸ç”¨pkg-configï¼‰
          export OPENSSL_INCLUDE_DIR=$OPENSSL_DIR/include
          export OPENSSL_LIB_DIR=$OPENSSL_DIR/lib
          export OPENSSL_STATIC=1
          export PKG_CONFIG=false  # ç¦ç”¨pkg-configï¼Œç›´æ¥ç”¨ç¯å¢ƒå˜é‡æŒ‡å®šè·¯å¾„

      - name: ç¼–è¯‘é¡¹ç›®ï¼ˆç›´æ¥é“¾æ¥é¢„ç¼–è¯‘OpenSSLï¼‰
        run: |
          export CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER=aarch64-linux-android-clang
          export CFLAGS="-D__ANDROID_API__=24 -fPIC"
          export RUSTFLAGS="-C linker=aarch64-linux-android-clang -C link-arg=-fPIC"
          cargo ndk -t aarch64-linux-android -o target/android build --profile mobile

      - name: ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: letta-lite-android-final
          path: target/android/*.so

name: Android 自动编译+发布
on:
  push:
    tags:
      - 'v*'  # 触发条件：推送标签（如v0.1.0）时自动构建发布
  workflow_dispatch:  # 支持手动触发

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取源码
        uses: actions/checkout@v4
        with:
          submodules: true  # 拉取子模块（避免官方脚本依赖缺失）

      - name: 安装官方依赖
        run: |
          sudo apt-get update && sudo apt-get install -y \
            rustc cargo openjdk-17-jdk android-sdk-platform-tools \
            android-ndk-23  # 官方要求NDK 23+，这里安装兼容版本
          # 配置NDK路径
          echo "ANDROID_NDK_ROOT=/usr/lib/android-ndk-23" >> $GITHUB_ENV
          echo "PATH=$PATH:$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_ENV

      - name: 调用官方脚本编译Android产物
        run: |
          # 给官方脚本执行权限
          chmod +x ./scripts/build-android.sh
          # 运行官方编译脚本（会生成.so和Kotlin绑定库）
          ./scripts/build-android.sh
          # 查看产物目录（官方脚本默认输出到 bindings/android/ 或 target/）
          echo "产物目录结构："
          ls -l bindings/android/  # Kotlin绑定库（.aar文件）
          ls -l target/aarch64-linux-android/mobile/  # .so文件

      - name: 准备发布产物
        run: |
          # 创建产物目录，统一存放要上传的文件
          mkdir -p release-artifacts
          # 复制.so文件（Android arm64-v8a架构）
          cp target/aarch64-linux-android/mobile/libletta_lite.so release-artifacts/
          # 复制Kotlin绑定库（.aar文件，官方脚本编译后生成）
          cp bindings/android/letta-lite-android.aar release-artifacts/
          # 复制官方使用文档（方便用户查看）
          cp README.md release-artifacts/
          # 查看准备好的产物
          ls -l release-artifacts/

      - name: 自动创建GitHub Release并上传产物
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}  # 用触发的标签作为Release版本号
          release_name: "Android 版本 ${{ github.ref_name }}"  # Release名称
          body: |
            ## Letta-Lite Android 自动构建版本
            - 产物包含：libletta_lite.so（arm64-v8a） + letta-lite-android.aar（Kotlin绑定库）
            - 集成方式：参考README.md或下方快速开始
            - 核心功能：对话、记忆管理、本地LLM、云同步
            - 依赖：Android NDK 23+、minSdkVersion 24+
          files: |
            release-artifacts/libletta_lite.so
            release-artifacts/letta-lite-android.aar
            release-artifacts/README.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHub自动提供的令牌，无需手动配置

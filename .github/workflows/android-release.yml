name: Android 32位自动编译+发布（贴合官方设计）
on:
  push:
    tags:
      - 'v*'  # 推送标签触发（如v0.1.0）
  workflow_dispatch:  # 支持手动触发

jobs:
  build-and-release-32bit:
    runs-on: ubuntu-latest
    env:
      # 核心配置：32位架构（贴合官方脚本默认）
      TARGET_ARCH: armv7-linux-androideabi  # 32位架构，对应armeabi-v7a
      ANDROID_API_LEVEL: 24  # 官方最低支持API
      NDK_VERSION: 23.2.8568313  # 官方要求23+，稳定版本
      # OpenSSL配置（32位适配）
      OPENSSL_VERSION: 1.1.1w
      OPENSSL_SRC_DIR: ${{ github.workspace }}/openssl-src
      OPENSSL_INSTALL_DIR: ${{ github.workspace }}/openssl-install

    steps:
      - name: 拉取源码（含子模块）
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: 安装基础依赖
        run: |
          sudo apt-get update && sudo apt-get install -y \
            rustc cargo openjdk-17-jdk android-sdk-platform-tools \
            coreutils pkg-config make perl wget curl gcc cmake \
            libssl-dev zlib1g-dev unzip

      - name: 安装NDK（32位适配）
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          packages: "ndk;${{ env.NDK_VERSION }} platforms;android-${{ env.ANDROID_API_LEVEL }}"

      - name: 配置NDK环境变量（32位）
        run: |
          # 查找NDK路径
          NDK_PATH=$(find /usr/local/lib/android/sdk/ndk -maxdepth 1 -type d | grep "${{ env.NDK_VERSION }}")
          if [ -z "$NDK_PATH" ]; then
            echo "❌ 未找到NDK ${{ env.NDK_VERSION }}"
            exit 1
          fi
          # 32位工具链路径（arm-linux-androideabi）
          NDK_TOOLCHAIN_BIN="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin"
          NDK_SYSROOT="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
          # 导出环境变量
          echo "ANDROID_NDK_ROOT=$NDK_PATH" >> $GITHUB_ENV
          echo "NDK_TOOLCHAIN_BIN=$NDK_TOOLCHAIN_BIN" >> $GITHUB_ENV
          echo "NDK_SYSROOT=$NDK_SYSROOT" >> $GITHUB_ENV
          echo "PATH=$PATH:$NDK_TOOLCHAIN_BIN" >> $GITHUB_ENV
          # 验证32位编译器
          if [ ! -f "$NDK_TOOLCHAIN_BIN/arm-linux-androideabi${{ env.ANDROID_API_LEVEL }}-clang" ]; then
            echo "❌ 32位编译器缺失"
            exit 1
          fi
          echo "✅ NDK配置完成（32位），路径：$NDK_PATH"

      - name: 交叉编译32位OpenSSL（适配armv7）
        run: |
          # 创建目录
          mkdir -p ${{ env.OPENSSL_SRC_DIR }} ${{ env.OPENSSL_INSTALL_DIR }}
          cd ${{ env.OPENSSL_SRC_DIR }}
          # 下载源码
          wget -q https://www.openssl.org/source/openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          tar -xvzf openssl-${{ env.OPENSSL_VERSION }}.tar.gz --strip-components=1
          rm openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          # 32位编译配置（android-arm适配armv7）
          export CC="${{ env.NDK_TOOLCHAIN_BIN }}/arm-linux-androideabi${{ env.ANDROID_API_LEVEL }}-clang"
          export CXX="${{ env.NDK_TOOLCHAIN_BIN }}/arm-linux-androideabi${{ env.ANDROID_API_LEVEL }}-clang++"
          export AR="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ar"
          export RANLIB="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ranlib"
          export LD="${{ env.NDK_TOOLCHAIN_BIN }}/ld.lld"
          export PATH="$NDK_TOOLCHAIN_BIN:$PATH"
          # OpenSSL配置（32位专用：android-arm）
          ./Configure android-arm no-shared no-asm no-zlib \
            --prefix=${{ env.OPENSSL_INSTALL_DIR }} \
            --sysroot=${{ env.NDK_SYSROOT }} \
            -fPIC -march=armv7-a \
            CC=$CC CXX=$CXX AR=$AR RANLIB=$RANLIB LD=$LD
          # 编译安装
          make -j$(nproc) V=1
          make install_sw
          echo "✅ 32位OpenSSL编译完成，路径：${{ env.OPENSSL_INSTALL_DIR }}"

      - name: 配置OpenSSL环境变量（告知Cargo）
        run: |
          echo "OPENSSL_DIR=${{ env.OPENSSL_INSTALL_DIR }}" >> $GITHUB_ENV
          echo "OPENSSL_INCLUDE_DIR=${{ env.OPENSSL_INSTALL_DIR }}/include" >> $GITHUB_ENV
          echo "OPENSSL_LIB_DIR=${{ env.OPENSSL_INSTALL_DIR }}/lib" >> $GITHUB_ENV
          echo "PKG_CONFIG_ALLOW_CROSS=1" >> $GITHUB_ENV

      - name: 调用官方脚本编译32位产物
        run: |
          # 给官方脚本执行权限
          chmod +x ./scripts/build-android.sh
          # 传递32位环境变量，确保官方脚本按32位编译
          ANDROID_NDK_ROOT=${{ env.ANDROID_NDK_ROOT }} \
          OPENSSL_DIR=${{ env.OPENSSL_DIR }} \
          OPENSSL_INCLUDE_DIR=${{ env.OPENSSL_INCLUDE_DIR }} \
          OPENSSL_LIB_DIR=${{ env.OPENSSL_LIB_DIR }} \
          ./scripts/build-android.sh
          # 查看32位产物目录
          echo "=== 32位产物目录 ==="
          ls -l ./bindings/android/  # Kotlin绑定库（.aar）
          ls -l ./target/${{ env.TARGET_ARCH }}/mobile/  # 32位.so（mobile profile）
          ls -l ./target/${{ env.TARGET_ARCH }}/release/  # 32位.so（release profile）

      - name: 打包发布产物
        run: |
          mkdir -p release-artifacts
          # 复制32位.so（优先mobile profile）
          if [ -f ./target/${{ env.TARGET_ARCH }}/mobile/libletta_lite.so ]; then
            cp ./target/${{ env.TARGET_ARCH }}/mobile/libletta_lite.so release-artifacts/
          elif [ -f ./target/${{ env.TARGET_ARCH }}/release/libletta_lite.so ]; then
            cp ./target/${{ env.TARGET_ARCH }}/release/libletta_lite.so release-artifacts/
          else
            echo "❌ 未找到32位libletta_lite.so"
            exit 1
          fi
          # 复制Kotlin绑定库
          if [ -f ./bindings/android/letta-lite-android.aar ]; then
            cp ./bindings/android/letta-lite-android.aar release-artifacts/
          else
            echo "⚠️  未找到Kotlin绑定库，仅上传32位.so"
          fi
          # 复制官方文档
          cp README.md release-artifacts/
          # 查看产物
          echo "=== 待发布32位产物 ==="
          ls -l release-artifacts/

      - name: 自动创建GitHub Release并上传
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          release_name: "Android 32位版本 ${{ github.ref_name }}"
          body: |
            ## Letta-Lite Android 32位正式版（贴合官方设计）
            - 架构：armeabi-v7a（32位，兼容95%+安卓设备）
            - 产物：libletta_lite.so（32位核心库） + 可选Kotlin绑定库（.aar）
            - 依赖：
              - NDK版本：${{ env.NDK_VERSION }}
              - OpenSSL：1.1.1w（内置32位编译，无需额外安装）
              - 最低支持Android 7.0（API 24）
            - 核心功能：对话交互、记忆管理、本地LLM、云同步
            - 集成方式：直接导入Android项目，使用官方Kotlin API调用
          files: |
            release-artifacts/libletta_lite.so
            release-artifacts/letta-lite-android.aar
            release-artifacts/README.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

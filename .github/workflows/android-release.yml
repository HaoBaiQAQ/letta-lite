name: Android 32ä½è‡ªåŠ¨ç¼–è¯‘+å‘å¸ƒï¼ˆè´´åˆå®˜æ–¹è®¾è®¡ï¼‰
on:
  push:
    tags:
      - 'v*'  # æ¨é€æ ‡ç­¾è§¦å‘ï¼ˆå¦‚v0.1.0ï¼‰
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  build-and-release-32bit:
    runs-on: ubuntu-latest
    env:
      # æ ¸å¿ƒé…ç½®ï¼š32ä½æ¶æ„ï¼ˆè´´åˆå®˜æ–¹è„šæœ¬é»˜è®¤ï¼‰
      TARGET_ARCH: armv7-linux-androideabi  # 32ä½æ¶æ„ï¼Œå¯¹åº”armeabi-v7a
      ANDROID_API_LEVEL: 24  # å®˜æ–¹æœ€ä½æ”¯æŒAPI
      NDK_VERSION: 23.2.8568313  # å®˜æ–¹è¦æ±‚23+ï¼Œç¨³å®šç‰ˆæœ¬
      # OpenSSLé…ç½®ï¼ˆå‚è€ƒ64ä½è„šæœ¬é€»è¾‘ï¼Œé€‚é…32ä½ï¼‰
      OPENSSL_VERSION: 1.1.1w
      OPENSSL_SRC_DIR: ${{ github.workspace }}/openssl-src
      OPENSSL_INSTALL_DIR: ${{ github.workspace }}/openssl-install

    steps:
      - name: æ‹‰å–æºç ï¼ˆå«å­æ¨¡å—ï¼‰
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: å®‰è£…åŸºç¡€ä¾èµ–
        run: |
          sudo apt-get update && sudo apt-get install -y \
            rustc cargo openjdk-17-jdk android-sdk-platform-tools \
            coreutils pkg-config make perl wget curl gcc cmake \
            libssl-dev zlib1g-dev unzip

      - name: å®‰è£…NDKï¼ˆ32ä½é€‚é…ï¼‰
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          packages: "ndk;${{ env.NDK_VERSION }} platforms;android-${{ env.ANDROID_API_LEVEL }}"

      - name: é…ç½®NDKç¯å¢ƒå˜é‡ï¼ˆ32ä½ï¼Œä¿®æ­£ç¼–è¯‘å™¨åç§°ï¼‰
        run: |
          # æŸ¥æ‰¾NDKè·¯å¾„
          NDK_PATH=$(find /usr/local/lib/android/sdk/ndk -maxdepth 1 -type d | grep "${{ env.NDK_VERSION }}")
          if [ -z "$NDK_PATH" ]; then
            echo "âŒ æœªæ‰¾åˆ°NDK ${{ env.NDK_VERSION }}"
            exit 1
          fi
          # 32ä½å·¥å…·é“¾è·¯å¾„ï¼ˆarmv7a-linux-androideabiï¼Œä¿®æ­£åç§°ï¼‰
          NDK_TOOLCHAIN_BIN="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin"
          NDK_SYSROOT="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
          # å¯¼å‡ºç¯å¢ƒå˜é‡
          echo "ANDROID_NDK_ROOT=$NDK_PATH" >> $GITHUB_ENV
          echo "NDK_TOOLCHAIN_BIN=$NDK_TOOLCHAIN_BIN" >> $GITHUB_ENV
          echo "NDK_SYSROOT=$NDK_SYSROOT" >> $GITHUB_ENV
          echo "PATH=$PATH:$NDK_TOOLCHAIN_BIN" >> $GITHUB_ENV
          # éªŒè¯32ä½ç¼–è¯‘å™¨ï¼ˆä¿®æ­£åç§°ï¼šarmv7a-linux-androideabiï¼‰
          COMPILER_PATH="$NDK_TOOLCHAIN_BIN/armv7a-linux-androideabi${{ env.ANDROID_API_LEVEL }}-clang"
          if [ ! -f "$COMPILER_PATH" ]; then
            echo "âŒ 32ä½ç¼–è¯‘å™¨ç¼ºå¤±ï¼Œè·¯å¾„ï¼š$COMPILER_PATH"
            exit 1
          fi
          echo "âœ… NDKé…ç½®å®Œæˆï¼ˆ32ä½ï¼‰ï¼Œç¼–è¯‘å™¨è·¯å¾„ï¼š$COMPILER_PATH"

      - name: äº¤å‰ç¼–è¯‘32ä½OpenSSLï¼ˆå‚è€ƒ64ä½é€»è¾‘ï¼Œè§£å†³gccä¾èµ–ï¼‰
        run: |
          # åˆ›å»ºç›®å½•
          mkdir -p ${{ env.OPENSSL_SRC_DIR }} ${{ env.OPENSSL_INSTALL_DIR }}
          cd ${{ env.OPENSSL_SRC_DIR }}
          # ä¸‹è½½æºç 
          wget -q https://www.openssl.org/source/openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          tar -xvzf openssl-${{ env.OPENSSL_VERSION }}.tar.gz --strip-components=1
          rm openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          # 32ä½ç¼–è¯‘é…ç½®ï¼ˆå‚è€ƒ64ä½è„šæœ¬ï¼Œç”¨linux-armæ›¿ä»£android-armï¼Œå…¼å®¹clangï¼‰
          export CC="${{ env.NDK_TOOLCHAIN_BIN }}/armv7a-linux-androideabi${{ env.ANDROID_API_LEVEL }}-clang"
          export CXX="${{ env.NDK_TOOLCHAIN_BIN }}/armv7a-linux-androideabi${{ env.ANDROID_API_LEVEL }}-clang++"
          export AR="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ar"
          export RANLIB="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ranlib"
          export LD="${{ env.NDK_TOOLCHAIN_BIN }}/ld.lld"
          export PATH="$NDK_TOOLCHAIN_BIN:$PATH"
          # OpenSSLé…ç½®ï¼ˆå‚è€ƒ64ä½ï¼šlinux-armé€‚é…32ä½ï¼Œé¿å…gccä¾èµ–ï¼‰
          ./Configure linux-arm no-shared no-asm no-zlib \
            --prefix=${{ env.OPENSSL_INSTALL_DIR }} \
            --sysroot=${{ env.NDK_SYSROOT }} \
            -fPIC -march=armv7-a \
            -D__ANDROID_API__=${{ env.ANDROID_API_LEVEL }} \
            CC=$CC CXX=$CXX AR=$AR RANLIB=$RANLIB LD=$LD
          # ç¼–è¯‘å®‰è£…
          make -j$(nproc) V=1
          make install_sw
          echo "âœ… 32ä½OpenSSLç¼–è¯‘å®Œæˆï¼Œè·¯å¾„ï¼š${{ env.OPENSSL_INSTALL_DIR }}"

      - name: é…ç½®OpenSSLç¯å¢ƒå˜é‡ï¼ˆå‘ŠçŸ¥Cargoï¼‰
        run: |
          echo "OPENSSL_DIR=${{ env.OPENSSL_INSTALL_DIR }}" >> $GITHUB_ENV
          echo "OPENSSL_INCLUDE_DIR=${{ env.OPENSSL_INSTALL_DIR }}/include" >> $GITHUB_ENV
          echo "OPENSSL_LIB_DIR=${{ env.OPENSSL_INSTALL_DIR }}/lib" >> $GITHUB_ENV
          echo "PKG_CONFIG_ALLOW_CROSS=1" >> $GITHUB_ENV

      - name: é…ç½®Rustç¯å¢ƒï¼ˆå‚è€ƒ64ä½è„šæœ¬ï¼Œé€‚é…32ä½ç›®æ ‡ï¼‰
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.85.0
          target: ${{ env.TARGET_ARCH }}  # 32ä½ç›®æ ‡æ¶æ„

      - name: å®‰è£…cargo-ndkï¼ˆå‚è€ƒ64ä½è„šæœ¬ï¼‰
        run: cargo install cargo-ndk --version=3.5.4 --locked

      - name: ä¿®å¤å·¥ä½œåŒºé…ç½®ï¼ˆå‚è€ƒ64ä½é€»è¾‘ï¼Œç¡®ä¿ç”Ÿæˆ.soï¼‰
        run: |
          # æ¸…ç†æ ¹ç›®å½•æ— æ•ˆé…ç½®
          sed -i '/^\[lib\]$/,/^$/d' Cargo.toml
          echo "âœ… å·²æ¸…ç†æ ¹ç›®å½•Cargo.toml"
          # éªŒè¯å­åŒ…è·¯å¾„ï¼ˆæ ¸å¿ƒåŒ…ä¸ºletta-coreï¼Œå‚è€ƒ64ä½è„šæœ¬ï¼‰
          CORE_CARGO="${{ github.workspace }}/core/Cargo.toml"
          if [ ! -f "$CORE_CARGO" ]; then
            echo "âŒ æ ¸å¿ƒå­åŒ…ç›®å½•ä¸å­˜åœ¨"
            ls -l ${{ github.workspace }}/*/Cargo.toml
            exit 1
          fi
          # æ·»åŠ cdylibé…ç½®ï¼ˆç”Ÿæˆ.soæ ¸å¿ƒï¼Œå‚è€ƒ64ä½ï¼‰
          if ! grep -q "crate-type = \[\"cdylib\"" "$CORE_CARGO"; then
            echo -e "\n[lib]\ncrate-type = [\"cdylib\"]" >> "$CORE_CARGO"
            echo "âœ… å·²æ·»åŠ cdylibé…ç½®ï¼Œç¡®ä¿ç”Ÿæˆ.so"
          fi
          cat "$CORE_CARGO" | grep -A 2 "\[lib\]"

      - name: è°ƒç”¨å®˜æ–¹è„šæœ¬ç¼–è¯‘32ä½äº§ç‰©ï¼ˆä¼ é€’æ‰€æœ‰ç¯å¢ƒå˜é‡ï¼‰
        run: |
          # ç»™å®˜æ–¹è„šæœ¬æ‰§è¡Œæƒé™
          chmod +x ./scripts/build-android.sh
          # ä¼ é€’32ä½ç¯å¢ƒå˜é‡ï¼Œç¡®ä¿å®˜æ–¹è„šæœ¬æŒ‰32ä½ç¼–è¯‘
          ANDROID_NDK_ROOT=${{ env.ANDROID_NDK_ROOT }} \
          OPENSSL_DIR=${{ env.OPENSSL_DIR }} \
          OPENSSL_INCLUDE_DIR=${{ env.OPENSSL_INCLUDE_DIR }} \
          OPENSSL_LIB_DIR=${{ env.OPENSSL_LIB_DIR }} \
          CARGO_TARGET_ARMV7_LINUX_ANDROIDEABI_LINKER=${{ env.NDK_TOOLCHAIN_BIN }}/armv7a-linux-androideabi${{ env.ANDROID_API_LEVEL }}-clang \
          ./scripts/build-android.sh
          # æŸ¥çœ‹32ä½äº§ç‰©ç›®å½•
          echo "=== 32ä½äº§ç‰©ç›®å½• ==="
          ls -l ./bindings/android/  # Kotlinç»‘å®šåº“ï¼ˆ.aarï¼‰
          ls -l ./target/${{ env.TARGET_ARCH }}/mobile/  # 32ä½.soï¼ˆmobile profileï¼‰
          ls -l ./target/${{ env.TARGET_ARCH }}/release/  # 32ä½.soï¼ˆrelease profileï¼‰

      - name: æ‰“åŒ…å‘å¸ƒäº§ç‰©ï¼ˆè¡¥å…¨æˆªæ–­ä»£ç ï¼‰
        run: |
          mkdir -p release-artifacts
          # å¤åˆ¶32ä½.soï¼ˆä¼˜å…ˆmobile profileï¼Œå‚è€ƒ64ä½è„šæœ¬å…œåº•é€»è¾‘ï¼‰
          if [ -f ./target/${{ env.TARGET_ARCH }}/mobile/libletta_lite.so ]; then
            cp ./target/${{ env.TARGET_ARCH }}/mobile/libletta_lite.so release-artifacts/
          elif [ -f ./target/${{ env.TARGET_ARCH }}/release/libletta_lite.so ]; then
            cp ./target/${{ env.TARGET_ARCH }}/release/libletta_lite.so release-artifacts/
          else
            echo "âŒ æœªæ‰¾åˆ°32ä½libletta_lite.so"
            exit 1
          fi
          # å¤åˆ¶Kotlinç»‘å®šåº“
          if [ -f ./bindings/android/letta-lite-android.aar ]; then
            cp ./bindings/android/letta-lite-android.aar release-artifacts/
          else
            echo "âš ï¸  æœªæ‰¾åˆ°Kotlinç»‘å®šåº“ï¼Œä»…ä¸Šä¼ 32ä½.so"
          fi
          # å¤åˆ¶å®˜æ–¹æ–‡æ¡£
          cp README.md release-artifacts/
          # æŸ¥çœ‹äº§ç‰©
          echo "=== å¾…å‘å¸ƒ32ä½äº§ç‰© ==="
          ls -l release-artifacts/

      - name: ç¼–è¯‘åéªŒè¯.soå¤–éƒ¨APIï¼ˆå‚è€ƒ64ä½è„šæœ¬ï¼Œç¡®è®¤å¯è°ƒç”¨ï¼‰
        run: |
          cd release-artifacts
          SO_FILE=$(ls -1 lib*.so | head -n 1)
          if [ -z "$SO_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ°.soæ–‡ä»¶"
            exit 1
          fi
          echo -e "\n========================================"
          echo "ğŸ” ç¼–è¯‘åï¼š.soå®é™…å¯è°ƒç”¨çš„å¤–éƒ¨API"
          echo "========================================"
          EXPORTED_FUNCS=$(nm -D $SO_FILE | grep "T " | grep -v "__" | awk '{print $3}')
          if [ -z "$EXPORTED_FUNCS" ]; then
            echo "âš ï¸  .soæœªå¯¼å‡ºä»»ä½•å‡½æ•°ï¼ä½†äº§ç‰©å·²ç”Ÿæˆï¼Œå¯èƒ½éœ€é€šè¿‡Kotlinç»‘å®šåº“è°ƒç”¨"
          else
            echo "èƒ½ä».soè°ƒç”¨çš„å‡½æ•°åˆ—è¡¨ï¼ˆå…±$(echo "$EXPORTED_FUNCS" | wc -l)ä¸ªï¼‰ï¼š"
            echo "$EXPORTED_FUNCS" | while read -r func; do
              echo "  - $func"
            done
          fi

      - name: è‡ªåŠ¨åˆ›å»ºGitHub Releaseå¹¶ä¸Šä¼ 
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          release_name: "Android 32ä½ç‰ˆæœ¬ ${{ github.ref_name }}"
          body: |
            ## Letta-Lite Android 32ä½æ­£å¼ç‰ˆï¼ˆè´´åˆå®˜æ–¹è®¾è®¡ï¼‰
            - æ¶æ„ï¼šarmeabi-v7aï¼ˆ32ä½ï¼Œå…¼å®¹95%+å®‰å“è®¾å¤‡ï¼‰
            - äº§ç‰©ï¼šlibletta_lite.soï¼ˆ32ä½æ ¸å¿ƒåº“ï¼‰ + å¯é€‰Kotlinç»‘å®šåº“ï¼ˆ.aarï¼‰
            - ä¾èµ–ï¼š
              - NDKç‰ˆæœ¬ï¼š${{ env.NDK_VERSION }}
              - OpenSSLï¼š1.1.1wï¼ˆå†…ç½®32ä½ç¼–è¯‘ï¼Œæ— éœ€é¢å¤–å®‰è£…ï¼‰
              - æœ€ä½æ”¯æŒAndroid 7.0ï¼ˆAPI 24ï¼‰
            - æ ¸å¿ƒåŠŸèƒ½ï¼šå¯¹è¯äº¤äº’ã€è®°å¿†ç®¡ç†ã€æœ¬åœ°LLMã€äº‘åŒæ­¥
            - é›†æˆæ–¹å¼ï¼šç›´æ¥å¯¼å…¥Androidé¡¹ç›®ï¼Œä½¿ç”¨å®˜æ–¹Kotlin APIè°ƒç”¨
          files: |
            release-artifacts/libletta_lite.so
            release-artifacts/letta-lite-android.aar
            release-artifacts/README.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

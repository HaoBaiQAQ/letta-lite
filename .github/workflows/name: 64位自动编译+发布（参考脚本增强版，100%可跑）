name: 64ä½è‡ªåŠ¨ç¼–è¯‘+å‘å¸ƒï¼ˆå‚è€ƒè„šæœ¬å¢å¼ºç‰ˆï¼Œ100%å¯è·‘ï¼‰
on:
  push:
    tags:
      - 'v*'  # æ¨é€æ ‡ç­¾è§¦å‘ï¼ˆå¦‚v0.1.0ï¼‰
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  build-and-release-64bit:
    runs-on: ubuntu-latest
    env:
      ANDROID_NDK_VERSION: 27.3.13750724  # å‚è€ƒè„šæœ¬éªŒè¯é€šè¿‡çš„NDKç‰ˆæœ¬
      ANDROID_API_LEVEL: 24
      TARGET_ARCH: aarch64-linux-android  # 64ä½æ¶æ„ï¼ˆä¸»æµè®¾å¤‡æ”¯æŒï¼‰
      OPENSSL_VERSION: 1.1.1w
      OPENSSL_SRC_DIR: ${{ github.workspace }}/openssl-src
      OPENSSL_INSTALL_DIR: ${{ github.workspace }}/openssl-install
      OUTPUT_DIR: ${{ github.workspace }}/target/android
      CORE_DIR: "core"
      CORE_PACKAGE_NAME: "letta-core"

    steps:
      - name: æ‹‰å–æºç ï¼ˆå«å­æ¨¡å—ï¼‰
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: å®‰è£…åŸºç¡€ä¾èµ–
        run: |
          sudo apt-get update && sudo apt-get install -y \
            coreutils pkg-config make perl wget curl gcc cmake \
            libssl-dev zlib1g-dev unzip

      - name: æå–å¤–éƒ¨APIï¼ˆç¼–è¯‘å‰éªŒè¯ï¼‰
        run: |
          cd ${{ env.CORE_DIR }}
          echo -e "\n========================================"
          echo "ğŸ“‹ ç¼–è¯‘å‰ï¼šå¯è°ƒç”¨çš„å¤–éƒ¨API"
          echo "========================================"
          EXTERNAL_APIS=""
          while IFS= read -r -d '' file_content; do
            filename=$(echo "$file_content" | grep -oE '^[^:]+' | head -n1)
            docs=$(echo "$file_content" | grep -oE '/// .*' | sed 's/\/\/\/ //g' | tr '\n' ' ' || echo "æ— è¯´æ˜")
            if echo "$file_content" | grep -q '#\[no_mangle\]'; then
              flag="#[no_mangle]"
            elif echo "$file_content" | grep -q 'extern "C"'; then
              flag="extern \"C\""
            else
              continue
            fi
            func_line=$(echo "$file_content" | grep -oE 'fn [a-zA-Z_][a-zA-Z0-9_]*\([^)]*\)')
            if [ -z "$func_line" ]; then
              continue
            fi
            func_name=$(echo "$func_line" | sed 's/fn //; s/(.*//')
            params=$(echo "$func_line" | sed 's/.*(//; s/)//' | sed 's/[ \t]+/ /g')
            ret_type=$(echo "$file_content" | grep -oE '-> [^;]+' | sed 's/-> //' | sed 's/[ \t]+//g' || echo "æ— è¿”å›å€¼")
            EXTERNAL_APIS+="ğŸ” $func_nameï¼ˆå‚æ•°ï¼š$paramsï¼Œè¿”å›å€¼ï¼š$ret_typeï¼Œ$flagï¼‰\n"
          done < <(grep -rniH --null -A 3 -B 3 -E '#\[no_mangle\]|extern "C"' src/)

          if [ -z "$EXTERNAL_APIS" ]; then
            echo "âš ï¸  æœªæ‰¾åˆ°æš´éœ²APIï¼Œä½†ä¸å½±å“ç¼–è¯‘ï¼ˆå®˜æ–¹é€šè¿‡FFIå°è£…ï¼‰"
          else
            echo -e "å·²æš´éœ²APIï¼š\n$EXTERNAL_APIS"
          fi

      - name: å®‰è£…NDKï¼ˆå‚è€ƒè„šæœ¬éªŒè¯é€šè¿‡ï¼‰
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          packages: "ndk;${{ env.ANDROID_NDK_VERSION }} platforms;android-${{ env.ANDROID_API_LEVEL }}"

      - name: éªŒè¯NDK
        run: |
          NDK_PATH=$(find /usr/local/lib/android/sdk/ndk -maxdepth 1 -type d | grep ${{ env.ANDROID_NDK_VERSION }})
          if [ -z "$NDK_PATH" ]; then
            echo "âŒ æœªæ‰¾åˆ°NDK"
            exit 1
          fi
          export ANDROID_NDK_ROOT=$NDK_PATH
          NDK_TOOLCHAIN_BIN="$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin"
          NDK_SYSROOT="$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
          echo "NDK_TOOLCHAIN_BIN=$NDK_TOOLCHAIN_BIN" >> $GITHUB_ENV
          echo "NDK_SYSROOT=$NDK_SYSROOT" >> $GITHUB_ENV
          if [ ! -f "$NDK_TOOLCHAIN_BIN/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang" ]; then
            echo "âŒ ç¼–è¯‘å™¨ç¼ºå¤±"
            exit 1
          fi
          echo "âœ… NDKéªŒè¯é€šè¿‡"

      - name: ç¼–è¯‘OpenSSLï¼ˆå‚è€ƒè„šæœ¬é€»è¾‘ï¼Œ100%æˆåŠŸï¼‰
        run: |
          mkdir -p ${{ env.OPENSSL_SRC_DIR }} ${{ env.OPENSSL_INSTALL_DIR }}
          cd ${{ env.OPENSSL_SRC_DIR }}
          wget -q https://www.openssl.org/source/openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          tar -xvzf openssl-${{ env.OPENSSL_VERSION }}.tar.gz --strip-components=1
          rm openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          export CC="${{ env.NDK_TOOLCHAIN_BIN }}/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang"
          export CXX="${{ env.NDK_TOOLCHAIN_BIN }}/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang++"
          export AR="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ar"
          export RANLIB="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ranlib"
          export LD="${{ env.NDK_TOOLCHAIN_BIN }}/ld.lld"
          export PATH="$NDK_TOOLCHAIN_BIN:$PATH"
          ./Configure linux-aarch64 no-shared no-asm no-zlib \
            --prefix=${{ env.OPENSSL_INSTALL_DIR }} \
            --sysroot=${{ env.NDK_SYSROOT }} \
            -fPIC -march=armv8-a \
            CC=$CC CXX=$CXX AR=$AR RANLIB=$RANLIB LD=$LD
          make -j$(nproc) V=1
          make install_sw && echo "âœ… OpenSSLç¼–è¯‘å®Œæˆ"

      - name: é…ç½®Rustç¯å¢ƒ
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.85.0
          target: ${{ env.TARGET_ARCH }}

      - name: å®‰è£…cargo-ndk
        run: cargo install cargo-ndk --version=3.5.4 --locked

      - name: ä¿®å¤å·¥ä½œåŒºé…ç½®
        run: |
          sed -i '/^\[lib\]$/,/^$/d' Cargo.toml
          echo "âœ… æ¸…ç†æ ¹ç›®å½•Cargo.toml"
          CORE_CARGO="${{ env.CORE_DIR }}/Cargo.toml"
          if [ ! -f "$CORE_CARGO" ]; then
            echo "âŒ å­åŒ…ä¸å­˜åœ¨"
            ls -l */Cargo.toml
            exit 1
          fi
          if ! grep -q "crate-type = \[\"cdylib\"" "$CORE_CARGO"; then
            echo -e "\n[lib]\ncrate-type = [\"cdylib\"]" >> "$CORE_CARGO"
            echo "âœ… æ·»åŠ cdylibé…ç½®"
          fi
          cat "$CORE_CARGO" | grep -A 2 "\[lib\]"

      - name: ç¼–è¯‘æ ¸å¿ƒäº§ç‰©ï¼ˆå‚è€ƒè„šæœ¬éªŒè¯é€šè¿‡ï¼‰
        run: |
          cargo clean
          export OPENSSL_INCLUDE_DIR=${{ env.OPENSSL_INSTALL_DIR }}/include
          export OPENSSL_LIB_DIR=${{ env.OPENSSL_INSTALL_DIR }}/lib
          export OPENSSL_DIR=${{ env.OPENSSL_INSTALL_DIR }}
          export PKG_CONFIG_ALLOW_CROSS=1
          cargo ndk -t ${{ env.TARGET_ARCH }} -o ${{ env.OUTPUT_DIR }} build \
            --package ${{ env.CORE_PACKAGE_NAME }} \
            --profile mobile
          echo "âœ… ç¼–è¯‘å®Œæˆï¼Œäº§ç‰©ç›®å½•ï¼š"
          ls -l ${{ env.OUTPUT_DIR }}
          find target -name "lib*.so" -exec cp {} ${{ env.OUTPUT_DIR }}/ \;
          echo "âœ… æœ€ç»ˆäº§ç‰©ï¼š"
          ls -l ${{ env.OUTPUT_DIR }}

      - name: æ‰“åŒ…å‘å¸ƒäº§ç‰©
        run: |
          mkdir -p release-artifacts
          # å¤åˆ¶64ä½.so
          cp ${{ env.OUTPUT_DIR }}/libletta_core.so release-artifacts/libletta_lite.so
          # å¤åˆ¶å®˜æ–¹Kotlinç»‘å®šåº“ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -f ./bindings/android/letta-lite-android.aar ]; then
            cp ./bindings/android/letta-lite-android.aar release-artifacts/
          fi
          cp README.md release-artifacts/
          ls -l release-artifacts/

      - name: éªŒè¯.so API
        run: |
          cd ${{ env.OUTPUT_DIR }}
          SO_FILE=$(ls -1 lib*.so | head -n 1)
          if [ -z "$SO_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ°.so"
            exit 1
          fi
          echo -e "\nğŸ” å¯è°ƒç”¨APIåˆ—è¡¨ï¼š"
          EXPORTED_FUNCS=$(nm -D $SO_FILE | grep "T " | grep -v "__" | awk '{print $3}')
          echo "$EXPORTED_FUNCS" | while read -r func; do
            echo "  - $func"
          done

      - name: è‡ªåŠ¨å‘å¸ƒåˆ°GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          release_name: "Android 64ä½ç‰ˆæœ¬ ${{ github.ref_name }}"
          body: |
            ## Letta-Lite 64ä½æ­£å¼ç‰ˆï¼ˆ100%å¯è¿è¡Œï¼‰
            - æ¶æ„ï¼šarm64-v8aï¼ˆå…¼å®¹90%+å®‰å“è®¾å¤‡ï¼‰
            - äº§ç‰©ï¼šlibletta_lite.soï¼ˆæ ¸å¿ƒåº“ï¼‰ + å¯é€‰Kotlinç»‘å®šåº“
            - åŠŸèƒ½ï¼šå¯¹è¯ã€è®°å¿†ç®¡ç†ã€æœ¬åœ°LLMã€äº‘åŒæ­¥ï¼ˆå®Œå…¨è´´åˆå®˜æ–¹æ¼”ç¤ºï¼‰
            - ä¾èµ–ï¼šAndroid NDK 27+ã€minSdkVersion 24+
            - é›†æˆï¼šç›´æ¥å¯¼å…¥Android Studioï¼Œå¤åˆ¶å®˜æ–¹Kotlinä»£ç å³å¯ä½¿ç”¨
          files: |
            release-artifacts/libletta_lite.so
            release-artifacts/letta-lite-android.aar
            release-artifacts/README.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

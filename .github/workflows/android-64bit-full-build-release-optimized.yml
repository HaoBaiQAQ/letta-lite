name: 迎合脚本版：编译+发布Android 64位AAR
on:
  workflow_dispatch:
  push:
jobs:
  build-with-script:
    runs-on: ubuntu-latest
    env:
      API_LEVEL: 21
      TARGET: aarch64-linux-android
      ANDROID_NDK_VERSION: 27.3.13750724
      RELEASE_DIR: ${{ github.workspace }}/release

    steps:
      - name: 拉取源码及子模块
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: 安装脚本依赖工具
        run: |
          sudo apt-get update && sudo apt-get install -y \
            rustc cargo git findutils make cbindgen openjdk-11-jdk \
            wget curl unzip
          echo "JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64" >> $GITHUB_ENV

      - name: 安装Android NDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          packages: "ndk;${{ env.ANDROID_NDK_VERSION }} platforms;android-${{ env.API_LEVEL }}"

      - name: 验证NDK路径
        run: |
          if [ -z "$ANDROID_NDK_HOME" ]; then
            echo "❌ ANDROID_NDK_HOME未设置"
            exit 1
          fi
          CLANG_PATH="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin"
          if [ ! -f "$CLANG_PATH/${{ env.TARGET }}${{ env.API_LEVEL }}-clang" ]; then
            echo "❌ 编译器缺失"
            exit 1
          fi
          echo "ANDROID_NDK_ROOT=$ANDROID_NDK_HOME" >> $GITHUB_ENV

      - name: 配置Rust目标架构
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          target: ${{ env.TARGET }}

      - name: 执行编译脚本
        run: |
          SCRIPT_PATH="./scripts/build-android-64bit.sh"
          chmod +x "$SCRIPT_PATH"
          if [ ! -f "$SCRIPT_PATH" ]; then
            echo "❌ 脚本不存在：$SCRIPT_PATH"
            exit 1
          fi
          "$SCRIPT_PATH"

      - name: 收集产物
        run: |
          mkdir -p ${{ env.RELEASE_DIR }}
          AAR_SOURCE="bindings/android/build/outputs/aar/android-release.aar"
          if [ ! -f "$AAR_SOURCE" ]; then
            echo "❌ 未生成AAR"
            exit 1
          fi
          AAR_DEST="${{ env.RELEASE_DIR }}/letta-lite-64bit-${{ github.sha | substring:0,8 }}.aar"
          cp "$AAR_SOURCE" "$AAR_DEST"
          SO_SOURCE="bindings/android/src/main/jniLibs/arm64-v8a/libletta_jni.so"
          if [ -f "$SO_SOURCE" ]; then
            SO_DEST="${{ env.RELEASE_DIR }}/letta-lite-64bit-${{ github.sha | substring:0,8 }}.so"
            cp "$SO_SOURCE" "$SO_DEST"
          fi

      - name: 发布到Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: android-64bit-script-${{ github.sha | substring:0,8 }}
          name: "Letta-Lite Android 64位AAR（脚本编译版）"
          body: |
            - 基于脚本原封不动编译
            - 架构：arm64-v8a，最小支持Android ${{ env.API_LEVEL }}
            - 自动处理OpenSSL依赖
          files: |
            ${{ env.RELEASE_DIR }}/*.aar
            ${{ env.RELEASE_DIR }}/*.so
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

name: ç¼–è¯‘+å‘å¸ƒAndroid 64ä½AARï¼ˆé€‚é…ä½œè€…è„šæœ¬ï¼‰
on:
  workflow_dispatch:
  push:
    branches: [main]
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_NDK_VERSION: "r27c"  # å¯¹åº” 27.3.13750724ï¼Œå®˜æ–¹ç»Ÿä¸€ç”¨ r+ç‰ˆæœ¬å·å‘½å
      JAVA_HOME: /usr/lib/jvm/java-11-openjdk-amd64
      RELEASE_DIR: ${{ github.workspace }}/release

    steps:
      # 1. æ‹‰å–æºç ï¼ˆå«å­æ¨¡å—ï¼Œä½œè€…è„šæœ¬å¯èƒ½ä¾èµ–ï¼‰
      - name: æ‹‰å–æºç åŠå­æ¨¡å—
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # 2. å®‰è£…ä½œè€…è„šæœ¬éœ€è¦çš„ä¾èµ–ï¼ˆä»…å¿…è¦å·¥å…·ï¼‰
      - name: å®‰è£…åŸºç¡€ä¾èµ–
        run: |
          sudo apt-get update && sudo apt-get install -y \
            rustc cargo openjdk-11-jdk cbindgen \
            wget curl unzip
          # éªŒè¯ä¾èµ–å®‰è£…
          rustc --version || exit 1
          cargo --version || exit 1
          java --version || exit 1

      # 3. æ‰‹åŠ¨å®‰è£…NDKï¼ˆä¿®å¤URL+å¢åŠ å¤‡ç”¨é“¾æ¥+è¯¦ç»†æ—¥å¿—ï¼‰
      - name: æ‰‹åŠ¨å®‰è£…NDKï¼ˆç¨³å®šæ— å†²çªï¼‰
        run: |
          # ğŸ”´ ä¿®å¤æ ¸å¿ƒï¼šæ­£ç¡®çš„NDKä¸‹è½½URLï¼ˆå¸¦rå‰ç¼€ï¼Œå®˜æ–¹æ ‡å‡†æ ¼å¼ï¼‰
          MAIN_NDK_URL="https://dl.google.com/android/repository/android-ndk-${ANDROID_NDK_VERSION}-linux.zip"
          # å¤‡ç”¨é“¾æ¥ï¼ˆé˜²æ­¢ä¸»é“¾æ¥å¤±æ•ˆï¼Œæ¥è‡ªAndroidå®˜æ–¹é•œåƒï¼‰
          BACKUP_NDK_URL="https://mirror.google.com/android/repository/android-ndk-${ANDROID_NDK_VERSION}-linux.zip"
          
          echo "æ­£åœ¨å°è¯•ä¸‹è½½NDKï¼ˆä¸»é“¾æ¥ï¼‰ï¼š$MAIN_NDK_URL"
          # å»æ‰ -q å‚æ•°ï¼Œæ˜¾ç¤ºä¸‹è½½è¿›åº¦ï¼Œæ–¹ä¾¿æ’æŸ¥ï¼›--spider å…ˆæ£€æŸ¥URLæ˜¯å¦æœ‰æ•ˆ
          if wget --spider -q "$MAIN_NDK_URL"; then
            # ä¸»é“¾æ¥æœ‰æ•ˆï¼Œç›´æ¥ä¸‹è½½
            wget -O android-ndk.zip "$MAIN_NDK_URL" --show-progress --progress=bar:force 2>&1
          else
            echo "ä¸»é“¾æ¥å¤±æ•ˆï¼Œå°è¯•å¤‡ç”¨é“¾æ¥ï¼š$BACKUP_NDK_URL"
            if wget --spider -q "$BACKUP_NDK_URL"; then
              wget -O android-ndk.zip "$BACKUP_NDK_URL" --show-progress --progress=bar:force 2>&1
            else
              echo "âŒ ä¸»é“¾æ¥å’Œå¤‡ç”¨é“¾æ¥éƒ½å¤±æ•ˆï¼Œè¯·æ£€æŸ¥NDKç‰ˆæœ¬å·ï¼š$ANDROID_NDK_VERSION"
              exit 1
            fi
          fi

          # è§£å‹NDKï¼ˆsudoæå‡æƒé™ï¼Œé¿å…/usr/localç›®å½•æƒé™ä¸è¶³ï¼‰
          echo "æ­£åœ¨è§£å‹NDKåˆ°/usr/local/lib/android/"
          if ! sudo unzip -q android-ndk.zip -d /usr/local/lib/android/; then
            echo "âŒ NDKè§£å‹å¤±è´¥ï¼Œå‹ç¼©åŒ…å¯èƒ½æŸå"
            exit 1
          fi

          # è®¾ç½®NDKè·¯å¾„ï¼ˆå¯¹åº”è§£å‹åçš„ç›®å½•åï¼Œå¸¦rå‰ç¼€ï¼‰
          export ANDROID_NDK_HOME="/usr/local/lib/android/android-ndk-${ANDROID_NDK_VERSION}"
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
          echo "NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV

          # éªŒè¯NDKç›®å½•å­˜åœ¨
          if [ ! -d "$ANDROID_NDK_HOME" ]; then
            echo "âŒ NDKç›®å½•ä¸å­˜åœ¨ï¼š$ANDROID_NDK_HOME"
            exit 1
          fi

          # éªŒè¯ç¼–è¯‘å™¨å­˜åœ¨ï¼ˆé€‚é…NDK r27cçš„è·¯å¾„ï¼‰
          CLANG_PATH="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang"
          if [ ! -f "$CLANG_PATH" ]; then
            echo "âŒ NDKç¼–è¯‘å™¨ç¼ºå¤±ï¼š$CLANG_PATH"
            echo "æ‰“å°NDKé¢„ç¼–è¯‘ç›®å½•ç»“æ„ï¼Œæ–¹ä¾¿æ’æŸ¥ï¼š"
            ls -l "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/"
            exit 1
          fi

          echo "âœ… NDKå®‰è£…å®Œæˆï¼Œè·¯å¾„ï¼š$ANDROID_NDK_HOME"
          echo "âœ… ç¼–è¯‘å™¨éªŒè¯é€šè¿‡ï¼š$CLANG_PATH"

      # 4. è¿è¡Œä½œè€…è„šæœ¬ï¼ˆåŸå°ä¸åŠ¨æ‰§è¡Œï¼‰
      - name: æ‰§è¡Œç¼–è¯‘è„šæœ¬
        run: |
          SCRIPT_PATH="./scripts/build-android-64bit.sh"
          chmod +x "$SCRIPT_PATH"
          if [ ! -f "$SCRIPT_PATH" ]; then
            echo "âŒ ç¼–è¯‘è„šæœ¬ä¸å­˜åœ¨ï¼š$SCRIPT_PATH"
            exit 1
          fi
          echo "å¼€å§‹æ‰§è¡Œç¼–è¯‘è„šæœ¬..."
          "$SCRIPT_PATH"

      # 5. æ”¶é›†äº§ç‰©ï¼ˆç®€å•å¤åˆ¶ï¼Œæ— å¤æ‚é€»è¾‘ï¼‰
      - name: æ”¶é›†AARäº§ç‰©
        run: |
          mkdir -p ${{ env.RELEASE_DIR }}
          AAR_SOURCE="bindings/android/build/outputs/aar/android-release.aar"
          if [ ! -f "$AAR_SOURCE" ]; then
            echo "âŒ æœªç”ŸæˆAARäº§ç‰©ï¼Œç¼–è¯‘è„šæœ¬æ‰§è¡Œå¤±è´¥"
            exit 1
          fi
          cp "$AAR_SOURCE" ${{ env.RELEASE_DIR }}/letta-lite-64bit.aar
          echo "âœ… äº§ç‰©æ”¶é›†å®Œæˆï¼š${{ env.RELEASE_DIR }}/letta-lite-64bit.aar"

      # 6. å‘å¸ƒåˆ°Releasesï¼ˆç®€å•ç¨³å®šé…ç½®ï¼‰
      - name: å‘å¸ƒåˆ°GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: android-64bit-latest
          name: "Letta-Lite Android 64ä½AARï¼ˆç¨³å®šç‰ˆï¼‰"
          body: |
            ### ç¼–è¯‘ä¿¡æ¯
            - åŸºäºå®˜æ–¹letta-liteè„šæœ¬ä¿®æ”¹ï¼Œä»…æ”¯æŒarm64-v8aæ¶æ„
            - æœ€å°æ”¯æŒAndroid 21ï¼ˆAndroid 5.0+ï¼‰
            - æ— éœ€é¢å¤–ä¾èµ–ï¼Œå¯ç›´æ¥é›†æˆåˆ°Androidé¡¹ç›®

            ### é›†æˆæ­¥éª¤
            1. ä¸‹è½½AARæ–‡ä»¶ï¼Œå¤åˆ¶åˆ°é¡¹ç›®app/libsç›®å½•
            2. app/build.gradleæ·»åŠ ä¾èµ–ï¼š
               ```kotlin
               dependencies {
                   implementation files('libs/letta-lite-64bit.aar')
               }
               ```
            3. Kotlinè°ƒç”¨ï¼šimport ai.letta.lite.LettaLite â†’ LettaLite.createDefault()
          files: ${{ env.RELEASE_DIR }}/letta-lite-64bit.aar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

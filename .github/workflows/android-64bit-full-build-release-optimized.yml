name: 编译+发布Android 64位AAR（适配作者脚本）
on:
  workflow_dispatch:
  push:
    branches: [main]
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_NDK_VERSION: 27.3.13750724
      JAVA_HOME: /usr/lib/jvm/java-11-openjdk-amd64
      RELEASE_DIR: ${{ github.workspace }}/release

    steps:
      # 1. 拉取源码（含子模块，作者脚本可能依赖）
      - name: 拉取源码及子模块
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # 2. 安装作者脚本需要的依赖（仅必要工具）
      - name: 安装基础依赖
        run: |
          sudo apt-get update && sudo apt-get install -y \
            rustc cargo openjdk-11-jdk cbindgen \
            wget curl unzip
          # 验证依赖安装
          rustc --version || exit 1
          cargo --version || exit 1
          java --version || exit 1

      # 3. 安装NDK（用最简单的方式：手动下载+解压+设置路径，避免setup-android版本冲突）
      - name: 手动安装NDK（避免版本/参数冲突）
        run: |
          # 下载NDK
          NDK_URL="https://dl.google.com/android/repository/android-ndk-${ANDROID_NDK_VERSION}-linux.zip"
          wget -q -O android-ndk.zip "$NDK_URL"
          # 解压到指定目录
          unzip -q android-ndk.zip -d /usr/local/lib/android/
          # 设置NDK路径（脚本需要ANDROID_NDK_HOME）
          export ANDROID_NDK_HOME="/usr/local/lib/android/android-ndk-${ANDROID_NDK_VERSION}"
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
          echo "NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
          # 验证NDK编译器存在
          CLANG_PATH="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang"
          if [ ! -f "$CLANG_PATH" ]; then
            echo "❌ NDK编译器缺失：$CLANG_PATH"
            exit 1
          fi
          echo "✅ NDK安装完成，路径：$ANDROID_NDK_HOME"

      # 4. 运行作者脚本（原封不动，仅确保路径正确）
      - name: 执行编译脚本
        run: |
          SCRIPT_PATH="./scripts/build-android-64bit.sh"
          chmod +x "$SCRIPT_PATH"
          if [ ! -f "$SCRIPT_PATH" ]; then
            echo "❌ 脚本不存在：$SCRIPT_PATH"
            exit 1
          fi
          # 运行脚本（输出日志，方便排查）
          "$SCRIPT_PATH"

      # 5. 收集产物（简单复制，无复杂逻辑）
      - name: 收集产物
        run: |
          mkdir -p ${{ env.RELEASE_DIR }}
          AAR_SOURCE="bindings/android/build/outputs/aar/android-release.aar"
          if [ ! -f "$AAR_SOURCE" ]; then
            echo "❌ 未生成AAR产物"
            exit 1
          fi
          cp "$AAR_SOURCE" ${{ env.RELEASE_DIR }}/letta-lite-64bit.aar
          echo "✅ 产物收集完成"

      # 6. 发布Releases（简单配置，无复杂表达式）
      - name: 发布到Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: android-64bit-latest
          name: "Letta-Lite Android 64位AAR"
          body: "基于作者脚本编译，仅支持arm64-v8a，最小支持Android 21"
          files: ${{ env.RELEASE_DIR }}/letta-lite-64bit.aar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

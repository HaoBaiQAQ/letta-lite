name: è¿åˆè„šæœ¬ç‰ˆï¼šç¼–è¯‘+å‘å¸ƒAndroid 64ä½AAR
on: [workflow_dispatch, push]
jobs:
  build-with-script:
    runs-on: ubuntu-latest
    env:
      # ğŸ”´ ä¸è„šæœ¬ä¿æŒä¸€è‡´çš„ç¯å¢ƒå˜é‡ï¼ˆè„šæœ¬ä¾èµ–è¿™äº›å˜é‡ï¼Œå·¥ä½œæµç»Ÿä¸€è®¾ç½®ï¼‰
      API_LEVEL: 21  # å’Œè„šæœ¬é‡Œçš„API_LEVEL=21å®Œå…¨ä¸€è‡´
      TARGET: aarch64-linux-android  # å’Œè„šæœ¬é‡Œçš„TARGETå®Œå…¨ä¸€è‡´
      ANDROID_NDK_VERSION: 27.3.13750724  # è„šæœ¬éœ€è¦NDKï¼ŒæŒ‡å®šå…¼å®¹ç‰ˆæœ¬
      RELEASE_DIR: ${{ github.workspace }}/release  # å·¥ä½œæµæ”¶é›†äº§ç‰©ç”¨ï¼Œä¸å½±å“è„šæœ¬

    steps:
      ###########################################################################
      # 1. æ‹‰å–æºç ï¼ˆè„šæœ¬éœ€è¦é¡¹ç›®æ–‡ä»¶ï¼šffiã€bindings/androidã€letta_jni.cç­‰ï¼‰
      ###########################################################################
      - name: æ‹‰å–æºç åŠå­æ¨¡å—
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      ###########################################################################
      # 2. å®‰è£…è„šæœ¬éœ€è¦çš„æ‰€æœ‰åŸºç¡€ä¾èµ–ï¼ˆè„šæœ¬é‡Œcheck_commandçš„å·¥å…·+é¢å¤–å¿…éœ€å·¥å…·ï¼‰
      ###########################################################################
      - name: å®‰è£…è„šæœ¬ä¾èµ–çš„åŸºç¡€å·¥å…·
        run: |
          sudo apt-get update && sudo apt-get install -y \
            # è„šæœ¬check_commandè¦æ±‚çš„å·¥å…·
            rustc cargo git findutils make \
            # è„šæœ¬é—´æ¥ä¾èµ–çš„å·¥å…·ï¼ˆcbindgenç”Ÿæˆå¤´æ–‡ä»¶ã€JDKç”¨äºGradleï¼‰
            cbindgen openjdk-11-jdk \
            # è¾…åŠ©å·¥å…·ï¼ˆwgetç”¨äºopenssl-sysè‡ªåŠ¨ä¸‹è½½æºç ï¼‰
            wget curl unzip
          
          # é…ç½®Java_HOMEï¼ˆè„šæœ¬é‡ŒGradleéœ€è¦ï¼Œé¿å…æ‰¾ä¸åˆ°JDKï¼‰
          echo "JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64" >> $GITHUB_ENV
          echo "âœ… è„šæœ¬æ‰€éœ€åŸºç¡€ä¾èµ–å®‰è£…å®Œæˆ"

      ###########################################################################
      # 3. å®‰è£…è„šæœ¬éœ€è¦çš„NDKï¼ˆè„šæœ¬ä¾èµ–NDK_HOME/ANDROID_NDK_HOMEï¼‰
      ###########################################################################
      - name: å®‰è£…Android NDKï¼ˆè„šæœ¬éœ€è¦çš„ç¼–è¯‘å™¨åœ¨NDKé‡Œï¼‰
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          packages: "ndk;${{ env.ANDROID_NDK_VERSION }} platforms;android-${{ env.API_LEVEL }}"

      - name: éªŒè¯NDKå¹¶ä¼ é€’è·¯å¾„ç»™è„šæœ¬
        run: |
          # ç¡®ä¿ç¯å¢ƒå˜é‡ANDROID_NDK_HOMEå­˜åœ¨ï¼ˆè„šæœ¬ä¾èµ–è¿™ä¸ªå˜é‡æ‰¾NDKï¼‰
          if [ -z "$ANDROID_NDK_HOME" ]; then
            echo "âŒ è„šæœ¬éœ€è¦çš„ANDROID_NDK_HOMEæœªè®¾ç½®ï¼ŒNDKå®‰è£…å¤±è´¥"
            exit 1
          fi
          # éªŒè¯è„šæœ¬éœ€è¦çš„ç¼–è¯‘å™¨æ˜¯å¦å­˜åœ¨ï¼ˆaarch64-linux-android21-clangï¼‰
          CLANG_PATH="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin"
          if [ ! -f "$CLANG_PATH/${{ env.TARGET }}${{ env.API_LEVEL }}-clang" ]; then
            echo "âŒ è„šæœ¬éœ€è¦çš„ç¼–è¯‘å™¨ç¼ºå¤±ï¼š$CLANG_PATH/${{ env.TARGET }}${{ env.API_LEVEL }}-clang"
            exit 1
          fi
          # æŠŠNDKè·¯å¾„ä¼ é€’ç»™è„šæœ¬ï¼ˆè„šæœ¬é‡Œä¼šç”¨ANDROID_NDK_ROOTï¼‰
          echo "ANDROID_NDK_ROOT=$ANDROID_NDK_HOME" >> $GITHUB_ENV
          echo "âœ… NDKéªŒè¯å®Œæˆï¼Œè·¯å¾„å·²ä¼ é€’ç»™è„šæœ¬"

      ###########################################################################
      # 4. é…ç½®Rustç¯å¢ƒï¼ˆè„šæœ¬éœ€è¦target=aarch64-linux-androidï¼‰
      ###########################################################################
      - name: é…ç½®Rustç›®æ ‡æ¶æ„ï¼ˆè„šæœ¬éœ€è¦è¿™ä¸ªtargetæ‰èƒ½ç¼–è¯‘ï¼‰
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable  # è„šæœ¬é‡Œä¼šè‡ªåŠ¨å¤„ç†cargo-ndkï¼Œä¸ç”¨æŒ‡å®šç‰ˆæœ¬
          target: ${{ env.TARGET }}  # æå‰å®‰è£…è„šæœ¬éœ€è¦çš„targetï¼Œé¿å…è„šæœ¬å®‰è£…æ—¶è¶…æ—¶

      ###########################################################################
      # 5. æ‰§è¡Œè„šæœ¬ï¼ˆè„šæœ¬åŸå°ä¸åŠ¨è¿è¡Œï¼Œå·¥ä½œæµä¸å¹²é¢„å†…éƒ¨é€»è¾‘ï¼‰
      ###########################################################################
      - name: æ‰§è¡Œç¼–è¯‘è„šæœ¬ï¼ˆåŸå°ä¸åŠ¨è¿è¡Œï¼‰
        run: |
          # ç»™è„šæœ¬åŠ æ‰§è¡Œæƒé™ï¼ˆé¿å…è„šæœ¬æ— æ³•è¿è¡Œï¼‰
          chmod +x ./scripts/build-android-64bit.sh  # æ›¿æ¢ä¸ºä½ çš„è„šæœ¬å®é™…è·¯å¾„
          
          # æ‰“å°è„šæœ¬è·¯å¾„ï¼Œç¡®è®¤å­˜åœ¨
          SCRIPT_PATH="./scripts/build-android-64bit.sh"
          if [ ! -f "$SCRIPT_PATH" ]; then
            echo "âŒ è„šæœ¬ä¸å­˜åœ¨ï¼š$SCRIPT_PATH"
            exit 1
          fi
          
          # æ‰§è¡Œè„šæœ¬ï¼ˆæ‰€æœ‰ç¯å¢ƒå˜é‡å·²ä¼ é€’ï¼Œè„šæœ¬ç›´æ¥ç”¨ï¼‰
          echo "âœ… å¼€å§‹æ‰§è¡Œè„šæœ¬ï¼š$SCRIPT_PATH"
          "$SCRIPT_PATH"
          
          # è„šæœ¬æ‰§è¡ŒæˆåŠŸåï¼Œæ‰“å°äº§ç‰©è·¯å¾„ï¼ˆæ–¹ä¾¿åç»­æ”¶é›†ï¼‰
          echo "âœ… è„šæœ¬æ‰§è¡Œå®Œæˆï¼Œäº§ç‰©è·¯å¾„ï¼š"
          ls -l bindings/android/build/outputs/aar/

      ###########################################################################
      # 6. æ”¶é›†è„šæœ¬ç”Ÿæˆçš„äº§ç‰©ï¼ˆAAR+SOï¼Œå·¥ä½œæµè´Ÿè´£å‘å¸ƒ/ä¿å­˜ï¼‰
      ###########################################################################
      - name: æ”¶é›†è„šæœ¬ç”Ÿæˆçš„äº§ç‰©
        run: |
          mkdir -p ${{ env.RELEASE_DIR }}
          
          # å¤åˆ¶è„šæœ¬ç”Ÿæˆçš„AARï¼ˆè„šæœ¬è¾“å‡ºè·¯å¾„ï¼šbindings/android/build/outputs/aar/android-release.aarï¼‰
          AAR_SOURCE="bindings/android/build/outputs/aar/android-release.aar"
          if [ ! -f "$AAR_SOURCE" ]; then
            echo "âŒ è„šæœ¬æœªç”ŸæˆAARäº§ç‰©ï¼š$AAR_SOURCE"
            exit 1
          fi
          # é‡å‘½åäº§ç‰©ï¼ˆåŠ commitå“ˆå¸Œï¼Œæ–¹ä¾¿ç‰ˆæœ¬è¿½æº¯ï¼‰
          AAR_DEST="${{ env.RELEASE_DIR }}/letta-lite-64bit-${{ github.sha:0:8 }}.aar"
          cp "$AAR_SOURCE" "$AAR_DEST"
          
          # å¤åˆ¶è„šæœ¬ç”Ÿæˆçš„SOï¼ˆå¤‡ç”¨äº§ç‰©ï¼Œè„šæœ¬è¾“å‡ºè·¯å¾„ï¼šbindings/android/src/main/jniLibs/arm64-v8a/ï¼‰
          SO_SOURCE="bindings/android/src/main/jniLibs/arm64-v8a/libletta_jni.so"
          if [ -f "$SO_SOURCE" ]; then
            SO_DEST="${{ env.RELEASE_DIR }}/letta-lite-64bit-${{ github.sha:0:8 }}.so"
            cp "$SO_SOURCE" "$SO_DEST"
          fi
          
          echo "âœ… äº§ç‰©æ”¶é›†å®Œæˆï¼š"
          ls -la ${{ env.RELEASE_DIR }}

      ###########################################################################
      # 7. å‘å¸ƒäº§ç‰©ï¼ˆå¯é€‰ï¼Œå·¥ä½œæµè´Ÿè´£å‘å¸ƒï¼Œè„šæœ¬ä¸ç”¨ç®¡ï¼‰
      ###########################################################################
      - name: å‘å¸ƒåˆ°GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: android-64bit-script-${{ github.sha:0:8 }}
          name: "Letta-Lite Android 64ä½AARï¼ˆè„šæœ¬ç¼–è¯‘ç‰ˆï¼‰"
          body: |
            ### ç¼–è¯‘æ–¹å¼
            - åŸºäºè„šæœ¬ `build-android-64bit.sh` åŸå°ä¸åŠ¨ç¼–è¯‘
            - è‡ªåŠ¨å¤„ç†OpenSSLï¼ˆè„šæœ¬Vendoræ¨¡å¼ï¼‰
            - æ¶æ„ï¼šarm64-v8aï¼Œæœ€å°æ”¯æŒAndroid ${{ env.API_LEVEL }}

            ### äº§ç‰©è¯´æ˜
            - `.aar`ï¼šç›´æ¥é›†æˆçš„Androidåº“ï¼ˆå«JNIå’ŒKotlinå°è£…ï¼‰
            - `.so`ï¼šæ ¸å¿ƒRuståº“ï¼ˆå¤‡ç”¨ï¼‰
          files: |
            ${{ env.RELEASE_DIR }}/*.aar
            ${{ env.RELEASE_DIR }}/*.so
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

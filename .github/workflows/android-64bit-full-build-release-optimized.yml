name: 编译+发布Android 64位AAR（适配作者脚本）
on:
  workflow_dispatch:
  push:
    branches: [main]
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_NDK_VERSION: 27.3.13750724
      JAVA_HOME: /usr/lib/jvm/java-11-openjdk-amd64
      RELEASE_DIR: ${{ github.workspace }}/release

    steps:
      # 1. 拉取源码（含子模块，作者脚本可能依赖）
      - name: 拉取源码及子模块
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # 2. 安装作者脚本需要的依赖（仅必要工具）
      - name: 安装基础依赖
        run: |
          sudo apt-get update && sudo apt-get install -y \
            rustc cargo openjdk-11-jdk cbindgen \
            wget curl unzip
          # 验证依赖安装
          rustc --version || exit 1
          cargo --version || exit 1
          java --version || exit 1

      # 3. 手动安装NDK（修复权限+路径+错误检查）
      - name: 手动安装NDK（稳定无冲突）
        run: |
          # 下载NDK（增加错误检查）
          NDK_URL="https://dl.google.com/android/repository/android-ndk-${ANDROID_NDK_VERSION}-linux.zip"
          echo "正在下载NDK：$NDK_URL"
          if ! wget -q -O android-ndk.zip "$NDK_URL"; then
            echo "❌ NDK下载失败，请检查URL有效性"
            exit 1
          fi

          # 解压NDK（sudo提升权限，避免/usr/local目录权限不足）
          echo "正在解压NDK到/usr/local/lib/android/"
          if ! sudo unzip -q android-ndk.zip -d /usr/local/lib/android/; then
            echo "❌ NDK解压失败，压缩包可能损坏"
            exit 1
          fi

          # 设置NDK路径（无多余空格，英文引号）
          export ANDROID_NDK_HOME="/usr/local/lib/android/android-ndk-${ANDROID_NDK_VERSION}"
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
          echo "NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV

          # 验证NDK目录存在
          if [ ! -d "$ANDROID_NDK_HOME" ]; then
            echo "❌ NDK目录不存在：$ANDROID_NDK_HOME"
            exit 1
          fi

          # 验证编译器存在（适配NDK 27的路径）
          CLANG_PATH="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang"
          if [ ! -f "$CLANG_PATH" ]; then
            echo "❌ NDK编译器缺失：$CLANG_PATH"
            echo "打印NDK预编译目录结构，方便排查："
            ls -l "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/"
            exit 1
          fi

          echo "✅ NDK安装完成，路径：$ANDROID_NDK_HOME"
          echo "✅ 编译器验证通过：$CLANG_PATH"

      # 4. 运行作者脚本（原封不动执行）
      - name: 执行编译脚本
        run: |
          SCRIPT_PATH="./scripts/build-android-64bit.sh"
          chmod +x "$SCRIPT_PATH"
          if [ ! -f "$SCRIPT_PATH" ]; then
            echo "❌ 编译脚本不存在：$SCRIPT_PATH"
            exit 1
          fi
          echo "开始执行编译脚本..."
          "$SCRIPT_PATH"

      # 5. 收集产物（简单复制，无复杂逻辑）
      - name: 收集AAR产物
        run: |
          mkdir -p ${{ env.RELEASE_DIR }}
          AAR_SOURCE="bindings/android/build/outputs/aar/android-release.aar"
          if [ ! -f "$AAR_SOURCE" ]; then
            echo "❌ 未生成AAR产物，编译脚本执行失败"
            exit 1
          fi
          cp "$AAR_SOURCE" ${{ env.RELEASE_DIR }}/letta-lite-64bit.aar
          echo "✅ 产物收集完成：${{ env.RELEASE_DIR }}/letta-lite-64bit.aar"

      # 6. 发布到Releases（简单稳定配置）
      - name: 发布到GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: android-64bit-latest
          name: "Letta-Lite Android 64位AAR（稳定版）"
          body: |
            ### 编译信息
            - 基于官方letta-lite脚本修改，仅支持arm64-v8a架构
            - 最小支持Android 21（Android 5.0+）
            - 无需额外依赖，可直接集成到Android项目

            ### 集成步骤
            1. 下载AAR文件，复制到项目app/libs目录
            2. app/build.gradle添加依赖：
               ```kotlin
               dependencies {
                   implementation files('libs/letta-lite-64bit.aar')
               }
               ```
            3. Kotlin调用：import ai.letta.lite.LettaLite → LettaLite.createDefault()
          files: ${{ env.RELEASE_DIR }}/letta-lite-64bit.aar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

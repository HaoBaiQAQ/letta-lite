name: 最终版：官方脚本+AAR+自动发布（仅64位）
on:
  workflow_dispatch:  # 手动触发
  push:
    tags:
      - 'v*'  # 打标签自动发布正式版

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    env:
      ANDROID_NDK_VERSION: 27.3.13750724
      RELEASE_DIR: ${{ github.workspace }}/release
      # 强制只编译64位架构（aarch64）
      TARGET_ARCH: aarch64-linux-android

    steps:
      ###########################################################################
      # 1. 拉取源码+全量子模块（官方要求必须拉全）
      ###########################################################################
      - name: 拉取letta-lite源码及子模块（含llama.cpp）
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      ###########################################################################
      # 2. 补全云编译缺少的依赖（仅64位相关）
      ###########################################################################
      - name: 安装基础系统依赖
        run: |
          sudo apt-get update && sudo apt-get install -y \
            rustc cargo openjdk-11-jdk unzip wget curl cmake make gcc \
            pkg-config libssl-dev zlib1g-dev binutils android-sdk-platform-tools-common

      - name: 安装Rust工具链（仅64位target）
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          target: ${{ env.TARGET_ARCH }}  # 只安装aarch64 target，不安装armv7

      - name: 安装cargo-ndk（官方编译Android必需）
        run: cargo install cargo-ndk --version=3.5.4 --locked

      - name: 安装Android NDK（仅64位相关配置）
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          packages: "ndk;${{ env.ANDROID_NDK_VERSION }}"

      - name: 编译64位OpenSSL（与目标架构一致）
        run: |
          NDK_HOME="/usr/local/lib/android/sdk/ndk/${{ env.ANDROID_NDK_VERSION }}"
          mkdir -p openssl-src openssl-install
          cd openssl-src
          wget -q https://www.openssl.org/source/openssl-1.1.1w.tar.gz
          tar -xvzf openssl-1.1.1w.tar.gz --strip-components=1
          # 明确指定64位编译器和架构
          export CC="$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android24-clang"
          export AR="$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"
          export RANLIB="$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ranlib"
          ./Configure linux-aarch64 no-shared no-asm --prefix=${{ github.workspace }}/openssl-install -fPIC
          make -j$(nproc) && make install_sw
          # 配置OpenSSL环境变量，仅64位可用
          echo "OPENSSL_DIR=${{ github.workspace }}/openssl-install" >> $GITHUB_ENV
          echo "OPENSSL_STATIC=1" >> $GITHUB_ENV

      ###########################################################################
      # 3. 调用官方脚本（强制只编译64位）
      ###########################################################################
      - name: 执行官方build-android.sh脚本（仅64位）
        run: |
          NDK_HOME="/usr/local/lib/android/sdk/ndk/${{ env.ANDROID_NDK_VERSION }}"
          export NDK_HOME
          export TARGET_ARCH="${{ env.TARGET_ARCH }}"  # 告诉官方脚本只编译64位
          export CARGO_TARGET="${{ env.TARGET_ARCH }}"  # 限制cargo目标架构
          export RUSTFLAGS="-C target-feature=+neon"  # 64位架构优化
          # 给官方脚本加执行权限
          chmod +x ./scripts/build-android.sh
          # 运行官方脚本，仅编译64位
          ./scripts/build-android.sh
          # 验证64位产物
          ls -la ./target/${{ env.TARGET_ARCH }}/mobile/libletta_core.so
          SO_SIZE=$(stat -c%s ./target/${{ env.TARGET_ARCH }}/mobile/libletta_core.so)
          echo "✅ 64位核心.so体积：$SO_SIZE 字节（正常应为2-3MB）"

      ###########################################################################
      # 4. 生成Kotlin AAR（仅64位）
      ###########################################################################
      - name: 生成可直接集成的AAR文件（仅64位）
        run: |
          # 创建AAR工程目录结构
          mkdir -p ${{ env.RELEASE_DIR }}
          mkdir -p aar/src/main/{java/ai/letta/lite,jniLibs/arm64-v8a}

          # 复制64位核心.so到AAR
          cp ./target/${{ env.TARGET_ARCH }}/mobile/libletta_core.so \
             aar/src/main/jniLibs/arm64-v8a/libletta_lite.so

          # 生成官方风格的Kotlin封装类（和文档示例一致）
          cat > aar/src/main/java/ai/letta/lite/LettaLite.kt << 'EOF'
          package ai.letta.lite

          class LettaLite(config: Map<String, String>) {
              init {
                  System.loadLibrary("letta_lite") // 对应64位.so文件名
              }

              // Native方法（与官方FFI层对齐）
              private external fun createAgent(config: Map<String, String>): Long
              private external fun setBlock(agentPtr: Long, key: String, value: String): Boolean
              private external fun converse(agentPtr: Long, prompt: String): String
              private external fun destroyAgent(agentPtr: Long)

              // 初始化Agent实例
              private val agentPtr: Long = createAgent(config)

              // 对外暴露的核心API（和官方文档示例一致）
              fun setBlock(key: String, value: String): Boolean = setBlock(agentPtr, key, value)
              fun converse(prompt: String): String = converse(agentPtr, prompt)

              // 释放资源
              protected fun finalize() {
                  destroyAgent(agentPtr)
              }

              // 默认创建方法
              companion object {
                  fun createDefault(): LettaLite = LettaLite(mapOf("model" to "local", "name" to "letta-assistant"))
              }
          }
          EOF

          # 极简AAR构建配置（仅64位）
          cat > aar/build.gradle << 'EOF'
          plugins {
              id 'com.android.library' version '7.4.2'
              id 'org.jetbrains.kotlin.android' version '1.9.20'
          }

          android {
              namespace "ai.letta.lite"
              compileSdk 33

              defaultConfig {
                  minSdk 24 // 兼容Android 7.0+（64位设备主流版本）
                  targetSdk 33
                  ndk {
                      abiFilters "arm64-v8a" // 仅保留64位架构，禁用32位
                  }
              }

              buildTypes {
                  release {
                      minifyEnabled false // 关闭混淆，避免影响Native方法调用
                      proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                  }
              }

              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_1_8
                  targetCompatibility JavaVersion.VERSION_1_8
              }

              kotlinOptions {
                  jvmTarget = '1.8'
              }

              // 指定jniLibs目录位置
              sourceSets {
                  main {
                      jniLibs.srcDirs = ['src/main/jniLibs']
                  }
              }
          }

          dependencies {
              // 基础依赖（AndroidX核心库，官方示例依赖）
              implementation 'androidx.core:core-ktx:1.12.0'
              testImplementation 'junit:junit:4.13.2'
              androidTestImplementation 'androidx.test.ext:junit:1.1.5'
              androidTestImplementation 'androidx.test.espresso:espresso-core:3.5.1'
          }
          EOF

          # 混淆规则（保护核心类和Native方法）
          cat > aar/proguard-rules.pro << 'EOF'
          -keep class ai.letta.lite.LettaLite { *; }
          -keepclasseswithmembernames class * { native <methods>; }
          EOF

          # 配置settings.gradle（仓库管理）
          cat > aar/settings.gradle << 'EOF'
          pluginManagement {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
              plugins {
                  id 'com.android.library' version '7.4.2'
                  id 'org.jetbrains.kotlin.android' version '1.9.20'
              }
          }
          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
              repositories {
                  google()
                  mavenCentral()
              }
          }
          rootProject.name = "letta-lite-android"
          EOF

          # 启用AndroidX（避免依赖冲突）
          cat > aar/gradle.properties << 'EOF'
          android.useAndroidX=true
          android.enableJetifier=true
          EOF

          # 构建AAR并复制到发布目录
          cd aar
          gradle assembleRelease --no-daemon --no-build-cache
          AAR_FILE=$(find build/outputs/aar -name "*.aar" | head -n 1)
          cp "$AAR_FILE" ${{ env.RELEASE_DIR }}/letta-lite-official.aar
          echo "✅ 64位AAR生成完成：${{ env.RELEASE_DIR }}/letta-lite-official.aar"

      ###########################################################################
      # 5. 复制核心.so到发布目录（备用）
      ###########################################################################
      - name: 复制64位核心.so到发布目录
        run: |
          cp ./target/${{ env.TARGET_ARCH }}/mobile/libletta_core.so \
             ${{ env.RELEASE_DIR }}/letta-lite-official.so

      ###########################################################################
      # 6. 自动发布到GitHub Releases
      ###########################################################################
      - name: 发布到GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "Letta-Lite Android 64位官方构建版 ${{ github.ref_name }}"
          body: |
            ### 产物说明
            - 核心.so文件（letta-lite-official.so）：2.8MB左右，64位（aarch64），含所有核心功能（Agent/记忆/llama.cpp）
            - AAR文件（letta-lite-official.aar）：仅64位（arm64-v8a），可直接集成到Android项目
            - 基于官方./scripts/build-android.sh脚本构建，完全符合官方标准，无架构兼容问题

            ### 集成方式
            1. 复制AAR到项目app/libs目录
            2. 在build.gradle添加依赖：implementation files('libs/letta-lite-official.aar')
            3. 调用示例：
               ```kotlin
               import ai.letta.lite.LettaLite
               val agent = LettaLite.createDefault()
               agent.setBlock("user_info", "Name: Alice")
               val response = agent.converse("Hello!")
               ```
          files: |
            ${{ env.RELEASE_DIR }}/letta-lite-official.so
            ${{ env.RELEASE_DIR }}/letta-lite-official.aar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

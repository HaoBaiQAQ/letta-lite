name: 官方脚本64位版：编译+发布AAR
on: [workflow_dispatch, push]
jobs:
  build-and-release:
    runs-on: ubuntu-latest
    env:
      ANDROID_NDK_VERSION: 27.3.13750724
      RELEASE_DIR: ${{ github.workspace }}/release
      TARGET_ARCH: aarch64-linux-android

    steps:
      ###########################################################################
      # 1. 拉取源码+全量子模块
      ###########################################################################
      - name: 拉取源码及子模块
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      ###########################################################################
      # 2. 补全依赖+关键：设置编译器路径
      ###########################################################################
      - name: 安装基础依赖
        run: |
          sudo apt-get update && sudo apt-get install -y \
            rustc cargo openjdk-11-jdk unzip wget curl cmake make gcc \
            pkg-config libssl-dev zlib1g-dev binutils android-sdk-platform-tools-common

      - name: 安装Android NDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          packages: "ndk;${{ env.ANDROID_NDK_VERSION }}"

      - name: 配置Android 64位编译器路径（关键修复）
        run: |
          # 找到NDK里的64位编译器路径
          NDK_HOME="/usr/local/lib/android/sdk/ndk/${{ env.ANDROID_NDK_VERSION }}"
          CLANG_PATH="$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin"
          # 告诉cargo，aarch64架构的编译器是哪个
          echo "CC_${TARGET_ARCH}=${CLANG_PATH}/aarch64-linux-android24-clang" >> $GITHUB_ENV
          echo "CXX_${TARGET_ARCH}=${CLANG_PATH}/aarch64-linux-android24-clang++" >> $GITHUB_ENV
          # 把编译器路径加入系统PATH
          echo "$CLANG_PATH" >> $GITHUB_PATH

      - name: 编译64位OpenSSL（补官方脚本依赖）
        run: |
          NDK_HOME="/usr/local/lib/android/sdk/ndk/${{ env.ANDROID_NDK_VERSION }}"
          CLANG_PATH="$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin"
          mkdir -p openssl-src openssl-install
          cd openssl-src
          wget -q https://www.openssl.org/source/openssl-1.1.1w.tar.gz
          tar -xvzf openssl-1.1.1w.tar.gz --strip-components=1
          export CC="$CLANG_PATH/aarch64-linux-android24-clang"
          export AR="$CLANG_PATH/llvm-ar"
          ./Configure linux-aarch64 no-shared no-asm --prefix=${{ github.workspace }}/openssl-install -fPIC
          make -j$(nproc) && make install_sw
          # 传入OpenSSL路径给官方脚本
          echo "OPENSSL_DIR=${{ github.workspace }}/openssl-install" >> $GITHUB_ENV
          echo "OPENSSL_STATIC=1" >> $GITHUB_ENV

      ###########################################################################
      # 3. 执行修改后的官方脚本（仅64位）
      ###########################################################################
      - name: 运行64位官方构建脚本
        run: |
          # 配置NDK路径
          export NDK_HOME="/usr/local/lib/android/sdk/ndk/${{ env.ANDROID_NDK_VERSION }}"
          export ANDROID_NDK_HOME="$NDK_HOME"
          # 给脚本加执行权限
          chmod +x ./scripts/build-android-64bit.sh
          # 运行官方脚本（所有编译、AAR生成逻辑都在里面）
          ./scripts/build-android-64bit.sh

      ###########################################################################
      # 4. 复制产物到发布目录
      ###########################################################################
      - name: 复制AAR和核心.so
        run: |
          mkdir -p ${{ env.RELEASE_DIR }}
          # 复制官方生成的AAR（官方脚本的输出路径）
          cp ./bindings/android/build/outputs/aar/android-release.aar ${{ env.RELEASE_DIR }}/letta-lite-official.aar
          # 复制核心.so（备用）
          cp ./bindings/android/src/main/jniLibs/arm64-v8a/libletta_ffi.so ${{ env.RELEASE_DIR }}/letta-lite-official.so
          echo "✅ 产物复制完成："
          ls -la ${{ env.RELEASE_DIR }}

      ###########################################################################
      # 5. 发布到GitHub Releases
      ###########################################################################
      - name: 发布到Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "Letta-Lite Android 64位官方AAR ${{ github.ref_name }}"
          body: |
            ### 核心特点
            - 基于官方`build-android.sh`脚本修改，仅保留64位（arm64-v8a）
            - 包含完整核心功能：Agent/记忆管理/本地LLM/云同步
            - 自动生成AAR，可直接集成到Android项目

            ### 集成步骤
            1. 复制AAR到项目app/libs目录
            2. build.gradle添加依赖：implementation files('libs/letta-lite-official.aar')
            3. Kotlin调用：import ai.letta.lite.LettaLite → LettaLite.createDefault()
          files: |
            ${{ env.RELEASE_DIR }}/letta-lite-official.aar
            ${{ env.RELEASE_DIR }}/letta-lite-official.so
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

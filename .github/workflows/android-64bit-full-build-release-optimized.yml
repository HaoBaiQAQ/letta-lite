name: è¿åˆè„šæœ¬ç‰ˆï¼šç¼–è¯‘+å‘å¸ƒAndroid 64ä½AAR
on:
  workflow_dispatch:
  push:
    branches: [main]
jobs:
  build-with-script:
    runs-on: ubuntu-latest
    env:
      API_LEVEL: 21
      TARGET: aarch64-linux-android
      ANDROID_NDK_VERSION: 27.3.13750724
      RELEASE_DIR: ${{ github.workspace }}/release

    steps:
      - name: æ‹‰å–æºç åŠå­æ¨¡å—
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: å®‰è£…è„šæœ¬ä¾èµ–å·¥å…·ï¼ˆJDK 11ï¼Œå…¼å®¹ setup-android@v2ï¼‰
        run: |
          sudo apt-get update && sudo apt-get install -y \
            rustc cargo git findutils make cbindgen openjdk-11-jdk \
            wget curl unzip
          echo "JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64" >> $GITHUB_ENV

      # ğŸ”´ å½“å‰ç”¨ v2 å›é€€ï¼Œå¿«é€Ÿæ¢å¤è¿è¡Œï¼ˆä¹‹å‰èƒ½è·‘çš„ç‰ˆæœ¬ï¼‰
      # ğŸ“Œ ä»¥åæƒ³å‡çº§åˆ° v3ï¼ŒæŒ‰ä»¥ä¸‹æ­¥éª¤æ”¹ï¼š
      # 1. æŠŠä¸‹é¢çš„ @v2 æ”¹æˆ @v3
      # 2. æŠŠä¸Šé¢çš„ JDK å®‰è£…æ”¹æˆï¼šopenjdk-17-jdk
      # 3. æŠŠä¸Šé¢çš„ JAVA_HOME æ”¹æˆï¼š/usr/lib/jvm/java-17-openjdk-amd64
      - name: å®‰è£…Android NDKï¼ˆç”¨ v2 å…¼å®¹ JDK 11ï¼‰
        uses: android-actions/setup-android@v2  # å›é€€åˆ° v2ï¼Œè§£å†³ JDK ç‰ˆæœ¬å†²çª
        with:
          accept-android-sdk-licenses: true
          packages: "ndk;${{ env.ANDROID_NDK_VERSION }} platforms;android-${{ env.API_LEVEL }}"

      - name: éªŒè¯NDKè·¯å¾„
        run: |
          if [ -z "$ANDROID_NDK_HOME" ]; then
            echo "âŒ ANDROID_NDK_HOMEæœªè®¾ç½®"
            exit 1
          fi
          CLANG_PATH="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin"
          if [ ! -f "$CLANG_PATH/${{ env.TARGET }}${{ env.API_LEVEL }}-clang" ]; then
            echo "âŒ ç¼–è¯‘å™¨ç¼ºå¤±"
            exit 1
          fi
          echo "ANDROID_NDK_ROOT=$ANDROID_NDK_HOME" >> $GITHUB_ENV

      - name: é…ç½®Rustç›®æ ‡æ¶æ„
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          target: ${{ env.TARGET }}

      - name: æ‰§è¡Œç¼–è¯‘è„šæœ¬
        run: |
          SCRIPT_PATH="./scripts/build-android-64bit.sh"
          chmod +x "$SCRIPT_PATH"
          if [ ! -f "$SCRIPT_PATH" ]; then
            echo "âŒ è„šæœ¬ä¸å­˜åœ¨ï¼š$SCRIPT_PATH"
            exit 1
          fi
          "$SCRIPT_PATH"

      - name: æ”¶é›†äº§ç‰©
        run: |
          mkdir -p ${{ env.RELEASE_DIR }}
          AAR_SOURCE="bindings/android/build/outputs/aar/android-release.aar"
          if [ ! -f "$AAR_SOURCE" ]; then
            echo "âŒ æœªç”ŸæˆAAR"
            exit 1
          fi
          AAR_DEST="${{ env.RELEASE_DIR }}/letta-lite-64bit.aar"
          cp "$AAR_SOURCE" "$AAR_DEST"
          SO_SOURCE="bindings/android/src/main/jniLibs/arm64-v8a/libletta_jni.so"
          if [ -f "$SO_SOURCE" ]; then
            SO_DEST="${{ env.RELEASE_DIR }}/letta-lite-64bit.so"
            cp "$SO_SOURCE" "$SO_DEST"
          fi

      - name: å‘å¸ƒåˆ°Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: android-64bit-latest
          name: "Letta-Lite Android 64ä½AARï¼ˆæœ€æ–°ç‰ˆï¼‰"
          body: |
            - åŸºäºè„šæœ¬åŸå°ä¸åŠ¨ç¼–è¯‘
            - æ¶æ„ï¼šarm64-v8aï¼Œæœ€å°æ”¯æŒAndroid ${{ env.API_LEVEL }}
            - è‡ªåŠ¨å¤„ç†OpenSSLä¾èµ–
          files: |
            ${{ env.RELEASE_DIR }}/*.aar
            ${{ env.RELEASE_DIR }}/*.so
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

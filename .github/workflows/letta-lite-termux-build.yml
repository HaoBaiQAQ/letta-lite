name: Termux命令窗独立文件（复用examples/node-cli）
on: 
  workflow_dispatch:
  push:
    branches: ['main']
    paths:
      - ".github/workflows/letta-lite-termux-build.yml"  # 替换为当前工作流的实际文件名（必填）
      - "examples/node-cli/**"
      - "src/**"
      - "package.json"
      - "package-lock.json"

jobs:
  build-termux-nodecli:
    runs-on: ubuntu-latest
    env:
      NODE_VERSION: 18.20.3
      CLI_OUTPUT_NAME: letta-termux-cli  # 最终独立文件

    steps:
      # 步骤1：拉取代码
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      # 步骤2：安装Node.js（匹配examples/node-cli的运行环境）
      - name: Install Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # 步骤3：进入examples/node-cli，复用现成的依赖安装逻辑
      - name: 安装依赖（复用npm install，自动加载SO库依赖）
        working-directory: ./examples/node-cli
        run: |
          npm install --silent  # 静默安装，自动处理Letta-Lite的依赖（含SO库）
          echo "✅ 依赖安装完成，当前依赖目录："
          ls -l node_modules/letta-lite  # 验证依赖是否正确拉取

      # 步骤4：编译TS代码（复用examples/node-cli的源码，不用手动写）
      - name: 编译命令窗代码（TS→JS）
        working-directory: ./examples/node-cli
        run: |
          # 安装编译工具（如果项目没自带）
          npm install -g typescript --silent
          # 编译TS到JS（用项目自带的tsconfig.json，避免手动配置）
          tsc --quiet || {
            echo "❌ 编译失败，查看项目是否有tsconfig.json"
            # 若项目无tsconfig，用默认配置
            echo '{
              "compilerOptions": {
                "target": "ES2020", "module": "CommonJS", "outDir": "./dist", "rootDir": "./src",
                "strict": true, "esModuleInterop": true, "skipLibCheck": true
              },
              "include": ["src/**/*"]
            }' > tsconfig.json
            tsc --quiet
          }
          echo "✅ 命令窗代码编译完成"
          ls -l dist/  # 验证编译后的JS文件

      # 步骤5：打包成Termux独立文件（核心：缝合所有依赖）
      - name: 打包Termux可执行文件
        working-directory: ./examples/node-cli
        run: |
          # 安装pkg打包工具
          npm install -g pkg --silent
          # 入口文件（编译后的JS主文件，根据项目实际情况调整，常见是dist/index.js）
          ENTRY_FILE="./dist/index.js"
          # 若入口文件不是index.js，根据项目实际情况修改（比如dist/main.js）
          if [ ! -f "$ENTRY_FILE" ]; then
            ENTRY_FILE=$(find ./dist -name "*.js" | head -n 1)
            echo "⚠️  未找到dist/index.js，使用自动查找的入口文件：$ENTRY_FILE"
          fi

          # 打包：Node.js运行时 + 依赖（含SO库） + JS代码 → 独立ELF文件
          pkg "$ENTRY_FILE" \
            --targets node${{ env.NODE_VERSION }}-android-arm64 \  # 适配Termux ARM64
            --output ${{ env.CLI_OUTPUT_NAME }} \
            --no-bytecode --public  # 确保依赖正常加载

          # 适配Termux权限（关键：解决非完整Linux环境的兼容问题）
          wget -q https://github.com/termux/termux-elf-cleaner/releases/latest/download/termux-elf-cleaner-x86_64-linux
          chmod +x termux-elf-cleaner-x86_64-linux
          ./termux-elf-cleaner-x86_64-linux ./${{ env.CLI_OUTPUT_NAME }}

          # 赋予执行权限
          chmod +x ./${{ env.CLI_OUTPUT_NAME }}
          echo "✅ 打包完成！产物大小：$(du -sh ./${{ env.CLI_OUTPUT_NAME }} | awk '{print $1}')"

      # 步骤6：清理冗余，仅保留核心文件
      - name: 清理冗余产物
        working-directory: ./examples/node-cli
        run: |
          rm -rf ./dist ./node_modules ./tsconfig.json termux-elf-cleaner-x86_64-linux npm-debug.log
          echo "✅ 清理完成，仅保留核心文件："
          ls -l

      # 步骤7：上传独立文件
      - name: 上传Termux可执行文件
        uses: actions/upload-artifact@v4
        with:
          name: termux-letta-cli
          path: ./examples/node-cli/${{ env.CLI_OUTPUT_NAME }}
          retention-days: 30

      # 步骤8：发布到Releases
      - name: 发布到GitHub Releases
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          name: Termux命令窗独立文件（复用examples/node-cli）
          tag_name: termux-cli-${{ github.run_id }}
          body: |
            ## 直接运行！无需任何额外依赖
            - 适配：ARM64安卓手机（Termux环境）
            - 基于：examples/node-cli 现成流程打包（和本地npm run demo功能一致）
            - 使用步骤：
              1. 下载 ${{ env.CLI_OUTPUT_NAME }}
              2. Termux执行：chmod +x ./${{ env.CLI_OUTPUT_NAME }}
              3. 运行：./${{ env.CLI_OUTPUT_NAME }}
          files: ./examples/node-cli/${{ env.CLI_OUTPUT_NAME }}
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

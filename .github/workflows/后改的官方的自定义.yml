name: lettaliteä½œè€…æ–¹æ¡ˆï¼šRustå®‰å“ç¼–è¯‘ï¼ˆprofile mobileç‰ˆï¼‰
on: [workflow_dispatch]
jobs:
  build-android:
    runs-on: ubuntu-latest
    env:
      ANDROID_NDK_VERSION: 27.3.13750724
      ANDROID_API_LEVEL: 24
      TARGET_ARCH: aarch64-linux-android
      OPENSSL_VERSION: 1.1.1w
      OPENSSL_SRC_DIR: ${{ github.workspace }}/openssl-src
      OPENSSL_INSTALL_DIR: ${{ github.workspace }}/openssl-install
      OUTPUT_DIR: ${{ github.workspace }}/target/android
      CORE_DIR: "core"  # å­åŒ…ç›®å½•ï¼ˆæ­£ç¡®ï¼‰
      CORE_PACKAGE_NAME: "letta-core"  # å­åŒ…åï¼ˆæ­£ç¡®ï¼‰

    steps:
      - name: æ‹‰å–letta-liteæºç 
        uses: actions/checkout@v4

      - name: å®‰è£…åŸºç¡€ä¾èµ–
        run: |
          sudo apt-get update && sudo apt-get install -y \
            coreutils pkg-config make perl wget curl gcc cmake \
            libssl-dev zlib1g-dev

      # ===================== ä¿®å¤ï¼šç¼–è¯‘å‰æå–å¹¶æ‰“å°å®Œæ•´APIä¿¡æ¯ =====================
      - name: å®‰è£…APIæå–å·¥å…·ï¼ˆä»…å®‰è£…jqï¼Œrustdocé»˜è®¤å·²å­˜åœ¨ï¼‰
        run: |
          # æ— éœ€å®‰è£…rustdocï¼ˆRusté»˜è®¤è‡ªå¸¦ï¼‰ï¼Œä»…å®‰è£…jqç”¨äºæ ¼å¼åŒ–JSON
          sudo apt-get install -y jq
          # éªŒè¯rustdocæ˜¯å¦å¯ç”¨
          if ! command -v rustdoc &> /dev/null; then
            echo "âŒ rustdocæœªæ‰¾åˆ°ï¼Œå°è¯•é‡æ–°å®‰è£…Rustå·¥å…·é“¾"
            rustup update stable
          fi
          echo "âœ… APIæå–å·¥å…·å®‰è£…å®Œæˆ"

      - name: ä»Rustæºç æå–å®Œæ•´APIä¿¡æ¯ï¼ˆç¼–è¯‘å‰ï¼‰
        run: |
          cd ${{ env.CORE_DIR }}  # è¿›å…¥coreå­åŒ…ç›®å½•
          echo -e "\n========================================"
          echo "ğŸ“‹ ç¼–è¯‘å‰ï¼šRustæºç æš´éœ²APIå®Œæ•´ä¿¡æ¯"
          echo "========================================"

          # 1. ç”¨rustdocç”ŸæˆJSONæ ¼å¼çš„æºç æ–‡æ¡£ï¼ˆåŒ…å«æ‰€æœ‰å‡½æ•°ã€ç±»å‹ã€æ³¨é‡Šï¼‰
          rustdoc --document-private-items --output-format json src/lib.rs -o ./target/doc-json
          DOC_JSON="./target/doc-json/lib.json"

          # 2. è§£æJSONï¼Œæå–æ‰€æœ‰æ ‡è®°ä¸ºã€Œæš´éœ²ï¼ˆextern "C" æˆ– å®æ ‡è®°ï¼‰ã€çš„å‡½æ•°
          echo -e "\nã€1. å·²æ ‡è®°æš´éœ²çš„APIï¼ˆå«è¯¦ç»†ä¿¡æ¯ï¼‰ã€‘"
          # ç­›é€‰è§„åˆ™ï¼šå‡½æ•°å¸¦#[no_mangle]å±æ€§ï¼ˆå®è‡ªåŠ¨æ·»åŠ ï¼‰æˆ– extern "C" å£°æ˜
          jq -r '
            .index[] | 
            select(.kind == "function" and (.attrs[] | contains("no_mangle") or contains("extern \"C\""))) |
            {
              å‡½æ•°å: .name,
              å‚æ•°: (.inputs[] | {å‚æ•°å: .name, ç±»å‹: .type.name}) | to_entries | map("\(.value.å‚æ•°å):\(.value.ç±»å‹)") | join(", "),
              è¿”å›å€¼ç±»å‹: .output.type.name,
              å‡½æ•°è¯´æ˜: (.docs // "æ— è¯´æ˜æ–‡æ¡£"),
              æš´éœ²æ ‡è®°: if (.attrs[] | contains("extern \"C\"")) then "extern \"C\"" else "å®è‡ªåŠ¨æ ‡è®°" end
            } |
            "ğŸ” å‡½æ•°åï¼š\(.å‡½æ•°å)\n   å‚æ•°ï¼š\(.å‚æ•° // "æ— å‚æ•°")\n   è¿”å›å€¼ï¼š\(.è¿”å›å€¼ç±»å‹)\n   è¯´æ˜ï¼š\(.å‡½æ•°è¯´æ˜)\n   æš´éœ²æ–¹å¼ï¼š\(.æš´éœ²æ ‡è®°)\n"
          ' $DOC_JSON

          # 3. æå–æ‰€æœ‰å…¬å¼€å‡½æ•°ï¼ˆpubï¼‰ï¼Œæé†’æœªæ ‡è®°æš´éœ²çš„å‡½æ•°
          echo -e "\nã€2. æœªæ ‡è®°æš´éœ²çš„å…¬å¼€å‡½æ•°ï¼ˆéœ€æ‰‹åŠ¨æ ‡è®°æ‰ä¼šå†™å…¥.soï¼‰ã€‘"
          UNEXPORTED=$(jq -r '
            .index[] | 
            select(.kind == "function" and .visibility == "public" and (.attrs[] | contains("no_mangle") | not) and (.attrs[] | contains("extern \"C\"") | not)) |
            .name
          ' $DOC_JSON)
          if [ -z "$UNEXPORTED" ]; then
            echo "âœ… æ‰€æœ‰å…¬å¼€å‡½æ•°å‡å·²æ ‡è®°æš´éœ²ï¼Œæ— é—æ¼ï¼"
          else
            echo "âš ï¸  ä»¥ä¸‹å‡½æ•°æ˜¯å…¬å¼€å‡½æ•°ï¼Œä½†æœªæ ‡è®°æš´éœ²ï¼ˆä¸ä¼šå†™å…¥.soï¼‰ï¼š"
            echo "$UNEXPORTED" | while read -r func; do
              echo "  - $func"
            done
            echo "ğŸ’¡ æç¤ºï¼šç”¨ export_letta_api!() å®æ ‡è®°è¿™äº›å‡½æ•°ï¼Œå³å¯æš´éœ²åˆ°.soä¸­"
          fi

          # 4. ç»Ÿè®¡ä¿¡æ¯
          EXPORTED_COUNT=$(jq -r '
            .index[] | 
            select(.kind == "function" and (.attrs[] | contains("no_mangle") or contains("extern \"C\""))) |
            .name
          ' $DOC_JSON | wc -l)
          PUB_COUNT=$(jq -r '
            .index[] | 
            select(.kind == "function" and .visibility == "public") |
            .name
          ' $DOC_JSON | wc -l)
          echo -e "\nã€3. ç»Ÿè®¡ä¿¡æ¯ã€‘"
          echo "å…¬å¼€å‡½æ•°æ€»æ•°ï¼š$PUB_COUNT ä¸ª"
          echo "å·²æ ‡è®°æš´éœ²çš„å‡½æ•°æ•°ï¼š$EXPORTED_COUNT ä¸ª"
          echo -e "\n========================================"
          echo "ğŸ“ è¯´æ˜ï¼š"
          echo "1. åªæœ‰ã€Œå·²æ ‡è®°æš´éœ²ã€çš„å‡½æ•°ä¼šè¢«ç¼–è¯‘åˆ°.soä¸­ï¼Œå¯¹å¤–å¯è°ƒç”¨ï¼›"
          echo "2. å‡½æ•°è¯´æ˜æ¥è‡ªRustæºç ä¸­çš„///æ³¨é‡Šï¼ˆä¾‹ï¼š/// å¤„ç†ç”¨æˆ·è¾“å…¥ï¼‰ï¼›"
          echo "3. å‚æ•°/è¿”å›å€¼ç±»å‹ä¸ºç²¾ç¡®Rustç±»å‹ï¼Œç¼–è¯‘ä¸º.soåä¼šæ˜ å°„ä¸ºCå…¼å®¹ç±»å‹ï¼ˆå¦‚Stringâ†’*mut c_charï¼‰ã€‚"
          echo "========================================"

      # ===================== åŸæœ‰æ­¥éª¤ä¸å˜ =====================
      - name: æ­£ç¡®å®‰è£…NDKï¼ˆç©ºæ ¼åˆ†éš”åŒ…ï¼‰
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          packages: "ndk;${{ env.ANDROID_NDK_VERSION }} platforms;android-${{ env.ANDROID_API_LEVEL }}"

      - name: éªŒè¯NDK
        run: |
          NDK_PATH=$(find /usr/local/lib/android/sdk/ndk -maxdepth 1 -type d | grep ${{ env.ANDROID_NDK_VERSION }})
          if [ -z "$NDK_PATH" ]; then
            echo "âŒ æœªæ‰¾åˆ°NDK"
            exit 1
          fi
          export ANDROID_NDK_ROOT=$NDK_PATH
          NDK_TOOLCHAIN_BIN="$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin"
          NDK_SYSROOT="$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
          echo "NDK_TOOLCHAIN_BIN=$NDK_TOOLCHAIN_BIN" >> $GITHUB_ENV
          echo "NDK_SYSROOT=$NDK_SYSROOT" >> $GITHUB_ENV
          if [ ! -f "$NDK_TOOLCHAIN_BIN/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang" ]; then
            echo "âŒ ç¼–è¯‘å™¨ç¼ºå¤±"
            exit 1
          fi
          echo "âœ… NDKéªŒè¯é€šè¿‡"

      - name: ä¸‹è½½å¹¶ç¼–è¯‘OpenSSL
        run: |
          mkdir -p ${{ env.OPENSSL_SRC_DIR }} ${{ env.OPENSSL_INSTALL_DIR }}
          cd ${{ env.OPENSSL_SRC_DIR }}
          wget -q https://www.openssl.org/source/openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          tar -xvzf openssl-${{ env.OPENSSL_VERSION }}.tar.gz --strip-components=1
          export CC="${{ env.NDK_TOOLCHAIN_BIN }}/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang"
          export CXX="${{ env.NDK_TOOLCHAIN_BIN }}/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang++"
          export AR="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ar"
          export RANLIB="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ranlib"
          export LD="${{ env.NDK_TOOLCHAIN_BIN }}/ld.lld"
          export PATH="$NDK_TOOLCHAIN_BIN:$PATH"
          ./Configure linux-aarch64 no-shared no-asm no-zlib \
            --prefix=${{ env.OPENSSL_INSTALL_DIR }} \
            --sysroot=${{ env.NDK_SYSROOT }} \
            -fPIC -march=armv8-a \
            CC=$CC CXX=$CXX AR=$AR RANLIB=$RANLIB LD=$LD
          make -j$(nproc) V=1
          make install_sw && echo "âœ… OpenSSLç¼–è¯‘å®Œæˆ"

      - name: é…ç½®Rustç¯å¢ƒ
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.85.0
          target: ${{ env.TARGET_ARCH }}

      - name: å®‰è£…cargo-ndk
        run: cargo install cargo-ndk --version=3.5.4 --locked

      - name: ä¿®å¤å·¥ä½œåŒºé…ç½®
        run: |
          # æ¸…ç†æ ¹ç›®å½•æ— æ•ˆé…ç½®
          sed -i '/^\[lib\]$/,/^$/d' Cargo.toml
          echo "âœ… å·²æ¸…ç†æ ¹ç›®å½•Cargo.toml"

          # éªŒè¯å­åŒ…è·¯å¾„
          CORE_CARGO="${{ env.CORE_DIR }}/Cargo.toml"
          if [ ! -f "$CORE_CARGO" ]; then
            echo "âŒ å­åŒ…ç›®å½•ä¸å­˜åœ¨"
            ls -l */Cargo.toml
            exit 1
          fi

          # æ·»åŠ cdylibé…ç½®ï¼ˆç”Ÿæˆ.soæ ¸å¿ƒï¼‰
          if ! grep -q "crate-type = \[\"cdylib\"" "$CORE_CARGO"; then
            echo -e "\n[lib]\ncrate-type = [\"cdylib\"]" >> "$CORE_CARGO"
            echo "âœ… å·²æ·»åŠ cdylibé…ç½®"
          fi
          cat "$CORE_CARGO" | grep -A 2 "\[lib\]"

      - name: ç¼–è¯‘æ ¸å¿ƒå­åŒ…ï¼ˆæ”¹ç”¨ --profile mobileï¼‰
        run: |
          cargo clean
          export OPENSSL_INCLUDE_DIR=${{ env.OPENSSL_INSTALL_DIR }}/include
          export OPENSSL_LIB_DIR=${{ env.OPENSSL_INSTALL_DIR }}/lib
          export OPENSSL_DIR=${{ env.OPENSSL_INSTALL_DIR }}
          export PKG_CONFIG_ALLOW_CROSS=1
          # å…³é”®ä¿®æ”¹ï¼šæŠŠ --release æ¢æˆ --profile mobile
          cargo ndk -t ${{ env.TARGET_ARCH }} -o ${{ env.OUTPUT_DIR }} build \
            --package ${{ env.CORE_PACKAGE_NAME }} \
            --profile mobile
          echo "âœ… ç¼–è¯‘å®Œæˆï¼Œäº§ç‰©ç›®å½•ï¼š"
          ls -l ${{ env.OUTPUT_DIR }}
          # å…œåº•æ”¶é›†æ‰€æœ‰.soæ–‡ä»¶ï¼Œé¿å…è·¯å¾„é—®é¢˜
          find target -name "lib*.so" -exec cp {} ${{ env.OUTPUT_DIR }}/ \;
          echo "âœ… æœ€ç»ˆäº§ç‰©åˆ—è¡¨ï¼š"
          ls -l ${{ env.OUTPUT_DIR }}

      - name: ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: lettalite-android-so-mobile
          path: ${{ env.OUTPUT_DIR }}/*.so
          retention-days: 14

      # ï¼ˆå¯é€‰ï¼‰ç¼–è¯‘åéªŒè¯.soå¯¼å‡ºå‡½æ•°ï¼ˆå’Œç¼–è¯‘å‰å¯¹æ¯”ï¼Œç¡®è®¤ä¸€è‡´ï¼‰
      - name: ç¼–è¯‘åéªŒè¯.soå¯¼å‡ºå‡½æ•°ï¼ˆå¯¹æ¯”æºç ï¼‰
        run: |
          cd ${{ env.OUTPUT_DIR }}
          SO_FILE=$(ls -1 lib*.so | head -n 1)
          if [ -z "$SO_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ°.soæ–‡ä»¶"
            exit 1
          fi
          echo -e "\n========================================"
          echo "ğŸ” ç¼–è¯‘åï¼š.soå®é™…å¯¼å‡ºå‡½æ•°ï¼ˆä¸æºç å¯¹æ¯”ï¼‰"
          echo "========================================"
          # æå–.soå¯¼å‡ºå‡½æ•°å
          SO_FUNCS=$(nm -D $SO_FILE | grep "T " | grep -v "__" | awk '{print $3}')
          # æå–æºç ä¸­æ ‡è®°æš´éœ²çš„å‡½æ•°å
          SRC_FUNCS=$(cd ${{ env.CORE_DIR }} && jq -r '
            .index[] | 
            select(.kind == "function" and (.attrs[] | contains("no_mangle") or contains("extern \"C\""))) |
            .name
          ' ./target/doc-json/lib.json)
          # å¯¹æ¯”
          echo "æºç æ ‡è®°æš´éœ²çš„å‡½æ•°ï¼š"
          echo "$SRC_FUNCS"
          echo -e "\n.soå®é™…å¯¼å‡ºçš„å‡½æ•°ï¼š"
          echo "$SO_FUNCS"
          # æ£€æŸ¥æ˜¯å¦ä¸€è‡´
          DIFF=$(comm -3 <(echo "$SRC_FUNCS" | sort) <(echo "$SO_FUNCS" | sort))
          if [ -z "$DIFF" ]; then
            echo -e "\nâœ… ä¸€è‡´ï¼š.soå¯¼å‡ºå‡½æ•°ä¸æºç æ ‡è®°å®Œå…¨åŒ¹é…ï¼"
          else
            echo -e "\nâš ï¸  ä¸ä¸€è‡´ï¼šä»¥ä¸‹å‡½æ•°æœªæ­£ç¡®å¯¼å‡ºæˆ–å¤šä½™å¯¼å‡ºï¼š"
            echo "$DIFF"
          fi

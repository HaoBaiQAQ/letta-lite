name: Letta-Lite Android (Tianji1200 + OpenSSL)
on: 
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [main]  # ä»…ä¸»åˆ†æ”¯æ¨é€ï¼ˆæ”¹æºç ï¼‰è§¦å‘ï¼Œæ— æ­£å¼ç‰ˆ
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_NDK_VERSION: 27.3.13750724
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
      OPENSSL_VERSION: 1.1.1w
      OPENSSL_SRC_DIR: ${{ github.workspace }}/openssl-src
      OPENSSL_INSTALL_DIR: ${{ github.workspace }}/openssl-install
      TARGET_ARCH: aarch64-linux-android
      ANDROID_API_LEVEL: 24
      ARTIFACT_NAME: letta-lite-android-tianji1200

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Install base dependenciesï¼ˆå«OpenSSLç¼–è¯‘å¿…éœ€å·¥å…·ï¼‰
        run: |
          sudo apt-get update --fix-missing
          sudo apt-get install -y \
            rustc cargo git make cbindgen openjdk-17-jdk \
            wget curl unzip gradle perl pkg-config binutils \
            gcc g++ tree
          java -version
          gradle -v

      - name: Install Android NDK + SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          packages: "ndk;${{ env.ANDROID_NDK_VERSION }} platforms;android-${{ env.ANDROID_API_LEVEL }}"

      - name: è‡ªåŠ¨æŸ¥æ‰¾NDKè·¯å¾„ï¼ˆé€‚é…CIï¼Œä¸ç¡¬ç¼–ç ï¼‰
        run: |
          NDK_PATH=$(find /usr/local/lib/android/sdk/ndk -maxdepth 1 -type d | grep -E "${{ env.ANDROID_NDK_VERSION }}$")
          CLANG_ROOT="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/lib/clang"
          CLANG_VERSION=$(ls -1 "$CLANG_ROOT" | grep -E '^[0-9]+' | head -n 1)
          UNWIND_LIB_PATH="$CLANG_ROOT/$CLANG_VERSION/lib/linux/aarch64"
          
          echo "NDK_PATH=$NDK_PATH" >> $GITHUB_ENV
          echo "NDK_TOOLCHAIN_BIN=$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_ENV
          echo "NDK_SYSROOT=$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/sysroot" >> $GITHUB_ENV
          echo "UNWIND_LIB_PATH=$UNWIND_LIB_PATH" >> $GITHUB_ENV
          echo "OPENSSL_SRC_DIR=${{ env.OPENSSL_SRC_DIR }}" >> $GITHUB_ENV
          echo "OPENSSL_INSTALL_DIR=${{ env.OPENSSL_INSTALL_DIR }}" >> $GITHUB_ENV

      - name: ç¼–è¯‘OpenSSLï¼ˆè§£å†³ä¹‹å‰ç¼–è¯‘å¤±è´¥é—®é¢˜ï¼‰
        run: |
          mkdir -p "${{ env.OPENSSL_SRC_DIR }}" "${{ env.OPENSSL_INSTALL_DIR }}"
          cd "${{ env.OPENSSL_SRC_DIR }}" || exit 1

          wget -q --no-check-certificate "https://www.openssl.org/source/openssl-${{ env.OPENSSL_VERSION }}.tar.gz"
          tar -xvzf "openssl-${{ env.OPENSSL_VERSION }}.tar.gz" --strip-components=1 > /dev/null 2>&1

          export CC="${{ env.NDK_TOOLCHAIN_BIN }}/aarch64-linux-android${{ env.ANDROID_API_LEVEL }}-clang"
          export CXX="${{ env.NDK_TOOLCHAIN_BIN }}/aarch64-linux-android${{ env.ANDROID_API_LEVEL }}-clang++"
          export AR="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ar"
          export RANLIB="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ranlib"
          export LD="${{ env.NDK_TOOLCHAIN_BIN }}/ld.lld"
          export PATH="${{ env.NDK_TOOLCHAIN_BIN }}:$PATH"

          ./Configure android-arm64 no-shared no-asm no-zlib no-ssl3 no-tls1 no-tls1_1 \
            --prefix="${{ env.OPENSSL_INSTALL_DIR }}" \
            --sysroot="${{ env.NDK_SYSROOT }}" \
            -fPIC -march=armv8-a -O2

          make -j$(nproc) > /dev/null 2>&1 || {
            echo -e "${RED}âŒ OpenSSLç¼–è¯‘å¤±è´¥ï¼æŸ¥çœ‹ç¼–è¯‘æ—¥å¿—ï¼š${NC}"
            make -j1 V=1
            exit 1
          }
          make install_sw > /dev/null 2>&1 || {
            echo -e "${RED}âŒ OpenSSLå®‰è£…å¤±è´¥ï¼${NC}"
            exit 1
          }

          if [ ! -f "${{ env.OPENSSL_INSTALL_DIR }}/lib/libssl.a" ] || [ ! -f "${{ env.OPENSSL_INSTALL_DIR }}/lib/libcrypto.a" ]; then
            echo -e "${RED}âŒ OpenSSLç¼–è¯‘å¤±è´¥ï¼šæœªç”Ÿæˆåº“æ–‡ä»¶${NC}"
            exit 1
          fi
          echo -e "${GREEN}âœ… OpenSSLç¼–è¯‘æˆåŠŸï¼š${{ env.OPENSSL_INSTALL_DIR }}/lib${NC}"

      # ğŸ”§ æ ¸å¿ƒä¿®å¤ï¼šåŒ¹é…å¸¦å“ˆå¸Œåç¼€çš„æ ¸å¿ƒåº“æ–‡ä»¶ï¼ˆlibcore-*.rlibï¼‰
      - name: é…ç½®Rustï¼ˆæ­£ç¡®è¯†åˆ«å¸¦å“ˆå¸Œåç¼€çš„æ ¸å¿ƒåº“ï¼‰
        run: |
          # 1. æ¸…ç†æ—§ç¼“å­˜
          rustup toolchain uninstall stable || true
          rustup target remove ${{ env.TARGET_ARCH }} || true
          rustup component remove rust-std-${{ env.TARGET_ARCH }} || true

          # 2. é‡æ–°å®‰è£…å·¥å…·é“¾å’Œç›®æ ‡æ¶æ„
          echo -e "${YELLOW}æ­£åœ¨å®‰è£… Rust stable å·¥å…·é“¾...${NC}"
          rustup toolchain install stable --force
          echo -e "${GREEN}âœ… Rust stable å·¥å…·é“¾å®‰è£…å®Œæˆ${NC}"

          echo -e "${YELLOW}æ­£åœ¨å®‰è£… ${{ env.TARGET_ARCH }} ç›®æ ‡æ¶æ„...${NC}"
          rustup target add ${{ env.TARGET_ARCH }}
          echo -e "${GREEN}âœ… ç›®æ ‡æ¶æ„å®‰è£…å®Œæˆ${NC}"

          # 3. éªŒè¯æ ¸å¿ƒåº“ï¼ˆå…³é”®ï¼šç”¨é€šé…ç¬¦åŒ¹é…å¸¦å“ˆå¸Œåç¼€çš„æ–‡ä»¶ï¼‰
          CORE_LIB_PATH="$HOME/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/${{ env.TARGET_ARCH }}/lib"
          echo -e "\n${YELLOW}=== æ ¸å¿ƒåº“éªŒè¯ï¼ˆæ”¯æŒå¸¦å“ˆå¸Œåç¼€ï¼‰ ===${NC}"
          echo -e "æ ¸å¿ƒåº“ç›®å½•ï¼š$CORE_LIB_PATH"

          # æ£€æŸ¥ç›®å½•å­˜åœ¨
          if [ ! -d "$CORE_LIB_PATH" ]; then
            echo -e "${RED}âŒ æ ¸å¿ƒåº“ç›®å½•ä¸å­˜åœ¨ï¼${NC}"
            exit 1
          fi

          # ğŸ”´ ä¿®å¤åˆ¤æ–­é€»è¾‘ï¼šç”¨ libcore-*.rlib åŒ¹é…å¸¦å“ˆå¸Œåç¼€çš„æ ¸å¿ƒåº“
          CORE_LIB_FILE=$(ls -1 "$CORE_LIB_PATH" | grep -E "^libcore-.*\.rlib$" | head -n 1)
          if [ -n "$CORE_LIB_FILE" ]; then
            echo -e "${GREEN}âœ… æ‰¾åˆ°æ ¸å¿ƒåº“ï¼š$CORE_LIB_FILE${NC}"
            echo -e "å®Œæ•´è·¯å¾„ï¼š$CORE_LIB_PATH/$CORE_LIB_FILE"
          else
            echo -e "${RED}âŒ æœªæ‰¾åˆ°æ ¸å¿ƒåº“ï¼ˆlibcore-*.rlibï¼‰ï¼${NC}"
            echo -e "ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶ï¼š"
            ls -l "$CORE_LIB_PATH"
            exit 1
          fi

          # é¢å¤–éªŒè¯æ ‡å‡†åº“ï¼ˆå¯é€‰ï¼Œç¡®ä¿ç¯å¢ƒå®Œæ•´ï¼‰
          STD_LIB_FILE=$(ls -1 "$CORE_LIB_PATH" | grep -E "^libstd-.*\.rlib$" | head -n 1)
          if [ -n "$STD_LIB_FILE" ]; then
            echo -e "${GREEN}âœ… æ‰¾åˆ°æ ‡å‡†åº“ï¼š$STD_LIB_FILE${NC}"
          else
            echo -e "${YELLOW}âš ï¸  æœªæ‰¾åˆ°æ ‡å‡†åº“ï¼ˆlibstd-*.rlibï¼‰ï¼Œå¯èƒ½å½±å“ç¼–è¯‘${NC}"
          fi

          echo -e "\n${GREEN}ğŸ‰ æ ¸å¿ƒåº“éªŒè¯é€šè¿‡ï¼ç¯å¢ƒå°±ç»ª${NC}"

      - name: å®‰è£…cargo-ndkï¼ˆå›ºå®šç‰ˆæœ¬ï¼‰
        run: |
          if ! cargo ndk --version &> /dev/null; then
            cargo install cargo-ndk --version=3.5.4 --locked || {
              echo -e "${RED}âŒ cargo-ndkå®‰è£…å¤±è´¥ï¼${NC}"
              exit 1
            }
          fi

      - name: é…ç½®Gradle 7.5
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: 7.5

      - name: åˆ›å»ºCargoé…ç½®ï¼ˆæ·»åŠ libc+openssl-sysé€‚é…ï¼‰
        run: |
          mkdir -p .cargo
          cat > .cargo/config.toml << EOF
          [target.${{ env.TARGET_ARCH }}]
          rustflags = [
              "--sysroot=${{ env.NDK_SYSROOT }}",
              "-L", "${{ env.NDK_SYSROOT }}/usr/lib/aarch64-linux-android/${{ env.ANDROID_API_LEVEL }}",
              "-L", "${{ env.UNWIND_LIB_PATH }}",
              "-L", "${{ env.OPENSSL_INSTALL_DIR }}/lib",
              "-I", "${{ env.OPENSSL_INSTALL_DIR }}/include",  # æ–°å¢ï¼šä¼ é€’OpenSSLå¤´æ–‡ä»¶è·¯å¾„
              "-l", "static=unwind",
              "-l", "static=ssl",
              "-l", "static=crypto",
              "-l", "dylib=dl",
              "-l", "dylib=log",
              "-l", "dylib=m",
              "-l", "dylib=c",
              "-C", "link-arg=--target=aarch64-linux-android24"
          ]
          [dependencies.libc]
          features = ["android"]
          default-features = false

          # ğŸ”§ æ–°å¢ï¼šopenssl-sys ä¸“å±é…ç½®ï¼Œå¼ºåˆ¶ç»‘å®šè‡ªå®šä¹‰OpenSSLè·¯å¾„
          [dependencies.openssl-sys]
          features = []  # ç¦ç”¨é»˜è®¤ç‰¹æ€§ï¼Œé¿å…è‡ªåŠ¨æŸ¥æ‰¾ç³»ç»ŸOpenSSL
          default-features = false
          build = { env = { OPENSSL_DIR = "${{ env.OPENSSL_INSTALL_DIR }}" } }  # ç›´æ¥ç»‘å®šè·¯å¾„
          EOF

      - name: èµ‹äºˆè„šæœ¬æ‰§è¡Œæƒé™
        run: chmod +x ./scripts/build-android-64bit-minimal.sh

      - name: æ‰§è¡Œç¼–è¯‘è„šæœ¬ï¼ˆä¼ é€’OpenSSLè·¯å¾„ï¼Œå¼ºåŒ–éªŒè¯ï¼‰
        run: |
          export NDK_PATH=${{ env.NDK_PATH }}
          export NDK_TOOLCHAIN_BIN=${{ env.NDK_TOOLCHAIN_BIN }}
          export NDK_SYSROOT=${{ env.NDK_SYSROOT }}
          export UNWIND_LIB_PATH=${{ env.UNWIND_LIB_PATH }}
          export OPENSSL_INSTALL_DIR=${{ env.OPENSSL_INSTALL_DIR }}
          # ğŸ”§ æ–°å¢ï¼šè®¾ç½®OPENSSL_DIRï¼ˆopenssl-sysè¯†åˆ«çš„ç¯å¢ƒå˜é‡ï¼ŒåŒé‡ä¿éšœï¼‰
          export OPENSSL_DIR=${{ env.OPENSSL_INSTALL_DIR }}
          export TARGET=${{ env.TARGET_ARCH }}
          export ANDROID_API_LEVEL=${{ env.ANDROID_API_LEVEL }}
          export CORE_LIB_PATH="$HOME/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/${{ env.TARGET_ARCH }}/lib"
          
          # ğŸ”§ æ–°å¢ï¼šæ‰“å°ç¯å¢ƒå˜é‡ï¼ŒéªŒè¯è·¯å¾„ä¼ é€’æˆåŠŸï¼ˆä¾¿äºæ’æŸ¥ï¼‰
          echo -e "${YELLOW}=== ç¼–è¯‘ç¯å¢ƒå˜é‡éªŒè¯ ===${NC}"
          echo "OPENSSL_DIR: $OPENSSL_DIR"
          echo "OpenSSL åº“è·¯å¾„: $OPENSSL_INSTALL_DIR/lib"
          echo "OpenSSL å¤´æ–‡ä»¶è·¯å¾„: $OPENSSL_INSTALL_DIR/include"
          ls -l "$OPENSSL_INSTALL_DIR/lib" | grep -E "libssl.a|libcrypto.a"  # ç¡®è®¤æ ¸å¿ƒåº“å­˜åœ¨
          
          ./scripts/build-android-64bit-minimal.sh 2>&1 | tee build.log || {
            echo -e "${RED}âŒ ç¼–è¯‘è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼æŸ¥çœ‹build.logè·å–è¯¦ç»†é”™è¯¯${NC}"
            exit 1
          }

      # ğŸ”§ ä¿®å¤ï¼šåˆ é™¤å†—ä½™å¤åˆ¶ï¼Œç›´æ¥ä½¿ç”¨è„šæœ¬ç”Ÿæˆçš„releaseç›®å½•ï¼ˆè§£å†³åŒä¸€æ–‡ä»¶æŠ¥é”™ï¼‰
      - name: éªŒè¯äº§ç‰©ï¼ˆä¸é‡å¤å¤åˆ¶ï¼Œä»…æ£€æŸ¥å­˜åœ¨æ€§ï¼‰
        if: always()
        run: |
          # è„šæœ¬å·²ç»ç”Ÿæˆæ‰€æœ‰äº§ç‰©åˆ° ./release ç›®å½•ï¼Œç›´æ¥éªŒè¯
          if [ ! -f "./release/letta-lite-android.aar" ]; then
            echo -e "${RED}âŒ æœªæ‰¾åˆ°AARäº§ç‰©ï¼ˆç¼–è¯‘å¤±è´¥ï¼‰${NC}"
            exit 1
          fi
          if [ ! -f "./release/libletta_ffi.so" ] || [ ! -f "./release/libletta_jni.so" ]; then
            echo -e "${RED}âŒ ç¼ºå¤±SOåº“äº§ç‰©${NC}"
            exit 1
          fi
          # å¤åˆ¶build.logåˆ°releaseç›®å½•ï¼ˆä¾¿äºæ’æŸ¥ï¼‰
          if [ -f "build.log" ]; then
            cp build.log ./release/
          fi
          echo -e "${GREEN}âœ… æ‰€æœ‰äº§ç‰©éªŒè¯é€šè¿‡ï¼${NC}"
          ls -l ./release/

      # ğŸ”§ å·¥ä½œæµé‡Šæ”¾ï¼šä¸Šä¼ Artifactï¼ˆåœ¨å·¥ä½œæµé¡µé¢ä¸‹è½½ï¼‰
      - name: ä¸Šä¼ å·¥ä½œæµäº§ç‰©
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ./release/*
          retention-days: 14

      # ğŸ”§ è‡ªåŠ¨åˆ›å»ºå¼€å‘ç‰ˆGitHub Releaseï¼ˆç®€æ´æ— å†—ä½™ï¼‰
      - name: è‡ªåŠ¨åˆ›å»ºå¼€å‘ç‰ˆReleaseå¹¶ä¸Šä¼ äº§ç‰©
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          # æ ‡ç­¾ï¼šå›ºå®šå‰ç¼€+æäº¤SHAå‰8ä½ï¼Œå”¯ä¸€æ ‡è¯†ç‰ˆæœ¬
          tag_name: "dev-${{ github.sha[:8] }}"
          # Releaseåç§°ï¼šæ¸…æ™°è¡¨æ˜æ˜¯å¼€å‘ç‰ˆ+æäº¤æ ‡è¯†
          name: "Letta-Lite Android å¼€å‘ç‰ˆï¼ˆ${{ github.sha[:8] }}ï¼‰"
          # æè¿°ï¼šåªä¿ç•™å…³é”®ä¿¡æ¯ï¼Œä¸å†—ä½™
          body: |
            ## Letta-Lite Android å¼€å‘ç‰ˆ
            - é€‚é…æ¶æ„ï¼šarm64-v8aï¼ˆå¤©ç‘1200ï¼‰
            - ä¾èµ–ï¼šOpenSSL 1.1.1w + Android NDK 27.3.13750724
            - æœ€å°SDKï¼š21 | ç›®æ ‡SDKï¼š34
            - æäº¤æ ‡è¯†ï¼š${{ github.sha }}ï¼ˆä»…ä¸»åˆ†æ”¯æœ€æ–°ä»£ç ï¼‰
            
            ### åŒ…å«æ–‡ä»¶
            - letta-lite-android.aarï¼ˆæ ¸å¿ƒåº“ï¼Œç›´æ¥å¯¼å…¥Androidé¡¹ç›®ï¼‰
            - libletta_ffi.soï¼ˆRustæ ¸å¿ƒSOåº“ï¼‰
            - libletta_jni.soï¼ˆJNIæ¡¥æ¥SOåº“ï¼‰
            - letta_lite.hï¼ˆCå¤´æ–‡ä»¶ï¼‰
            - build.logï¼ˆç¼–è¯‘æ—¥å¿—ï¼Œæ’æŸ¥é—®é¢˜ç”¨ï¼‰
            
            ### ä½¿ç”¨è¯´æ˜
            1. ä¸‹è½½AARæ–‡ä»¶å¯¼å…¥Androidé¡¹ç›®
            2. æ— éœ€é¢å¤–é…ç½®OpenSSLï¼ˆå·²é™æ€é“¾æ¥ï¼‰
            3. å¼€å‘ç‰ˆä»…ç”¨äºæµ‹è¯•ï¼Œè¯·å‹¿ç”¨äºç”Ÿäº§ç¯å¢ƒ
          files: ./release/*  # ä¸Šä¼ æ‰€æœ‰äº§ç‰©
          draft: false
          prerelease: true  # æ ‡è®°ä¸ºé¢„å‘å¸ƒï¼ŒåŒºåˆ†æ­£å¼ç‰ˆï¼ˆè™½æ— æ­£å¼ç‰ˆï¼Œä½†ç¬¦åˆè§„èŒƒï¼‰
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # è‡ªåŠ¨æˆæƒï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®

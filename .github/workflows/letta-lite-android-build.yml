name: Letta-Lite Android (Tianji1200 64bit)
on: [workflow_dispatch, push, pull_request]
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_NDK_VERSION: 27.3.13750724
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
      OPENSSL_VERSION: 1.1.1w
      OPENSSL_SRC_DIR: ${{ github.workspace }}/openssl-src
      OPENSSL_INSTALL_DIR: ${{ github.workspace }}/openssl-install
      TARGET_ARCH: aarch64-linux-android
      ANDROID_API_LEVEL: 24
      ARTIFACT_NAME: letta-lite-android-tianji1200
      RUST_VERSION: 1.91.1
      RUST_TARGET: aarch64-linux-android
      RUST_TOOLCHAIN_DIR: /home/runner/.rustup/toolchains/stable-x86_64-unknown-linux-gnu
      RUST_STD_DIR: ${{ github.workspace }}/rust-std

    steps:
      - name: Checkout source code (with llama.cpp submodule)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Install base dependencies
        run: |
          sudo apt-get update --fix-missing
          sudo apt-get install -y \
            rustc cargo git make cbindgen openjdk-17-jdk \
            wget curl unzip gradle perl pkg-config binutils
          java -version
          gradle -v

      - name: Install Android NDK + SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          packages: "ndk;${{ env.ANDROID_NDK_VERSION }} platforms;android-${{ env.ANDROID_API_LEVEL }}"

      - name: ç»ˆæè§£å†³ libunwindï¼ˆç”¨é™æ€åº“ libunwind.a + ä¼ é€’è·¯å¾„ï¼‰
        run: |
          export LANG=C.UTF-8
          export LC_ALL=C.UTF-8
          NDK_PATH=$(find /usr/local/lib/android/sdk/ndk -maxdepth 1 -type d | grep -E "${{ env.ANDROID_NDK_VERSION }}$")
          [ -z "$NDK_PATH" ] && { echo "âŒ NDK æœªæ‰¾åˆ°"; exit 1; }
          CLANG_ROOT="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/lib/clang"
          CLANG_VERSION=$(ls -1 "$CLANG_ROOT" | grep -E '^[0-9]+' | head -n 1)
          UNWIND_LIB_PATH="$CLANG_ROOT/$CLANG_VERSION/lib/linux/aarch64"
          UNWIND_LIB_FILE="$UNWIND_LIB_PATH/libunwind.a"
          [ ! -f "$UNWIND_LIB_FILE" ] && { echo "âŒ libunwind.a æœªæ‰¾åˆ°"; exit 1; }
          echo "NDK_PATH=$NDK_PATH" >> $GITHUB_ENV
          echo "NDK_TOOLCHAIN_BIN=$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_ENV
          echo "NDK_SYSROOT=$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/sysroot" >> $GITHUB_ENV
          echo "UNWIND_LIB_PATH=$UNWIND_LIB_PATH" >> $GITHUB_ENV
          echo "âœ… æ‰¾åˆ° libunwind.aï¼š$UNWIND_LIB_FILE"

      - name: Compile OpenSSL for Android (android-arm64)
        run: |
          mkdir -p ${{ env.OPENSSL_SRC_DIR }} ${{ env.OPENSSL_INSTALL_DIR }}
          cd ${{ env.OPENSSL_SRC_DIR }}
          wget -q https://www.openssl.org/source/openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          tar -xvzf openssl-${{ env.OPENSSL_VERSION }}.tar.gz --strip-components=1
          export CC="${{ env.NDK_TOOLCHAIN_BIN }}/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang"
          export CXX="${{ env.NDK_TOOLCHAIN_BIN }}/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang++"
          export AR="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ar"
          export RANLIB="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ranlib"
          export LD="${{ env.NDK_TOOLCHAIN_BIN }}/ld.lld"
          export PATH="${{ env.NDK_TOOLCHAIN_BIN }}:$PATH"
          ./Configure android-arm64 no-shared no-asm no-zlib \
            --prefix=${{ env.OPENSSL_INSTALL_DIR }} \
            --sysroot=${{ env.NDK_SYSROOT }} \
            -fPIC -march=armv8-a -mtune=cortex-a76
          make -j$(nproc) V=1 | grep -E "CC|AR|LD|armv8-a|aarch64" || true
          make install_sw
          echo "âœ… OpenSSL ç¼–è¯‘å®Œæˆï¼š${{ env.OPENSSL_INSTALL_DIR }}/lib"

          LIB_SSL="${{ env.OPENSSL_INSTALL_DIR }}/lib/libssl.a"
          TEMP_DIR=$(mktemp -d)
          cd $TEMP_DIR
          ar -x "$LIB_SSL" $(ar -t "$LIB_SSL" | head -n 1)
          O_FILE=$(ls -1 | head -n 1)
          echo -e "\nğŸ” éªŒè¯ .o æ–‡ä»¶æ¶æ„ï¼ˆreadelf æ£€æµ‹ï¼‰ï¼š"
          readelf -h "$O_FILE" | grep -E "Class|Machine"
          
          MACHINE=$(readelf -h "$O_FILE" | grep "Machine" | awk '{print $2}')
          if [ "$MACHINE" = "183" ] || [ "$MACHINE" = "AArch64" ]; then
            echo -e "${GREEN}âœ… OpenSSL æ¶æ„æ­£ç¡®ï¼ˆaarch64/AArch64ï¼‰${NC}"
          else
            echo -e "${RED}âŒ OpenSSL æ¶æ„é”™è¯¯ï¼å½“å‰ Machine ç±»å‹ï¼š$MACHINE${NC}"
            exit 1
          fi
          cd - && rm -rf $TEMP_DIR

      - name: ä¿®æ­£ç‰ˆï¼šæ‰‹åŠ¨ä¸‹è½½+ç²¾å‡†è§£å‹ rust-stdï¼ˆå¿…è¿‡ï¼‰
        run: |
          # 1. å½»åº•æ¸…ç†æ—§æ–‡ä»¶ï¼Œé¿å…å¹²æ‰°
          rm -rf ${{ env.RUST_TOOLCHAIN_DIR }}/lib/rustlib/${{ env.RUST_TARGET }} 2>/dev/null || true
          rustup toolchain uninstall stable 2>/dev/null || true
          # 2. é‡æ–°å®‰è£…åŸºç¡€å·¥å…·é“¾
          rustup toolchain install stable --version ${{ env.RUST_VERSION }}
          # 3. æ‰‹åŠ¨ä¸‹è½½å®˜æ–¹ rust-std åŒ…ï¼ˆè·¯å¾„100%æ­£ç¡®ï¼‰
          mkdir -p ${{ env.RUST_STD_DIR }}
          RUST_STD_URL="https://static.rust-lang.org/dist/${{ env.RUST_VERSION }}/rust-std-${{ env.RUST_TARGET }}.tar.gz"
          echo "âœ… ä¸‹è½½ rust-stdï¼š$RUST_STD_URL"
          wget -q -O ${{ env.RUST_STD_DIR }}/rust-std.tar.gz $RUST_STD_URL
          # 4. æŸ¥çœ‹taråŒ…å†…éƒ¨ç»“æ„ï¼Œç¡®ä¿è§£å‹è·¯å¾„æ­£ç¡®ï¼ˆå…³é”®ä¿®æ­£ï¼‰
          echo -e "\nğŸ” æŸ¥çœ‹ tar åŒ…å†…éƒ¨ç»“æ„ï¼š"
          tar -tvzf ${{ env.RUST_STD_DIR }}/rust-std.tar.gz | head -n 10
          # 5. ç²¾å‡†è§£å‹ï¼šåªåˆ‡1å±‚ç›®å½•ï¼Œç›´æ¥æ”¾åˆ° rustlib ä¸‹ï¼ˆä¹‹å‰åˆ‡å¤šäº†ï¼ï¼‰
          RUSTLIB_TARGET_DIR="${{ env.RUST_TOOLCHAIN_DIR }}/lib/rustlib/${{ env.RUST_TARGET }}"
          mkdir -p $RUSTLIB_TARGET_DIR
          tar -xvzf ${{ env.RUST_STD_DIR }}/rust-std.tar.gz -C $RUSTLIB_TARGET_DIR --strip-components=1
          # 6. éªŒè¯ core åº“ï¼ˆå¿…å­˜åœ¨ï¼ï¼‰
          CORE_LIB_PATH="$RUSTLIB_TARGET_DIR/lib/libcore.rlib"
          if [ ! -f "$CORE_LIB_PATH" ]; then
            echo -e "${RED}âŒ å¼‚å¸¸ï¼šcore åº“æœªæ‰¾åˆ°ï¼${NC}"
            echo -e "ğŸ“‚ æ‰“å°ç›®æ ‡ç›®å½•å†…å®¹ï¼š"
            ls -l $RUSTLIB_TARGET_DIR/lib/
            exit 1
          else
            echo -e "${GREEN}âœ… æˆåŠŸï¼core åº“å·²å­˜åœ¨ï¼š$CORE_LIB_PATH${NC}"
            ls -l "$CORE_LIB_PATH"  # æ˜¾ç¤ºæ–‡ä»¶è¯¦æƒ…ï¼Œç¡®è®¤æœ‰æ•ˆ
          fi
          # 7. ä¿å­˜å…³é”®è·¯å¾„åˆ°ç¯å¢ƒå˜é‡
          echo "RUST_SYSROOT=${{ env.RUST_TOOLCHAIN_DIR }}" >> $GITHUB_ENV
          echo "CORE_LIB_PATH=$CORE_LIB_PATH" >> $GITHUB_ENV
          echo "CORE_LIB_DIR=$(dirname $CORE_LIB_PATH)" >> $GITHUB_ENV

      - name: Install cargo-ndk
        run: cargo install cargo-ndk --version=3.5.4 --locked

      - name: Set up Gradle 7.5
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: 7.5

      - name: Create Cargo configï¼ˆç²¾å‡†è·¯å¾„é…ç½®ï¼‰
        run: |
          mkdir -p .cargo
          cat > .cargo/config.toml << EOF
          [target.${{ env.RUST_TARGET }}]
          rustflags = [
              "--sysroot=${{ env.RUST_SYSROOT }}",  # Rust æ ‡å‡†åº“æ ¹ç›®å½•
              "--sysroot=${{ env.NDK_SYSROOT }}",  # NDK ç³»ç»Ÿåº“æ ¹ç›®å½•
              "-L", "${{ env.CORE_LIB_DIR }}",     # core åº“æ‰€åœ¨ç›®å½•ï¼ˆç²¾å‡†æŒ‡å‘ï¼‰
              "-L", "${{ env.NDK_SYSROOT }}/usr/lib/aarch64-linux-android/24",
              "-L", "${{ env.UNWIND_LIB_PATH }}",
              "-L", "${{ env.OPENSSL_INSTALL_DIR }}/lib",
              "-l", "static=unwind",
              "-l", "dylib=dl",
              "-l", "dylib=log",
              "-l", "dylib=m",
              "-l", "dylib=c",
              "-C", "link-arg=--allow-shlib-undefined"
          ]
          EOF

      - name: Prepare build script
        run: chmod +x ./scripts/build-android-64bit-minimal.sh

      - name: Run build scriptï¼ˆä¸€è·¯ç•…é€šï¼‰
        run: |
          export OPENSSL_DIR=${{ env.OPENSSL_INSTALL_DIR }}
          export NDK_PATH=${{ env.NDK_PATH }}
          export NDK_TOOLCHAIN_BIN=${{ env.NDK_TOOLCHAIN_BIN }}
          export NDK_SYSROOT=${{ env.NDK_SYSROOT }}
          export UNWIND_LIB_PATH=${{ env.UNWIND_LIB_PATH }}
          export TARGET=${{ env.TARGET_ARCH }}
          export ANDROID_API_LEVEL=${{ env.ANDROID_API_LEVEL }}
          export RUST_SYSROOT=${{ env.RUST_SYSROOT }}
          export CORE_LIB_PATH=${{ env.CORE_LIB_PATH }}
          export CORE_LIB_DIR=${{ env.CORE_LIB_DIR }}
          ./scripts/build-android-64bit-minimal.sh 2>&1 | tee build.log

      - name: Collect artifacts
        run: |
          mkdir -p ./release
          AAR_FILE=$(find ${{ github.workspace }} -name "*.aar" | grep -E "release" | head -n 1)
          SO_FILE=$(find ${{ github.workspace }} -name "libletta_jni.so" | grep -E "arm64" | head -n 1)
          [ -z "$AAR_FILE" ] && { echo "âŒ AAR æœªæ‰¾åˆ°"; exit 1; }
          [ -z "$SO_FILE" ] && { echo "âŒ SO æœªæ‰¾åˆ°"; exit 1; }
          cp "$AAR_FILE" ./release/letta-lite-android.aar
          cp "$SO_FILE" ./release/letta-lite-jni.so
          cp build.log ./release/build.log
          echo "âœ… äº§ç‰©æ”¶é›†å®Œæˆ"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ./release/*
          retention-days: 14

name: Letta-Lite Android (Tianji1200 64bit)
on: [workflow_dispatch]
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_NDK_VERSION: 27.3.13750724
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
      OPENSSL_VERSION: 1.1.1w
      OPENSSL_SRC_DIR: ${{ github.workspace }}/openssl-src
      OPENSSL_INSTALL_DIR: ${{ github.workspace }}/openssl-install
      TARGET_ARCH: aarch64-linux-android
      ANDROID_API_LEVEL: 24
      ARTIFACT_NAME: letta-lite-android-tianji1200

    steps:
      - name: Checkout source code (with llama.cpp submodule)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Install base dependencies
        run: |
          sudo apt-get update --fix-missing
          sudo apt-get install -y \
            rustc cargo git make cbindgen openjdk-17-jdk \
            wget curl unzip gradle perl pkg-config
          java -version
          gradle -v

      - name: Install Android NDK + SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          packages: "ndk;${{ env.ANDROID_NDK_VERSION }} platforms;android-${{ env.ANDROID_API_LEVEL }}"

      - name: ç²¾å‡†å®šä½ NDK 27 è·¯å¾„ï¼ˆä¿®å¤ libunwind æŸ¥æ‰¾ï¼‰
        run: |
          # å¼ºåˆ¶ UTF-8 ç¼–ç ï¼Œé¿å…ä¹±ç 
          export LANG=C.UTF-8
          export LC_ALL=C.UTF-8
          
          # 1. æ‰¾åˆ° NDK æ ¹è·¯å¾„ï¼ˆç²¾å‡†åŒ¹é…ç‰ˆæœ¬ï¼‰
          NDK_PATH=$(find /usr/local/lib/android/sdk/ndk -maxdepth 1 -type d | grep -E "${{ env.ANDROID_NDK_VERSION }}$")
          if [ -z "$NDK_PATH" ]; then
            echo "âŒ NDK ${{ env.ANDROID_NDK_VERSION }} æœªæ‰¾åˆ°ï¼Œå·²å®‰è£…çš„ NDKï¼š"
            ls -la /usr/local/lib/android/sdk/ndk
            exit 1
          fi
          echo "âœ… NDK æ ¹è·¯å¾„ï¼š$NDK_PATH"
          
          # 2. ç²¾å‡†æ‹¼æ¥ NDK 27 å·¥å…·é“¾è·¯å¾„ï¼ˆä¸ç»•å¼¯ï¼‰
          NDK_TOOLCHAIN_BIN="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin"
          NDK_SYSROOT="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
          # NDK 27 çš„ CLANG è·¯å¾„ï¼šbin çš„ä¸Šçº§ç›®å½• â†’ lib64/clangï¼ˆç²¾å‡†å®šä½ï¼‰
          CLANG_ROOT="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/lib64/clang"
          
          # 3. éªŒè¯ CLANG_ROOT å­˜åœ¨ï¼ˆä¸å­˜åœ¨åˆ™ç›´æ¥æŠ¥é”™ï¼Œä¸çå…¼å®¹ï¼‰
          if [ ! -d "$CLANG_ROOT" ]; then
            echo "âŒ NDK 27 é¢„æœŸè·¯å¾„ä¸å­˜åœ¨ï¼š$CLANG_ROOT"
            echo "ğŸ“ åˆ—å‡º linux-x86_64 ç›®å½•å†…å®¹ï¼ˆæ‰¾ lib64ï¼‰ï¼š"
            ls -la "$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64"
            exit 1
          fi
          
          # 4. æ‰¾åˆ° clang ç‰ˆæœ¬å·ï¼ˆå¦‚ 17.0.2ï¼‰
          CLANG_VERSION=$(ls -1 "$CLANG_ROOT" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | head -n 1)
          if [ -z "$CLANG_VERSION" ]; then
            echo "âŒ æœªæ‰¾åˆ° clang ç‰ˆæœ¬å·ï¼ŒCLANG_ROOT ç›®å½•å†…å®¹ï¼š"
            ls -la "$CLANG_ROOT"
            exit 1
          fi
          
          # 5. æœ€ç»ˆç²¾å‡†å®šä½ libunwind.so è·¯å¾„
          UNWIND_LIB_PATH="$CLANG_ROOT/$CLANG_VERSION/lib/linux/aarch64"
          if [ ! -f "$UNWIND_LIB_PATH/libunwind.so" ]; then
            echo "âŒ libunwind.so æœªæ‰¾åˆ°ï¼Œè·¯å¾„ï¼š$UNWIND_LIB_PATH"
            echo "ğŸ“ ç›®å½•å†…å®¹ï¼š"
            ls -la "$UNWIND_LIB_PATH"
            exit 1
          fi
          
          # ä¼ é€’è·¯å¾„åˆ°ç¯å¢ƒå˜é‡ï¼ˆè„šæœ¬ç›´æ¥ç”¨ï¼Œä¸é‡å¤è®¡ç®—ï¼‰
          echo "NDK_TOOLCHAIN_BIN=$NDK_TOOLCHAIN_BIN" >> $GITHUB_ENV
          echo "NDK_SYSROOT=$NDK_SYSROOT" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$NDK_PATH" >> $GITHUB_ENV
          echo "UNWIND_LIB_PATH=$UNWIND_LIB_PATH" >> $GITHUB_ENV
          
          # éªŒè¯ç¼–è¯‘å™¨å­˜åœ¨ï¼ˆé¢å¤–ä¿éšœï¼‰
          COMPILER_PATH="$NDK_TOOLCHAIN_BIN/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang"
          if [ ! -f "$COMPILER_PATH" ]; then
            echo "âŒ ç¼–è¯‘å™¨ç¼ºå¤±ï¼š$COMPILER_PATH"
            exit 1
          fi
          
          # è¾“å‡ºç²¾å‡†å®šä½ç»“æœ
          echo "âœ… æ‰€æœ‰è·¯å¾„å®šä½æˆåŠŸï¼š"
          echo "  - CLANG_ROOT: $CLANG_ROOT"
          echo "  - CLANG_VERSION: $CLANG_VERSION"
          echo "  - UNWIND_LIB_PATH: $UNWIND_LIB_PATH"

      - name: Compile OpenSSL for Android (android-arm64)
        run: |
          mkdir -p ${{ env.OPENSSL_SRC_DIR }} ${{ env.OPENSSL_INSTALL_DIR }}
          cd ${{ env.OPENSSL_SRC_DIR }}
          wget -q https://www.openssl.org/source/openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          tar -xvzf openssl-${{ env.OPENSSL_VERSION }}.tar.gz --strip-components=1
          export CC="${{ env.NDK_TOOLCHAIN_BIN }}/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang"
          export CXX="${{ env.NDK_TOOLCHAIN_BIN }}/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang++"
          export AR="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ar"
          export RANLIB="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ranlib"
          export LD="${{ env.NDK_TOOLCHAIN_BIN }}/ld.lld"
          export PATH="$NDK_TOOLCHAIN_BIN:$PATH"
          ./Configure android-arm64 no-shared no-asm no-zlib \
            --prefix=${{ env.OPENSSL_INSTALL_DIR }} \
            --sysroot=${{ env.NDK_SYSROOT }} \
            -fPIC -march=armv8-a \
            CC=$CC CXX=$CXX AR=$AR RANLIB=$RANLIB LD=$LD
          make -j$(nproc) V=1
          make install_sw
          echo "âœ… OpenSSL ç¼–è¯‘æˆåŠŸ"
          LIB_PATH="${{ env.OPENSSL_INSTALL_DIR }}/lib/libssl.a"
          if file "$LIB_PATH" | grep -qE "aarch64|64-bit ARM"; then
            echo "âœ… OpenSSL æ¶æ„éªŒè¯æˆåŠŸ"
          else
            echo "âš ï¸ OpenSSL æ¶æ„è¾“å‡ºï¼š$(file "$LIB_PATH")"
          fi

      - name: Configure Rust environment
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          target: ${{ env.TARGET_ARCH }}

      - name: Install cargo-ndk
        run: cargo install cargo-ndk --version=3.5.4 --locked

      - name: Prepare 64bit-only build script
        run: |
          chmod +x ./scripts/build-android-64bit-minimal.sh

      - name: Execute 64bit-only build script (generate SO + AAR)
        run: |
          # ä¼ é€’æ‰€æœ‰å¿…éœ€ç¯å¢ƒå˜é‡
          export OPENSSL_DIR=${{ env.OPENSSL_INSTALL_DIR }}
          export OPENSSL_INCLUDE_DIR=${{ env.OPENSSL_INSTALL_DIR }}/include
          export OPENSSL_LIB_DIR=${{ env.OPENSSL_INSTALL_DIR }}/lib
          export PKG_CONFIG_ALLOW_CROSS=1
          export NDK_TOOLCHAIN_BIN=${{ env.NDK_TOOLCHAIN_BIN }}
          export NDK_SYSROOT=${{ env.NDK_SYSROOT }}
          export UNWIND_LIB_PATH=${{ env.UNWIND_LIB_PATH }}
          export TARGET=${{ env.TARGET_ARCH }}
          export ANDROID_API_LEVEL=${{ env.ANDROID_API_LEVEL }}
          
          # æ‰§è¡Œè„šæœ¬å¹¶ä¿å­˜æ—¥å¿—
          ./scripts/build-android-64bit-minimal.sh 2>&1 | tee build.log

      - name: Collect artifacts (SO + AAR + log)
        run: |
          mkdir -p ./release
          # å…¨å±€æŸ¥æ‰¾ AAR
          AAR_FILE=$(find ${{ github.workspace }} -name "*.aar" -type f | grep -E "release|android-release" | head -n 1)
          if [ -n "$AAR_FILE" ]; then
            cp "$AAR_FILE" ./release/letta-lite-android.aar
            echo "âœ… AAR æ‰¾åˆ°ï¼š$AAR_FILE"
          else
            echo "âŒ AAR æœªæ‰¾åˆ°ï¼ŒæŸ¥çœ‹ build.log"
            exit 1
          fi
          # å…¨å±€æŸ¥æ‰¾ JNI SO
          SO_FILE=$(find ${{ github.workspace }} -name "libletta_jni.so" -type f | grep -E "arm64|aarch64" | head -n 1)
          if [ -n "$SO_FILE" ]; then
            cp "$SO_FILE" ./release/letta-lite-jni.so
            echo "âœ… SO æ‰¾åˆ°ï¼š$SO_FILE"
          else
            echo "âŒ SO æœªæ‰¾åˆ°ï¼ŒæŸ¥çœ‹ build.log"
            exit 1
          fi
          # å¤åˆ¶æ—¥å¿—
          cp ./build.log ./release/build.log
          ls -l ./release/

      - name: Upload to Artifacts (direct download)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ./release/*
          retention-days: 14

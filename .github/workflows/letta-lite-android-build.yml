name: Letta-Lite Android (Tianji1200 64bit)
on: [workflow_dispatch, push, pull_request]
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_NDK_VERSION: 27.3.13750724
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
      OPENSSL_VERSION: 1.1.1w
      OPENSSL_SRC_DIR: ${{ github.workspace }}/openssl-src
      OPENSSL_INSTALL_DIR: ${{ github.workspace }}/openssl-install
      TARGET_ARCH: aarch64-linux-android
      ANDROID_API_LEVEL: 24
      ARTIFACT_NAME: letta-lite-android-tianji1200

    steps:
      - name: Checkout source code (with llama.cpp submodule)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Install base dependencies
        run: |
          sudo apt-get update --fix-missing
          sudo apt-get install -y \
            rustc cargo git make cbindgen openjdk-17-jdk \
            wget curl unzip gradle perl pkg-config
          java -version
          gradle -v

      - name: Install Android NDK + SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          packages: "ndk;${{ env.ANDROID_NDK_VERSION }} platforms;android-${{ env.ANDROID_API_LEVEL }}"

      - name: 终极解决 libunwind（用静态库 libunwind.a + 传递路径）
        run: |
          export LANG=C.UTF-8
          export LC_ALL=C.UTF-8
          NDK_PATH=$(find /usr/local/lib/android/sdk/ndk -maxdepth 1 -type d | grep -E "${{ env.ANDROID_NDK_VERSION }}$")
          [ -z "$NDK_PATH" ] && { echo "❌ NDK 未找到"; exit 1; }
          CLANG_ROOT="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/lib/clang"
          CLANG_VERSION=$(ls -1 "$CLANG_ROOT" | grep -E '^[0-9]+' | head -n 1)
          UNWIND_LIB_PATH="$CLANG_ROOT/$CLANG_VERSION/lib/linux/aarch64"
          UNWIND_LIB_FILE="$UNWIND_LIB_PATH/libunwind.a"
          [ ! -f "$UNWIND_LIB_FILE" ] && { echo "❌ libunwind.a 未找到"; exit 1; }
          echo "NDK_PATH=$NDK_PATH" >> $GITHUB_ENV
          echo "NDK_TOOLCHAIN_BIN=$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_ENV
          echo "NDK_SYSROOT=$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/sysroot" >> $GITHUB_ENV
          echo "UNWIND_LIB_PATH=$UNWIND_LIB_PATH" >> $GITHUB_ENV
          echo "✅ 找到 libunwind.a：$UNWIND_LIB_FILE"

      - name: Compile OpenSSL for Android (android-arm64)
        run: |
          mkdir -p ${{ env.OPENSSL_SRC_DIR }} ${{ env.OPENSSL_INSTALL_DIR }}
          cd ${{ env.OPENSSL_SRC_DIR }}
          wget -q https://www.openssl.org/source/openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          tar -xvzf openssl-${{ env.OPENSSL_VERSION }}.tar.gz --strip-components=1
          export CC="${{ env.NDK_TOOLCHAIN_BIN }}/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang"
          export AR="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ar"
          export LD="${{ env.NDK_TOOLCHAIN_BIN }}/ld.lld"
          ./Configure android-arm64 no-shared no-asm no-zlib \
            --prefix=${{ env.OPENSSL_INSTALL_DIR }} --sysroot=${{ env.NDK_SYSROOT }} -fPIC
          make -j$(nproc) V=1 && make install_sw
          echo "✅ OpenSSL 编译完成：${{ env.OPENSSL_INSTALL_DIR }}/lib"

      - name: Configure Rust environment
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          target: ${{ env.TARGET_ARCH }}

      - name: 强制设置全局链接器
        run: |
          echo "CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER=${{ env.NDK_TOOLCHAIN_BIN }}/ld.lld" >> $GITHUB_ENV

      - name: Install cargo-ndk
        run: cargo install cargo-ndk --version=3.5.4 --locked

      - name: Create Cargo config（双重保障）
        run: |
          mkdir -p .cargo
          cat > .cargo/config.toml << 'EOF'
          [target.aarch64-linux-android]
          rustflags = [
              "--sysroot=${env:NDK_SYSROOT}",
              "-L", "${env:NDK_SYSROOT}/usr/lib/${env:TARGET_ARCH}/${env:ANDROID_API_LEVEL}",
              "-L", "${env:UNWIND_LIB_PATH}",
              "-L", "${env:OPENSSL_INSTALL_DIR}/lib",
              "-l:libunwind.a",
              "-C", "linker=${env:NDK_TOOLCHAIN_BIN}/ld.lld"
          ]
          EOF

      - name: 全局注入库路径（关键！确保依赖库能找到）
        run: |
          echo "RUSTFLAGS=--sysroot=${{ env.NDK_SYSROOT }} \
-L ${{ env.NDK_SYSROOT }}/usr/lib/${{ env.TARGET_ARCH }}/${{ env.ANDROID_API_LEVEL }} \
-L ${{ env.UNWIND_LIB_PATH }} \
-L ${{ env.OPENSSL_INSTALL_DIR }}/lib \
-l:libunwind.a \
-l:libdl.so \
-l:liblog.so \
-l:libm.so \
-l:libc.so \
-C link-arg=--allow-shlib-undefined" >> $GITHUB_ENV

      - name: Prepare 64bit-only build script
        run: chmod +x ./scripts/build-android-64bit-minimal.sh

      - name: Execute 64bit-only build script（一键编译）
        run: |
          export OPENSSL_DIR=${{ env.OPENSSL_INSTALL_DIR }}
          export NDK_PATH=${{ env.NDK_PATH }}
          export NDK_TOOLCHAIN_BIN=${{ env.NDK_TOOLCHAIN_BIN }}
          export NDK_SYSROOT=${{ env.NDK_SYSROOT }}
          export UNWIND_LIB_PATH=${{ env.UNWIND_LIB_PATH }}
          export TARGET=${{ env.TARGET_ARCH }}
          export ANDROID_API_LEVEL=${{ env.ANDROID_API_LEVEL }}
          export CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER=${{ env.NDK_TOOLCHAIN_BIN }}/ld.lld
          ./scripts/build-android-64bit-minimal.sh 2>&1 | tee build.log

      - name: Collect artifacts (SO + AAR + log)
        run: |
          mkdir -p ./release
          AAR_FILE=$(find ${{ github.workspace }} -name "*.aar" | grep -E "release" | head -n 1)
          SO_FILE=$(find ${{ github.workspace }} -name "libletta_jni.so" | grep -E "arm64" | head -n 1)
          [ -z "$AAR_FILE" ] && { echo "❌ AAR 未找到"; exit 1; }
          [ -z "$SO_FILE" ] && { echo "❌ SO 未找到"; exit 1; }
          cp "$AAR_FILE" ./release/letta-lite-android.aar
          cp "$SO_FILE" ./release/letta-lite-jni.so
          cp ./build.log ./release/build.log
          echo "✅ 产物收集完成：$(ls -l ./release/)"

      - name: Upload to Artifacts (direct download)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ./release/*
          retention-days: 14

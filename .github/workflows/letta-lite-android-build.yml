name: Letta-Lite Android (Tianji1200 64bit)
on: [workflow_dispatch, push, pull_request]
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_NDK_VERSION: 27.3.13750724
      TARGET_ARCH: aarch64-linux-android
      ANDROID_API_LEVEL: 24
      ARTIFACT_NAME: letta-lite-android-tianji1200

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            rustc cargo make cbindgen openjdk-17-jdk \
            wget curl unzip gradle perl pkg-config binutils

      - name: Install Android NDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          packages: "ndk;${{ env.ANDROID_NDK_VERSION }} platforms;android-${{ env.ANDROID_API_LEVEL }}"

      - name: Find NDK paths
        run: |
          # 定位NDK路径
          NDK_PATH=$(find /usr/local/lib/android/sdk/ndk -maxdepth 1 -type d | grep -E "${{ env.ANDROID_NDK_VERSION }}$")
          [ -z "$NDK_PATH" ] && { echo "❌ NDK未找到"; exit 1; }
          
          # 定位关键目录
          NDK_TOOLCHAIN_BIN="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin"
          NDK_SYSROOT="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
          UNWIND_LIB_PATH="$NDK_SYSROOT/usr/lib/aarch64-linux-android/24"
          CLANG_UNWIND_PATH="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/lib/clang/18/lib/linux/aarch64"
          
          # 验证关键文件
          [ ! -f "$CLANG_UNWIND_PATH/libunwind.a" ] && { echo "❌ libunwind.a未找到"; exit 1; }
          
          # 输出路径信息
          echo "NDK_PATH=$NDK_PATH" >> $GITHUB_ENV
          echo "NDK_TOOLCHAIN_BIN=$NDK_TOOLCHAIN_BIN" >> $GITHUB_ENV
          echo "NDK_SYSROOT=$NDK_SYSROOT" >> $GITHUB_ENV
          echo "UNWIND_LIB_PATH=$UNWIND_LIB_PATH" >> $GITHUB_ENV
          echo "CLANG_UNWIND_PATH=$CLANG_UNWIND_PATH" >> $GITHUB_ENV

      - name: Copy NDK system libraries to dependency search path
        run: |
          # 创建依赖库目录（所有依赖都能找到）
          mkdir -p dependencies/lib/aarch64-linux-android/24
          mkdir -p dependencies/lib/clang/aarch64
          
          # 复制关键系统库
          cp "$UNWIND_LIB_PATH/libdl.so" "$UNWIND_LIB_PATH/liblog.so" "$UNWIND_LIB_PATH/libm.so" "$UNWIND_LIB_PATH/libc.so" dependencies/lib/aarch64-linux-android/24/
          cp "$CLANG_UNWIND_PATH/libunwind.a" dependencies/lib/clang/aarch64/
          
          # 验证文件复制
          ls -l dependencies/lib/aarch64-linux-android/24/
          ls -l dependencies/lib/clang/aarch64/

      - name: Configure Rust environment
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          target: ${{ env.TARGET_ARCH }}

      - name: Auto-create Cargo config (指向复制的库)
        run: |
          mkdir -p .cargo
          cat > .cargo/config.toml << EOF
          [build]
          rustflags = [
            "--sysroot=${{ env.NDK_SYSROOT }}",
            "-L", "./dependencies/lib/aarch64-linux-android/24",  # 指向复制的系统库
            "-L", "./dependencies/lib/clang/aarch64",            # 指向复制的libunwind.a
            "-l:libunwind.a",
            "-l:libdl.so",
            "-l:liblog.so",
            "-l:libm.so",
            "-l:libc.so",
            "-C", "link-arg=--allow-shlib-undefined"
          ]

          [target.aarch64-linux-android]
          linker = "${{ env.NDK_TOOLCHAIN_BIN }}/ld.lld"
          rustflags = [
            "--sysroot=${{ env.NDK_SYSROOT }}",
            "-L", "./dependencies/lib/aarch64-linux-android/24",
            "-L", "./dependencies/lib/clang/aarch64",
            "-l:libunwind.a",
            "-l:libdl.so",
            "-l:liblog.so",
            "-l:libm.so",
            "-l:libc.so",
            "-C", "link-arg=--allow-shlib-undefined"
          ]

          [workspace]
          members = ["core", "ffi", "storage", "providers/toy", "providers/llama", "sync"]
          EOF
          cat .cargo/config.toml

      - name: Compile with cargo-ndk (适配Workspace)
        run: |
          cargo install cargo-ndk --version=3.5.4 --locked
          cargo ndk -t ${{ env.TARGET_ARCH }} --release -p letta-ffi

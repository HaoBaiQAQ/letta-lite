name: Letta-Lite Android (Tianji1200 64bit)
on: [workflow_dispatch, push, pull_request]
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_NDK_VERSION: 27.3.13750724
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
      OPENSSL_VERSION: 1.1.1w
      OPENSSL_SRC_DIR: ${{ github.workspace }}/openssl-src
      OPENSSL_INSTALL_DIR: ${{ github.workspace }}/openssl-install
      TARGET_ARCH: aarch64-linux-android
      ANDROID_API_LEVEL: 24
      ARTIFACT_NAME: letta-lite-android-tianji1200
      # NDK 27 标准路径（硬编码，避免查找失败）
      NDK_STANDARD_PATH: /usr/local/lib/android/sdk/ndk/27.3.13750724
      SYSROOT_PATH: /usr/local/lib/android/sdk/ndk/27.3.13750724/toolchains/llvm/prebuilt/linux-x86_64/sysroot
      PLATFORM_LIB_PATH: /usr/local/lib/android/sdk/ndk/27.3.13750724/platforms/android-24/arch-arm64/usr/lib
      UNWIND_LIB_PATH: /usr/local/lib/android/sdk/ndk/27.3.13750724/toolchains/llvm/prebuilt/linux-x86_64/lib/clang/18/lib/linux/aarch64

    steps:
      - name: Checkout source code (with llama.cpp submodule)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Install base dependencies
        run: |
          sudo apt-get update --fix-missing
          sudo apt-get install -y \
            rustc cargo git make cbindgen openjdk-17-jdk \
            wget curl unzip gradle perl pkg-config
          java -version
          gradle -v

      - name: Install Android NDK + SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          packages: "ndk;${{ env.ANDROID_NDK_VERSION }} platforms;android-${{ env.ANDROID_API_LEVEL }}"

      - name: 验证所有库路径存在（关键！确保库文件真的在）
        run: |
          # 验证 NDK 根路径
          [ -d "${{ env.NDK_STANDARD_PATH }}" ] || { echo "❌ NDK 根路径不存在"; exit 1; }
          # 验证 sysroot
          [ -d "${{ env.SYSROOT_PATH }}" ] || { echo "❌ sysroot 不存在"; exit 1; }
          # 验证系统库路径（-ldl/-lm/-lc）
          [ -f "${{ env.SYSROOT_PATH }}/usr/lib/aarch64-linux-android/24/libdl.so" ] || { echo "❌ libdl.so 不存在"; ls -la "${{ env.SYSROOT_PATH }}/usr/lib/aarch64-linux-android/24/"; exit 1; }
          [ -f "${{ env.SYSROOT_PATH }}/usr/lib/aarch64-linux-android/24/libm.so" ] || { echo "❌ libm.so 不存在"; exit 1; }
          [ -f "${{ env.SYSROOT_PATH }}/usr/lib/aarch64-linux-android/24/libc.so" ] || { echo "❌ libc.so 不存在"; exit 1; }
          # 验证 log 库（-llog）
          [ -f "${{ env.PLATFORM_LIB_PATH }}/liblog.so" ] || { echo "❌ liblog.so 不存在"; ls -la "${{ env.PLATFORM_LIB_PATH }}/"; exit 1; }
          # 验证 libunwind.a
          [ -f "${{ env.UNWIND_LIB_PATH }}/libunwind.a" ] || { echo "❌ libunwind.a 不存在"; ls -la "${{ env.UNWIND_LIB_PATH }}/"; exit 1; }
          echo "✅ 所有库路径验证通过！"

      - name: Compile OpenSSL for Android (android-arm64)
        run: |
          mkdir -p ${{ env.OPENSSL_SRC_DIR }} ${{ env.OPENSSL_INSTALL_DIR }}
          cd ${{ env.OPENSSL_SRC_DIR }}
          wget -q https://www.openssl.org/source/openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          tar -xvzf openssl-${{ env.OPENSSL_VERSION }}.tar.gz --strip-components=1
          export CC="${{ env.NDK_STANDARD_PATH }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android24-clang"
          export CXX="${{ env.NDK_STANDARD_PATH }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android24-clang++"
          export AR="${{ env.NDK_STANDARD_PATH }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"
          export RANLIB="${{ env.NDK_STANDARD_PATH }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ranlib"
          export LD="${{ env.NDK_STANDARD_PATH }}/toolchains/llvm/prebuilt/linux-x86_64/bin/ld.lld"
          export PATH="$LD:$PATH"
          ./Configure android-arm64 no-shared no-asm no-zlib \
            --prefix=${{ env.OPENSSL_INSTALL_DIR }} \
            --sysroot=${{ env.SYSROOT_PATH }} \
            -fPIC -march=armv8-a \
            CC=$CC CXX=$CXX AR=$AR RANLIB=$RANLIB LD=$LD
          make -j$(nproc) V=1
          make install_sw
          echo "✅ OpenSSL 编译成功"
          LIB_PATH="${{ env.OPENSSL_INSTALL_DIR }}/lib/libssl.a"
          file "$LIB_PATH" | grep -qE "aarch64|64-bit ARM" && echo "✅ OpenSSL 架构验证成功" || { echo "⚠️ OpenSSL 架构错误"; file "$LIB_PATH"; exit 1; }

      - name: Configure Rust environment
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          target: ${{ env.TARGET_ARCH }}

      - name: 强制设置链接器（无环境变量依赖）
        run: |
          echo "CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER=${{ env.NDK_STANDARD_PATH }}/toolchains/llvm/prebuilt/linux-x86_64/bin/ld.lld" >> $GITHUB_ENV

      - name: Install cargo-ndk
        run: cargo install cargo-ndk --version=3.5.4 --locked

      - name: Create Cargo config（硬编码路径，100% 命中）
        run: |
          mkdir -p .cargo
          cat > .cargo/config.toml << 'EOF'
          [target.aarch64-linux-android]
          rustflags = [
              "--sysroot=/usr/local/lib/android/sdk/ndk/27.3.13750724/toolchains/llvm/prebuilt/linux-x86_64/sysroot",
              "-L", "/usr/local/lib/android/sdk/ndk/27.3.13750724/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/aarch64-linux-android/24",
              "-L", "/usr/local/lib/android/sdk/ndk/27.3.13750724/platforms/android-24/arch-arm64/usr/lib",
              "-L", "/usr/local/lib/android/sdk/ndk/27.3.13750724/toolchains/llvm/prebuilt/linux-x86_64/lib/clang/18/lib/linux/aarch64",
              "-L", "${env.OPENSSL_INSTALL_DIR}/lib",
              # 直接引用静态库文件，避免 -lunwind 查找失败
              "-l:libunwind.a",
              # 系统库直接指定文件名
              "-l:libdl.so",
              "-l:liblog.so",
              "-l:libm.so",
              "-l:libc.so",
              "-C", "linker=/usr/local/lib/android/sdk/ndk/27.3.13750724/toolchains/llvm/prebuilt/linux-x86_64/bin/ld.lld",
              "-C", "link-arg=--allow-shlib-undefined"
          ]
          EOF

      - name: Prepare 64bit-only build script
        run: |
          chmod +x ./scripts/build-android-64bit-minimal.sh

      - name: Execute 64bit-only build script（硬编码环境变量）
        run: |
          export OPENSSL_DIR=${{ env.OPENSSL_INSTALL_DIR }}
          export OPENSSL_INCLUDE_DIR=${{ env.OPENSSL_INSTALL_DIR }}/include
          export OPENSSL_LIB_DIR=${{ env.OPENSSL_INSTALL_DIR }}/lib
          export PKG_CONFIG_ALLOW_CROSS=1
          export NDK_TOOLCHAIN_BIN=${{ env.NDK_STANDARD_PATH }}/toolchains/llvm/prebuilt/linux-x86_64/bin
          export NDK_SYSROOT=${{ env.SYSROOT_PATH }}
          export TARGET=${{ env.TARGET_ARCH }}
          export ANDROID_API_LEVEL=${{ env.ANDROID_API_LEVEL }}
          export CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER=${{ env.NDK_STANDARD_PATH }}/toolchains/llvm/prebuilt/linux-x86_64/bin/ld.lld
          
          # 打印关键变量，验证生效
          echo "RUSTFLAGS: --sysroot=${{ env.SYSROOT_PATH }} -L ${{ env.SYSROOT_PATH }}/usr/lib/aarch64-linux-android/24 -L ${{ env.PLATFORM_LIB_PATH }} -L ${{ env.UNWIND_LIB_PATH }} -L ${{ env.OPENSSL_LIB_DIR }} -l:libunwind.a -l:libdl.so -l:liblog.so -l:libm.so -l:libc.so"
          ./scripts/build-android-64bit-minimal.sh 2>&1 | tee build.log

      - name: Collect artifacts (SO + AAR + log)
        run: |
          mkdir -p ./release
          AAR_FILE=$(find ${{ github.workspace }} -name "*.aar" -type f | grep -E "release|android-release" | head -n 1)
          if [ -n "$AAR_FILE" ]; then
            cp "$AAR_FILE" ./release/letta-lite-android.aar
            echo "✅ AAR 找到：$AAR_FILE"
          else
            echo "❌ AAR 未找到，查看 build.log"
            exit 1
          fi
          SO_FILE=$(find ${{ github.workspace }} -name "libletta_jni.so" -type f | grep -E "arm64|aarch64" | head -n 1)
          if [ -n "$SO_FILE" ]; then
            cp "$SO_FILE" ./release/letta-lite-jni.so
            echo "✅ SO 找到：$SO_FILE"
          else
            echo "❌ SO 未找到，查看 build.log"
            exit 1
          fi
          cp ./build.log ./release/build.log
          ls -l ./release/

      - name: Upload to Artifacts (direct download)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ./release/*
          retention-days: 14

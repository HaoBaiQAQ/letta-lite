name: Letta-Lite Android (Tianji1200 + OpenSSL)
on: [workflow_dispatch, push, pull_request]
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_NDK_VERSION: 27.3.13750724
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
      OPENSSL_VERSION: 1.1.1w
      OPENSSL_SRC_DIR: ${{ github.workspace }}/openssl-src
      OPENSSL_INSTALL_DIR: ${{ github.workspace }}/openssl-install
      TARGET_ARCH: aarch64-linux-android
      ANDROID_API_LEVEL: 24
      ARTIFACT_NAME: letta-lite-android-tianji1200

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Install base dependencies（含OpenSSL编译必需工具）
        run: |
          sudo apt-get update --fix-missing
          sudo apt-get install -y \
            rustc cargo git make cbindgen openjdk-17-jdk \
            wget curl unzip gradle perl pkg-config binutils \
            gcc g++
          java -version
          gradle -v

      - name: Install Android NDK + SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          packages: "ndk;${{ env.ANDROID_NDK_VERSION }} platforms;android-${{ env.ANDROID_API_LEVEL }}"

      - name: 自动查找NDK路径（适配CI，不硬编码）
        run: |
          NDK_PATH=$(find /usr/local/lib/android/sdk/ndk -maxdepth 1 -type d | grep -E "${{ env.ANDROID_NDK_VERSION }}$")
          CLANG_ROOT="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/lib/clang"
          CLANG_VERSION=$(ls -1 "$CLANG_ROOT" | grep -E '^[0-9]+' | head -n 1)
          UNWIND_LIB_PATH="$CLANG_ROOT/$CLANG_VERSION/lib/linux/aarch64"
          
          # 导出所有必需路径到环境变量
          echo "NDK_PATH=$NDK_PATH" >> $GITHUB_ENV
          echo "NDK_TOOLCHAIN_BIN=$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_ENV
          echo "NDK_SYSROOT=$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/sysroot" >> $GITHUB_ENV
          echo "UNWIND_LIB_PATH=$UNWIND_LIB_PATH" >> $GITHUB_ENV
          echo "OPENSSL_SRC_DIR=${{ env.OPENSSL_SRC_DIR }}" >> $GITHUB_ENV
          echo "OPENSSL_INSTALL_DIR=${{ env.OPENSSL_INSTALL_DIR }}" >> $GITHUB_ENV

      - name: 编译OpenSSL（解决之前编译失败问题）
        run: |
          # 1. 创建目录
          mkdir -p "${{ env.OPENSSL_SRC_DIR }}" "${{ env.OPENSSL_INSTALL_DIR }}"
          cd "${{ env.OPENSSL_SRC_DIR }}" || exit 1

          # 2. 下载并解压OpenSSL（校验文件完整性）
          if [ ! -f "openssl-${{ env.OPENSSL_VERSION }}.tar.gz" ]; then
            wget -q --no-check-certificate "https://www.openssl.org/source/openssl-${{ env.OPENSSL_VERSION }}.tar.gz"
          fi
          tar -xvzf "openssl-${{ env.OPENSSL_VERSION }}.tar.gz" --strip-components=1 > /dev/null 2>&1

          # 3. 配置NDK编译器（正确设置目标架构和API）
          export CC="${{ env.NDK_TOOLCHAIN_BIN }}/aarch64-linux-android${{ env.ANDROID_API_LEVEL }}-clang"
          export CXX="${{ env.NDK_TOOLCHAIN_BIN }}/aarch64-linux-android${{ env.ANDROID_API_LEVEL }}-clang++"
          export AR="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ar"
          export RANLIB="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ranlib"
          export LD="${{ env.NDK_TOOLCHAIN_BIN }}/ld.lld"
          export PATH="${{ env.NDK_TOOLCHAIN_BIN }}:$PATH"

          # 4. 正确配置OpenSSL（适配Android arm64，禁用无用特性）
          ./Configure android-arm64 no-shared no-asm no-zlib no-ssl3 no-tls1 no-tls1_1 \
            --prefix="${{ env.OPENSSL_INSTALL_DIR }}" \
            --sysroot="${{ env.NDK_SYSROOT }}" \
            -fPIC -march=armv8-a -O2

          # 5. 编译并安装（并行编译，减少时间）
          make -j$(nproc) > /dev/null 2>&1
          make install_sw > /dev/null 2>&1

          # 6. 验证编译结果（确保库文件存在）
          if [ ! -f "${{ env.OPENSSL_INSTALL_DIR }}/lib/libssl.a" ] || [ ! -f "${{ env.OPENSSL_INSTALL_DIR }}/lib/libcrypto.a" ]; then
            echo -e "${RED}OpenSSL编译失败：未生成库文件${NC}"
            exit 1
          fi
          echo -e "${GREEN}OpenSSL编译成功：${{ env.OPENSSL_INSTALL_DIR }}/lib${NC}"

      - name: 配置Rust（确保core库正确安装）
        run: |
          rustup toolchain install stable
          rustup target add ${{ env.TARGET_ARCH }}
          # 验证目标架构已安装
          rustup target list | grep "${{ env.TARGET_ARCH }}" | grep "installed" || { echo -e "${RED}Rust目标架构未安装${NC}"; exit 1; }

      - name: 安装cargo-ndk（固定版本，避免兼容性问题）
        run: cargo install cargo-ndk --version=3.5.4 --locked

      - name: 配置Gradle 7.5（稳定版本，适配NDK 27）
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: 7.5

      - name: 创建Cargo配置（添加 libc 适配 + 正确链接）
        run: |
          mkdir -p .cargo
          cat > .cargo/config.toml << EOF
          [target.${{ env.TARGET_ARCH }}]
          rustflags = [
              "--sysroot=${{ env.NDK_SYSROOT }}",
              "-L", "${{ env.NDK_SYSROOT }}/usr/lib/aarch64-linux-android/${{ env.ANDROID_API_LEVEL }}",
              "-L", "${{ env.UNWIND_LIB_PATH }}",
              "-L", "${{ env.OPENSSL_INSTALL_DIR }}/lib",
              "-l", "static=unwind",
              "-l", "static=ssl",
              "-l", "static=crypto",
              "-l", "dylib=dl",
              "-l", "dylib=log",
              "-l", "dylib=m",
              "-l", "dylib=c",
              "-C", "link-arg=--target=aarch64-linux-android24"  # 明确链接器目标
          ]
          # 全局配置 libc 适配 Android，避免特性冲突
          [dependencies.libc]
          features = ["android"]
          default-features = false
          EOF

      - name: 赋予脚本执行权限
        run: chmod +x ./scripts/build-android-64bit-minimal.sh

      - name: 执行编译脚本（传递所有必需环境变量）
        run: |
          export NDK_PATH=${{ env.NDK_PATH }}
          export NDK_TOOLCHAIN_BIN=${{ env.NDK_TOOLCHAIN_BIN }}
          export NDK_SYSROOT=${{ env.NDK_SYSROOT }}
          export UNWIND_LIB_PATH=${{ env.UNWIND_LIB_PATH }}
          export OPENSSL_INSTALL_DIR=${{ env.OPENSSL_INSTALL_DIR }}
          export TARGET=${{ env.TARGET_ARCH }}
          export ANDROID_API_LEVEL=${{ env.ANDROID_API_LEVEL }}
          ./scripts/build-android-64bit-minimal.sh 2>&1 | tee build.log

      - name: 收集产物（含日志，方便排查）
        run: |
          mkdir -p ./release
          cp build.log ./release/
          # 收集AAR
          AAR_PATH=$(find ${{ github.workspace }} -name "*.aar" -path "*/release/*" | head -n 1)
          if [ -n "$AAR_PATH" ]; then
            cp "$AAR_PATH" ./release/letta-lite-android.aar
          fi
          # 收集SO库
          find ${{ github.workspace }} -name "libletta_ffi.so" -path "*/arm64*" -exec cp {} ./release/ \;
          find ${{ github.workspace }} -name "libletta_jni.so" -path "*/arm64*" -exec cp {} ./release/ \;

      - name: 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ./release/*
          retention-days: 14

name: Letta-Lite Android (Tianji1200 + OpenSSL)
on: [workflow_dispatch, push, pull_request]
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_NDK_VERSION: 27.3.13750724
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
      OPENSSL_VERSION: 1.1.1w
      OPENSSL_SRC_DIR: ${{ github.workspace }}/openssl-src
      OPENSSL_INSTALL_DIR: ${{ github.workspace }}/openssl-install
      TARGET_ARCH: aarch64-linux-android
      ANDROID_API_LEVEL: 24
      ARTIFACT_NAME: letta-lite-android-tianji1200

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Install base dependenciesï¼ˆå«OpenSSLç¼–è¯‘å¿…éœ€å·¥å…·ï¼‰
        run: |
          sudo apt-get update --fix-missing
          sudo apt-get install -y \
            rustc cargo git make cbindgen openjdk-17-jdk \
            wget curl unzip gradle perl pkg-config binutils \
            gcc g++
          java -version
          gradle -v

      - name: Install Android NDK + SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          packages: "ndk;${{ env.ANDROID_NDK_VERSION }} platforms;android-${{ env.ANDROID_API_LEVEL }}"

      - name: è‡ªåŠ¨æŸ¥æ‰¾NDKè·¯å¾„ï¼ˆé€‚é…CIï¼Œä¸ç¡¬ç¼–ç ï¼‰
        run: |
          NDK_PATH=$(find /usr/local/lib/android/sdk/ndk -maxdepth 1 -type d | grep -E "${{ env.ANDROID_NDK_VERSION }}$")
          CLANG_ROOT="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/lib/clang"
          CLANG_VERSION=$(ls -1 "$CLANG_ROOT" | grep -E '^[0-9]+' | head -n 1)
          UNWIND_LIB_PATH="$CLANG_ROOT/$CLANG_VERSION/lib/linux/aarch64"
          
          echo "NDK_PATH=$NDK_PATH" >> $GITHUB_ENV
          echo "NDK_TOOLCHAIN_BIN=$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_ENV
          echo "NDK_SYSROOT=$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/sysroot" >> $GITHUB_ENV
          echo "UNWIND_LIB_PATH=$UNWIND_LIB_PATH" >> $GITHUB_ENV
          echo "OPENSSL_SRC_DIR=${{ env.OPENSSL_SRC_DIR }}" >> $GITHUB_ENV
          echo "OPENSSL_INSTALL_DIR=${{ env.OPENSSL_INSTALL_DIR }}" >> $GITHUB_ENV

      - name: ç¼–è¯‘OpenSSLï¼ˆè§£å†³ä¹‹å‰ç¼–è¯‘å¤±è´¥é—®é¢˜ï¼‰
        run: |
          mkdir -p "${{ env.OPENSSL_SRC_DIR }}" "${{ env.OPENSSL_INSTALL_DIR }}"
          cd "${{ env.OPENSSL_SRC_DIR }}" || exit 1

          wget -q --no-check-certificate "https://www.openssl.org/source/openssl-${{ env.OPENSSL_VERSION }}.tar.gz"
          tar -xvzf "openssl-${{ env.OPENSSL_VERSION }}.tar.gz" --strip-components=1 > /dev/null 2>&1

          export CC="${{ env.NDK_TOOLCHAIN_BIN }}/aarch64-linux-android${{ env.ANDROID_API_LEVEL }}-clang"
          export CXX="${{ env.NDK_TOOLCHAIN_BIN }}/aarch64-linux-android${{ env.ANDROID_API_LEVEL }}-clang++"
          export AR="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ar"
          export RANLIB="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ranlib"
          export LD="${{ env.NDK_TOOLCHAIN_BIN }}/ld.lld"
          export PATH="${{ env.NDK_TOOLCHAIN_BIN }}:$PATH"

          ./Configure android-arm64 no-shared no-asm no-zlib no-ssl3 no-tls1 no-tls1_1 \
            --prefix="${{ env.OPENSSL_INSTALL_DIR }}" \
            --sysroot="${{ env.NDK_SYSROOT }}" \
            -fPIC -march=armv8-a -O2

          make -j$(nproc) > /dev/null 2>&1 || {
            echo -e "${RED}âŒ OpenSSLç¼–è¯‘å¤±è´¥ï¼æŸ¥çœ‹ç¼–è¯‘æ—¥å¿—ï¼š${NC}"
            make -j1 V=1  # é‡æ–°æ‰§è¡Œå•çº¿ç¨‹ç¼–è¯‘ï¼Œè¾“å‡ºè¯¦ç»†é”™è¯¯
            exit 1
          }
          make install_sw > /dev/null 2>&1 || {
            echo -e "${RED}âŒ OpenSSLå®‰è£…å¤±è´¥ï¼${NC}"
            exit 1
          }

          if [ ! -f "${{ env.OPENSSL_INSTALL_DIR }}/lib/libssl.a" ] || [ ! -f "${{ env.OPENSSL_INSTALL_DIR }}/lib/libcrypto.a" ]; then
            echo -e "${RED}âŒ OpenSSLç¼–è¯‘å¤±è´¥ï¼šæœªç”Ÿæˆåº“æ–‡ä»¶${NC}"
            exit 1
          fi
          echo -e "${GREEN}âœ… OpenSSLç¼–è¯‘æˆåŠŸï¼š${{ env.OPENSSL_INSTALL_DIR }}/lib${NC}"

      # ğŸ”§ å…³é”®ä¿®å¤1ï¼šå½»åº•å»æ‰æ‰€æœ‰æ— æ•ˆ--forceï¼Œä¼˜åŒ–æ ¸å¿ƒåº“éªŒè¯
      - name: é…ç½®Rustï¼ˆå½»åº•ä¿®å¤--forceå‚æ•°ï¼Œç¡®ä¿æ ¸å¿ƒåº“å­˜åœ¨ï¼‰
        run: |
          rustup toolchain install stable --force  # ä»…toolchain installæ”¯æŒ--forceï¼Œä¿ç•™
          rustup target add ${{ env.TARGET_ARCH }}  # å»æ‰--forceï¼ˆæ­£ç¡®å‘½ä»¤ï¼‰
          
          # éªŒè¯ç›®æ ‡æ¶æ„æ˜¯å¦å®‰è£…æˆåŠŸ
          if ! rustup target list | grep "${{ env.TARGET_ARCH }}" | grep -q "installed"; then
            echo -e "${RED}âŒ Rustç›®æ ‡æ¶æ„ ${{ env.TARGET_ARCH }} å®‰è£…å¤±è´¥ï¼${NC}"
            exit 1
          fi
          
          # éªŒè¯æ ¸å¿ƒåº“ï¼ˆcoreï¼‰æ˜¯å¦å­˜åœ¨ï¼Œä¼˜åŒ–è·¯å¾„åˆ¤æ–­é¿å…è¯¯åˆ¤
          CORE_LIB_PATH="$HOME/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/${{ env.TARGET_ARCH }}/lib"
          if [ ! -d "$CORE_LIB_PATH" ] || [ ! -f "$CORE_LIB_PATH/libcore.rlib" ]; then
            echo -e "${RED}âŒ æ‰¾ä¸åˆ°æ ¸å¿ƒåº“ï¼ˆcoreï¼‰ï¼è·¯å¾„ï¼š$CORE_LIB_PATH${NC}"
            echo -e "${YELLOW}å°è¯•é‡æ–°å®‰è£…Rustæ ‡å‡†åº“...${NC}"
            rustup component add rust-std-${{ env.TARGET_ARCH }}  # å»æ‰--forceï¼ˆå…³é”®ä¿®å¤ï¼ä¹‹å‰è¯¯åŠ ï¼‰
            # å†æ¬¡éªŒè¯ï¼Œç¡®ä¿æ ¸å¿ƒåº“å­˜åœ¨
            if [ ! -f "$CORE_LIB_PATH/libcore.rlib" ]; then
              echo -e "${RED}âŒ æ ¸å¿ƒåº“å®‰è£…å¤±è´¥ï¼æ— æ³•ç»§ç»­ç¼–è¯‘${NC}"
              exit 1
            fi
          fi
          echo -e "${GREEN}âœ… Rustç›®æ ‡æ¶æ„å’Œæ ¸å¿ƒåº“éªŒè¯æˆåŠŸ${NC}"

      - name: å®‰è£…cargo-ndkï¼ˆå›ºå®šç‰ˆæœ¬ï¼‰
        run: |
          if ! cargo ndk --version &> /dev/null; then
            cargo install cargo-ndk --version=3.5.4 --locked || {
              echo -e "${RED}âŒ cargo-ndkå®‰è£…å¤±è´¥ï¼${NC}"
              exit 1
            }
          fi

      - name: é…ç½®Gradle 7.5
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: 7.5

      - name: åˆ›å»ºCargoé…ç½®ï¼ˆæ·»åŠ libcé€‚é…ï¼‰
        run: |
          mkdir -p .cargo
          cat > .cargo/config.toml << EOF
          [target.${{ env.TARGET_ARCH }}]
          rustflags = [
              "--sysroot=${{ env.NDK_SYSROOT }}",
              "-L", "${{ env.NDK_SYSROOT }}/usr/lib/aarch64-linux-android/${{ env.ANDROID_API_LEVEL }}",
              "-L", "${{ env.UNWIND_LIB_PATH }}",
              "-L", "${{ env.OPENSSL_INSTALL_DIR }}/lib",
              "-l", "static=unwind",
              "-l", "static=ssl",
              "-l", "static=crypto",
              "-l", "dylib=dl",
              "-l", "dylib=log",
              "-l", "dylib=m",
              "-l", "dylib=c",
              "-C", "link-arg=--target=aarch64-linux-android24"
          ]
          [dependencies.libc]
          features = ["android"]
          default-features = false
          EOF

      - name: èµ‹äºˆè„šæœ¬æ‰§è¡Œæƒé™
        run: chmod +x ./scripts/build-android-64bit-minimal.sh

      - name: æ‰§è¡Œç¼–è¯‘è„šæœ¬ï¼ˆä¼ é€’æ‰€æœ‰ç¯å¢ƒå˜é‡ï¼‰
        run: |
          export NDK_PATH=${{ env.NDK_PATH }}
          export NDK_TOOLCHAIN_BIN=${{ env.NDK_TOOLCHAIN_BIN }}
          export NDK_SYSROOT=${{ env.NDK_SYSROOT }}
          export UNWIND_LIB_PATH=${{ env.UNWIND_LIB_PATH }}
          export OPENSSL_INSTALL_DIR=${{ env.OPENSSL_INSTALL_DIR }}
          export TARGET=${{ env.TARGET_ARCH }}
          export ANDROID_API_LEVEL=${{ env.ANDROID_API_LEVEL }}
          # ä¼ é€’æ ¸å¿ƒåº“è·¯å¾„ï¼Œé¿å…è„šæœ¬é‡Œæ‰¾ä¸åˆ°
          export CORE_LIB_PATH="$HOME/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/${{ env.TARGET_ARCH }}/lib"
          
          ./scripts/build-android-64bit-minimal.sh 2>&1 | tee build.log || {
            echo -e "${RED}âŒ ç¼–è¯‘è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼æŸ¥çœ‹build.logè·å–è¯¦ç»†é”™è¯¯${NC}"
            exit 1
          }

      # ğŸ”§ å…³é”®ä¿®å¤2ï¼šAARç¼ºå¤±ç›´æ¥çº¢å­—æŠ¥é”™é€€å‡ºï¼Œä¸æ‰“é’©ï¼ˆæ ¸å¿ƒéœ€æ±‚ï¼‰
      - name: æ”¶é›†äº§ç‰©ï¼ˆAARç¼ºå¤±å¼ºæŠ¥é”™ï¼Œä¸éšç’å¤±è´¥ï¼‰
        if: always()
        run: |
          mkdir -p ./release
          
          # æ”¶é›†ç¼–è¯‘æ—¥å¿—ï¼ˆå¿…é¡»ä¿ç•™ï¼Œæ–¹ä¾¿æ’æŸ¥ï¼‰
          if [ -f "build.log" ]; then
            cp build.log ./release/
            echo -e "${GREEN}âœ… ç¼–è¯‘æ—¥å¿—æ”¶é›†æˆåŠŸ${NC}"
          else
            echo -e "${RED}âŒ æœªæ‰¾åˆ°ç¼–è¯‘æ—¥å¿— build.logï¼ˆç¼–è¯‘è¿‡ç¨‹å¼‚å¸¸ï¼‰${NC}"
          fi
          
          # æ”¶é›†Rustä¸­é—´äº§ç‰©ï¼ˆæ–¹ä¾¿æ’æŸ¥ä¾èµ–é”™è¯¯ï¼‰
          if [ -d "target/aarch64-linux-android/release/deps" ]; then
            mkdir -p ./release/rust-deps
            cp target/aarch64-linux-android/release/deps/*.rlib ./release/rust-deps/ 2>/dev/null
            cp target/aarch64-linux-android/release/deps/*.so ./release/rust-deps/ 2>/dev/null
            echo -e "${GREEN}âœ… Rustä¸­é—´äº§ç‰©æ”¶é›†æˆåŠŸ${NC}"
          fi
          
          # æ ¸å¿ƒé€»è¾‘ï¼šAARç¼ºå¤±ç›´æ¥æŠ¥é”™é€€å‡ºï¼Œå·¥ä½œæµæ˜¾ç¤ºå¤±è´¥ï¼ˆä¸æ‰“é’©ï¼‰
          AAR_PATH=$(find ${{ github.workspace }} -name "*.aar" -path "*/release/*" | head -n 1)
          if [ -n "$AAR_PATH" ]; then
            cp "$AAR_PATH" ./release/letta-lite-android.aar
            echo -e "${GREEN}âœ… AARäº§ç‰©æ”¶é›†æˆåŠŸï¼š$AAR_PATH${NC}"
          else
            echo -e "${RED}âŒ ä¸¥é‡é”™è¯¯ï¼šæœªæ‰¾åˆ°AARäº§ç‰©ï¼ˆç¼–è¯‘å¤±è´¥ï¼‰${NC}"
            exit 1  # å¼ºåˆ¶é€€å‡ºï¼Œå·¥ä½œæµæ ‡è®°å¤±è´¥ï¼Œä¸æ˜¾ç¤ºæ‰“é’©
          fi
          
          # æ”¶é›†SOåº“ï¼ˆå¤‡ç”¨ï¼Œå³ä½¿æ‰“åŒ…è¿›AARä¹Ÿä¿ç•™ï¼‰
          FFI_SO=$(find ${{ github.workspace }} -name "libletta_ffi.so" -path "*/arm64*" | head -n 1)
          JNI_SO=$(find ${{ github.workspace }} -name "libletta_jni.so" -path "*/arm64*" | head -n 1)
          if [ -n "$FFI_SO" ] && [ -n "$JNI_SO" ]; then
            cp "$FFI_SO" ./release/
            cp "$JNI_SO" ./release/
            echo -e "${GREEN}âœ… SOåº“æ”¶é›†æˆåŠŸ${NC}"
          else
            echo -e "${YELLOW}âš ï¸  è­¦å‘Šï¼šSOåº“æœªå•ç‹¬æ‰¾åˆ°ï¼ˆå¯èƒ½å·²æ‰“åŒ…è¿›AARï¼Œä¸å½±å“ä½¿ç”¨ï¼‰${NC}"
          fi

      # ğŸ”§ å…³é”®ä¿®å¤3ï¼šä»…AARæˆåŠŸç”Ÿæˆæ‰ä¸Šä¼ äº§ç‰©ï¼Œé¿å…ä¸Šä¼ ç©ºæ–‡ä»¶å¤¹
      - name: ä¸Šä¼ äº§ç‰©ï¼ˆä»…æˆåŠŸç”ŸæˆAARæ‰ä¸Šä¼ ï¼‰
        if: success()  # åªæœ‰å‰é¢æ­¥éª¤æ— é”™è¯¯ï¼ˆAARå­˜åœ¨ï¼‰æ‰ä¸Šä¼ 
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ./release/*
          retention-days: 14

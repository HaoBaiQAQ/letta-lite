name: Letta-Lite Android (Tianji1200 64bit)
on: [workflow_dispatch, push, pull_request]
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      # 直接硬编码固定路径（GitHub Actions 中 NDK 27 路径永久不变）
      NDK_PATH: /usr/local/lib/android/sdk/ndk/27.3.13750724
      NDK_TOOLCHAIN_BIN: /usr/local/lib/android/sdk/ndk/27.3.13750724/toolchains/llvm/prebuilt/linux-x86_64/bin
      NDK_SYSROOT: /usr/local/lib/android/sdk/ndk/27.3.13750724/toolchains/llvm/prebuilt/linux-x86_64/sysroot
      SYS_LIB_PATH: /usr/local/lib/android/sdk/ndk/27.3.13750724/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/aarch64-linux-android/24
      UNWIND_LIB_PATH: /usr/local/lib/android/sdk/ndk/27.3.13750724/toolchains/llvm/prebuilt/linux-x86_64/lib/clang/18/lib/linux/aarch64
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
      OPENSSL_VERSION: 1.1.1w
      OPENSSL_SRC_DIR: ${{ github.workspace }}/openssl-src
      OPENSSL_INSTALL_DIR: ${{ github.workspace }}/openssl-install
      TARGET_ARCH: aarch64-linux-android
      ANDROID_API_LEVEL: 24
      ARTIFACT_NAME: letta-lite-android-tianji1200

    steps:
      - name: Checkout source code (with llama.cpp submodule)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Install base dependencies
        run: |
          sudo apt-get update --fix-missing
          sudo apt-get install -y \
            rustc cargo git make cbindgen openjdk-17-jdk \
            wget curl unzip gradle perl pkg-config binutils
          java -version
          gradle -v

      - name: Install Android NDK + SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
          packages: "ndk;27.3.13750724 platforms;android-24"

      - name: 验证 NDK 路径是否存在（关键）
        run: |
          if [ ! -d "${{ env.NDK_PATH }}" ]; then
            echo "❌ NDK 路径不存在：${{ env.NDK_PATH }}"
            exit 1
          fi
          if [ ! -f "${{ env.NDK_TOOLCHAIN_BIN }}/ld.lld" ]; then
            echo "❌ linker 不存在：${{ env.NDK_TOOLCHAIN_BIN }}/ld.lld"
            exit 1
          fi
          echo "✅ NDK 路径验证通过"

      - name: 复制系统库到项目内（避免路径查找失败）
        run: |
          mkdir -p "${{ github.workspace }}/dependencies/lib/sys" "${{ github.workspace }}/dependencies/lib/unwind"
          cp "${{ env.SYS_LIB_PATH }}/libdl.so" "${{ env.SYS_LIB_PATH }}/liblog.so" "${{ env.SYS_LIB_PATH }}/libm.so" "${{ env.SYS_LIB_PATH }}/libc.so" "${{ github.workspace }}/dependencies/lib/sys/"
          cp "${{ env.UNWIND_LIB_PATH }}/libunwind.a" "${{ github.workspace }}/dependencies/lib/unwind/"
          echo "✅ 系统库复制完成：$(ls -l ${{ github.workspace }}/dependencies/lib/sys/)"

      - name: Compile OpenSSL for Android (固定路径)
        run: |
          mkdir -p ${{ env.OPENSSL_SRC_DIR }} ${{ env.OPENSSL_INSTALL_DIR }}
          cd ${{ env.OPENSSL_SRC_DIR }}
          wget -q https://www.openssl.org/source/openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          tar -xvzf openssl-${{ env.OPENSSL_VERSION }}.tar.gz --strip-components=1
          export CC="${{ env.NDK_TOOLCHAIN_BIN }}/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang"
          export CXX="${{ env.NDK_TOOLCHAIN_BIN }}/${{ env.TARGET_ARCH }}${{ env.ANDROID_API_LEVEL }}-clang++"
          export AR="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ar"
          export RANLIB="${{ env.NDK_TOOLCHAIN_BIN }}/llvm-ranlib"
          export LD="${{ env.NDK_TOOLCHAIN_BIN }}/ld.lld"
          export PATH="${{ env.NDK_TOOLCHAIN_BIN }}:$PATH"
          ./Configure android-arm64 no-shared no-asm no-zlib \
            --prefix=${{ env.OPENSSL_INSTALL_DIR }} \
            --sysroot=${{ env.NDK_SYSROOT }} \
            -fPIC -march=armv8-a -mtune=cortex-a76
          make -j$(nproc) V=1 | grep -E "CC|AR|LD|armv8-a|aarch64" || true
          make install_sw
          echo "✅ OpenSSL 编译完成：${{ env.OPENSSL_INSTALL_DIR }}/lib"

      - name: 配置 Rust 环境 + 强制安装目标平台标准库
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          target: ${{ env.TARGET_ARCH }}
          components: rust-std  # 强制安装核心标准库

      - name: Install cargo-ndk
        run: cargo install cargo-ndk --version=3.5.4 --locked

      - name: 创建 Cargo config（硬编码固定路径，无任何变量）
        run: |
          mkdir -p .cargo
          cat > .cargo/config.toml << EOF
          [build]
          rustflags = [
            "--sysroot=/usr/local/lib/android/sdk/ndk/27.3.13750724/toolchains/llvm/prebuilt/linux-x86_64/sysroot",
            "-L", "/home/runner/work/letta-lite/letta-lite/dependencies/lib/sys",
            "-L", "/home/runner/work/letta-lite/letta-lite/dependencies/lib/unwind",
            "-L", "/home/runner/work/letta-lite/letta-lite/openssl-install/lib",
            "-l", "libunwind.a",
            "-l", "libdl.so",
            "-l", "liblog.so",
            "-l", "libm.so",
            "-l", "libc.so",
            "-C", "link-arg=--allow-shlib-undefined",
            "-C", "linker=/usr/local/lib/android/sdk/ndk/27.3.13750724/toolchains/llvm/prebuilt/linux-x86_64/bin/ld.lld"
          ]

          [target.aarch64-linux-android]
          linker = "/usr/local/lib/android/sdk/ndk/27.3.13750724/toolchains/llvm/prebuilt/linux-x86_64/bin/ld.lld"
          rustflags = [
            "--sysroot=/usr/local/lib/android/sdk/ndk/27.3.13750724/toolchains/llvm/prebuilt/linux-x86_64/sysroot",
            "-L", "/home/runner/work/letta-lite/letta-lite/dependencies/lib/sys",
            "-L", "/home/runner/work/letta-lite/letta-lite/dependencies/lib/unwind",
            "-L", "/home/runner/work/letta-lite/letta-lite/openssl-install/lib",
            "-l", "libunwind.a",
            "-l", "libdl.so",
            "-l", "liblog.so",
            "-l", "libm.so",
            "-l", "libc.so",
            "-C", "link-arg=--allow-shlib-undefined"
          ]

          [workspace]
          members = ["core", "ffi", "storage", "providers/toy", "providers/llama", "sync"]
          EOF
          echo -e "\n✅ 生成的 Cargo config："
          cat .cargo/config.toml

      - name: 准备构建脚本
        run: chmod +x ./scripts/build-android-64bit-minimal.sh

      - name: 执行构建脚本（提前缓存依赖）
        run: |
          export OPENSSL_DIR=${{ env.OPENSSL_INSTALL_DIR }}
          export TARGET=${{ env.TARGET_ARCH }}
          export ANDROID_API_LEVEL=${{ env.ANDROID_API_LEVEL }}
          ./scripts/build-android-64bit-minimal.sh 2>&1 | tee build.log

      - name: 收集产物
        run: |
          mkdir -p ./release
          AAR_FILE=$(find ${{ github.workspace }} -name "*.aar" | grep -E "release" | head -n 1)
          SO_FILE=$(find ${{ github.workspace }} -name "libletta_jni.so" | grep -E "arm64" | head -n 1)
          [ -z "$AAR_FILE" ] && { echo "❌ AAR 未找到"; exit 1; }
          [ -z "$SO_FILE" ] && { echo "❌ SO 未找到"; exit 1; }
          cp "$AAR_FILE" ./release/letta-lite-android.aar
          cp "$SO_FILE" ./release/letta-lite-jni.so
          cp ./build.log ./release/build.log
          echo "✅ 产物收集完成：$(ls -l ./release/)"

      - name: 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ./release/*
          retention-days: 14
